<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
<title>Caynana AI v7.0 Relational</title>
<style>
  :root {
    --bg-outer: #000000;
    --bg: #0e0e0e;
    --text: #ececec;
    --gold: #ffb300;
    --pistachio: #bef264;
    --glass: rgba(20, 20, 20, 0.98);
    --border: rgba(255, 255, 255, 0.12);
    --lip-color: #d84315;
    --card-bg: #1a1a1a;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100dvh;
    background: var(--bg-outer);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }

  .mobile-frame {
    width: 100%; height: 100%;
    max-width: 480px;
    background: var(--bg);
    position: relative;
    display: flex; flex-direction: column;
    box-shadow: 0 0 50px rgba(255, 255, 255, 0.05);
    overflow: hidden;
  }
  @media (min-width: 500px) { .mobile-frame { height: 95dvh; border-radius: 24px; border: 1px solid #333; } }

  /* TOPBAR */
  .topbar {
    flex: 0 0 70px; background: var(--glass); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 3000;
  }
  .left-controls { display: flex; gap: 15px; align-items: center; }
  .hamb-btn { background: none; border: none; cursor: pointer; color: #aaa; font-size: 24px; padding: 0; }
  
  /* Logo Area */
  .brand-wrapper { display: flex; flex-direction: column; align-items: center; margin-right: 40px; flex: 1;}
  .logo-area { display: flex; align-items: center; gap: 8px; }
  .brand-name { font-weight: 700; font-size: 16px; color: #fff; }
  .slogan { font-size: 10px; color: #888; margin-top: 2px; }
  .seesaw-svg { width: 36px; height: 18px; overflow: visible; }
  .seesaw-bar { transform-origin: 18px 14px; transition: transform 0.4s; }
  .tilt-left .seesaw-bar { transform: rotate(-15deg); }
  .tilt-right .seesaw-bar { transform: rotate(15deg); }

  /* FACE PANEL (Gƒ∞ZLƒ∞Lƒ∞K KAPISI) */
  .face-container {
    flex: 0 0 0px; background: linear-gradient(to bottom, var(--bg), transparent);
    overflow: hidden; transition: flex-basis 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 2500;
  }
  .mobile-frame.tracking-active .face-container { flex-basis: 180px; } /* Panel a√ßƒ±lƒ±r */
  
  .face-panel-inner { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; transform: translateY(-30px); transition: 0.4s; }
  .mobile-frame.tracking-active .face-panel-inner { opacity: 1; transform: translateY(0); }

  /* G√ñZLER VE ANƒ∞MASYONLAR */
  .mobile-frame.sleeping .eyes-row { animation: sleepBreath 3s infinite ease-in-out; }
  .mobile-frame.sleeping .brow { transform: translateY(12px) rotate(8deg); transition: 1s; }
  .mobile-frame.sleeping .lid-top { height: 70% !important; border-bottom: 3px solid #111; transition: 1s; }
  .mobile-frame.sleeping .lid-bot { height: 70% !important; border-top: 3px solid #111; transition: 1s; }
  @keyframes sleepBreath { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.95) translateY(3px); } }

  .eyes-row { display: flex; gap: 24px; margin-bottom: 10px; }
  .eye { width: 90px; height: 65px; position: relative; --lidTop:0%; --lidBot:0%; --gx:0px; --gy:0px; transition: 0.1s; }
  
  .brow { position: absolute; top: -14px; left: 0; width: 100%; height: 16px; background: #222; border-radius: 99px; transform-origin: center; transition: 0.3s; box-shadow: 0 3px 6px rgba(0,0,0,0.5); }
  .sclera { width: 100%; height: 100%; background: #e0e0e0; border-radius: 50%; overflow: hidden; position: relative; border: 2px solid #1a1a1a; box-shadow: inset 0 0 8px rgba(0,0,0,0.8); }
  .iris { width: 32px; height: 32px; background: radial-gradient(circle, #5d4037 0%, #281a16 100%); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); border: 1px solid rgba(255,255,255,0.25); transition: transform 0.08s linear; }
  .pupil { width: 10px; height: 10px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  .reflection { position: absolute; top: 6px; right: 6px; width: 4px; height: 4px; background: #fff; border-radius: 50%; opacity: 0.9; }
  .lid-top, .lid-bot { position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10; transition: height 0.1s; }
  .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
  .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

  /* DUYGU MODLARI */
  .eye.angry .brow { transform: translateY(6px) rotate(12deg); }
  .eye.angry .lid-top { height: 30% !important; }
  .eye.happy .brow { transform: translateY(-6px); }
  .eye.happy .lid-bot { height: 35% !important; }
  .eye.shock .brow { transform: translateY(-12px); }
  .eye.shock .iris { transform: scale(0.85) translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); }

  /* READING MODE (G√∂zler A≈üaƒüƒ±) */
  .mobile-frame.reading .iris { transform: translate(-50%, 15px) !important; transition: 0.3s; }
  .mobile-frame.reading .lid-top { height: 40% !important; transition: 0.3s; }
  .mobile-frame.reading .brow { transform: translateY(0); }

  /* MOUTH & SPEAKING */
  .mouth-wrapper { width: 60px; height: 26px; display: flex; justify-content: center; align-items: center; position: relative; margin-top: 8px; }
  .mouth { width: 40px; height: 10px; border-top: 3px solid var(--lip-color); border-radius: 50% 50% 0 0; position: absolute; top: 8px; transition: 0.15s; opacity: 0.9; }
  .mouth::after { content:''; position: absolute; bottom: -5px; left: 15%; width: 70%; height: 3px; background: rgba(216, 67, 21, 0.3); border-radius: 0 0 10px 10px; transition: 0.15s; }
  
  .mobile-frame.speaking .mouth { height: 18px; width: 36px; background: #3e2723; border: 2px solid var(--lip-color); border-radius: 50%; top: 5px; animation: talkAnim 0.15s infinite alternate; }
  .mobile-frame.speaking .mouth::after { opacity: 0; }
  @keyframes talkAnim { 0% { transform: scaleY(0.8); } 100% { transform: scaleY(1.1); } }
  .mobile-frame.mumbling .mouth { transform: scaleX(1.15); border-color: #ff5722; }
  
  .close-track-btn { margin-top: 10px; background: rgba(198, 40, 40, 0.2); color: #ef9a9a; border: 1px solid rgba(198, 40, 40, 0.5); padding: 5px 14px; border-radius: 20px; font-size: 11px; cursor: pointer; }

  /* CHAT AREA */
  .chat-area {
    flex: 1; overflow-y: auto; padding: 20px 16px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth;
    scrollbar-width: none; -ms-overflow-style: none;
  }
  .chat-area::-webkit-scrollbar { display: none; width: 0; height: 0; }

  .bubble { 
    max-width: 85%; padding: 12px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; animation: pop 0.2s ease;
    word-wrap: break-word; word-break: break-word;
  }
  @keyframes pop { from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
  .bubble.bot { align-self: flex-start; background: #1c1c1c; border-left: 3px solid var(--gold); color: #ddd; border-top-left-radius: 4px; min-height: 40px;}
  .bubble.user { align-self: flex-end; background: #222; border-right: 3px solid var(--pistachio); color: #fff; border-top-right-radius: 4px; text-align: right; }
  
  /* TYPEWRITER CURSOR */
  .cursor::after { content: '|'; animation: blinkCursor 0.8s infinite; margin-left: 2px; color: var(--gold); }
  @keyframes blinkCursor { 50% { opacity: 0; } }

  /* PRODUCT CARD */
  .product-card { background: var(--card-bg); border: 1px solid #333; border-radius: 16px; padding: 12px; display: flex; gap: 12px; align-items: center; animation: slideIn 0.3s ease; width: 100%; transition: 0.2s; }
  .product-card:active { transform: scale(0.98); }
  @keyframes slideIn { from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
  .p-img { width: 60px; height: 60px; background: #333; border-radius: 10px; flex-shrink: 0; display:flex; align-items:center; justify-content:center; font-size:24px;}
  .p-info { flex: 1; min-width: 0; }
  .p-title { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .p-price { font-size: 15px; color: var(--gold); font-weight: 700; }
  .p-source { font-size: 10px; color: #888; }
  .p-comment { margin-top: 6px; font-size: 11px; color: #ccc; font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 4px; word-wrap: break-word; }
  .product-card.recommend { border: 1px solid var(--pistachio); box-shadow: 0 0 10px rgba(190, 242, 100, 0.1); }
  .product-card.recommend .p-comment { color: var(--pistachio); }
  .product-card.expensive { border: 1px solid #d32f2f; }
  .product-card.expensive .p-comment { color: #ef9a9a; }

  /* DOCK */
  .input-dock { flex: 0 0 auto; background: var(--glass); padding: 10px 16px 25px 16px; z-index: 3000; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
  .track-trigger-row { display: flex; justify-content: center; width: 100%; transition: 0.3s; height: 36px; overflow: hidden; }
  .mobile-frame.tracking-active .track-trigger-row { height: 0; margin: 0; opacity: 0; pointer-events: none; }
  .main-track-btn { background: rgba(255, 179, 0, 0.15); border: 1px solid var(--gold); color: var(--gold); padding: 8px 24px; border-radius: 24px; cursor: pointer; font-size: 13px; font-weight: 600; box-shadow: 0 0 15px rgba(255, 179, 0, 0.1); animation: pulseBtn 2s infinite; display: flex; align-items: center; gap: 8px; }
  @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  .dock-inner { display: flex; align-items: flex-end; gap: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 24px; padding: 6px; }
  .icon-btn { width: 42px; height: 42px; border-radius: 50%; border: none; background: transparent; color: #888; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: 0.2s; }
  .icon-btn.active { color: var(--gold); background: rgba(255,179,0,0.15); }
  .icon-btn svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; }
  .send-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--pistachio); color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(190, 242, 100, 0.3); }
  .send-btn:active { transform: scale(0.9); }
  .send-btn svg { width: 20px; height: 20px; fill: #000; transform: translateX(-2px) translateY(1px); }
  
  textarea {
    flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px; resize: none; padding: 10px; max-height: 100px; min-height: 24px; font-family: inherit;
    scrollbar-width: none; word-break: break-all; word-wrap: break-word;
  }
  textarea::-webkit-scrollbar { display: none; }

  .footer { text-align: center; font-size: 9px; color: #444; margin-top: 2px; }
  .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); display:flex; justify-content: flex-start;}
  .menu-overlay.open { opacity: 1; pointer-events: auto; }
  .menu-sidebar { width: 260px; height: 100%; background: #161616; padding: 80px 20px; transform: translateX(-100%); transition: 0.3s; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid #333; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
  .menu-overlay.open .menu-sidebar { transform: translateX(0); }
  .menu-item { color: #ccc; text-decoration: none; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 16px; }
  #camVideo { display: none; }
</style>
</head>
<body>

<div class="mobile-frame" id="mobileFrame">
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-sidebar">
      <a href="#" class="menu-item">Hesabƒ±m</a>
      <a href="#" class="menu-item">Ayarlar</a>
      <a href="#" class="menu-item" style="color:var(--gold)">Caynana v7.0</a>
    </div>
  </div>

  <div class="topbar">
    <div class="left-controls">
      <button class="hamb-btn" id="hambBtn">‚ò∞</button>
      </div>
    <div class="brand-wrapper" id="brandWrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20">
          <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
          <g class="seesaw-bar" id="seesawBar">
             <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
             <circle cx="3" cy="5" r="3" fill="#bef264" />
             <circle cx="37" cy="5" r="3" fill="#ffb300" />
          </g>
        </svg>
        <div class="brand-name">Caynana AI</div>
      </div>
      <div class="slogan">ƒ∞li≈ükisel Asistan v7.0</div>
    </div>
  </div>

  <div class="face-container">
    <div class="face-panel-inner" id="faceInner">
      <div class="eyes-row">
        <div class="eye" id="eyeL">
          <div class="brow"></div>
          <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
          <div class="lid-top"></div><div class="lid-bot"></div>
        </div>
        <div class="eye" id="eyeR">
          <div class="brow"></div>
          <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
          <div class="lid-top"></div><div class="lid-bot"></div>
        </div>
      </div>
      <div class="mouth-wrapper"><div class="mouth"></div></div>
      <button class="close-track-btn" id="closeTrackBtn">Takibi Kapat</button>
    </div>
  </div>

  <div class="chat-area" id="chat">
    <div class="bubble bot">G√∂z√ºm √ºzerinde... Ne arƒ±yorsan s√∂yle.</div>
  </div>

  <div class="input-dock">
    <div class="track-trigger-row">
      <button class="main-track-btn" id="openTrackBtn">üëÅÔ∏è TAKƒ∞P ET</button>
    </div>
    <div class="dock-inner">
      <button class="icon-btn" id="camBtn">
        <svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
      </button>
      <textarea id="msgInput" rows="1" placeholder="Ne lazƒ±m evladƒ±m?"></textarea>
      <button class="icon-btn" id="micBtn">
        <svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
      </button>
      <button class="send-btn" id="sendBtn">
        <svg viewBox="0 0 24 24"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2Z"></path></svg>
      </button>
    </div>
    <div class="footer">@CaynanAI Relational Edition</div>
  </div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
  // DOM Elements
  const frame = document.getElementById('mobileFrame');
  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const eyeL = document.getElementById('eyeL');
  const eyeR = document.getElementById('eyeR');
  const brandWrapper = document.getElementById('brandWrapper');
  const openTrackBtn = document.getElementById('openTrackBtn');
  const closeTrackBtn = document.getElementById('closeTrackBtn');
  const camBtn = document.getElementById('camBtn');
  const micBtn = document.getElementById('micBtn');
  const sendBtn = document.getElementById('sendBtn');
  const camVideo = document.getElementById('camVideo');
  const menuOverlay = document.getElementById('menuOverlay');
  const hambBtn = document.getElementById('hambBtn');

  // STATE MACHINE VARIABLES
  let isTracking = false;
  let isCameraOn = false;
  let faceMesh, camera;
  let idleTimer = null;
  let currentState = 'IDLE'; // IDLE, READING, SPEAKING, LISTENING, SLEEPING
  const IDLE_LIMIT = 10000;

  // CAYNANA DATABASE (Aynen korundu)
  const productDB = {
    'telefon': [
      { name: 'iPhone 15 Pro Max', price: 98000, source: 'TeknoStore', img: 'üì±' },
      { name: 'Samsung Galaxy A34', price: 12500, source: 'UcuzPazar', img: 'üì≤' },
      { name: 'Nokia 3310 (Yenilenmi≈ü)', price: 1500, source: 'Antikacƒ±', img: 'üìû' }
    ],
    'bilgisayar': [
      { name: 'MacBook Pro M3', price: 75000, source: 'Apple', img: 'üíª' },
      { name: 'Lenovo ƒ∞≈ü Bilgisayarƒ±', price: 18000, source: 'OfisMarket', img: 'üíª' }
    ],
    'ayakkabƒ±': [
      { name: 'Nike Air Jordan', price: 8500, source: 'Sneaks', img: 'üëü' },
      { name: 'Pazar Malƒ± Spor', price: 650, source: 'Semt Pazarƒ±', img: 'üëû' }
    ]
  };

  // --- STATE HELPERS ---
  const setState = (newState) => {
    currentState = newState;
    if(newState === 'READING') {
      frame.classList.add('reading');
      setMood('normal'); // Okurken n√∂tr ol
    } else {
      frame.classList.remove('reading');
    }

    if(newState === 'SPEAKING') {
      frame.classList.add('speaking');
    } else {
      frame.classList.remove('speaking');
    }
  };

  // --- RELATIONAL BEHAVIORS ---
  
  // 1. ONAYLAMA (Approval Blink)
  const doApprovalBlink = async () => {
    if(!isTracking) return;
    setLids(100); // G√∂z kapat
    await sleep(150);
    setLids(0);   // G√∂z a√ß
    await sleep(100);
    setGaze(0, 0); // G√∂z sabitle
  };

  // 2. DAKTƒ∞LO + SES (Synchronized Response)
  async function speakAndType(text) {
    setState('SPEAKING');
    
    // TTS Ba≈ülat
    const synth = window.speechSynthesis;
    if(synth.speaking) synth.cancel(); // √ñnceki konu≈ümayƒ± kes
    
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'tr-TR';
    utter.rate = 1.0;
    utter.pitch = 0.9;
    
    // Senkronizasyon i√ßin Promise
    const speechPromise = new Promise(resolve => {
      utter.onend = resolve;
      utter.onerror = resolve; // Hata olursa da devam et
    });
    
    synth.speak(utter);
    
    // Daktilo Efekti
    const bubble = document.createElement('div'); 
    bubble.className = 'bubble bot cursor'; 
    chat.appendChild(bubble);
    
    let i = 0;
    const speed = 40; // Yazma hƒ±zƒ±
    
    // Yazma d√∂ng√ºs√º
    while(i < text.length) {
      bubble.innerText += text.charAt(i);
      scrollChat();
      i++;
      await sleep(speed);
    }
    bubble.classList.remove('cursor'); // ƒ∞mleci kaldƒ±r

    // Ses bitene kadar bekle (veya ses bitmi≈üse devam et)
    await speechPromise;
    setState('IDLE');
    brandWrapper.classList.remove('tilt-right');
    resetIdle();
  }

  // Helpers
  const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const scrollChat = () => chat.scrollTop = chat.scrollHeight;

  // --- G√ñZ FONKSƒ∞YONLARI ---
  function setGaze(x, y) {
    if(currentState === 'SLEEPING' || currentState === 'READING') return; // Okurken g√∂z sabit
    const gx = clamp(x * 20, -20, 20);
    const gy = clamp(y * 15, -15, 15);
    [eyeL, eyeR].forEach(e => { e.style.setProperty('--gx', gx+'px'); e.style.setProperty('--gy', gy+'px'); });
  }

  function setLids(top, bot=0) {
    if(currentState === 'SLEEPING') return;
    [eyeL, eyeR].forEach(e => { e.style.setProperty('--lidTop', top+'%'); e.style.setProperty('--lidBot', bot+'%'); });
  }
  
  function setSingleLid(eye, top) {
    if(currentState === 'SLEEPING') return;
    eye.style.setProperty('--lidTop', top+'%');
  }

  function setMood(mood) {
    [eyeL, eyeR].forEach(e => e.classList.remove('angry', 'shock', 'happy'));
    if(mood !== 'normal') [eyeL, eyeR].forEach(e => e.classList.add(mood));
  }

  // --- FARE TAKƒ∞Bƒ∞ (Sadece IDLE iken) ---
  window.addEventListener('pointermove', (e) => {
    resetIdle();
    if(!isTracking || isCameraOn || currentState !== 'IDLE') return;
    const rect = frame.getBoundingClientRect();
    const xRel = e.clientX - rect.left;
    const yRel = e.clientY - rect.top;
    const x = (xRel / rect.width) * 2 - 1;
    const y = (yRel / rect.height) * 2 - 1;
    setGaze(x, y);
  });

  // --- UYKU VE IDLE ---
  function resetIdle() {
    if (!isTracking) return;
    clearTimeout(idleTimer);
    if (currentState === 'SLEEPING') {
      frame.classList.remove('sleeping');
      setState('IDLE');
      setLids(0, 0); setTimeout(()=>setLids(100), 100); setTimeout(()=>setLids(0), 250);
    }
    idleTimer = setTimeout(() => {
      if(!isTracking || currentState === 'SPEAKING' || currentState === 'READING') return;
      frame.classList.add('sleeping');
      currentState = 'SLEEPING';
    }, IDLE_LIMIT);
  }

  // --- Gƒ∞ZLƒ∞Lƒ∞K KAPISI (TRACKING TOGGLE) ---
  function toggleTracking(active) {
    isTracking = active;
    if(active) {
      frame.classList.add('tracking-active'); 
      resetIdle();
      setState('IDLE');
    } else {
      frame.classList.remove('tracking-active'); 
      stopCamera(); 
      clearTimeout(idleTimer); 
      frame.classList.remove('sleeping'); 
      setState('IDLE');
      setMood('normal');
    }
  }
  openTrackBtn.addEventListener('click', () => toggleTracking(true));
  closeTrackBtn.addEventListener('click', () => toggleTracking(false));

  // --- MESAJ G√ñNDERME ---
  async function sendMessage() {
    const txt = msgInput.value.trim();
    if(!txt) return;
    resetIdle();
    
    // 1. Onaylama Hareketi
    await doApprovalBlink();
    
    addBubble(txt, 'user');
    msgInput.value = '';
    frame.classList.remove('mumbling');
    msgInput.blur(); // Klavye insin, okuma modu bitsin
    
    await sleep(600);
    processQuery(txt);
  }

  // --- CEVAP MOTORU ---
  async function processQuery(txt) {
    const t = txt.toLowerCase();
    
    // √úr√ºn Arama
    for (const key in productDB) {
      if (t.includes(key)) {
        await speakAndType(`Bak senin i√ßin ≈üunlarƒ± buldum... Ama fiyatlara dikkat et!`);
        const products = productDB[key];
        for (const p of products) {
          const analysis = analyzeProduct(p);
          addCard(p, analysis);
          if(isTracking) setMood(analysis.mood);
          await sleep(1500);
        }
        if(isTracking) setTimeout(() => setMood('normal'), 1000);
        return;
      }
    }
    
    // Genel Sohbet
    let ans = "Hƒ±mm...";
    if(t.includes('merhaba')) ans = "Sana da merhaba evladƒ±m. Ho≈ü geldin.";
    else if(t.includes('takip')) ans = "G√∂z√ºm √ºzerinde, sakƒ±n hata yapma. Seni izliyorum.";
    else if(t.includes('nasƒ±lsƒ±n')) ans = "Yuvarlanƒ±p gidiyoruz i≈üte. Sen nasƒ±lsƒ±n?";
    else ans = "Bunu hafƒ±zaya attƒ±m. Ba≈üka ne lazƒ±m?";
    
    await speakAndType(ans);
  }

  // --- √úR√úN ANALƒ∞Zƒ∞ (Aynen korundu) ---
  function analyzeProduct(product) {
    let mood = 'normal';
    let comment = '';
    let styleClass = '';
    if (product.price > 50000) {
      mood = 'angry'; styleClass = 'expensive';
      const r = Math.random();
      if(r < 0.3) comment = "Ocaƒüƒ±na incir aƒüacƒ± mƒ± dikeceksin?";
      else if(r < 0.6) comment = "Evladƒ±m sen banka mƒ± soydun?";
      else comment = "Buna bu parayƒ± veren aklƒ±nƒ± peynir ekmekle yemi≈ütir.";
    } 
    else if (product.price < 2000) {
      mood = 'happy'; styleClass = 'recommend';
      const r = Math.random();
      if(r < 0.3) comment = "Bak bu kelepir! Hemen al.";
      else if(r < 0.6) comment = "Sudan ucuz.";
      else comment = "ƒ∞≈üte akƒ±llƒ± alƒ±≈üveri≈ü budur.";
    } 
    else if (product.name.includes('iPhone') || product.name.includes('Mac')) {
      mood = 'shock'; comment = "ƒ∞smi var diye para sa√ßma.";
    }
    else { mood = 'normal'; comment = "Eh i≈üte, fiyatƒ± makul."; }
    return { mood, comment, styleClass };
  }

  function addCard(product, analysis) {
    const card = document.createElement('div');
    card.className = `product-card ${analysis.styleClass}`;
    card.innerHTML = `
      <div class="p-img">${product.img}</div>
      <div class="p-info">
        <div class="p-title">${product.name}</div>
        <div class="p-price">${product.price.toLocaleString('tr-TR')} TL</div>
        <div class="p-source">${product.source}</div>
        <div class="p-comment">" ${analysis.comment} "</div>
      </div>
    `;
    chat.appendChild(card);
    scrollChat();
  }

  function addBubble(txt, type) {
    const d = document.createElement('div'); d.className = `bubble ${type}`; d.innerText = txt; 
    chat.appendChild(d); scrollChat(); 
  }

  // --- INPUT EVENTS (OKUMA MODU TETƒ∞KLEYƒ∞Cƒ∞Sƒ∞) ---
  msgInput.addEventListener('focus', () => {
    resetIdle();
    if(isTracking) setState('READING'); // Okuma modu: G√∂zler a≈üaƒüƒ±
  });
  
  msgInput.addEventListener('blur', () => {
    if(isTracking && currentState === 'READING') setState('IDLE'); // Normale d√∂n
  });

  msgInput.addEventListener('input', () => {
    resetIdle();
    msgInput.style.height = 'auto'; msgInput.style.height = Math.min(msgInput.scrollHeight, 100) + 'px';
    brandWrapper.classList.add('tilt-left');
    if(isTracking) { 
      frame.classList.add('mumbling'); 
      // Okurken k√º√ß√ºk g√∂z hareketleri
      if(currentState === 'READING') {
         const x = Math.sin(msgInput.value.length * 0.5) * 0.2; 
         setGaze(x, 0.8); // Hep a≈üaƒüƒ±da kalsƒ±n, saƒüa sola oynasƒ±n
      }
    }
  });

  msgInput.addEventListener('keydown', (e) => { 
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } 
  });
  sendBtn.addEventListener('click', sendMessage);

  // --- KAMERA (WINK) ---
  camBtn.addEventListener('click', () => { if(!isTracking) toggleTracking(true); if(isCameraOn) stopCamera(); else startCamera(); });

  async function startCamera() {
    if(isCameraOn) return;
    if(!faceMesh) {
      faceMesh = new FaceMesh.FaceMesh({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
      faceMesh.setOptions({maxNumFaces:1, refineLandmarks:true});
      faceMesh.onResults(onFace);
    }
    try {
      camera = new Camera(camVideo, { onFrame: async()=>{ await faceMesh.send({image:camVideo}); }, width:640, height:480 });
      await camera.start(); isCameraOn = true; camBtn.classList.add('active');
    } catch(e) { console.log(e); }
  }
  function stopCamera() { isCameraOn = false; camBtn.classList.remove('active'); }

  function getEyeOpenness(lm, topIdx, botIdx, leftIdx, rightIdx) {
    const h = Math.hypot(lm[topIdx].x - lm[botIdx].x, lm[topIdx].y - lm[botIdx].y);
    const w = Math.hypot(lm[leftIdx].x - lm[rightIdx].x, lm[leftIdx].y - lm[rightIdx].y);
    return h / w;
  }

  function onFace(res) {
    if(!isTracking || !isCameraOn || currentState === 'SLEEPING' || currentState === 'READING') return; // Okurken kamera gaze'i ezmesin
    if(res.multiFaceLandmarks && res.multiFaceLandmarks.length>0) {
      const lm = res.multiFaceLandmarks[0];
      const nose = lm[1];
      setGaze(-(nose.x-0.5)*3, (nose.y-0.5)*3);
      
      const leftRatio = getEyeOpenness(lm, 159, 145, 33, 133);
      const rightRatio = getEyeOpenness(lm, 386, 374, 362, 263);
      const THRESHOLD = 0.18;

      if(leftRatio < THRESHOLD && rightRatio < THRESHOLD) setLids(100);
      else if(leftRatio < THRESHOLD) { setSingleLid(eyeR, 100); setSingleLid(eyeL, 0); }
      else if(rightRatio < THRESHOLD) { setSingleLid(eyeL, 100); setSingleLid(eyeR, 0); }
      else setLids(0, 0);
    }
  }

  // --- Mƒ∞KROFON (LISTENING STATE) ---
  micBtn.addEventListener('click', () => {
    if(!isTracking) toggleTracking(true);
    resetIdle();
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Mikrofon yok");
    
    setState('LISTENING'); // Dinleme modu (g√∂zler dikkat kesilebilir)
    
    const r = new SR(); r.lang = 'tr-TR';
    micBtn.classList.add('active');
    r.onstart = () => brandWrapper.classList.add('tilt-left');
    r.onresult = (ev) => { 
      const t = ev.results[0][0].transcript; 
      addBubble(t, 'user'); 
      processQuery(t); 
    };
    r.onend = () => { 
      micBtn.classList.remove('active'); 
      brandWrapper.classList.remove('tilt-left'); 
      if(currentState === 'LISTENING') setState('IDLE');
    };
    r.start();
  });

  hambBtn.addEventListener('click', ()=>menuOverlay.classList.add('open'));
  menuOverlay.addEventListener('click', ()=>menuOverlay.classList.remove('open'));
</script>
</body>
</html>
