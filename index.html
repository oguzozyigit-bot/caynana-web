<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CAYNANA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #10B981;
    --primary-light: #D1FAE5;
    --bg: #FFFFFF;
    --text: #1F2937;
    --gray: #6B7280;
    /* İtalyan Renkleri */
    --it-green: #009246;
    --it-white: #F1F2F1;
    --it-red: #CE2B37;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- SCROLLABLE MAIN CONTAINER --- */
  /* Bu yapı sayesinde arama kutusu ve sonuçlar aynı akışta durur */
  #app-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    scroll-behavior: smooth;
    padding-bottom: 80px; /* Footer payı */
  }

  /* --- LOGO ALANI --- */
  .logo-area {
    margin-top: 15vh; /* Başlangıçta ortada dursun */
    margin-bottom: 30px;
    text-align: center;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .logo {
    font-size: 50px;
    font-weight: 900;
    color: #333;
    letter-spacing: -2px;
    display: inline-block;
  }
  .logo span { color: var(--primary); }
  
  .slogan {
    font-size: 14px;
    color: var(--gray);
    margin-top: 5px;
    font-weight: 500;
    opacity: 1;
    transition: opacity 0.3s;
  }

  /* --- ARAMA KUTUSU (KALP) --- */
  .search-wrapper {
    width: 100%;
    max-width: 650px;
    position: relative;
    z-index: 10;
    transition: all 0.5s ease;
  }

  .search-box {
    width: 100%;
    height: 60px;
    border: 2px solid #E5E7EB;
    border-radius: 30px;
    padding: 0 120px 0 25px; /* İkonlar için sağ boşluk */
    font-size: 17px;
    outline: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    background: white;
  }
  
  .search-box:focus {
    border-color: var(--primary);
    box-shadow: 0 8px 30px rgba(16, 185, 129, 0.15);
  }

  /* İKON GRUBU */
  .input-tools {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .tool-btn {
    width: 42px; height: 42px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--gray);
    font-size: 19px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .tool-btn:hover { background: #F3F4F6; color: var(--primary); }
  
  /* Gönder Butonu (Yeşil) */
  .send-btn {
    background: var(--primary);
    color: white;
  }
  .send-btn:hover { background: #059669; color: white; transform: scale(1.05); }

  /* Mikrofon Aktif Animasyonu */
  .tool-btn.mic-active { color: #EF4444; background: #FEE2E2; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);} }

  /* --- HIZLI BUTONLAR (CHIPS) --- */
  .shortcuts {
    display: flex;
    gap: 12px;
    margin-top: 25px;
    flex-wrap: wrap;
    justify-content: center;
    transition: opacity 0.3s;
  }
  .chip {
    background: #F9FAFB;
    border: 1px solid #E5E7EB;
    padding: 10px 18px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: #4B5563;
    cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    transition: 0.2s;
  }
  .chip:hover { border-color: var(--primary); background: var(--primary-light); color: #065F46; }
  .chip i { font-size: 15px; color: var(--primary); }

  /* --- SONUÇ ALANI (AŞAĞI AKAN) --- */
  #results-stream {
    width: 100%;
    max-width: 800px;
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    opacity: 0; /* Başlangıçta gizli */
    transition: opacity 0.5s;
  }

  /* Mesaj Balonları */
  .msg-block { display: flex; flex-direction: column; width: 100%; animation: slideUp 0.4s ease; }
  .msg-block.user { align-items: flex-end; }
  .msg-block.ai { align-items: flex-start; }

  .user-bubble {
    background: #F3F4F6;
    color: #111;
    padding: 12px 20px;
    border-radius: 20px;
    border-bottom-right-radius: 4px;
    font-weight: 600;
    font-size: 16px;
    max-width: 80%;
  }

  .ai-bubble {
    background: white;
    border: 1px solid #E5E7EB;
    padding: 20px;
    border-radius: 20px;
    border-bottom-left-radius: 4px;
    color: #374151;
    font-size: 16px;
    line-height: 1.6;
    width: 100%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
  }

  /* Görsel Önizleme */
  .preview-img { max-width: 150px; border-radius: 12px; margin-bottom: 10px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

  /* Ürün Kartları (Yatay) */
  .cards-container {
    display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px 20px 5px; width: 100%; scrollbar-width: none;
  }
  .cards-container::-webkit-scrollbar { display: none; }

  .product-card {
    min-width: 220px; max-width: 220px;
    background: white; border: 1px solid #E5E7EB; border-radius: 16px;
    padding: 12px; text-decoration: none; color: inherit;
    display: flex; flex-direction: column; transition: transform 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
  }
  .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
  
  .p-img { width: 100%; height: 140px; object-fit: contain; margin-bottom: 10px; }
  .p-title { font-size: 14px; font-weight: 700; margin-bottom: 5px; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .p-price { color: var(--primary); font-weight: 800; font-size: 16px; margin-top: auto; }
  .p-store { font-size: 11px; color: #9CA3AF; margin-top: 4px; display: flex; align-items: center; gap: 4px; }

  /* Ses Butonu */
  .voice-btn {
    margin-top: 10px; background: #F9FAFB; border: 1px solid #E5E7EB;
    border-radius: 20px; padding: 6px 14px; font-size: 12px; font-weight: 600;
    color: #4B5563; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    transition: 0.2s;
  }
  .voice-btn:hover { background: #F3F4F6; color: var(--primary); }

  /* --- ARAMA MODU (Animasyon) --- */
  body.search-active .logo-area {
    margin-top: 20px; /* Yukarı kayar */
    transform: scale(0.8); /* Biraz küçülür */
    margin-bottom: 20px;
  }
  body.search-active .slogan { display: none; }
  body.search-active .shortcuts { display: none; } /* Hızlı butonlar gider */
  body.search-active #results-stream { opacity: 1; }

  @keyframes slideUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }

  /* --- FOOTER & İTALYAN BARI --- */
  .footer-fixed {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #F9FAFB; border-top: 1px solid #E5E7EB; z-index: 20;
  }
  .footer-links {
    padding: 12px; text-align: center; font-size: 12px; color: #6B7280;
    display: flex; justify-content: center; gap: 20px;
  }
  .footer-links span { cursor: pointer; font-weight: 500; transition: 0.2s; }
  .footer-links span:hover { color: var(--primary); }
  
  .italy-stripe {
    height: 6px; width: 100%;
    background: linear-gradient(90deg, var(--it-green) 33.3%, var(--it-white) 33.3%, var(--it-white) 66.6%, var(--it-red) 66.6%);
  }

  /* Yükleniyor */
  .loader { display: none; width: 100%; text-align: center; padding: 30px; color: var(--gray); font-style: italic; }

</style>
</head>
<body>

<div id="app-container">
  
  <div class="logo-area">
    <div class="logo">CAYNANA<span>.AI</span></div>
    <div class="slogan">Alışveriş, Fal, Yaşam Koçluğu ve Fazlası</div>
  </div>

  <div class="search-wrapper">
    <input type="text" id="mainInput" class="search-box" placeholder="Ne danışmak istersin evladım?" autocomplete="off" onkeypress="if(event.key==='Enter') startProcess()">
    
    <div class="input-tools">
      <button class="tool-btn" onclick="triggerCam()" title="Fotoğraf Çek"><i class="fa-solid fa-camera"></i></button>
      <button class="tool-btn" onclick="triggerMic()" id="micBtn" title="Konuş"><i class="fa-solid fa-microphone"></i></button>
      <button class="tool-btn send-btn" onclick="startProcess()"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
  </div>

  <div class="shortcuts" id="shortcuts">
    <div class="chip" onclick="fill('Kahve falı bak (Fotoğraf)')"><i class="fa-solid fa-mug-hot"></i> Kahve Falı</div>
    <div class="chip" onclick="fill('Haftalık burç yorumu')"><i class="fa-solid fa-star"></i> Burç</div>
    <div class="chip" onclick="fill('Airfryer önerisi')"><i class="fa-solid fa-cart-shopping"></i> Alışveriş</div>
    <div class="chip" onclick="fill('Canım sıkkın, dertleş')"><i class="fa-solid fa-heart"></i> Yaşam Koçu</div>
  </div>

  <div id="results-stream">
    <div class="loader" id="loader">
      <i class="fa-solid fa-circle-notch fa-spin"></i> Kaynanan inceliyor...
    </div>
  </div>

</div>

<div class="footer-fixed">
  <div class="footer-links">
    <span>Hakkımızda</span>
    <span>Gizlilik</span>
    <span>SSS</span>
    <span>İletişim</span>
  </div>
  <div class="italy-stripe"></div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">

<script>
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-1.onrender.com/api/speak";
  
  const mainInput = document.getElementById('mainInput');
  const resultsStream = document.getElementById('results-stream');
  const loader = document.getElementById('loader');
  
  let currentImg = null;
  let currentAudio = null;

  function fill(txt) {
    mainInput.value = txt;
    startProcess();
  }

  function triggerCam() { document.getElementById('fileInput').click(); }
  
  function handleFile(file) {
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      currentImg = e.target.result;
      mainInput.value = "Fotoğraf eklendi. Yorumla...";
      mainInput.focus();
    };
    reader.readAsDataURL(file);
  }

  function triggerMic() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return alert("Tarayıcın mikrofon desteklemiyor evladım.");
    const rec = new SpeechRecognition();
    rec.lang = 'tr-TR';
    const btn = document.getElementById('micBtn');
    
    rec.onstart = () => { btn.classList.add('mic-active'); mainInput.placeholder = "Dinliyorum..."; };
    rec.onend = () => { btn.classList.remove('mic-active'); mainInput.placeholder = "Ne danışmak istersin?"; };
    rec.onresult = (e) => {
      mainInput.value = e.results[0][0].transcript;
      startProcess();
    };
    rec.start();
  }

  async function startProcess() {
    const txt = mainInput.value.trim();
    if(!txt && !currentImg) return;

    // 1. Tasarım Modunu Değiştir (Logo yukarı kayar, Chips gider)
    document.body.classList.add('search-active');
    
    // 2. Kullanıcı Mesajını Bas
    addUserMsg(txt, currentImg);
    
    // 3. Yükleniyor...
    resultsStream.appendChild(loader);
    loader.style.display = 'block';
    scrollToBottom();

    const payload = {
        message: txt,
        image: currentImg,
        user: { city: 'İstanbul', gender: 'neutral' }
    };

    // Temizle
    mainInput.value = '';
    currentImg = null;
    document.getElementById('fileInput').value = '';

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      
      loader.style.display = 'none';
      addAIResponse(data);

    } catch(e) {
      loader.style.display = 'none';
      addAIMsg("Bağlantı koptu evladım. İnternetini kontrol et.");
    }
  }

  function addUserMsg(text, img) {
    const div = document.createElement('div');
    div.className = 'msg-block user';
    
    let content = `<div class="user-bubble">`;
    if(img) content += `<img src="${img}" class="preview-img"><br>`;
    content += `${text}</div>`;
    
    div.innerHTML = content;
    resultsStream.insertBefore(div, loader);
  }

  function addAIMsg(text) {
    const div = document.createElement('div');
    div.className = 'msg-block ai';
    div.innerHTML = `<div class="ai-bubble">${text}</div>`;
    resultsStream.insertBefore(div, loader);
    scrollToBottom();
  }

  function addAIResponse(data) {
    const container = document.createElement('div');
    container.className = 'msg-block ai';

    // Metin
    const textDiv = document.createElement('div');
    textDiv.className = 'ai-bubble';
    const cleanText = (data.reply || data.assistant_text || "").replace(/\n/g, '<br>');
    textDiv.innerHTML = cleanText;
    
    // Ses Butonu
    const audioBtn = document.createElement('button');
    audioBtn.className = 'voice-btn';
    audioBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Seslendir';
    const safeTxt = cleanText.replace(/<[^>]*>?/gm, '').replace(/"/g, '');
    audioBtn.onclick = () => playVoice(audioBtn, safeTxt);
    
    textDiv.appendChild(audioBtn);
    container.appendChild(textDiv);

    // Kartlar
    if(data.data && Array.isArray(data.data)) {
        const row = document.createElement('div');
        row.className = 'cards-container';
        data.data.forEach(c => {
            const card = document.createElement('a');
            card.className = 'product-card';
            card.href = c.url || '#';
            card.target = '_blank';
            
            const img = c.image ? `<img src="${c.image}" class="p-img">` : '<div style="height:120px; background:#f9fafb; display:flex; align-items:center; justify-content:center; margin-bottom:10px;"><i class="fa-solid fa-image" style="color:#ccc; font-size:30px;"></i></div>';
            
            card.innerHTML = `
                ${img}
                <div class="p-title">${c.title || 'Ürün'}</div>
                <div class="p-price">${c.price || c.desc || ''}</div>
                <div class="p-store"><i class="fa-solid fa-shop"></i> ${c.footer || 'Satıcı'}</div>
            `;
            row.appendChild(card);
        });
        container.appendChild(row);
    }

    resultsStream.insertBefore(container, loader);
    scrollToBottom();
  }

  function scrollToBottom() {
    const container = document.getElementById('app-container');
    container.scrollTop = container.scrollHeight;
  }

  async function playVoice(btn, text) {
    if(currentAudio) { currentAudio.pause(); currentAudio=null; btn.innerHTML='<i class="fa-solid fa-volume-high"></i> Seslendir'; return; }
    
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...';
    try {
      const res = await fetch(SPEAK_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      currentAudio.onended = () => { btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Seslendir'; };
      await currentAudio.play();
      btn.innerHTML = '<i class="fa-solid fa-stop"></i> Durdur';
    } catch(e) {
      btn.innerHTML = 'Hata';
    }
  }
</script>

</body>
</html>
