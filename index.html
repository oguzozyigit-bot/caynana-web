<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
  <title>Caynana AI</title>
  <link rel="icon" href="data:," />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg0:#07070a; --bg1:#0b0b12;
      --glass: rgba(22,22,30,.78);
      --glass2: rgba(22,22,30,.92);
      --border: rgba(255,255,255,.12);
      --text:#ececec; --muted:#a9a9b3;
      --primary:#E6C25B;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --r: 18px; --r2: 22px;
      --safe: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0; min-height:100vh; overflow-x:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(230,194,91,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(145,120,255,.14), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(129,199,132,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .app{ max-width: 980px; margin:0 auto; padding: calc(14px + var(--safe)) 14px 16px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position: sticky; top:0; padding: 10px 0 12px; z-index: 30;
      backdrop-filter: blur(12px);
    }
    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .logo{
      width:44px; height:44px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border); box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo::before{
      content:""; position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(230,194,91,.45), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(145,120,255,.35), transparent 55%);
      transform: rotate(18deg); opacity:.9;
    }
    .eyes{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:8px; z-index:2;
    }
    .eye{
      width:10px; height:10px; border-radius:999px; background: rgba(255,255,255,.92);
      overflow:hidden; position:relative; transform: translateY(1px);
      animation: blink 5.8s infinite;
    }
    .eye:nth-child(2){ animation-delay:.2s; }
    .pupil{
      width:4px; height:4px; border-radius:999px; background: rgba(0,0,0,.72);
      position:absolute; left:3px; top:3px; animation: look 4.2s ease-in-out infinite;
    }
    @keyframes blink{
      0%, 92%, 100%{ transform: scaleY(1) translateY(1px); }
      94%{ transform: scaleY(.12) translateY(1px); }
      96%{ transform: scaleY(1) translateY(1px); }
    }
    @keyframes look{
      0%, 100%{ transform: translate(0,0); }
      25%{ transform: translate(2px,1px); }
      50%{ transform: translate(-1px,2px); }
      75%{ transform: translate(1px,-1px); }
    }
    .brandTitle{ line-height:1.05; }
    .brandTitle b{ font-size:14px; letter-spacing:.2px; }
    .brandTitle div{ font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{ display:flex; align-items:center; gap:10px; }
    .iconBtn{
      width:42px; height:42px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
      cursor:pointer; user-select:none;
    }
    .iconBtn:active{ transform: scale(.98); }
    .iconBtn svg{ width:18px; height:18px; stroke: rgba(255,255,255,.85); fill:none; stroke-width:2; }

    .hero{
      display:flex; gap:14px; padding: 14px;
      border-radius: var(--r2);
      background: var(--glass);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden; position:relative;
    }
    .hero::after{
      content:""; position:absolute; right:-120px; top:-120px;
      width:280px; height:280px;
      background: radial-gradient(circle, rgba(230,194,91,.18), transparent 60%);
      pointer-events:none;
    }
    .heroLeft{ flex:1; min-width:0; }
    .heroTitle{ font-size:22px; font-weight:900; margin-bottom:6px; }
    .heroDesc{ font-size:13px; color: var(--muted); line-height:1.45; margin-bottom:12px; }
    .heroPills{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      font-size:12px; padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      display:flex; align-items:center; gap:8px;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--primary); box-shadow: 0 0 0 6px rgba(230,194,91,.12); }

    .oz-lines{ display:flex; gap:8px; padding: 12px 4px 0; opacity:.9; }
    .oz-lines span{ flex:1; height:5px; border-radius:999px; background: rgba(255,255,255,.08); transition: background .25s ease; }

    .panel{
      margin-top: 12px;
      border-radius: var(--r2);
      border:1px solid var(--border);
      background: var(--glass2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .chatArea{ height: min(54vh, 520px); overflow:auto; padding:12px; scroll-behavior:smooth; }
    .msg-row{ display:flex; margin:10px 0; }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.bot{ justify-content:flex-start; }
    .msg-bubble{
      max-width:82%; padding:10px 12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      line-height:1.45; font-size:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      white-space: pre-wrap; word-break: break-word;
    }
    .msg-bubble.user{ background: linear-gradient(180deg, rgba(230,194,91,.20), rgba(230,194,91,.10)); border-color: rgba(230,194,91,.22); }
    .msg-bubble.bot{ background: rgba(255,255,255,.06); }

    .composer{
      display:flex; gap:10px; padding:12px;
      border-top: 1px solid rgba(255,255,255,.08);
      align-items:flex-end;
    }
    .inp{
      flex:1; min-height:44px; max-height:120px; resize:none;
      border-radius:16px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px; outline:none; font-size:14px; line-height:1.3;
    }
    .sendBtn{
      width:52px; height:44px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(230,194,91,.14);
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .sendBtn:active{ transform: scale(.98); }

    /* Drawer */
    .drawerMask{
      position: fixed; inset:0; background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none; z-index: 80;
    }
    .drawer{
      position:absolute; top:0; right:0;
      width: min(92vw, 360px); height:100%;
      background: linear-gradient(180deg, rgba(22,22,30,.96), rgba(16,16,22,.96));
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -20px 0 60px rgba(0,0,0,.55);
      padding: calc(14px + var(--safe)) 14px 14px;
      display:flex; flex-direction:column; gap:12px;
    }
    .drawerTop{ display:flex; align-items:center; justify-content:space-between; }
    .drawerTitle{ font-weight:900; display:flex; align-items:center; gap:10px; }
    .chip{ font-size:11px; padding: 6px 10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); color: rgba(255,255,255,.85); }

    .profileCard{
      border-radius: 18px; padding:12px; display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      position:relative; overflow:hidden;
    }
    .profileCard::before{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(230,194,91,.18), transparent 50%),
                  radial-gradient(circle at 80% 40%, rgba(145,120,255,.16), transparent 50%);
      transform: rotate(20deg); opacity:.85; pointer-events:none;
    }
    .avatar{
      width:46px; height:46px; border-radius:16px; object-fit:cover;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06);
      position:relative; z-index:1;
    }
    .pinfo{ position:relative; z-index:1; min-width:0; }
    .pname{ font-weight:900; }
    .pmeta{ color: var(--muted); font-size:12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .menuGroup{ display:flex; flex-direction:column; gap:8px; }
    .menuBtn{
      border-radius:16px; padding:11px 12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:space-between;
      color: rgba(255,255,255,.92);
    }
    .menuBtn small{ color: var(--muted); font-weight:600; }
    .danger{ background: rgba(255,82,82,.10); border-color: rgba(255,82,82,.20); }
    .danger small{ color: rgba(255,190,190,.9); }

    /* Auth modal */
    .modalMask{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index: 90; background: rgba(0,0,0,.60); backdrop-filter: blur(10px); padding: 18px;
    }
    .modal{
      width:min(92vw, 440px);
      border-radius: 22px;
      background: rgba(22,22,30,.96);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalBody{ padding: 14px; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .btn{
      border-radius:16px; padding:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      cursor:pointer; font-weight:900;
      display:flex; align-items:center; justify-content:center;
    }
    .btnLight{ background:#fff; color:#000; }
    .hint{ color: var(--muted); font-size:12px; line-height:1.45; }
    @media (max-width: 520px){
      .msg-bubble{ max-width: 92%; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <div class="eyes">
            <div class="eye"><div class="pupil"></div></div>
            <div class="eye"><div class="pupil"></div></div>
          </div>
        </div>
        <div class="brandTitle">
          <b>CAYNANA</b>
          <div>Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
        </div>
      </div>

      <div class="topActions">
        <div class="iconBtn" id="notifBtn" title="Bildirim">
          <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        </div>

        <div class="iconBtn" id="hambBtn" title="Men√º">
          <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </div>
      </div>
    </div>

    <div class="hero">
      <div class="heroLeft">
        <div class="heroTitle">Caynana ile<br>Dertle≈ü.</div>
        <div class="heroDesc">Hadi gel evladƒ±m, anlat bakalƒ±m.</div>
        <div class="heroPills">
          <div class="pill"><span class="dot"></span><span id="whoPill">Misafir modundasƒ±n</span></div>
          <div class="pill">üîí <span id="termsPill">S√∂zle≈üme: ‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="oz-lines">
      <span style="background:#E6C25B"></span><span style="background:#81C784"></span><span style="background:#CE93D8"></span><span style="background:#7986CB"></span>
    </div>

    <div class="panel">
      <div class="chatArea" id="chatContainer"></div>
      <div class="composer">
        <textarea id="text" class="inp" rows="1" placeholder="Yaz bakalƒ±m evladƒ±m..."></textarea>
        <div class="sendBtn" id="sendBtn" title="G√∂nder">‚û§</div>
      </div>
    </div>

  </div>

  <!-- Drawer -->
  <div class="drawerMask" id="drawerMask">
    <div class="drawer">
      <div class="drawerTop">
        <div class="drawerTitle">Men√º <span class="chip" id="menuChip">‚Äî</span></div>
        <div class="iconBtn" id="drawerClose" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>

      <div class="profileCard">
        <img id="drawerAvatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar" />
        <div class="pinfo">
          <div class="pname" id="drawerName">Misafir</div>
          <div class="pmeta" id="drawerMeta">Giri≈ü yaparsan seni tanƒ±rƒ±m.</div>
        </div>
      </div>

      <div class="menuGroup" id="menuActions"></div>

      <div style="margin-top:auto; color:rgba(255,255,255,.45); font-size:12px; display:flex; justify-content:space-between;">
        <span>¬© CaynanaAI</span><span>O.√ñzyiƒüit</span>
      </div>
    </div>
  </div>

  <!-- Auth modal -->
  <div class="modalMask" id="authModal">
    <div class="modal">
      <div class="modalHead">
        <b>Google ile Giri≈ü</b>
        <div class="iconBtn" id="authCloseX" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="hint">Mobil/PC fark etmez: √∂nce ‚ÄúBaƒülan‚Äù dener, olmazsa alttaki Google butonunu kullan.</div>
          <div class="btn btnLight" id="googleLoginBtn">Google ile Baƒülan</div>
          <div id="googleBtnMount" style="display:flex; justify-content:center;"></div>
          <div id="googleFallbackHint" class="hint" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { BASE_DOMAIN, GOOGLE_CLIENT_ID, STORAGE_KEY, PLACEHOLDER_IMG } from "./js/config.js";

    const $ = (id) => document.getElementById(id);
    const safeJson = (s, fb={}) => { try { return JSON.parse(s||""); } catch { return fb; } };
    const getUser = () => safeJson(localStorage.getItem(STORAGE_KEY), {});
    const setUser = (u) => localStorage.setItem(STORAGE_KEY, JSON.stringify(u||{}));

    // --- UI ---
    const openDrawer = () => ($("drawerMask").style.display="block");
    const closeDrawer = () => ($("drawerMask").style.display="none");
    const openAuth = () => ($("authModal").style.display="flex");
    const closeAuth = () => ($("authModal").style.display="none");

    function hitap(u){
      const h = String(u?.hitap||"").trim();
      if(h) return h;
      const full = String(u?.fullname||"").trim();
      return (full.split(/\s+/)[0] || "Misafir");
    }

    function refreshMenu(){
      const u = getUser();
      const logged = !!(u?.isSessionActive && u?.id);
      $("menuChip").innerText = logged ? "Aktif" : "Misafir";
      $("drawerAvatar").src = u?.avatar || PLACEHOLDER_IMG;
      $("drawerName").innerText = hitap(u);
      $("drawerMeta").innerText = logged ? (u.email || "Google ile baƒülƒ±") : "Giri≈ü yaparsan seni tanƒ±rƒ±m.";
      $("whoPill").innerText = logged ? `Merhaba ${hitap(u)} üëã` : "Misafir modundasƒ±n";
      $("termsPill").innerText = u?.terms_accepted_at ? "S√∂zle≈üme: onaylƒ±" : "S√∂zle≈üme: ‚Äî";

      const actions = $("menuActions");
      if(!actions) return;

      if(logged){
        actions.innerHTML = `
          <div class="menuBtn" id="logoutBtn"><span><b>√áƒ±kƒ±≈ü</b> <small>Google</small></span><span>‚éã</span></div>
          <div class="menuBtn danger" id="deleteBtn"><span><b>Hesabƒ±mƒ± Sil</b> <small>kalƒ±cƒ±</small></span><span>‚úï</span></div>
        `;
      }else{
        actions.innerHTML = `
          <div class="menuBtn" id="loginBtn"><span><b>Google ile Baƒülan</b> <small>PC + mobil</small></span><span>‚Ä∫</span></div>
        `;
      }

      // bind
      actions.querySelectorAll(".menuBtn").forEach(b=>{
        b.addEventListener("click", async () => {
          closeDrawer();
          if(b.id==="loginBtn") openAuth();
          if(b.id==="logoutBtn") doLogout();
          if(b.id==="deleteBtn") deleteAccount();
        });
      });
    }

    // --- Google Sign-In (GIS) ---
    function decodeJwtPayload(token){
      try{
        const parts = String(token||"").split(".");
        if(parts.length < 2) return null;
        let base64Url = parts[1].replace(/-/g,"+").replace(/_/g,"/");
        const pad = base64Url.length % 4;
        if(pad) base64Url += "=".repeat(4-pad);
        const json = decodeURIComponent(
          atob(base64Url).split("").map(c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join("")
        );
        return JSON.parse(json);
      }catch{ return null; }
    }

    function initGIS(){
      if(!window.google || !google.accounts || !google.accounts.id) return false;

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (resp) => {
          const idToken = String(resp?.credential || "");
          if(!idToken) return;

          localStorage.setItem("google_id_token", idToken);

          const claims = decodeJwtPayload(idToken) || {};
          const email = String(claims.email||"").toLowerCase().trim();
          const name = String(claims.name||"").trim();
          const picture = String(claims.picture||"").trim();

          if(!email){
            alert("Google email alƒ±namadƒ±.");
            return;
          }

          const u0 = getUser();
          const u = {
            ...u0,
            id: email,
            email,
            fullname: name || u0.fullname || "",
            avatar: picture || u0.avatar || "",
            provider: "google",
            isSessionActive: true,
            lastLoginAt: new Date().toISOString()
          };
          setUser(u);

          closeAuth();
          refreshMenu();
        },
        auto_select: false,
        cancel_on_tap_outside: true
      });

      // fallback button mount
      const mount = $("googleBtnMount");
      if(mount){
        try{
          google.accounts.id.renderButton(mount, { theme:"outline", size:"large", text:"continue_with", shape:"pill", width: 260 });
        }catch(e){}
      }

      return true;
    }

    function promptLogin(){
      if(!window.google || !google.accounts || !google.accounts.id){
        alert("Google servisi hen√ºz y√ºklenmedi.");
        return;
      }
      google.accounts.id.prompt((notif)=>{
        if(notif.isNotDisplayed?.() || notif.isSkippedMoment?.()){
          const reason = notif.getNotDisplayedReason?.() || notif.getSkippedReason?.() || "unknown";
          const hint = $("googleFallbackHint");
          if(hint){
            hint.style.display="block";
            hint.innerText = `Google penceresi a√ßƒ±lamadƒ± (${reason}). Alttaki Google butonunu kullan.`;
          }
        }
      });
    }

    function doLogout(){
      const u = getUser();
      u.isSessionActive = false;
      setUser(u);
      localStorage.removeItem("google_id_token");
      refreshMenu();
      location.reload();
    }

    async function deleteAccount(){
      const u = getUser();
      if(!u?.id) return;
      if(!confirm("Hesabƒ±nƒ± kalƒ±cƒ± silmek istiyor musun?")) return;

      const idToken = (localStorage.getItem("google_id_token")||"").trim();

      try{
        const r = await fetch(`${BASE_DOMAIN}/api/profile/delete`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ user_id: u.id, email: u.email||"", google_id_token: idToken||"" })
        });
        if(r.ok){
          alert("Hesabƒ±n silindi.");
          localStorage.clear();
          location.reload();
          return;
        }
      }catch(e){}

      try{
        const r2 = await fetch(`${BASE_DOMAIN}/api/profile/update`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ user_id: u.id, meta:{ email:u.email||"", deleted_at:new Date().toISOString() }, google_id_token: idToken||"" })
        });
        if(r2.ok){
          alert("Silme talebin alƒ±ndƒ±.");
          localStorage.clear();
          location.reload();
          return;
        }
      }catch(e){}

      alert("Silme endpoint'i yok/√ßalƒ±≈ümƒ±yor. Backend'e ekleyelim.");
    }

    // --- Chat demo (site √ßalƒ±≈üsƒ±n diye) ---
    function addBubble(text, who){
      const c = $("chatContainer");
      c.innerHTML += `<div class="msg-row ${who}"><div class="msg-bubble ${who}">${text}</div></div>`;
      c.scrollTop = c.scrollHeight;
    }

    function sendMessage(){
      const input = $("text");
      const txt = (input.value||"").trim();
      if(!txt) return;
      input.value="";
      addBubble(txt, "user");

      const u = getUser();
      const logged = !!(u?.isSessionActive && u?.id);

      if(!logged){
        addBubble("√ñnce Google ile giri≈ü yap evladƒ±m.", "bot");
        openAuth();
        return;
      }

      // demo
      setTimeout(()=> addBubble("Heh, ≈üimdi oldu. Anlat bakalƒ±m‚Ä¶", "bot"), 350);
    }

    // --- boot ---
    document.addEventListener("DOMContentLoaded", ()=>{
      $("hambBtn").addEventListener("click", ()=>{ refreshMenu(); openDrawer(); });
      $("drawerClose").addEventListener("click", closeDrawer);
      $("drawerMask").addEventListener("click", (e)=>{ if(e.target === $("drawerMask")) closeDrawer(); });

      $("notifBtn").addEventListener("click", ()=> alert("Bildirim mod√ºl√º hazƒ±r ‚Äî initNotif baƒülayacaƒüƒ±z."));
      $("googleLoginBtn").addEventListener("click", promptLogin);
      $("authCloseX").addEventListener("click", closeAuth);
      $("authModal").addEventListener("click", (e)=>{ if(e.target === $("authModal")) closeAuth(); });

      $("sendBtn").addEventListener("click", sendMessage);
      $("text").addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

      // GIS init (google script ge√ß gelirse tekrar dene)
      const t0 = Date.now();
      const timer = setInterval(()=>{
        const ok = initGIS();
        if(ok || Date.now()-t0 > 8000) clearInterval(timer);
      }, 250);

      refreshMenu();
    });
  </script>
</body>
</html>
