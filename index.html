<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CAYNANA - Yeni Nesil Asistan</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #10B981;
    --primary-dark: #059669;
    --bg: #F3F4F6;
    --white: #FFFFFF;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-500: #6B7280;
    --gray-800: #1F2937;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    color: var(--gray-800);
    overflow: hidden;
  }

  /* --- HEADER --- */
  .header {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--gray-200);
    z-index: 50;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 800;
    font-size: 20px;
    color: var(--gray-800);
    letter-spacing: -0.5px;
  }
  .brand i { color: var(--primary); font-size: 22px; }
  
  .status-badge {
    background: #ECFDF5;
    color: var(--primary-dark);
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #D1FAE5;
  }
  .dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 2s infinite; }
  @keyframes pulse { 0% {opacity:1} 50% {opacity:0.5} 100% {opacity:1} }

  /* --- CHAT AREA --- */
  #chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  /* Messages */
  .msg {
    display: flex;
    flex-direction: column;
    max-width: 85%;
    position: relative;
    animation: slideUp 0.3s ease-out;
  }
  .msg.user { align-self: flex-end; align-items: flex-end; }
  .msg.ai { align-self: flex-start; align-items: flex-start; }

  .bubble {
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: var(--shadow-sm);
    word-wrap: break-word;
  }
  .msg.user .bubble {
    background: var(--primary);
    color: white;
    border-bottom-right-radius: 4px;
  }
  .msg.ai .bubble {
    background: var(--white);
    color: var(--gray-800);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--gray-200);
  }

  .msg-img {
    max-width: 200px;
    border-radius: 12px;
    margin-bottom: 8px;
    border: 2px solid white;
    box-shadow: var(--shadow-md);
  }

  @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

  /* --- ACTIONS --- */
  .actions {
    background: var(--white);
    border-top: 1px solid var(--gray-200);
    padding-bottom: env(safe-area-inset-bottom);
  }

  /* Chips */
  .chips-scroll {
    display: flex;
    gap: 8px;
    padding: 10px 16px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .chip {
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--gray-500);
    white-space: nowrap;
    cursor: pointer;
    transition: 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .chip:active { background: var(--gray-200); transform: scale(0.96); }
  .chip i { color: var(--primary); }

  /* Input Bar */
  .input-bar {
    padding: 10px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .tool-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--gray-100);
    color: var(--gray-500);
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: 0.2s;
  }
  .tool-btn:active { background: var(--gray-200); }
  .tool-btn.recording { color: #EF4444; background: #FEE2E2; animation: pulse 1s infinite; }

  .input-field {
    flex: 1;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 24px;
    padding: 12px 16px;
    font-size: 16px;
    outline: none;
    transition: 0.2s;
  }
  .input-field:focus { background: var(--white); border-color: var(--primary); }

  .send-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--primary);
    color: white;
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
    transition: 0.2s;
  }
  .send-btn:active { transform: scale(0.9); background: var(--primary-dark); }

  /* File Input (Hidden) */
  #fileInput { display: none; }

  /* Typing Indicator */
  .typing {
    padding: 0 20px 10px;
    font-size: 12px;
    color: var(--gray-500);
    font-style: italic;
    display: none;
  }
</style>
</head>
<body>

<div class="header">
  <div class="brand" onclick="location.reload()">
    <i class="fa-solid fa-comment-dots"></i> CAYNANA
  </div>
  <div class="status-badge">
    <div class="dot"></div> Çevrimiçi
  </div>
</div>

<div id="chat-area">
  <div class="msg ai">
    <div class="bubble">
      Hoş geldin evladım. Ben Kaynanan. Alışveriş, yemek, dert, fal... Ne varsa dökül, hallederiz.
    </div>
  </div>
</div>

<div class="typing" id="typingIndicator">Kaynanan yazıyor...</div>

<div class="actions">
  <div class="chips-scroll">
    <div class="chip" onclick="fill('Fal bak')"><i class="fa-solid fa-wand-magic-sparkles"></i> Fal Bak</div>
    <div class="chip" onclick="fill('Bugün ne giysem?')"><i class="fa-solid fa-shirt"></i> Ne Giysem?</div>
    <div class="chip" onclick="fill('Nöbetçi eczane nerede?')"><i class="fa-solid fa-pills"></i> Eczane</div>
    <div class="chip" onclick="fill('Canım sıkkın')"><i class="fa-solid fa-heart-crack"></i> Dertleş</div>
  </div>

  <div class="input-bar">
    <button class="tool-btn" onclick="triggerCamera()">
      <i class="fa-solid fa-camera"></i>
    </button>
    
    <button class="tool-btn" id="micBtn" onclick="toggleMic()">
      <i class="fa-solid fa-microphone"></i>
    </button>
    
    <input type="text" id="msgInput" class="input-field" placeholder="Bir şeyler yaz..." autocomplete="off">
    
    <button class="send-btn" onclick="sendMessage()">
      <i class="fa-solid fa-paper-plane"></i>
    </button>
    
    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleFile(this.files[0])">
  </div>
</div>

<script>
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";
  const chatArea = document.getElementById('chat-area');
  const msgInput = document.getElementById('msgInput');
  const typing = document.getElementById('typingIndicator');
  let currentImg = null;

  // --- Functions ---

  function fill(txt) {
    msgInput.value = txt;
    sendMessage();
  }

  function triggerCamera() {
    document.getElementById('fileInput').click();
  }

  function handleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      currentImg = e.target.result;
      addMessage("Fotoğraf eklendi. Göndermek için bir şeyler yaz.", 'user', currentImg);
      msgInput.focus();
    };
    reader.readAsDataURL(file);
  }

  function toggleMic() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return alert("Mikrofon desteklenmiyor evladım.");
    
    const rec = new SpeechRecognition();
    rec.lang = 'tr-TR';
    const btn = document.getElementById('micBtn');
    
    rec.onstart = () => {
      btn.classList.add('recording');
      msgInput.placeholder = "Dinliyorum...";
    };
    
    rec.onend = () => {
      btn.classList.remove('recording');
      msgInput.placeholder = "Bir şeyler yaz...";
    };
    
    rec.onresult = (e) => {
      msgInput.value = e.results[0][0].transcript;
      sendMessage();
    };
    
    rec.start();
  }

  function addMessage(text, type, imgBase64 = null) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `msg ${type}`;
    
    let content = "";
    if (imgBase64) {
      content += `<img src="${imgBase64}" class="msg-img">`;
    }
    content += `<div class="bubble">${text}</div>`;
    
    msgDiv.innerHTML = content;
    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  async function sendMessage() {
    const txt = msgInput.value.trim();
    if (!txt && !currentImg) return;

    // 1. Show User Msg (if not just image preview)
    if (!currentImg) addMessage(txt, 'user');
    
    msgInput.value = '';
    typing.style.display = 'block';
    chatArea.scrollTop = chatArea.scrollHeight;

    const payload = {
      message: txt || "Fotoğrafı yorumla",
      image: currentImg,
      user: { city: 'İstanbul', gender: 'neutral' }
    };

    currentImg = null;
    document.getElementById('fileInput').value = "";

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      
      const data = await res.json();
      typing.style.display = 'none';

      // 2. Show AI Response
      addMessage(data.reply || data.assistant_text || "Bir şeyler ters gitti.", 'ai');

    } catch (e) {
      typing.style.display = 'none';
      addMessage("Bağlantı koptu veya sistem hatası evladım.", 'ai');
    }
  }

  // Enter Key
  msgInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") sendMessage();
  });

</script>

</body>
</html>
