<script type="module">
  import { initPartials } from './js/partials.js';
  import { initNotif } from './js/notif.js';

  import { initAuth, handleLogin, logout, acceptTerms } from './js/auth.js';
  import { addUserBubble } from './js/chat.js';
  import { BASE_DOMAIN, STORAGE_KEY } from './js/config.js';
  import { openFalPanel, closeFalPanel, handleFalPhoto } from './js/fal.js';

  // ------------------------------
  // SAFE HELPERS
  // ------------------------------
  const $ = (id) => document.getElementById(id);

  function firstNameOnly(fullname="") {
    const s = (fullname || "").trim();
    if(!s) return "";
    return s.split(/\s+/)[0];
  }

  function getProfileMeta(){
    try{ return JSON.parse(localStorage.getItem("caynana_profile_v2") || "{}"); }catch(e){ return {}; }
  }

  function getCaynanaWho(user, profile){
    const hitap = (profile?.hitap || "").trim();
    if(hitap) return hitap;
    const n = firstNameOnly(user?.fullname || user?.name || "");
    if(n) return n;
    return "EvladÄ±m";
  }

  function iconFor(type){
    if(type==="match") return "âš½";
    if(type==="horoscope") return "â™ˆ";
    if(type==="diet") return "ðŸ¥—";
    if(type==="spouse_bday") return "ðŸŽ‚";
    if(type==="child_bday") return "ðŸ§’";
    if(type==="wedding") return "ðŸ’";
    if(type==="period_check") return "ðŸŒ™";
    return "ðŸ””";
  }

  function timeLabel(daysLeft){
    if(daysLeft === 0) return "BugÃ¼n";
    if(daysLeft === 1) return "YarÄ±n";
    if(daysLeft > 1) return daysLeft + " gÃ¼n kaldÄ±";
    return "";
  }

  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ------------------------------
  // EYE TRACKING FUNCTIONS (define early!)
  // ------------------------------
  let isTracking = false;
  let isMouseActive = false;
  let sleepTimer = null;
  let gazeTimer = null;

  const SLEEP_DELAY = 30000;
  const GAZE_DELAY  = 2000;
  const AUTO_LOOK_FREQ = 5000;

  function setGaze(x, y) {
    const eyeL = $("eyeL");
    const eyeR = $("eyeR");
    if(!eyeL || !eyeR) return;
    const gx = Math.min(Math.max(x * 20, -20), 20);
    const gy = Math.min(Math.max(y * 15, -15), 15);
    [eyeL, eyeR].forEach(e => {
      e.style.setProperty('--gx', gx+'px');
      e.style.setProperty('--gy', gy+'px');
    });
  }

  function setLids(top, bot=0) {
    const eyeL = $("eyeL");
    const eyeR = $("eyeR");
    if(!eyeL || !eyeR) return;
    [eyeL, eyeR].forEach(e => {
      e.style.setProperty('--lidTop', top+'%');
      e.style.setProperty('--lidBot', bot+'%');
    });
  }

  function resetIdle() {
    clearTimeout(sleepTimer);
    sleepTimer = setTimeout(goSleep, SLEEP_DELAY);
  }

  function goSleep() {
    const frame = $("mobileFrame");
    if(!frame) return;
    if(frame.classList.contains('sleeping')) return;
    frame.classList.add('sleeping');
    setLids(100, 100);
  }

  function wakeUp() {
    const frame = $("mobileFrame");
    if(!frame) return;
    frame.classList.remove('sleeping');
    setLids(0, 0);
    resetIdle();
  }

  function centerEyes() { setGaze(0, 0); }

  function autoLookBehavior() {
    const frame = $("mobileFrame");
    if (!frame) return;
    if (isMouseActive || frame.classList.contains('sleeping') || !isTracking) return;
    const rX = (Math.random() - 0.5) * 0.8;
    const rY = (Math.random() - 0.5) * 0.5;
    setGaze(rX, rY);
    setTimeout(() => setGaze(0, 0), 1000);
  }

  // ------------------------------
  // NOTIFICATIONS (safe local refresh)
  // ------------------------------
  async function fetchNotificationsToday(){
    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if(!user?.id) return [];
    try{
      const res = await fetch(`${BASE_DOMAIN}/api/reminders/today?user_id=${encodeURIComponent(user.id)}`, { cache: "no-store" });
      const data = await res.json();
      return data?.items || [];
    }catch(e){ return []; }
  }

  async function refreshNotifications(){
    const list = $("notifList");
    const badge = $("notifBadge");
    if(!list) return; // DOM yoksa sessizce Ã§Ä±k

    const items = await fetchNotificationsToday();
    if (badge) badge.style.display = items.length ? "block" : "none";

    if(!items.length){
      list.innerHTML = `
        <div class="notif-item">
          <div class="notif-icon">ðŸ§¿</div>
          <div class="notif-content">
            <div class="notif-title">BugÃ¼n sakin</div>
            <div class="notif-desc">EvladÄ±m bugÃ¼n hatÄ±rlatmam yok. Ben yine buradayÄ±m.</div>
            <div class="notif-time">â€”</div>
          </div>
        </div>`;
      return;
    }

    list.innerHTML = items.map(it => {
      const clickable = it.action_url ? "cursor:pointer;" : "";
      const onclick = it.action_url ? `location.href='${it.action_url}'` : "";
      return `
        <div class="notif-item" style="${clickable}" onclick="${onclick}">
          <div class="notif-icon">${iconFor(it.type)}</div>
          <div class="notif-content">
            <div class="notif-title">${escapeHtml(it.title || "")}</div>
            <div class="notif-desc">${escapeHtml(it.message || "")}</div>
            <div class="notif-time">${timeLabel(it.days_left)}</div>
          </div>
        </div>`;
    }).join("");
  }

  // ------------------------------
  // GLOBAL EXPORTS
  // ------------------------------
  window.handleLogin = handleLogin;
  window.logout = logout;
  window.openFal = openFalPanel;
  window.closeFal = closeFalPanel;
  window.handleFalFile = (input) => handleFalPhoto(input);

  // Terms overlay (SAFE)
  window.showTermsOverlay = function(){
    const el = $("termsOverlay");
    if(!el) return;
    el.classList.add("active");
  };
  window.hideTermsOverlay = function(){
    const el = $("termsOverlay");
    if(!el) return;
    el.classList.remove("active");
  };

  window.acceptTermsAndEnter = async function(){
    const cb = $("termsCheck");
    if(!cb || !cb.checked){ alert("Onay kutusunu iÅŸaretle evladÄ±m."); return; }
    const ok = await acceptTerms();
    if(ok) window.enterApp();
    else alert("Onay kaydedilemedi evladÄ±m.");
  };

  // App giriÅŸ (SAFE)
  window.enterApp = function () {
    $("loginOverlay")?.classList.remove('active');
    window.hideTermsOverlay?.();

    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const profile = getProfileMeta();
    const who = getCaynanaWho(user, profile);
    const bot = profile?.bot_name || user?.bot_name || user?.botName || "Caynana";

    setTimeout(() => {
      window.typeWriter?.(`HoÅŸ geldin ${who}. Ben ${bot}.`);
    }, 400);

    refreshNotifications();
  };

  // Camera toggle (SAFE)
  window.toggleCam = function() {
    const frame = $("mobileFrame");
    const camBtn = $("camBtn");
    if(!frame || !camBtn) return;

    if(frame.classList.contains('tracking-active')) {
      frame.classList.remove('tracking-active');
      camBtn.classList.remove('active');
      isTracking = false;
    } else {
      frame.classList.add('tracking-active');
      camBtn.classList.add('active');
      isTracking = true;
      wakeUp();
    }
  };

  window.startDictation = function() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) { alert("Ses desteÄŸi yok evladÄ±m."); return; }
    const recognition = new SpeechRecognition();
    recognition.lang = "tr-TR";
    recognition.start();
    recognition.onresult = function(e) {
      const inputEl = $("msgInput");
      if(inputEl) inputEl.value = e.results[0][0].transcript;
      recognition.stop();
      sendMessage();
    };
  };

  async function playVoice(text) {
    try {
      const res = await fetch(`${BASE_DOMAIN}/api/speech`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      if(data.audio_data) {
        const audio = new Audio("data:audio/mp3;base64," + data.audio_data);
        audio.play();
      }
    } catch(e) { console.error("Ses hatasÄ±:", e); }
  }

  // Typewriter (SAFE)
  window.typeWriter = function(text, elementId = 'chat') {
    const chatDiv = $(elementId);
    if(!chatDiv) return;
    const brandWrapper = $("brandWrapper");
    brandWrapper?.classList.add('talking');

    const bubbleRow = document.createElement("div");
    bubbleRow.className = "bubble bot";
    chatDiv.appendChild(bubbleRow);

    let i = 0; const speed = 20;
    function type() {
      if (i < text.length) {
        bubbleRow.textContent += text.charAt(i);
        i++;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        setTimeout(type, speed);
      } else {
        brandWrapper?.classList.remove('talking');
      }
    }
    type();
  };

  // Chat history
  let chatHistory = [];

  async function sendMessage() {
    const inputEl = $("msgInput");
    if(!inputEl) return;
    const txt = inputEl.value.trim();
    if(!txt) return;

    addUserBubble(txt);
    inputEl.value = '';
    inputEl.blur();

    chatHistory.push({ role: "user", content: txt });
    if(chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

    const brandWrapper = $("brandWrapper");
    brandWrapper?.classList.add('thinking');

    try {
      const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      const response = await fetch(`${BASE_DOMAIN}/api/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          text: txt,
          user_id: user.id || "guest",
          history: chatHistory
        })
      });

      const data = await response.json();
      brandWrapper?.classList.remove('thinking');

      if(data && data.text) {
        window.typeWriter?.(data.text);
        chatHistory.push({ role: "assistant", content: data.text });
        await playVoice(data.text);
      }
    } catch(e) {
      console.error("Chat Error:", e);
      brandWrapper?.classList.remove('thinking');
      window.typeWriter?.("EvladÄ±m tansiyonum dÃ¼ÅŸtÃ¼, internetine bir bakÄ±ver.");
    }
  }

  // ------------------------------
  // ONLOAD: IMPORTANT ORDER
  // ------------------------------
  window.onload = async function() {
    // auth init
    try { if(typeof initAuth === 'function') initAuth(); } catch(e){ console.log(e); }

    // partials first
    try { await initPartials(); } catch(e) { console.log("Partials yÃ¼klenemedi:", e); }

    // notif init (mount/partial sonrasÄ±)
    try { initNotif({ baseUrl: BASE_DOMAIN }); } catch(e) { console.log("Notif init hatasÄ±:", e); }

    // bind menu now (after partial)
    const menuOverlay = $("menuOverlay");
    const hambBtn = $("hambBtn");
    window.toggleMenu = function() {
      if(!menuOverlay) return;
      menuOverlay.classList.toggle('open');
    };
    hambBtn?.addEventListener('click', () => window.toggleMenu());
    menuOverlay?.addEventListener('click', (e) => { if(e.target === menuOverlay) window.toggleMenu(); });

    // send listeners
    $("sendBtn")?.addEventListener('click', sendMessage);
    $("msgInput")?.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    // tracking buttons
    $("openTrackBtn")?.addEventListener('click', ()=>{ isTracking=true; $("mobileFrame")?.classList.add('tracking-active'); wakeUp(); });
    $("closeTrackBtn")?.addEventListener('click', ()=>{ isTracking=false; $("mobileFrame")?.classList.remove('tracking-active'); });

    // gaze listener (after DOM)
    const frame = $("mobileFrame");
    if(frame) {
      window.addEventListener('pointermove', (e) => {
        if(!isTracking || frame.classList.contains('sleeping')) { if(frame.classList.contains('sleeping')) wakeUp(); }
        resetIdle(); isMouseActive = true; clearTimeout(gazeTimer);

        const rect = frame.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
        setGaze(x, y);

        gazeTimer = setTimeout(() => { isMouseActive = false; centerEyes(); }, GAZE_DELAY);
      });
    }

    // session check
    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if(user && user.isSessionActive && user.email) {
      if(!user.terms_accepted_at) window.showTermsOverlay?.();
      else window.enterApp?.();
    }

    // idle + autolook
    setInterval(autoLookBehavior, AUTO_LOOK_FREQ);
    resetIdle();

    // notif refresh periodic (safe)
    refreshNotifications();
    setInterval(refreshNotifications, 60000);

    // google button binding
    const googleBtn = $("googleLoginBtn") || document.querySelector('.google-login-btn');
    if (googleBtn) {
      googleBtn.addEventListener('click', function(e) {
        e.preventDefault();
        handleLogin('google');
      });
    }
  };
</script>
