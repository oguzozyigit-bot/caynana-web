<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f18" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ --primary:#FFB300; --font:'Outfit',sans-serif; } /* Sohbet rengi varsayƒ±lan oldu */
  *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; width: 100%; }

  body{
    font-family:var(--font);
    background:#050505; /* Masa√ºst√º arka planƒ± simsiyah */
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden; /* Masa√ºst√ºnde sayfa kaymasƒ±nƒ± engeller */
  }

  /* WEB: telefon √ßer√ßevesi (Ortalanmƒ±≈ü ve sƒ±nƒ±rlandƒ±rƒ±lmƒ±≈ü) */
  #app{
    width:100%;
    height:100%;
    /* Masa√ºst√º boyutlandƒ±rmasƒ± */
    max-width:440px; 
    max-height:880px;
    border-radius:24px; /* K√∂≈üeleri yuvarladƒ±k */
    overflow:hidden;
    position:relative;
    display:flex;
    flex-direction:column;
    
    /* Telefon hissi veren g√∂lge */
    box-shadow: 0 0 0 10px #1a1a1a, 0 20px 50px rgba(0,0,0,0.8); 
    background:#0b0f18;
    
    background-position:center;
    background-size:cover;
    background-repeat:no-repeat;
    transition:background-image .25s ease;
  }

  /* MOBƒ∞L: Full Ekran (Kenarlƒ±k yok) */
  @media (max-width:500px){
    body{ background:#000; }
    #app{
      width:100vw; height:100vh;
      max-width:none; max-height:none;
      border-radius:0;
      box-shadow:none;
    }
  }

  /* Overlay */
  #app::before{
    content:"";
    position:absolute; inset:0;
    background:linear-gradient(to bottom,
      rgba(0,0,0,.60) 0%,
      rgba(0,0,0,.30) 25%,
      rgba(0,0,0,.10) 50%,
      rgba(0,0,0,0) 70%
    );
    pointer-events:none;
    z-index:1;
  }

  /* HEADER */
  #topbar{
    position:relative; z-index:10;
    height:70px;
    padding:12px 18px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .brand-wrap{ display:flex; flex-direction:column; gap:2px; cursor: pointer; }
  .brand{
    display:flex; align-items:center; gap:8px;
    font-size:20px; font-weight:900; letter-spacing:-.5px;
    color:#fff;
  }
  .brand i{ color:var(--primary); font-size:18px; }
  .brand span{ color:var(--primary); }
  .brand-sub{ font-size:10px; font-weight:700; color:rgba(255,255,255,.7); letter-spacing: 0.5px; }
  
  .menu-btn{
    width:40px; height:40px;
    border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.1);
    color:#fff; cursor:pointer;
  }

  /* HERO AREA */
  #main{
    position:relative; z-index:8;
    flex:1;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    padding:0 18px 240px 18px; /* Alt bo≈üluk arttƒ±rƒ±ldƒ± */
    display:flex; flex-direction:column;
  }

  #heroContent{
    margin-top:40px;
    text-align:left;
    max-width:90%;
  }
  #heroTitle{
    font-size:32px;
    font-weight:900;
    line-height:1.1;
    color:#fff;
    letter-spacing:-1px;
    text-shadow:0 10px 30px rgba(0,0,0,.5);
  }
  #heroDesc{
    margin-top:10px;
    font-size:15px;
    font-weight:600;
    color:rgba(255,255,255,.9);
    line-height:1.4;
    text-shadow:0 5px 15px rgba(0,0,0,.4);
  }

  /* CHAT */
  #chatContainer{ display:none; margin-top:10px; padding-bottom: 20px; }
  .msg{ display:flex; margin-bottom:12px; }
  .msg.user{ justify-content:flex-end; }
  .msg.ai{ justify-content:flex-start; }
  .bubble{
    max-width:85%;
    padding:12px 16px;
    border-radius:18px;
    font-size:15px;
    line-height:1.5;
    font-weight:600;
    position: relative;
  }
  .msg.user .bubble{
    background:var(--primary);
    color:#fff;
    border-bottom-right-radius:4px;
    box-shadow:0 5px 15px rgba(0,0,0,.15);
  }
  .msg.ai .bubble{
    background:#fff;
    color:#111;
    border-bottom-left-radius:4px;
    box-shadow:0 5px 15px rgba(0,0,0,.1);
  }
  
  /* TTS Button */
  .audio-btn{
    margin-top:8px;
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 12px;
    border-radius:20px;
    background:#f0f0f0; color:#333;
    font-size:11px; font-weight:800;
    cursor:pointer;
  }
  .audio-btn.playing{ background:#ffebee; color:#d32f2f; }

  /* CARDS (Shopping) */
  .cards{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
  .card{
    background:#fff; border-radius:12px; padding:8px;
    display:flex; flex-direction:column;
    box-shadow:0 5px 15px rgba(0,0,0,.08);
    position:relative; overflow:hidden;
  }
  .card-badge{
    position:absolute; top:8px; left:0;
    padding:3px 8px; font-size:9px; font-weight:800;
    color:#fff; border-radius:0 8px 8px 0; z-index:2;
  }
  .card-badge.gold{ background:#FFA000; }
  .card-badge.silver{ background:#9E9E9E; }
  .pimg{ width:100%; height:100px; object-fit:contain; margin-bottom:5px; }
  .title{ font-size:12px; font-weight:800; height:32px; overflow:hidden; margin-bottom:4px; color:#222; }
  .price{ font-size:14px; font-weight:900; color:var(--primary); }
  .btnLink{
    margin-top:6px; padding:6px; text-align:center;
    font-size:11px; font-weight:800; color:#fff;
    background:var(--primary); border-radius:6px; text-decoration:none;
  }

  /* BOTTOM AREA */
  #bottom{
    position:absolute; bottom:0; left:0; right:0;
    z-index:20;
    background:rgba(255,255,255,.95);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    border-top-left-radius: 24px;
    border-top-right-radius: 24px;
    padding:15px 18px 25px 18px; /* Alt padding g√ºvenli alan i√ßin */
    box-shadow:0 -10px 40px rgba(0,0,0,.15);
  }

  #suggestionText{
    position: absolute; top:-45px; left:50%; transform:translateX(-50%);
    background:#fff; color:var(--primary);
    padding:8px 16px; border-radius:20px;
    font-size:12px; font-weight:800;
    box-shadow:0 5px 20px rgba(0,0,0,.15);
    white-space:nowrap; z-index:5;
    opacity:0.95;
    transition: all 0.3s ease;
  }

  /* SEARCH BAR & SEND BTN FIX */
  .input-wrapper{
    display:flex; align-items:center; gap:8px;
    width:100%;
  }
  .search-bar{
    flex:1; /* Kalan alanƒ± doldur */
    height:50px;
    background:#f4f4f4;
    border-radius:25px;
    display:flex; align-items:center;
    padding:0 5px 0 15px; /* Sol padding yazƒ± i√ßin, saƒü padding butonlar i√ßin */
    border:1px solid transparent;
    transition:0.3s;
    min-width: 0; /* Flexbox i√ßinde ta≈ümayƒ± √∂nler */
  }
  .search-bar:focus-within{ background:#fff; border-color:var(--primary); box-shadow:0 5px 15px rgba(0,0,0,.05); }
  
  #text{
    flex:1; border:none; background:transparent;
    font-size:15px; color:#333; outline:none;
    min-width: 0; /* Inputun k√º√ß√ºlmesine izin ver */
  }
  
  .tool-btn{
    padding:8px; color:#999; font-size:18px; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  .tool-btn:active{ color:var(--primary); }

  #sendBtn{
    width:50px; height:50px;
    border-radius:50%; border:none;
    background:var(--primary); color:#fff;
    font-size:20px;
    flex-shrink: 0; /* Butonun asla k√º√ß√ºlmemesini saƒülar */
    display:flex; align-items:center; justify-content:center;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.2);
  }
  #sendBtn:active{ transform:scale(0.95); }

  /* DOCK (Modes) */
  #dock{
    display:flex; gap:20px; overflow-x:auto;
    padding:15px 5px 10px 5px;
    scrollbar-width:none;
  }
  #dock::-webkit-scrollbar{ display:none; }
  
  .dock-item{
    display:flex; flex-direction:column; align-items:center; gap:6px;
    opacity:0.5; transition:0.3s; cursor:pointer; min-width:55px;
  }
  .dock-item.active{ opacity:1; transform:translateY(-3px); }
  
  .icon-box{
    width:42px; height:42px; border-radius:14px;
    background:#eee; color:#666;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; transition:0.3s;
  }
  .dock-item.active .icon-box{
    background:var(--primary); color:#fff;
    box-shadow:0 5px 15px rgba(0,0,0,.2);
  }
  .dock-label{ font-size:10px; font-weight:800; color:#444; }

  /* NEW FOOTER (Ozyigits Style) */
  .brand-footer{
    margin-top:5px;
    text-align:center;
    display:flex; flex-direction:column; align-items:center; gap:6px;
  }
  .footer-text{
    font-size:12px; font-weight:800; color:#333; letter-spacing:0.5px;
  }
  .footer-text span{ font-weight:400; color:#888; }
  
  .oz-lines{
    display:flex; gap:4px; height:4px;
  }
  .oz-lines span{ height:100%; border-radius:2px; }
  .oz-l-black{ width:30px; background:#222; }
  .oz-l-gray{ width:12px; background:#aaa; }
  .oz-l-red{ width:12px; background:#D32F2F; }

  /* DRAWER */
  #drawerMask{ position:absolute; inset:0; background:rgba(0,0,0,.6); z-index:50; display:none; }
  #drawer{
    position:absolute; top:0; right:0; height:100%; width:280px;
    background:#fff; z-index:60; padding:20px;
    transform:translateX(100%); transition:0.3s;
  }
  #drawer.open{ transform:translateX(0); }
  #drawerMask.show{ display:block; }

  #fileInput{ display:none; }
  .mic-active{ color:#D32F2F !important; animation:pulse 1s infinite; }
  @keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
</style>
</head>

<body>
<div id="app">

  <div id="drawerMask"></div>
  <div id="drawer">
    <h3 style="margin-bottom:20px;">Men√º</h3>
    <div style="padding:10px 0; border-bottom:1px solid #eee;">Hesap</div>
    <div style="padding:10px 0; border-bottom:1px solid #eee;">Ayarlar</div>
  </div>

  <div id="topbar">
    <div class="brand-wrap" onclick="switchMode('chat')">
      <div class="brand"><i class="fa-solid fa-wand-magic-sparkles"></i>CAYNANA<span>.AI</span></div>
      <div class="brand-sub">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div class="menu-btn" id="menuBtn"><i class="fa-solid fa-bars"></i></div>
  </div>

  <div id="main">
    <div id="heroContent">
      <div id="heroTitle"></div>
      <div id="heroDesc"></div>
    </div>
    <div id="chatContainer"></div>
  </div>

  <div id="bottom">
    <div id="suggestionText"></div>

    <div class="input-wrapper">
      <div class="search-bar">
        <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <input id="text" placeholder="Bir ≈üey yaz..." autocomplete="off" onkeypress="if(event.key==='Enter') send()">
        <div class="tool-btn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div id="dock"></div>

    <div class="brand-footer">
      <div class="footer-text">CAYNANA <span>by Ozyigits</span> 2026</div>
      <div class="oz-lines">
        <span class="oz-l-black"></span>
        <span class="oz-l-gray"></span>
        <span class="oz-l-red"></span>
        <span class="oz-l-black"></span>
      </div>
    </div>
  </div>

</div>

<input type="file" id="fileInput" accept="image/*" capture="environment" />

<script>
  // ===== API CONFIG (Render) =====
  const BASE_DOMAIN = "https://bikonomi-api-2.onrender.com";
  const API_URL = `${BASE_DOMAIN}/api/chat`;
  const SPEAK_URL = `${BASE_DOMAIN}/api/speak`;

  let sessionId = "sess_" + Math.random().toString(36).slice(2,10);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "chat"; // Varsayƒ±lan SOHBET
  let isSending = false;
  const chatHistory = {};

  marked.setOptions({ mangle:false, headerIds:false });

  // Asset Path Fix
  function basePath(){
    const p = location.pathname;
    return p.endsWith("/") ? p : p.substring(0, p.lastIndexOf("/") + 1);
  }
  function asset(rel){ return basePath() + rel.replace(/^\/+/, ""); }

  // ===== MODES =====
  const MODES = {
    chat:{ label:"Sohbet", icon:"fa-comments", color:"#FFB300",
      title:"Caynana ile<br>iki lafƒ±n belini kƒ±r.", desc:"Biraz dur bakalƒ±m, neler anlatacaksƒ±n?",
      img: asset("images/hero-chat.png"),
      ph:"Naber Caynana?", sugg:"Benim zamanƒ±mda her ≈üey daha g√ºzeldi ah ah‚Ä¶",
      pos:"55% 15%"
    },
    shopping:{ label:"Alƒ±≈üveri≈ü", icon:"fa-bag-shopping", color:"#00C897",
      title:"Almadan √∂nce<br>Caynana‚Äôya sor.", desc:"Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.",
      img: asset("images/hero-shopping.png"),
      ph:"Ne arƒ±yorsun evladƒ±m?", sugg:"Her indirime atlayan sonunda pahalƒ± √∂der.",
      pos:"50% 18%"
    },
    fal:{ label:"Fal", icon:"fa-mug-hot", color:"#8B5CF6",
      title:"Kahveni i√ßtin mi?<br>Gel falƒ±na bakayƒ±m.", desc:"Fal eƒülencedir evladƒ±m, ama bazen tutar.",
      img: asset("images/hero-fal.png"),
      ph:"Fincanƒ± √ßektin mi?", sugg:"Kapat fincanƒ±, fotoƒürafƒ±nƒ± √ßek g√∂nder.",
      pos:"55% 12%"
    },
    health:{ label:"Saƒülƒ±k", icon:"fa-heart-pulse", color:"#EF4444",
      title:"Caynana Saƒülƒ±k'la<br>turp gibi ol.", desc:"Neren aƒürƒ±yor s√∂yle bakayƒ±m?",
      img: asset("images/hero-health.png"),
      ph:"≈ûikayetin ne?", sugg:"√áay √ºst√ºne sakƒ±n soƒüuk su i√ßme!",
      pos:"55% 12%"
    },
    diet:{ label:"Diyet", icon:"fa-carrot", color:"#84CC16",
      title:"Saƒülƒ±klƒ± beslen<br>zinde kal!", desc:"A√ßlƒ±ktan deƒüil, keyiften yiyin.",
      img: asset("images/hero-diet.png"),
      ph:"Boy kilo ka√ß?", sugg:"Ekmek deƒüil, ye≈üillik ye.",
      pos:"55% 12%"
    },
    food:{ label:"Yemek", icon:"fa-utensils", color:"#F97316",
      title:"Bug√ºn ne<br>pi≈üirsem derdi biter.", desc:"Dolapta ne var s√∂yle, tarif benden.",
      img: asset("images/hero-food.png"),
      ph:"Dolapta ne var?", sugg:"Malzemeyi ziyan etme, bereket ka√ßar.",
      pos:"55% 12%"
    },
    law:{ label:"Hukuk", icon:"fa-scale-balanced", color:"#3B82F6",
      title:"Hukuk i≈üleri<br>≈üakaya gelmez.", desc:"Ben avukat deƒüilim ama √ßok dava g√∂rd√ºm.",
      img: asset("images/hero-law.png"),
      ph:"Derdini anlat.", sugg:"S√∂zle≈ümeye bakmadan imza atma!",
      pos:"55% 12%"
    },
    astro:{ label:"Bur√ß", icon:"fa-star", color:"#D946EF",
      title:"Yƒ±ldƒ±zlar senin i√ßin<br>ne diyor?", desc:"Merk√ºr retrosu falan‚Ä¶ dikkat et.",
      img: asset("images/hero-astro.png"),
      ph:"Burcun ne?", sugg:"Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k.",
      pos:"55% 12%"
    },
    translate:{ label:"√áeviri", icon:"fa-language", color:"#64748B",
      title:"√áeviri lazƒ±m mƒ±?<br>S√∂yle √ßevireyim.", desc:"Metni yapƒ±≈ütƒ±r veya fotoƒürafƒ±nƒ± √ßek.",
      img: asset("images/hero-translate.png"),
      ph:"Metni yaz.", sugg:"Bir lisan bir insan, iki lisan iki insan.",
      pos:"55% 12%"
    },
    dream:{ label:"R√ºya", icon:"fa-cloud-moon", color:"#6366F1",
      title:"R√ºyalar alemine<br>ho≈ü geldin.", desc:"Hayƒ±rdƒ±r in≈üallah‚Ä¶",
      img: asset("images/hero-dream.png"),
      ph:"Ne g√∂rd√ºn?", sugg:"R√ºyalar tersine √ßƒ±kar derler ama‚Ä¶",
      pos:"55% 12%"
    }
  };

  // ===== UI LOGIC =====
  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key=>{
      const m = MODES[key];
      const div = document.createElement("div");
      div.className = "dock-item " + (key===currentMode ? "active":"");
      div.onclick = ()=> switchMode(key);
      div.innerHTML = `
        <div class="icon-box"><i class="fa-solid ${m.icon}"></i></div>
        <div class="dock-label">${m.label}</div>
      `;
      dock.appendChild(div);
    });
  }

  function setBackground(mode){
    const app = document.getElementById("app");
    const bust = `${mode.img}?v=${Date.now()}`;
    const img = new Image();
    img.onload = ()=>{ 
      app.style.backgroundImage = `url("${bust}")`; 
      app.style.backgroundPosition = mode.pos || "center";
    };
    img.src = bust;
  }

  function switchMode(newMode){
    const chat = document.getElementById("chatContainer");
    chatHistory[currentMode] = chat.innerHTML; // Kaydet

    currentMode = newMode;
    const m = MODES[newMode];

    document.documentElement.style.setProperty("--primary", m.color);
    setBackground(m);

    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerText = m.desc;
    document.getElementById("suggestionText").innerText = m.sugg;
    document.getElementById("text").placeholder = m.ph;
    
    // Ge√ßmi≈üi y√ºkle
    chat.innerHTML = chatHistory[newMode] || "";
    
    const hasContent = chat.innerHTML.trim().length > 0;
    document.getElementById("heroContent").style.display = hasContent ? "none" : "block";
    chat.style.display = hasContent ? "block" : "none";

    renderDock();
  }

  // ===== Helpers =====
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
  
  function renderCards(list){
    const wrap = document.createElement("div");
    wrap.className="cards";
    (list||[]).forEach((p, idx)=>{
      const badge = (idx===0) ? {k:"gold",t:"ALTIN"} : (idx===1) ? {k:"silver",t:"G√úM√ú≈û"} : null;
      const bHtml = badge ? `<div class="card-badge ${badge.k}">${badge.t}</div>` : "";
      
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML = `
        ${bHtml}
        <img class="pimg" src="${p.image||''}" onerror="this.src='https://via.placeholder.com/150'">
        <div class="title">${escapeHtml(p.title)}</div>
        <div class="price">${escapeHtml(p.price)}</div>
        <a class="btnLink" href="${p.url}" target="_blank">ƒ∞NCELE</a>
      `;
      wrap.appendChild(div);
    });
    document.getElementById("chatContainer").appendChild(wrap);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  function addBubble(role, text, isLoader=false, speech=null, imgData=null, id=null){
    const div = document.createElement("div");
    div.className = "msg " + role;
    if(id) div.id = id;

    let content = "";
    if(imgData) content += `<img src="${imgData}" style="max-width:100%; border-radius:12px; margin-bottom:8px;">`;
    
    let htmlContent = text;
    if(role==="ai" && !isLoader){
      htmlContent = DOMPurify.sanitize(marked.parse(text));
    } else if(role==="user"){
      htmlContent = escapeHtml(text);
    }

    div.innerHTML = `<div class="bubble">${content + htmlContent}</div>`;
    
    if(speech && role==="ai"){
      const btn = document.createElement("div");
      btn.className="audio-btn";
      btn.setAttribute("data-speech", speech);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Dinle`;
      div.querySelector(".bubble").appendChild(btn);
    }

    document.getElementById("chatContainer").appendChild(div);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  // ===== Actions =====
  async function send(){
    if(isSending) return;
    const input = document.getElementById("text");
    let val = input.value.trim();

    if(pendingImage && val==="") val = "Bu resmi yorumla";
    if(!val && !pendingImage) return;

    if(currentMode==="shopping") document.querySelectorAll(".cards").forEach(e=>e.remove());

    isSending = true;
    document.getElementById("sendBtn").disabled = true;
    document.getElementById("heroContent").style.display="none";
    document.getElementById("chatContainer").style.display="block";

    addBubble("user", val, false, null, pendingImage);
    input.value = "";
    
    const loaderId = "ldr"+Date.now();
    addBubble("ai", "<i class='fa-solid fa-spinner fa-spin'></i>", true, null, null, loaderId);

    const payload = { message: val, session_id: sessionId, image: pendingImage, mode: currentMode };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
      const data = await res.json();
      document.getElementById(loaderId)?.remove();
      
      addBubble("ai", data.assistant_text, false, data.speech_text);
      if(data.data && data.data.length) renderCards(data.data);

    } catch(e){
      document.getElementById(loaderId).innerHTML = "Baƒülantƒ± hatasƒ±.";
    } finally{
      isSending = false;
      document.getElementById("sendBtn").disabled = false;
    }
  }

  // Audio Play
  async function playAudio(text, btn){
    if(currentAudio){ currentAudio.pause(); currentAudio=null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove("playing"); b.innerHTML=`<i class="fa-solid fa-volume-high"></i> Dinle`;
    });

    const oldHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
    
    try{
      const r = await fetch(SPEAK_URL, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})});
      const blob = await r.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = ()=>{
        btn.classList.remove("playing");
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Dinle`;
      };
      await currentAudio.play();
      btn.classList.add("playing");
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Durdur`;
    } catch(e){
      btn.innerHTML = oldHtml;
    }
  }

  document.getElementById("chatContainer").addEventListener("click", e=>{
    const btn = e.target.closest(".audio-btn");
    if(btn) playAudio(btn.getAttribute("data-speech"), btn);
  });

  // Tools
  const fileEl = document.getElementById("fileInput");
  function openCamera(){ fileEl.value=""; fileEl.click(); }
  fileEl.addEventListener("change", e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload=()=>{ pendingImage=r.result; document.getElementById("text").value="üì∑ Resim eklendi"; };
    r.readAsDataURL(f);
  });

  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Tarayƒ±cƒ± desteklemiyor");
    const r = new SR(); r.lang="tr-TR";
    const mic = document.getElementById("micBtn");
    mic.classList.add("mic-active");
    r.onresult = e=>{ document.getElementById("text").value = e.results[0][0].transcript; mic.classList.remove("mic-active"); send(); };
    r.onend = ()=> mic.classList.remove("mic-active");
    r.start();
  }

  // Drawer
  const mask=document.getElementById("drawerMask"), drawer=document.getElementById("drawer");
  document.getElementById("menuBtn").onclick=()=>{ mask.classList.add("show"); drawer.classList.add("open"); };
  mask.onclick=()=>{ mask.classList.remove("show"); drawer.classList.remove("open"); };

  // Init
  renderDock();
  switchMode("chat"); // Ba≈ülangƒ±√ß Modu: SOHBET
</script>
</body>
</html>
