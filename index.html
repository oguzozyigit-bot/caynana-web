<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#FFFFFF">
<title>CAYNANA.AI</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ 
    --primary: #00C897; 
    --primary-dark: #00A87E;
    --primary-soft: rgba(0, 200, 151, 0.12);
    --accent: #FFB300;
    
    --bg-app: #FFFFFF;
    --bg-secondary: #F8F9FA;
    
    --text-main: #1A1A1A;
    --text-muted: #666666;
    
    --font-main: 'Outfit', sans-serif;
    --border-light: #F0F0F0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
  
  body { 
    font-family: var(--font-main); 
    background: var(--bg-app); 
    height: 100dvh; display: flex; justify-content: center; 
    color: var(--text-main); 
    overscroll-behavior: none;
  }
  
  #app { 
    width: 100%; max-width: 480px; height: 100%; 
    background: var(--bg-app); 
    position: relative; display: flex; flex-direction: column; 
  }

  /* --- HEADER --- */
  #topbar {
    height: 68px; display: flex; align-items: center; justify-content: space-between; 
    padding: 0 24px; 
    background: rgba(255,255,255,0.8); /* Daha ≈üeffaf */
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    z-index: 20; border-bottom: 1px solid rgba(0,0,0,0.05);
    position: absolute; top: 0; left: 0; right: 0;
  }
  .brand { 
    font-weight: 800; color: var(--text-main); font-size: 24px; 
    display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; cursor: pointer;
  } 
  .brand i { color: var(--primary); font-size: 22px; transition: color 0.3s; } 
  .brand span { color: var(--primary); }
  .menu-btn { 
    font-size: 22px; color: var(--text-main); cursor: pointer; 
    width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
    border-radius: 12px; background: rgba(255,255,255,0.5); transition: all 0.2s;
  }

  /* --- MAIN AREA --- */
  #main { 
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding: 0; /* Hero tam ekran olsun diye padding sƒ±fƒ±rlandƒ± */
    scroll-behavior: smooth; display: flex; flex-direction: column;
    background: var(--bg-app);
  }

  /* ================================
     FULLSCREEN HERO (SAHNE MODU)
  ================================ */
  .hero-section {
    position: relative;
    /* Ekran boyundan alt ve √ºst paylarƒ± √ßƒ±karƒ±yoruz */
    height: calc(100dvh - 180px); 
    min-height: 500px;
    width: 100%;
    overflow: hidden;

    /* Arka plan ayarlarƒ± */
    background-repeat: no-repeat;
    background-position: center bottom; /* Karakter a≈üaƒüƒ±da */
    background-size: contain; /* Resmi kesmeden sƒ±ƒüdƒ±r */
    /* Mobilde 'cover' bazen kafayƒ± kesebilir, 'contain' veya 'cover' g√∂rselin tipine g√∂re deƒüi≈üir. 
       Eƒüer resimlerin tam ekran dikeyse 'cover', deƒüilse 'contain' + background-color kullanabiliriz.
       ≈ûimdilik senin isteƒüin √ºzerine 'cover' yapƒ±yoruz. */
    background-size: cover; 

    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* Yazƒ±lar √ºstte */
    padding: 100px 24px 0 24px; /* Header altƒ±ndan ba≈ülasƒ±n */
    transition: background-image 0.4s ease-in-out;
  }

  /* √úst Fade Efekti (Yazƒ± Okunurluƒüu ƒ∞√ßin) */
  .hero-section::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(255,255,255, 1) 0%,
      rgba(255,255,255, 0.8) 25%,
      rgba(255,255,255, 0.2) 50%,
      rgba(255,255,255, 0) 100%
    );
    pointer-events: none;
    z-index: 0;
  }

  .hero-title { 
    position: relative; z-index: 1;
    font-size: 34px; font-weight: 800; color: var(--text-main); 
    line-height: 1.1; margin-bottom: 12px; letter-spacing: -1px;
    text-shadow: 0 10px 30px rgba(255,255,255,0.8);
  }
  .hero-desc { 
    position: relative; z-index: 1;
    font-size: 16px; color: var(--text-muted); font-weight: 600; 
    line-height: 1.5; text-shadow: 0 5px 20px rgba(255,255,255,0.8);
    max-width: 80%;
  }

  /* --- SOHBET ALANI --- */
  .msg-container { 
    margin-top: 80px; width: 100%; padding: 0 20px 240px 20px; 
  }
  .msg { display: flex; margin-bottom: 20px; animation: fadeInUp 0.4s ease; }
  .msg.user { justify-content: flex-end; } .msg.ai { justify-content: flex-start; }
  
  .bubble { 
    max-width: 88%; padding: 16px 20px; border-radius: 22px; 
    font-size: 15px; line-height: 1.6; position: relative; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    word-wrap: break-word; font-weight: 500;
  }
  .msg.user .bubble { 
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: #fff; border-bottom-right-radius: 6px; 
    box-shadow: 0 8px 20px -5px rgba(0, 200, 151, 0.4);
  }
  .msg.ai .bubble { 
    background: var(--bg-secondary); 
    color: var(--text-main); border-bottom-left-radius: 6px; 
    border: 1px solid var(--border-light);
  }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* Markdown Tablo */
  .bubble table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 10px 0; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-light); }
  .bubble th { background: var(--bg-secondary); padding: 12px; text-align: left; font-weight: 700; color: var(--text-main); }
  .bubble td { padding: 12px; border-top: 1px solid var(--border-light); color: var(--text-muted); }

  /* Ses Butonu */
  .audio-btn {
    margin-top: 12px; display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 18px; background: #fff; border: 1px solid var(--border-light);
    border-radius: 24px; font-size: 13px; font-weight: 700; color: var(--primary);
    cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
  }
  .audio-btn.playing { background: #FEF2F2; color: #EF4444; border-color: #FCA5A5; }

  /* --- KART TASARIMI --- */
  .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 100%; margin-top: 20px; }
  .card { 
    background: #fff; border: 1px solid var(--border-light); 
    border-radius: 20px; padding: 14px; 
    display: flex; flex-direction: column; position: relative; overflow: hidden; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
  }
  
  .card-badge {
    position: absolute; top: 14px; left: 0; padding: 5px 12px; font-size: 10px; 
    font-weight: 800; border-top-right-radius: 12px; border-bottom-right-radius: 12px; 
    text-transform: uppercase; z-index: 2; letter-spacing: 0.5px;
  }
  .card-badge.gold { background: linear-gradient(90deg, #FFB300, #FF8F00); color: #fff; }
  .card-badge.silver { background: linear-gradient(90deg, #9E9E9E, #757575); color: #fff; }
  .card-badge.value { background: linear-gradient(90deg, #00C897, #00A87E); color: #fff; }

  .pimg { width: 100%; height: 130px; object-fit: contain; margin-bottom: 12px; padding: 5px; }
  .title { font-size: 14px; font-weight: 700; height: 40px; overflow: hidden; margin-bottom: 8px; color: var(--text-main); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .price { font-size: 18px; font-weight: 800; color: var(--primary); margin-bottom: 12px; letter-spacing: -0.5px; }
  
  .btnLink { 
    background: var(--primary); color: #fff; padding: 12px; border-radius: 14px; 
    text-align: center; font-size: 13px; text-decoration: none; margin-top: auto; 
    display: flex; align-items: center; justify-content: center; gap: 6px;
    font-weight: 700;
  }
  .btnLink.btn-gold { background: linear-gradient(135deg, #FFB300, #FF8F00); }
  .btnLink.btn-silver { background: linear-gradient(135deg, #9E9E9E, #757575); }
  .btnLink.btn-blue { background: linear-gradient(135deg, #00C897, #00A87E); }

  /* --- BOTTOM AREA --- */
  #bottom { 
    position: absolute; bottom: 0; left: 0; right: 0; 
    background: rgba(255,255,255,0.9); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    z-index: 50; border-top: 1px solid rgba(255,255,255,0.5);
    box-shadow: 0 -10px 40px rgba(0,0,0,0.04);
    padding-bottom: env(safe-area-inset-bottom);
  }

  .suggestion-box {
    background: #fff; color: var(--primary); font-size: 13px; font-weight: 600;
    padding: 12px 24px; border-radius: 99px; margin: -24px auto 15px auto; width: max-content; max-width: 90%;
    text-align: center; border: 1px solid var(--primary-soft); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  }

  .input-wrapper { padding: 10px 24px; display: flex; gap: 14px; align-items: center; }
  .search-bar {
    flex: 1; height: 56px; background: var(--bg-secondary); border: 1px solid var(--border-light);
    border-radius: 28px; display: flex; align-items: center; padding: 0 18px;
    transition: 0.3s;
  }
  .search-bar:focus-within { border-color: var(--primary); background: #fff; box-shadow: 0 4px 20px var(--primary-soft); }
  #text { flex: 1; border: none; background: transparent; font-size: 16px; color: var(--text-main); height: 100%; margin: 0 12px; font-weight: 500; }
  
  #sendBtn {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
    color: #fff; border: none;
    width: 56px; height: 56px; border-radius: 50%; cursor: pointer; 
    display: flex; align-items: center; justify-content: center; font-size: 20px;
    box-shadow: 0 8px 20px var(--primary-soft);
    transition: 0.3s;
  }
  #sendBtn:disabled { background: #E0E0E0; opacity: 0.8; }

  /* Dock (Men√º) */
  .dock-container {
    padding: 15px 24px; 
    overflow-x: auto; display: flex; gap: 20px; 
    scrollbar-width: none;
  }
  .dock-container::-webkit-scrollbar { display: none; }

  .dock-item {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    min-width: 64px; cursor: pointer; opacity: 0.6; transition: 0.3s;
  }
  .dock-item.active { opacity: 1; transform: translateY(-2px); }
  
  .dock-icon-box {
    width: 52px; height: 52px; border-radius: 18px;
    background: var(--bg-secondary); display: flex; align-items: center; justify-content: center;
    font-size: 22px; color: var(--text-muted); transition: 0.3s;
  }
  .dock-item.active .dock-icon-box {
    background: var(--primary); color: #fff; 
    box-shadow: 0 10px 20px -5px var(--primary-soft);
  }
  .dock-label { font-size: 11px; font-weight: 700; color: var(--text-main); letter-spacing: 0.3px; }

  .brand-footer { text-align: center; padding: 5px 0 15px 0; background: transparent; opacity: 0.5; }
  .brand-text { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.2px; }
  .it-flag { width: 32px; height: 4px; display: flex; margin: 6px auto 0; border-radius: 4px; overflow: hidden; }
  .it-flag span { flex: 1; height: 100%; } .g{background:#009246} .w{background:#fff;border:1px solid #eee} .r{background:#CE2B37}

  .tool-btn { color: var(--text-muted); font-size: 20px; padding: 8px; cursor: pointer; }
  .tool-btn:hover { color: var(--primary); }
  .mic-active { color: #EF4444 !important; animation: pulseRed 1s infinite; }
  @keyframes pulseRed { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
  #fileInput { display: none; }

</style>
</head>
<body>

<div id="app">
  <div id="topbar">
    <div class="brand" onclick="location.reload()">
      <i class="fa-solid fa-wand-magic-sparkles"></i> CAYNANA<span>.AI</span>
    </div>
    <div class="menu-btn"><i class="fa-solid fa-bars"></i></div>
  </div>

  <div id="main">
    <div id="heroSection" class="hero-section">
      <h1 class="hero-title" id="heroTitle">Almadan √∂nce<br>Caynana‚Äôya sor.</h1>
      <p class="hero-desc" id="heroDesc">Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.</p>
    </div>

    <div id="chatContainer" class="msg-container"></div>
  </div>

  <div id="bottom">
    <div class="suggestion-box" id="suggestionText">
      Her indirime atlayan sonunda pahalƒ± √∂der.
    </div>

    <div class="input-wrapper">
      <div class="search-bar">
        <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <input id="text" placeholder="Ne arƒ±yorsun evladƒ±m?" autocomplete="off" onkeypress="if(event.key==='Enter') send()">
        <div class="tool-btn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div class="dock-container" id="dock"></div>

    <div class="brand-footer">
      <div class="brand-text">@CAYNANA BY ITALKY TECHNOLOGY</div>
      <div class="it-flag"><span class="g"></span><span class="w"></span><span class="r"></span></div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" capture="environment">

<script>
  // --- AYARLAR ---
  const API_URL = "https://bikonomi-api-2.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-2.onrender.com/api/speak";
  
  let sessionId = "sess_" + Math.random().toString(36).substr(2, 9);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "shopping";
  let isSending = false;
  const chatHistory = {};

  marked.setOptions({ mangle: false, headerIds: false });

  // --- CDN Lƒ∞NKLERƒ∞ ---
  const GH_BASE = "https://raw.githubusercontent.com/oguzozyigit-bot/bikonomi-frontend/main/";

  const MODES = {
    shopping: { label: "Alƒ±≈üveri≈ü", icon: "fa-bag-shopping", color: "#00C897", title: "Almadan √∂nce<br>Caynana‚Äôya sor.", desc: "Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.", img: GH_BASE + "mode_shopping.png", ph: "Ne arƒ±yorsun evladƒ±m?", sugg: "Her indirime atlayan sonunda pahalƒ± √∂der." },
    chat: { label: "Sohbet", icon: "fa-comments", color: "#FFB300", title: "Caynana ile<br>iki lafƒ±n belini kƒ±r.", desc: "Biraz dur bakalƒ±m, neler anlatacaksƒ±n?", img: GH_BASE + "mode_chat.png", ph: "Naber Caynana?", sugg: "Benim zamanƒ±mda her ≈üey daha g√ºzeldi ah ah..." },
    fal: { label: "Fal", icon: "fa-mug-hot", color: "#8B5CF6", title: "Kahveni i√ßtin mi?<br>Gel falƒ±na bakayƒ±m.", desc: "Fal eƒülencedir evladƒ±m, ama bazen tutar.", img: GH_BASE + "mode_fal.png", ph: "Fincanƒ± kapattƒ±n mƒ±?", sugg: "Hemen inanma ama kulak da tƒ±ka." },
    health: { label: "Saƒülƒ±k", icon: "fa-heart-pulse", color: "#EF4444", title: "Caynana Saƒülƒ±k'la<br>alƒ±≈ükanlƒ±k kazan.", desc: "Neren aƒürƒ±yor s√∂yle bakayƒ±m?", img: GH_BASE + "mode_health.png", ph: "Neren aƒürƒ±yor?", sugg: "√áay √ºst√ºne sakƒ±n soƒüuk su i√ßme!" },
    diet: { label: "Diyet", icon: "fa-carrot", color: "#84CC16", title: "Caynana Diyet'le<br>saƒülƒ±klƒ± beslen!", desc: "A√ßlƒ±ktan deƒüil, keyiften yiyin.", img: GH_BASE + "mode_diet.png", ph: "Boy kilo ka√ß evladƒ±m?", sugg: "Ekmek deƒüil, ye≈üillik ye ye≈üillik." },
    food: { label: "Yemek", icon: "fa-utensils", color: "#F97316", title: "Caynana Yemek'le<br>en lezzetli tarifler!", desc: "Ne pi≈üirsem evladƒ±m? Ekranƒ± kokutalƒ±m mƒ±?", img: GH_BASE + "mode_food.png", ph: "Dolapta ne var?", sugg: "Malzemeyi ziyan etme, bereket ka√ßar." },
    law: { label: "Hukuk", icon: "fa-scale-balanced", color: "#3B82F6", title: "Caynana Hukuk'la<br>kim haklƒ± √∂ƒüren!", desc: "Ben avukat deƒüilim ama √ßok dava g√∂rd√ºm.", img: GH_BASE + "mode_law.png", ph: "Derdini kƒ±saca anlat.", sugg: "S√∂zle≈ümeye bakmadan imza atma!" },
    dream: { label: "R√ºya", icon: "fa-cloud-moon", color: "#6366F1", title: "R√ºyada yƒ±lan mƒ±?<br>Gel tabir edeyim.", desc: "Hayƒ±rdƒ±r in≈üallah de bakalƒ±m.", img: GH_BASE + "mode_dream.png", ph: "Ne g√∂rd√ºn r√ºyanda?", sugg: "R√ºyalar tersine √ßƒ±kar derler ama..." },
    translate: { label: "√áeviri", icon: "fa-language", color: "#64748B", title: "Uygarlƒ±k destanƒ±<br>ne demek ƒ∞talyanca?", desc: "S√∂yle √ßevireyim evladƒ±m.", img: GH_BASE + "mode_translate.png", ph: "Ne yazƒ±yor orada?", sugg: "Dil bilmek altƒ±n bileziktir." },
    astro: { label: "Bur√ß", icon: "fa-star", color: "#D946EF", title: "Yƒ±ldƒ±zlar senin i√ßin<br>ne diyor?", desc: "Merk√ºr retrosu falan, dikkat et.", img: GH_BASE + "mode_astro.png", ph: "Burcun ne senin?", sugg: "Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k." }
  };

  function renderDock() {
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key => {
      const m = MODES[key];
      const div = document.createElement("div");
      div.className = `dock-item ${key === currentMode ? 'active' : ''}`;
      div.onclick = () => switchMode(key);
      div.innerHTML = `<div class="dock-icon-box"><i class="fa-solid ${m.icon}"></i></div><span class="dock-label">${m.label}</span>`;
      dock.appendChild(div);
    });
  }

  function hexToRgba(hex, alpha) {
    let c;
    if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
        c= hex.substring(1).split('');
        if(c.length== 3){ c= [c[0], c[0], c[1], c[1], c[2], c[2]]; }
        c= '0x'+c.join('');
        return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')';
    }
    return 'rgba(0, 200, 151, 0.12)';
  }

  function switchMode(newMode) {
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
        b.classList.remove("playing");
        b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
    });

    const html = document.getElementById("chatContainer").innerHTML;
    chatHistory[currentMode] = html.length > 60000 ? html.slice(-60000) : html;
    
    currentMode = newMode;
    const m = MODES[newMode];
    
    // Tema Rengi G√ºncelleme
    document.documentElement.style.setProperty('--primary', m.color);
    document.documentElement.style.setProperty('--primary-soft', hexToRgba(m.color, 0.15));
    
    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerText = m.desc;
    document.getElementById("text").placeholder = m.ph;
    document.getElementById("suggestionText").innerText = m.sugg;
    
    // HERO BACKGROUND G√úNCELLE (Sahne Modu)
    document.getElementById("heroSection").style.backgroundImage = `url("${m.img}")`;

    const savedChat = chatHistory[newMode] || "";
    document.getElementById("chatContainer").innerHTML = savedChat;
    
    if (savedChat.trim() !== "") {
        document.getElementById("heroSection").style.display = "none";
        document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
    } else {
        document.getElementById("heroSection").style.display = "flex";
    }
    renderDock();
  }

  function resizeImage(base64Str, maxWidth = 1024) {
    return new Promise((resolve) => {
        let img = new Image();
        img.src = base64Str;
        img.onload = () => {
            let canvas = document.createElement('canvas');
            let width = img.width; 
            let height = img.height; 
            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
            canvas.width = width; canvas.height = height;
            let ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
        };
        img.onerror = () => resolve(base64Str);
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  
  function safeLink(u){
    try{
        const url = new URL(u, location.href); 
        if (url.protocol === "http:" || url.protocol === "https:") return url.toString();
    }catch(e){}
    return "";
  }

  function safeImg(u){
    try{
        const url = new URL(u, location.href);
        if (url.protocol === "http:" || url.protocol === "https:") return url.toString();
    } catch(e){}
    return "https://via.placeholder.com/150?text=Resim+Yok";
  }

  async function send() {
    if (isSending) return; 
    
    const txtEl = document.getElementById("text");
    let val = txtEl.value.trim();
    
    if (pendingImage && val === "") {
        if(currentMode === 'fal') val = "Bu fotoƒüraftaki fala bak";
        else if(currentMode === 'translate') val = "Bunu √ßevir";
        else val = "Buna bak evladƒ±m";
    }

    if (!val && !pendingImage) return;

    if (currentMode === "shopping" && (val || pendingImage)) {
        document.querySelectorAll("#chatContainer .cards").forEach(el => el.remove());
    }

    isSending = true; 
    document.getElementById("sendBtn").disabled = true;
    document.getElementById("sendBtn").style.opacity = "0.7";

    document.getElementById("heroSection").style.display = "none";
    addBubble("user", val, false, null, pendingImage);
    txtEl.value = "";
    
    const loaderId = "loader_" + Date.now();
    addBubble("ai", "<i class='fa-solid fa-circle-notch fa-spin'></i> Bakƒ±yorum...", true, null, null, loaderId);
    
    let finalImage = pendingImage;
    if(finalImage && finalImage.length > 250000) { try { finalImage = await resizeImage(finalImage); } catch(e){} }

    const payload = { message: val, session_id: sessionId, image: finalImage, mode: currentMode };
    pendingImage = null;

    try {
      const res = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const data = await res.json();
      document.getElementById(loaderId)?.remove();
      
      addBubble("ai", data.assistant_text, false, data.speech_text);
      if (data.data && data.data.length) renderCards(data.data);
    } catch (e) {
      document.getElementById(loaderId).innerHTML = "ƒ∞nternet gitti galiba evladƒ±m.";
    } finally {
        isSending = false; 
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("sendBtn").style.opacity = "1";
    }
  }

  function addBubble(role, text, isLoader=false, speech=null, imgData=null, customId=null) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    if(customId) div.id = customId;

    let content = "";
    if (imgData) content += `<img src="${imgData}" style="max-width:100%; border-radius:16px; margin-bottom:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08);">`;
    
    let htmlContent = text;
    if (role === "ai" && !isLoader) {
        const raw = marked.parse(text);
        htmlContent = DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
    } else if (role === "user") {
        htmlContent = escapeHtml(text);
    }

    div.innerHTML = `<div class="bubble">${content + htmlContent}</div>`;
    
    if (speech && role === "ai" && !isLoader) {
      const btn = document.createElement("div");
      btn.className = "audio-btn";
      btn.setAttribute("data-speech", speech);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
      div.querySelector(".bubble").appendChild(btn);
    }

    document.getElementById("chatContainer").appendChild(div);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  function pickBadge(p, idx) {
    const t = (p.caynana_trust?.badge || p.badge || p.rank || p.type || p.tag || "").toString().toLowerCase();
    if (t.includes("sponsor")) return { key:"gold", text:"SPONSORLU" };
    if (t.includes("efsane") || t.includes("altƒ±n") || t.includes("gold")) return { key:"gold", text:"ALTIN √ñNERƒ∞" };
    if (t.includes("iyi") || t.includes("g√ºm√º≈ü") || t.includes("silver")) return { key:"silver", text:"G√úM√ú≈û SE√áƒ∞M" };
    if (t.includes("fiyat") || t.includes("perf")) return { key:"value", text:"Fƒ∞YAT/PERF" };
    if (idx === 0) return { key:"gold", text:"ALTIN √ñNERƒ∞" };
    if (idx === 1) return { key:"silver", text:"G√úM√ú≈û SE√áƒ∞M" };
    if (idx === 2) return { key:"value", text:"Fƒ∞YAT/PERF" };
    return null;
  }

  function renderCards(list) {
    list = (list || []).slice().sort((a,b)=>{
        const score = (x) => {
            const t = (x.caynana_trust?.badge || x.badge || x.rank || x.type || x.tag || "").toString().toLowerCase();
            if (t.includes("sponsor")) return 0;
            if (t.includes("efsane") || t.includes("altƒ±n")) return 1;
            if (t.includes("iyi") || t.includes("g√ºm√º≈ü")) return 2;
            return 9;
        };
        return score(a) - score(b);
    });

    const wrap = document.createElement("div");
    wrap.className = "cards";
    
    list.forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "card";
      const badge = pickBadge(p, idx);
      if(badge) card.classList.add(`badge-${badge.key}`);
      const badgeHtml = badge ? `<div class="card-badge ${badge.key}">${badge.text}</div>` : "";
      const title = escapeHtml(String(p.title || ""));
      const price = escapeHtml(String(p.price || ""));
      const url = p.url ? safeLink(String(p.url)) : "";
      const img = p.image ? safeImg(String(p.image)) : 'https://via.placeholder.com/150?text=Resim+Yok';
      
      let btnClass = "btnLink";
      if(badge?.key === 'gold') btnClass += " btn-gold";
      else if(badge?.key === 'silver') btnClass += " btn-silver";
      else if(badge?.key === 'value') btnClass += " btn-blue";

      let btnHTML = url ? `<a href="${url}" target="_blank" rel="noopener noreferrer" class="${btnClass}">ƒ∞NCELE <i class="fa-solid fa-arrow-right" style="margin-left:4px"></i></a>` : "";
      let priceHTML = price ? `<div class="price">${price}</div>` : "";
      
      card.innerHTML = `
        ${badgeHtml}
        <img class="pimg" src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Resim+Yok'">
        <div class="title">${title}</div>
        ${priceHTML}
        ${btnHTML}
      `;
      wrap.appendChild(card);
    });
    
    document.getElementById("chatContainer").appendChild(wrap);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  async function playAudio(text, btn) {
    const wasPlayingThisBtn = btn.classList.contains('playing');
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
        b.classList.remove('playing');
        b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
    });
    if (wasPlayingThisBtn) return;
    
    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...`;
    
    try {
      const res = await fetch(SPEAK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text }) });
      const blob = await res.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = () => { 
          btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`; 
          btn.classList.remove('playing'); 
          currentAudio = null; 
      };
      await currentAudio.play();
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sus Kƒ±z!`;
      btn.classList.add('playing');
    } catch (e) { 
        btn.innerHTML = "Hata"; 
        setTimeout(()=> btn.innerHTML = originalText, 1500); 
    }
  }

  document.getElementById("chatContainer").addEventListener("click", (e) => {
    const btn = e.target.closest(".audio-btn");
    if (!btn) return;
    const speech = btn.getAttribute("data-speech");
    if (speech) playAudio(speech, btn);
  });

  const fileEl = document.getElementById("fileInput");
  function openCamera() { fileEl.value = ""; fileEl.click(); }
  fileEl.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => { 
        pendingImage = reader.result; 
        document.getElementById("text").value = "üì∑ Fotoƒüraf eklendi"; 
        document.getElementById("text").focus();
    };
    reader.readAsDataURL(file);
  });

  function startMic() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert("Mikrofon izni yok veya desteklenmiyor."); return; }
    const rec = new SR(); rec.lang = "tr-TR";
    const btn = document.getElementById("micBtn");
    btn.classList.add("mic-active");
    rec.onresult = (e) => { 
        document.getElementById("text").value = e.results[0][0].transcript; 
        btn.classList.remove("mic-active");
        send();
    };
    rec.onend = () => btn.classList.remove("mic-active");
    rec.start();
  }

  renderDock();
  switchMode('shopping');
</script>

</body>
</html>
