<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ --primary:#00C897; --font:'Outfit',sans-serif; }
  *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; }

  body{
    font-family:var(--font);
    background:#0b0f18;
    overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }

  /* WEB Ã‡ERÃ‡EVESÄ° (MOBÄ°L GÃ–RÃœNÃœM) */
  #app{
    width:100%; height:100%;
    max-width:480px; max-height:920px;
    border-radius:22px; overflow:hidden;
    box-shadow:0 0 60px rgba(0,0,0,.60);
    position:relative; display:flex; flex-direction:column;
    
    /* Arka plan resim geÃ§iÅŸi */
    background: linear-gradient(135deg,#0b1220 0%,#0b0f18 100%);
    background-position: center; background-size: cover; background-repeat: no-repeat;
    transition: background-image 0.4s ease-in-out;
  }

  @media (max-width:520px){
    body{ display:block; background:#000; }
    #app{ width:100vw; height:100vh; max-width:none; max-height:none; border-radius:0; box-shadow:none; }
  }

  /* Karartma KatmanÄ± */
  #app::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(to bottom, rgba(0,0,0,.5) 0%, rgba(0,0,0,.2) 30%, rgba(0,0,0,.1) 50%, rgba(255,255,255,0.9) 85%);
    pointer-events:none; z-index:1;
  }

  /* HEADER */
  #topbar{
    position:relative; z-index:10; height:70px;
    padding:14px 18px; display:flex; justify-content:space-between; align-items:center;
  }
  .brand-wrap{ display:flex; flex-direction:column; gap:2px; cursor:pointer; }
  .brand{ display:flex; align-items:center; gap:8px; font-size:20px; font-weight:900; color:#fff; }
  .brand i, .brand span{ color:var(--primary); }
  .brand-sub{ font-size:11px; font-weight:600; color:rgba(255,255,255,.8); }
  
  /* Ayarlar Butonu */
  .settings-btn{
    width:40px; height:40px; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.2); color:#fff;
    backdrop-filter:blur(10px); cursor:pointer;
  }

  /* ORTA ALAN */
  #main{
    position:relative; z-index:8; flex:1;
    overflow-y:auto; padding:0 18px 200px 18px; /* Alt bar payÄ± */
  }

  /* Hero YazÄ±larÄ± (Ortada Ã§Ä±kan bÃ¼yÃ¼k yazÄ±lar) */
  #heroContent{ margin-top:60px; text-align:left; padding-left:10px; transition: opacity 0.3s; }
  #heroTitle{
    font-size:38px; font-weight:800; line-height:1.1; color:#fff;
    text-shadow:0 4px 10px rgba(0,0,0,.4);
  }
  #heroDesc{
    margin-top:10px; font-size:16px; font-weight:600; color:rgba(255,255,255,.9);
    text-shadow:0 2px 5px rgba(0,0,0,.3);
  }

  /* Sohbet AlanÄ± */
  #chatContainer{ display:none; margin-top:20px; padding-bottom: 20px; }
  .msg{ display:flex; margin-bottom:12px; flex-direction: column; }
  .msg.user{ align-items: flex-end; }
  .msg.ai{ align-items: flex-start; }
  
  .bubble{
    max-width:85%; padding:12px 16px; border-radius:18px;
    font-size:15px; line-height:1.4; font-weight:500;
  }
  .msg.user .bubble{ background:var(--primary); color:#fff; border-bottom-right-radius:4px; box-shadow:0 4px 10px rgba(0,0,0,.1); }
  .msg.ai .bubble{ background:#fff; color:#333; border-bottom-left-radius:4px; box-shadow:0 4px 10px rgba(0,0,0,.1); }

  /* Ses OynatÄ±cÄ± Butonu (Balonun altÄ±nda) */
  .audio-player {
    margin-top: 5px; font-size: 11px; color: #555; cursor: pointer;
    display: flex; align-items: center; gap: 5px; font-weight: 700;
    background: rgba(255,255,255,0.5); padding: 4px 10px; border-radius: 10px; width: fit-content;
  }
  .audio-player i { color: var(--primary); }

  /* ALT BAR */
  #bottom{
    position:absolute; bottom:0; left:0; right:0; z-index:20;
    background:#fff; border-top-left-radius: 24px; border-top-right-radius: 24px;
    padding: 20px 10px 30px 10px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
  }

  /* Ã–neri Balonu */
  #suggestionText{
    position: absolute; top: -45px; left: 50%; transform: translateX(-50%);
    background: #fff; padding: 10px 20px; border-radius: 30px;
    font-size: 13px; font-weight: 700; color: var(--primary);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); white-space: nowrap;
  }

  /* Input AlanÄ± */
  .input-wrapper{ display:flex; gap:10px; align-items:center; margin-bottom: 15px; padding: 0 10px; }
  .search-bar{
    flex:1; height:50px; border-radius:25px; background:#f0f2f5;
    display:flex; align-items:center; padding:0 15px;
  }
  #text{ flex:1; border:none; background:transparent; font-size:15px; outline:none; color:#333; }
  .tool-btn{ color:#888; font-size:18px; margin-left: 10px; cursor: pointer; }
  #sendBtn{
    width:50px; height:50px; border-radius:50%; border:none;
    background:var(--primary); color:#fff; font-size:20px;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 10px rgba(0,200,151,.4); cursor:pointer;
  }

  /* MenÃ¼ (Dock) */
  #dock{ display:flex; gap:20px; overflow-x:auto; padding: 0 10px; scrollbar-width: none; }
  .dock-item{ display:flex; flex-direction:column; align-items:center; gap:5px; opacity:0.5; transition:0.3s; min-width: 60px; cursor: pointer; }
  .dock-item.active{ opacity:1; transform: translateY(-5px); }
  .dock-icon-box{ font-size:24px; color:#555; }
  .dock-item.active .dock-icon-box{ color:var(--primary); }
  .dock-label{ font-size:11px; font-weight:700; color:#333; }

  /* Ayarlar ModalÄ± */
  #settings-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center; }
  .modal-content { background:#fff; width:85%; max-width:320px; padding:25px; border-radius:24px; text-align:center; }
  .modal-title { font-size:18px; font-weight:800; color:#333; margin-bottom:10px; }
  #voice-select { width:100%; padding:12px; margin-bottom:20px; border-radius:10px; border:1px solid #ddd; background: #f9f9f9; font-family: var(--font); }
  .close-btn { background:var(--primary); color:#fff; border:none; padding:12px; width:100%; border-radius:12px; font-weight:700; cursor: pointer; }

  #fileInput{ display:none !important; }
</style>
</head>

<body>
<div id="app">

  <div id="topbar">
    <div class="brand-wrap">
      <div class="brand"><i class="fa-solid fa-wand-magic-sparkles"></i>CAYNANA<span>.AI</span></div>
      <div class="brand-sub">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
    </div>
    <div class="settings-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></div>
  </div>

  <div id="main">
    <div id="heroContent">
      <div id="heroTitle">Almadan Ã¶nce<br>Caynanaâ€™ya sor.</div>
      <div id="heroDesc">Sonra â€œkeÅŸkeâ€ dememek iÃ§in buradayÄ±m.</div>
    </div>
    <div id="chatContainer"></div>
  </div>

  <div id="bottom">
    <div id="suggestionText">Her indirime atlayan sonunda pahalÄ± Ã¶der.</div>

    <div class="input-wrapper">
      <div class="search-bar">
        <input id="text" placeholder="Ne danÄ±ÅŸmak istersin?" autocomplete="off">
        <div class="tool-btn" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-camera"></i></div>
        <div class="tool-btn"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div id="dock"></div>
  </div>

  <div id="settings-modal">
    <div class="modal-content">
      <div class="modal-title">Caynana'nÄ±n Sesi</div>
      <p style="font-size:12px; color:#666; margin-bottom:15px;">ElevenLabs hesabÄ±ndaki seslerden birini seÃ§.</p>
      <select id="voice-select"><option>YÃ¼kleniyor...</option></select>
      <button class="close-btn" onclick="closeSettings()">Kaydet ve Kapat</button>
    </div>
  </div>

</div>

<input type="file" id="fileInput" accept="image/*">

<script>
  // ğŸ”¥ Ã–NEMLÄ°: Bu adresi kendi Render adresinle deÄŸiÅŸtir!
  // Ã–rn: const API_BASE = "https://bikonomi-api-2.onrender.com";
  // Åimdilik test iÃ§in localhost bÄ±rakÄ±yorum:
  const API_BASE = "https://bikonomi-api-2.onrender.com"; 

  let currentMode = "shopping";
  let pendingImage = null;
  let chatHistory = {};
  let currentAudio = null;
  let selectedVoiceId = localStorage.getItem("caynana_voice_id") || "";

  // GÃ¶rseller (GitHub klasÃ¶rÃ¼ndeki isimlerle birebir aynÄ± olmalÄ±)
  const MODES = {
    shopping: { label:"AlÄ±ÅŸveriÅŸ", icon:"fa-bag-shopping", title:"Ä°ndirimleri tarÄ±yorum.<br>Ne alacaÄŸÄ±z?", desc:"Ä°sraf haramdÄ±r, iyisine bakalÄ±m.", sugg:"BÃ¼tÃ§eni sÃ¶yle, en iyisini bulayÄ±m.", img:"images/hero-shopping.png", color:"#00C897" },
    chat: { label:"Sohbet", icon:"fa-comments", title:"Caynana ile<br>iki lafÄ±n belini kÄ±r.", desc:"Biraz dur bakalÄ±m, neler anlatacaksÄ±n?", sugg:"BugÃ¼n neyi dert ettin?", img:"images/hero-chat.png", color:"#FFB300" },
    fal: { label:"Fal", icon:"fa-mug-hot", title:"FalÄ±na bakalÄ±m mÄ±?<br>FincanÄ± Ã§ek.", desc:"FincanÄ± Ã§ek, ben yorumlayayÄ±m.", sugg:"FincanÄ± kapattÄ±n mÄ±? Ã‡ek gÃ¶nder.", img:"images/hero-fal.png", color:"#8B5CF6" },
    dream: { label:"RÃ¼ya", icon:"fa-cloud-moon", title:"RÃ¼yanda ne gÃ¶rdÃ¼n?<br>Anlat tabir edeyim.", desc:"HayÄ±rdÄ±r inÅŸallah...", sugg:"DetayÄ± sÃ¶yle, tabiri netleÅŸir.", img:"images/hero-dream.png", color:"#6366F1" },
    health: { label:"SaÄŸlÄ±k", icon:"fa-heart-pulse", title:"Caynana SaÄŸlÄ±k'la<br>alÄ±ÅŸkanlÄ±k kazan.", desc:"Neren aÄŸrÄ±yor sÃ¶yle bakayÄ±m?", sugg:"Neyin var evladÄ±m? Ä°hmale gelmez.", img:"images/hero-health.png", color:"#EF4444" },
    diet: { label:"Diyet", icon:"fa-carrot", title:"Caynana Diyet'le<br>saÄŸlÄ±klÄ± beslen!", desc:"AÃ§lÄ±ktan deÄŸil, keyiften yiyin.", sugg:"Boy-kilo yaz, hedef koyalÄ±m.", img:"images/hero-diet.png", color:"#84CC16" },
    food: { label:"Yemek", icon:"fa-utensils", title:"Caynana Yemek'le<br>ne piÅŸirsem?", desc:"Dolapta ne var sÃ¶yle, tarif benden.", sugg:"Dolapta ne var? Sana harika tarif vereyim.", img:"images/hero-food.png", color:"#F97316" },
    law: { label:"Hukuk", icon:"fa-scale-balanced", title:"Caynana Hukuk'la<br>kim haklÄ± Ã¶ÄŸren.", desc:"Ben avukat deÄŸilim ama Ã§ok dava gÃ¶rdÃ¼m.", sugg:"SÃ¶zleÅŸmeye bakmadan imza atma!", img:"images/hero-law.png", color:"#3B82F6" },
    astro: { label:"BurÃ§", icon:"fa-star", title:"YÄ±ldÄ±zlar senin iÃ§in<br>ne diyor?", desc:"MerkÃ¼r retrosu falan... dikkat et.", sugg:"Burcunu yaz, yorumlayayÄ±m.", img:"images/hero-astro.png", color:"#D946EF" },
    translate: { label:"Ã‡eviri", icon:"fa-language", title:"Ã‡eviri lazÄ±m mÄ±?<br>SÃ¶yle Ã§evireyim.", desc:"Metni yapÄ±ÅŸtÄ±r, ben hallederim.", sugg:"Dil bilmek altÄ±n bileziktir.", img:"images/hero-translate.png", color:"#64748B" }
  };

  function init(){
    renderDock();
    switchMode("shopping");
    loadVoices();
    
    // Enter tuÅŸu
    document.getElementById("text").addEventListener("keypress", (e)=>{ if(e.key==="Enter") send(); });
  }

  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key=>{
      const m = MODES[key];
      const div = document.createElement("div");
      div.className = "dock-item " + (key===currentMode ? "active":"");
      div.onclick = ()=> switchMode(key);
      div.innerHTML = `<div class="dock-icon-box"><i class="fa-solid ${m.icon}"></i></div><div class="dock-label">${m.label}</div>`;
      dock.appendChild(div);
    });
  }

  function switchMode(newMode){
    currentMode = newMode;
    const m = MODES[newMode];
    
    // Tema rengi
    document.documentElement.style.setProperty("--primary", m.color);
    
    // Arka plan
    document.getElementById("app").style.backgroundImage = `url('${m.img}')`;
    
    // Hero Metinleri
    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerHTML = m.desc;
    document.getElementById("suggestionText").innerHTML = m.sugg;
    
    // Dock gÃ¼ncelle
    renderDock();
    
    // Sohbet geÃ§miÅŸi temizle veya yÃ¼kle (Åimdilik temizliyoruz)
    document.getElementById("chatContainer").innerHTML = "";
    document.getElementById("heroContent").style.opacity = "1";
    document.getElementById("heroContent").style.display = "block";
    document.getElementById("chatContainer").style.display = "none";
  }

  async function loadVoices() {
    try {
      const res = await fetch(`${API_BASE}/api/voices`);
      const data = await res.json();
      const select = document.getElementById("voice-select");
      select.innerHTML = "";
      
      if(data.voices && data.voices.length > 0){
          data.voices.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v.id;
            opt.text = v.name + (v.category ? ` (${v.category})` : "");
            if(v.id === selectedVoiceId) opt.selected = true;
            select.appendChild(opt);
          });
          // HiÃ§ seÃ§im yoksa ilkini seÃ§
          if(!selectedVoiceId) selectedVoiceId = data.voices[0].id;
      } else {
          select.innerHTML = "<option>Ses BulunamadÄ±</option>";
      }
    } catch(e) { console.log("Sesler yÃ¼klenemedi:", e); }
  }

  async function send(){
    const input = document.getElementById("text");
    const txt = input.value.trim();
    if(!txt && !pendingImage) return;

    // UI GÃ¼ncelle
    document.getElementById("heroContent").style.display = "none";
    document.getElementById("chatContainer").style.display = "block";
    
    addMessage("user", txt, pendingImage);
    input.value = "";
    
    const payload = { message: txt, mode: currentMode, image: pendingImage };
    pendingImage = null;

    try {
      const res = await fetch(`${API_BASE}/api/chat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      
      // CevabÄ± ekle ve seslendir
      addMessage("ai", data.assistant_text, null, true);
      playAudio(data.assistant_text);
      
    } catch(e) {
      addMessage("ai", "Ah evladÄ±m internetim kesildi galiba. Backend adresini kontrol et.");
    }
  }

  async function playAudio(text) {
    if(currentAudio) { currentAudio.pause(); currentAudio = null; }
    try {
      const res = await fetch(`${API_BASE}/api/speak`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text, voice_id: selectedVoiceId })
      });
      
      if(res.status === 204) return; 

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      currentAudio.play();
    } catch(e) { console.error("Ses hatasÄ±:", e); }
  }

  function addMessage(role, text, imgData, hasAudio=false){
    const container = document.getElementById("chatContainer");
    const msgDiv = document.createElement("div");
    msgDiv.className = `msg ${role}`;
    
    let content = "";
    if(imgData) content += `<img src="${imgData}" style="width:100%; border-radius:10px; margin-bottom:5px;">`;
    
    if(role === "ai"){
        content += DOMPurify.sanitize(marked.parse(text));
        if(hasAudio){
            // TÄ±rnak iÅŸaretlerini temizle
            const safeText = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            content += `<div class="audio-player" onclick="playAudio('${safeText}')"><i class="fa-solid fa-volume-high"></i> Tekrar Oku</div>`;
        }
    } else {
        content += text;
    }
    
    msgDiv.innerHTML = `<div class="bubble">${content}</div>`;
    container.appendChild(msgDiv);
    container.scrollIntoView({ behavior: "smooth", block: "end" });
  }

  // FotoÄŸraf YÃ¼kleme
  const fileInput = document.getElementById("fileInput");
  fileInput.addEventListener("change", (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (evt)=>{
      pendingImage = evt.target.result;
      document.getElementById("text").value = "ğŸ“· FotoÄŸraf eklendi";
    };
    reader.readAsDataURL(file);
  });

  // Ayarlar ModalÄ±
  function openSettings() { document.getElementById("settings-modal").style.display = "flex"; }
  function closeSettings() { 
      document.getElementById("settings-modal").style.display = "none";
      const sel = document.getElementById("voice-select");
      if(sel.value) { selectedVoiceId = sel.value; localStorage.setItem("caynana_voice_id", sel.value); }
  }

  init();
</script>
</body>
</html>
