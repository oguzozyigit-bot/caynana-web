<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Caynana AI</title>
<style>
  :root {
    --bg: #0e0e0e; /* Siyahƒ±n bir tƒ±k a√ßƒ±ƒüƒ± */
    --panel: #181818;
    --text: #ececec;
    --gold: #ffb300;
    --pistachio: #bef264; /* Fƒ±stƒ±k Ye≈üili */
    --glass: rgba(20, 20, 20, 0.65);
    --border: rgba(255, 255, 255, 0.08);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body, html {
    margin: 0; padding: 0;
    height: 100%;
    background: #000;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    overflow: hidden; /* Scroll chat i√ßinde olacak */
  }

  /* --- ANA KONTEYNER --- */
  .app-container {
    width: 100%; height: 100%;
    max-width: 480px; /* Mobil g√∂r√ºn√ºm */
    margin: 0 auto;
    background: var(--bg);
    position: relative;
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 40px rgba(0,0,0,0.5);
  }

  /* --- TOPBAR (Buzlu Cam) --- */
  .topbar {
    position: absolute; top: 0; left: 0; right: 0;
    height: 60px;
    background: var(--glass);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 1000;
  }
  .hamb { font-size: 24px; cursor: pointer; color: #aaa; background:none; border:none; }
  .brand { font-weight: 700; font-size: 16px; letter-spacing: 0.5px; color: #fff; }
  .status-dot { width: 8px; height: 8px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 8px var(--gold); }

  /* --- EYES AREA (Sabit) --- */
  .eyes-wrapper {
    position: absolute;
    top: 70px; /* Header altƒ± */
    left: 0; right: 0;
    height: 140px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    z-index: 900;
    pointer-events: none; /* Arkadaki chat'e engel olmasƒ±n, JS ile kontrol edecegiz */
    transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    opacity: 0;
    transform: translateY(-20px) scale(0.9);
  }
  .eyes-wrapper.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  .eyes-box {
    width: 300px; height: 110px;
    /* G√∂zlerin arkasƒ± ≈üeffaf olsun ki chat g√∂r√ºns√ºn veya hafif bir g√∂lge */
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  /* --- EYE CSS --- */
  .eye {
    width: 120px; height: 90px;
    position: relative;
    display: flex; align-items: center; justify-content: center;
    /* Deƒüi≈ükenler JS ile g√ºncellenecek */
    --lidTop: 0%; --lidBot: 0%; 
    --gx: 0px; --gy: 0px;
  }
  
  /* Kirpik/Ka≈ü/G√∂z Yapƒ±sƒ± */
  .brow {
    position: absolute; top: -10px; width: 100%; height: 20px;
    background: #111; border-radius: 50%;
    filter: blur(2px); opacity: 0.8;
    transform-origin: center;
    transition: 0.2s;
  }
  .sclera {
    width: 100%; height: 100%;
    background: #e0e0e0;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 15px rgba(0,0,0,0.8), 0 0 10px rgba(0,0,0,0.5);
    border: 2px solid #333;
  }
  .iris {
    width: 44px; height: 44px;
    background: radial-gradient(circle, #6d4c41 0%, #3e2723 100%);
    border-radius: 50%;
    position: absolute; top: 50%; left: 50%;
    transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy)));
    border: 1px solid rgba(255,255,255,0.2);
    display:flex; align-items:center; justify-content:center;
    transition: transform 0.08s linear; /* Yumu≈üak hareket */
  }
  .pupil { width: 16px; height: 16px; background: #000; border-radius: 50%; }
  .reflection {
    position: absolute; top: 8px; right: 8px;
    width: 8px; height: 8px; background: rgba(255,255,255,0.8);
    border-radius: 50%; filter: blur(0.5px);
  }
  
  /* G√∂z Kapaklarƒ± */
  .lid-top, .lid-bot {
    position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10;
    transition: height 0.1s;
  }
  .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
  .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

  /* Takip Toggle Butonu (G√∂zlerin hemen altƒ±nda) */
  .track-toggle-btn {
    margin-top: 10px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.1);
    color: #ccc;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    transition: 0.2s;
    pointer-events: auto; /* G√∂r√ºnmez olsa da bu buton tƒ±klanabilir olmalƒ± mƒ±? Hayƒ±r, parent opacity 0 yapacak. */
  }
  .track-toggle-btn:hover { background: rgba(255, 179, 0, 0.2); color: var(--gold); border-color: var(--gold); }

  /* --- CHAT AREA --- */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 80px 16px 100px 16px; /* Topbar ve Dock bo≈üluklarƒ± */
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }
  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

  .bubble {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.5;
    position: relative;
    animation: popIn 0.2s ease;
  }
  @keyframes popIn { from{ transform:translateY(10px); opacity:0; } to{ transform:translateY(0); opacity:1; } }

  /* BOT Bubble */
  .bubble.bot {
    align-self: flex-start;
    background: #1a1a1a;
    border-left: 3px solid var(--gold); /* Turuncu √áizgi */
    border-top-left-radius: 4px;
    color: #ddd;
  }
  
  /* USER Bubble */
  .bubble.user {
    align-self: flex-end;
    background: #222;
    border-right: 3px solid var(--pistachio); /* Fƒ±stƒ±k Ye≈üili √áizgi */
    border-top-right-radius: 4px;
    color: #fff;
    text-align: right; /* ƒ∞steƒüe baƒülƒ±, saƒüa yaslƒ± metin */
  }

  /* --- INPUT DOCK (ChatGPT Style) --- */
  .input-dock {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(to top, #0e0e0e 90%, transparent);
    padding: 10px 16px 30px 16px; /* Safe area */
    z-index: 1000;
  }
  
  /* Ana Takip Butonu (G√∂zler kapalƒ±yken g√∂r√ºnen) */
  .main-track-trigger {
    position: absolute;
    top: -40px; left: 50%; transform: translateX(-50%);
    background: rgba(20,20,20,0.8);
    border: 1px solid #333;
    color: #888;
    font-size: 12px;
    padding: 6px 12px;
    border-radius: 20px;
    cursor: pointer;
    backdrop-filter: blur(4px);
    transition: 0.2s;
  }
  .main-track-trigger.active { color: var(--gold); border-color: var(--gold); }

  .dock-inner {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: #1e1e1e;
    border: 1px solid #333;
    border-radius: 24px;
    padding: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }

  .dock-btn {
    width: 40px; height: 40px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: #999;
    font-size: 20px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .dock-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
  .dock-btn.active { color: var(--gold); background: rgba(255,179,0,0.1); }

  textarea {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    font-size: 16px;
    resize: none;
    padding: 10px 5px;
    max-height: 120px;
    min-height: 24px;
    font-family: inherit;
  }

  .footer {
    position: absolute; bottom: 5px; left: 0; right: 0;
    text-align: center;
    font-size: 10px; color: #555;
    pointer-events: none;
    z-index: 1001;
  }

  /* Gizli Video/Canvas */
  #camVideo, #camCanvas { display: none; }
</style>
</head>
<body>

<div class="app-container">
  <div class="topbar">
    <button class="hamb">‚ò∞</button>
    <div class="brand">Caynana AI</div>
    <div class="status-dot"></div>
  </div>

  <div class="eyes-wrapper" id="eyesWrapper">
    <div class="eyes-box" id="eyesBox">
      <div class="eye" id="eyeL">
        <div class="brow"></div>
        <div class="sclera">
          <div class="iris">
            <div class="pupil"></div>
            <div class="reflection"></div>
          </div>
        </div>
        <div class="lid-top"></div>
        <div class="lid-bot"></div>
      </div>
      <div class="eye" id="eyeR">
        <div class="brow"></div>
        <div class="sclera">
          <div class="iris">
            <div class="pupil"></div>
            <div class="reflection"></div>
          </div>
        </div>
        <div class="lid-top"></div>
        <div class="lid-bot"></div>
      </div>
    </div>
    <button class="track-toggle-btn" id="closeTrackBtn">Takibi Kapat</button>
  </div>

  <div class="chat-area" id="chat">
    <div class="bubble bot">G√∂z√ºm √ºzerinde evladƒ±m...</div>
  </div>

  <div class="input-dock">
    <button class="main-track-trigger" id="openTrackBtn">üëÅÔ∏è Takip et</button>

    <div class="dock-inner">
      <button class="dock-btn" id="camBtn">üì∑</button>
      <textarea id="msgInput" rows="1" placeholder="Mesaj yaz..."></textarea>
      <button class="dock-btn" id="micBtn">üéôÔ∏è</button>
    </div>
  </div>

  <div class="footer">@CaynanAI By Ozyigit's 2026</div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<script>
  // --- DOM Elements ---
  const eyesWrapper = document.getElementById('eyesWrapper');
  const openTrackBtn = document.getElementById('openTrackBtn');
  const closeTrackBtn = document.getElementById('closeTrackBtn');
  const eyeL = document.getElementById('eyeL');
  const eyeR = document.getElementById('eyeR');
  const chat = document.getElementById('chat');
  const msgInput = document.getElementById('msgInput');
  const micBtn = document.getElementById('micBtn');
  const camBtn = document.getElementById('camBtn');
  const camVideo = document.getElementById('camVideo');

  // --- State ---
  let isTracking = false;
  let isCameraOn = false;
  let isMicListening = false;
  
  // MediaPipe Setup
  let faceMesh;
  let camera;

  // --- Helper Functions ---
  function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }
  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
  function scrollChat() { chat.scrollTop = chat.scrollHeight; }

  // G√∂z Pozisyonu Ayarla (x, y: -1 ile 1 arasƒ±)
  function setGaze(x, y) {
    // √áarpanƒ± artƒ±rdƒ±m: daha belirgin hareket (Prompt: "daha belirgin olsun")
    const gx = clamp(x * 25, -25, 25); 
    const gy = clamp(y * 20, -20, 20);
    
    [eyeL, eyeR].forEach(eye => {
      eye.style.setProperty('--gx', gx + 'px');
      eye.style.setProperty('--gy', gy + 'px');
    });
  }

  function setLids(topPercent, botPercent = 0) {
    [eyeL, eyeR].forEach(eye => {
      eye.style.setProperty('--lidTop', topPercent + '%');
      eye.style.setProperty('--lidBot', botPercent + '%');
    });
  }

  // G√∂z Kƒ±rpma
  async function blink() {
    setLids(100);
    await sleep(100);
    setLids(0);
  }

  // Otomatik G√∂z Kƒ±rpma D√∂ng√ºs√º
  setInterval(() => {
    if (Math.random() < 0.1) blink();
  }, 2000);

  // Onaylama Hareketi (Nodding)
  async function approveNod() {
    // Hƒ±zlƒ±ca a≈üaƒüƒ± yukarƒ± bakma
    setGaze(0, 0.8); await sleep(150);
    setGaze(0, -0.5); await sleep(150);
    setGaze(0, 0);
  }

  // --- Takip Kontrol√º (G√∂zleri A√ß/Kapa) ---
  function toggleTracking(state) {
    isTracking = state;
    if (state) {
      eyesWrapper.classList.add('visible');
      openTrackBtn.style.display = 'none';
      startCamera(); // G√∂zler a√ßƒ±lƒ±nca kamera da ba≈ülasƒ±n (isteƒüe baƒülƒ±)
    } else {
      eyesWrapper.classList.remove('visible');
      openTrackBtn.style.display = 'block';
      stopCamera();
      // Reset
      setGaze(0, 0);
    }
  }

  openTrackBtn.addEventListener('click', () => toggleTracking(true));
  closeTrackBtn.addEventListener('click', () => toggleTracking(false));

  // --- Input & Okuma Efekti ---
  // Yazƒ± yazarken metni takip ediyormu≈ü gibi yap
  msgInput.addEventListener('input', () => {
    // Auto-resize
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
    
    if (isTracking) {
      // Satƒ±r uzunluƒüuna g√∂re g√∂z√º hafif saƒüa kaydƒ±r
      const len = msgInput.value.length;
      const x = Math.sin(len * 0.1) * 0.5; // Basit okuma simulasyonu
      const y = 0.6; // A≈üaƒüƒ± bakƒ±yor
      setGaze(x, y);
    }
  });

  msgInput.addEventListener('focus', () => {
    if (isTracking) setGaze(0, 0.6); // Klavyeye bak
  });

  // Mesaj G√∂nderme
  msgInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const txt = msgInput.value.trim();
      if (!txt) return;
      
      // User Bubble
      addBubble(txt, 'user');
      msgInput.value = '';
      msgInput.style.height = 'auto';

      // Onaylama hareketi
      if (isTracking) await approveNod();

      // Bot Response
      setTimeout(() => botReply(txt, false), 600);
    }
  });

  function addBubble(text, type) {
    const d = document.createElement('div');
    d.className = `bubble ${type}`;
    d.innerText = text;
    chat.appendChild(d);
    scrollChat();
    return d;
  }

  // --- BOT YANITI ---
  async function botReply(userText, isVoiceMode) {
    let replyText = "Ben bir yapay zekayƒ±m ama her ≈üeyi g√∂r√ºr√ºm.";
    
    // Basit mantƒ±k (Mood detection)
    const t = userText.toLowerCase();
    if (t.includes('merhaba')) replyText = "Selam evladƒ±m, ho≈ü geldin.";
    else if (t.includes('nasƒ±lsƒ±n')) replyText = "Turp gibiyim, sen nasƒ±lsƒ±n?";
    else if (t.includes('takip')) replyText = "G√∂z√ºm zaten √ºzerinde...";
    else replyText = "Hmm... bunu not aldƒ±m. Devam et.";

    // Eƒüer Sesli mod ise (Mikrofon kullanƒ±ldƒ±ysa)
    if (isVoiceMode) {
      speak(replyText);
      // Sesli modda yazƒ± yazsƒ±n mƒ±? Prompt: "Cevabƒ± konu≈üarak versin. Yazƒ± ile deƒüil." 
      // Ancak UX i√ßin baloncuk bo≈ü kalmasƒ±n diye "Dinliyor..." ikonu veya metin de g√∂sterebiliriz.
      // Biz hem yazƒ±p hem konu≈üacaƒüƒ±z ama konu≈üma bitene kadar daktilo efekti s√ºrecek.
    }
    
    // Daktilo efekti ile yazma
    const bubble = addBubble('', 'bot');
    const chars = replyText.split('');
    
    for (let c of chars) {
      bubble.innerText += c;
      scrollChat();
      await sleep(30); // Daktilo hƒ±zƒ±
    }
  }

  // --- TTS (Text to Speech) & Dudak Hareketi ---
  function speak(text) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'tr-TR';
    u.rate = 1.0;
    
    // Konu≈üurken g√∂zler oynasƒ±n
    const speakInterval = setInterval(() => {
      if (isTracking) {
        setGaze((Math.random()-0.5), (Math.random()-0.5));
        // Hafif kapak hareketi (mimik)
        setLids(Math.random()*20, Math.random()*20);
      }
    }, 150);

    u.onend = () => {
      clearInterval(speakInterval);
      if (isTracking) {
        setGaze(0, 0);
        setLids(0, 0);
      }
    };
    
    window.speechSynthesis.speak(u);
  }

  // --- Mƒ∞KROFON (Sesli Giri≈ü) ---
  micBtn.addEventListener('click', () => {
    // Mikrofon a√ßƒ±lƒ±nca g√∂zler otomatik gelsin
    if (!isTracking) toggleTracking(true);

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Tarayƒ±cƒ±n ses tanƒ±mayƒ± desteklemiyor.");
      return;
    }

    if (isMicListening) return; // Zaten dinliyorsa
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'tr-TR';
    recognition.interimResults = false;

    micBtn.classList.add('active'); // Kƒ±rmƒ±zƒ±/Aktif yap
    micBtn.style.color = 'var(--gold)';
    isMicListening = true;

    recognition.onstart = () => {
      console.log("Dinleniyor...");
    };

    recognition.onresult = async (event) => {
      const txt = event.results[0][0].transcript;
      addBubble(txt, 'user');
      
      // Onaylama
      if(isTracking) await approveNod();
      
      // Sesli cevap ver
      botReply(txt, true);
    };

    recognition.onend = () => {
      micBtn.style.color = '';
      micBtn.classList.remove('active');
      isMicListening = false;
    };

    recognition.start();
  });

  // --- KAMERA / TOUCH TAKƒ∞Bƒ∞ ---
  
  // Dokunma Takibi
  document.addEventListener('pointermove', (e) => {
    if (!isTracking) return;
    if (isCameraOn) return; // Kamera a√ßƒ±ksa √∂ncelik kamerada olsun

    const w = window.innerWidth;
    const h = window.innerHeight;
    // Normalize -1 to 1
    const x = (e.clientX / w) * 2 - 1;
    const y = (e.clientY / h) * 2 - 1;
    
    setGaze(x, y);
  });

  // Kamera Takibi (FaceMesh)
  async function startCamera() {
    if (isCameraOn) return;
    
    if (!faceMesh) {
      faceMesh = new FaceMesh.FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
      faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
      faceMesh.onResults(onResults);
    }

    try {
      camera = new Camera(camVideo, {
        onFrame: async () => { await faceMesh.send({image: camVideo}); },
        width: 640, height: 480
      });
      await camera.start();
      isCameraOn = true;
      camBtn.classList.add('active');
      camBtn.style.color = 'var(--gold)';
    } catch(e) {
      console.log("Kamera hatasƒ±", e);
    }
  }

  function stopCamera() {
    if (!camera) return;
    // camera.stop() k√ºt√ºphanede bazen sorunlu olabilir, bayrakla y√∂netiyoruz
    isCameraOn = false;
    camBtn.classList.remove('active');
    camBtn.style.color = '';
  }

  camBtn.addEventListener('click', () => {
    if (!isTracking) toggleTracking(true);
    
    if (isCameraOn) stopCamera();
    else startCamera();
  });

  let prevX = 0, prevY = 0;
  function onResults(results) {
    if (!isTracking || !isCameraOn) return;
    if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) return;

    const lm = results.multiFaceLandmarks[0];
    
    // Burun ucu (index 1) veya g√∂z ortasƒ±
    // Ekranƒ± ayna gibi d√º≈ü√ºnmek i√ßin X'i tersliyoruz
    const nose = lm[1];
    
    // Deƒüerleri normalize et ve yumu≈üat (Lerp)
    let targetX = -(nose.x - 0.5) * 3; // √áarpan hareket hassasiyeti
    let targetY = (nose.y - 0.5) * 3;

    // Smoothing
    const alpha = 0.3;
    const curX = prevX + (targetX - prevX) * alpha;
    const curY = prevY + (targetY - prevY) * alpha;
    
    prevX = curX;
    prevY = curY;

    setGaze(curX, curY);
  }

</script>
</body>
</html>
