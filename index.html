<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>CAYNANA.AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://bikonomi-api-1.onrender.com; connect-src 'self' https://bikonomi-api-1.onrender.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline';">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --primary:#10B981; --bg:#F3F4F6; --bubble-user:#10B981; --bubble-ai:#FFFFFF; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:'Inter',sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; overflow:hidden; }

    .header { padding:15px; background:white; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e5e7eb; }
    .logo { font-weight:900; font-size:20px; color:#111; letter-spacing:-1px; display:flex; align-items:center; gap:8px;}
    .logo .dot { width:10px; height:10px; background:var(--primary); border-radius:50%; display:inline-block;}
    .mode-badge { font-size:10px; font-weight:800; background:#ECFDF5; color:var(--primary); padding:4px 8px; border-radius:12px; text-transform:uppercase; }

    #chat-container { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:15px; }
    .message { max-width:85%; padding:12px 16px; border-radius:16px; font-size:14px; line-height:1.5; position:relative; animation:popIn .25s ease; white-space:pre-line;}
    .message.user { align-self:flex-end; background:var(--primary); color:white; border-bottom-right-radius:4px; }
    .message.ai { align-self:flex-start; background:white; color:#333; border-bottom-left-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,.05); }
    @keyframes popIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    .cards-scroll { display:flex; gap:10px; overflow-x:auto; padding:10px 0 5px 0; margin-top:10px; width:100%; scrollbar-width:none; }
    .cards-scroll::-webkit-scrollbar { display:none; }

    .card { min-width:220px; max-width:220px; background:white; border-radius:12px; padding:10px; box-shadow:0 4px 10px rgba(0,0,0,.05);
            text-decoration:none; color:inherit; display:block; border:1px solid #f0f0f0; }
    .badge { font-size:10px; font-weight:900; letter-spacing:.6px; text-transform:uppercase; margin-bottom:6px; display:inline-block; }
    .badge.fallback { color:#b45309; background:#fff7ed; border:1px solid #fed7aa; padding:2px 6px; border-radius:999px;}
    .badge.place { color:#1d4ed8; background:#eff6ff; border:1px solid #bfdbfe; padding:2px 6px; border-radius:999px;}
    .badge.pharmacy { color:#991b1b; background:#fee2e2; border:1px solid #fecaca; padding:2px 6px; border-radius:999px;}
    .badge.product { color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:2px 6px; border-radius:999px;}

    .card img { width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:8px; background:#f9f9f9; }
    .card-title { font-weight:700; font-size:13px; margin-bottom:4px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .card-sub { font-size:11px; color:#666; }
    .card-sub.muted { color:#999; }

    .coach-card { background:#F0FDF9; border:1px solid #10B981; border-radius:12px; padding:15px; width:100%; margin-top:10px; }
    .coach-head { font-weight:900; color:#065F46; font-size:12px; margin:10px 0 6px; text-transform:uppercase; letter-spacing:.6px;}
    .coach-text { font-size:14px; color:#064E3B; margin:0 0 8px; }
    .coach-q { font-size:13px; color:#064E3B; margin:6px 0; padding-left:14px; position:relative; }
    .coach-q:before { content:"â€¢"; position:absolute; left:0; color:#10B981; font-weight:900; }
    .coach-boost { font-weight:800; color:#059669; }

    .input-area { background:white; padding:10px 15px; border-top:1px solid #e5e7eb; display:flex; gap:10px; align-items:center; }
    .input-box { flex:1; background:#F3F4F6; border:none; padding:12px; border-radius:24px; font-size:15px; outline:none; }
    .send-btn { background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }

    #modal { position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:99; display:flex; align-items:center; justify-content:center; }
    .modal-box { background:white; width:90%; max-width:400px; padding:25px; border-radius:20px; text-align:center; }
    .btn-opt { display:block; width:100%; padding:12px; margin-top:10px; border:2px solid #eee; border-radius:10px; background:white; font-weight:700; cursor:pointer; }
    .btn-opt.sel { border-color:var(--primary); background:#ECFDF5; }
  </style>
</head>

<body>
<div id="modal">
  <div class="modal-box">
    <h2>TanÄ±ÅŸalÄ±m EvladÄ±m</h2>
    <p style="color:#666; font-size:14px;">Sana nasÄ±l hitap edeyim?</p>
    <button class="btn-opt" onclick="setGender('female', this)">ðŸ‘© KÄ±zÄ±m</button>
    <button class="btn-opt" onclick="setGender('male', this)">ðŸ‘¨ OÄŸlum</button>

    <input type="text" id="cityIn" placeholder="Hangi Åžehir?"
           style="width:100%; padding:12px; margin-top:15px; border:1px solid #ddd; border-radius:10px;">

    <button class="btn-opt" style="background:var(--primary); color:white; border:none; margin-top:20px;" onclick="saveProfile()">BaÅŸla</button>
  </div>
</div>

<header class="header">
  <div class="logo"><span class="dot"></span> CAYNANA</div>
  <div class="mode-badge" id="modeBadge">AUTO</div>
</header>

<div id="chat-container">
  <div class="message ai">
    HoÅŸ geldin evladÄ±m. Ben Kaynanan.
    AlÄ±ÅŸveriÅŸ mi, yemek mi, gezi mi, dert miâ€¦ yaz gitsin.
  </div>
</div>

<div class="input-area">
  <input type="text" id="msgInput" class="input-box" placeholder="Bir ÅŸeyler yaz..."
         onkeypress="if(event.key==='Enter') sendMsg()">
  <button class="send-btn" onclick="sendMsg()"><i class="fa-solid fa-paper-plane"></i></button>
</div>

<script>
  let user = { gender: 'neutral', city: 'Ä°stanbul' };
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";

  function setGender(g, btn) {
    user.gender = g;
    document.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('sel'));
    btn.classList.add('sel');
  }

  function saveProfile() {
    const c = document.getElementById('cityIn').value.trim();
    if (c) user.city = c;
    document.getElementById('modal').style.display = 'none';
  }

  async function sendMsg() {
    const inp = document.getElementById('msgInput');
    const txt = inp.value.trim();
    if (!txt) return;

    addBubble(txt, 'user');
    inp.value = '';

    const loadEl = addBubble('Kaynanan dÃ¼ÅŸÃ¼nÃ¼yor...', 'ai', true);

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message: txt, user: user, mode_lock: 'auto' })
      });

      const data = await res.json();
      loadEl.remove();

      const aiEl = addBubble(data.assistant_text || '...', 'ai');

      document.getElementById('modeBadge').innerText = (data.intent || 'AUTO').toUpperCase();

      if (data.intent === 'life' && data.coach_plan) {
        renderCoachCard(aiEl, data.coach_plan);
      } else if (Array.isArray(data.cards) && data.cards.length > 0) {
        renderDataCards(aiEl, data.cards);
      }

    } catch(e) {
      loadEl.innerText = "Hata oldu evladÄ±m, tekrar dene.";
    }
  }

  function addBubble(text, type, temp=false) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerText = text;
    document.getElementById('chat-container').appendChild(div);
    div.scrollIntoView({behavior:'smooth'});
    return div;
  }

  function safeUrl(u) {
    const s = String(u || '').trim();
    if (!s) return '';
    if (s.startsWith('http://') || s.startsWith('https://')) return s;
    return '';
  }

  function badgeForCard(c) {
    const t = (c.type || '').toLowerCase();
    if (t === 'product') return `<span class="badge product">ÃœRÃœN</span>`;
    if (t === 'pharmacy') return `<span class="badge pharmacy">ECZANE</span>`;
    if (t === 'place') return `<span class="badge place">MEKAN</span>`;
    if (t === 'fallback') return `<span class="badge fallback">FALLBACK</span>`;
    return '';
  }

  function renderDataCards(parent, cards) {
    const scroll = document.createElement('div');
    scroll.className = 'cards-scroll';

    cards.forEach(c => {
      const a = document.createElement('a');
      a.className = 'card';

      const url = safeUrl(c.url);
      if (url) {
        a.href = url;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
      } else {
        a.href = 'javascript:void(0)';
        a.style.opacity = '0.6';
        a.style.pointerEvents = 'none';
      }

      const imgHtml = c.image ? `<img src="${c.image}" alt="">` : '';
      a.innerHTML = `
        ${badgeForCard(c)}
        ${imgHtml}
        <div class="card-title">${c.title || ''}</div>
        <div class="card-sub">${c.subtitle || ''}</div>
        <div class="card-sub muted">${c.footer || ''}</div>
      `;
      scroll.appendChild(a);
    });

    parent.appendChild(scroll);
    scroll.scrollIntoView({behavior:'smooth'});
  }

  function renderCoachCard(parent, plan) {
    const div = document.createElement('div');
    div.className = 'coach-card';

    const qs = Array.isArray(plan.clarifying_questions) ? plan.clarifying_questions : [];
    const wp = Array.isArray(plan.week_plan) ? plan.week_plan : [];

    div.innerHTML = `
      <div class="coach-head">DURUM</div>
      <div class="coach-text">${plan.summary || ''}</div>

      <div class="coach-head">3 SORU</div>
      ${qs.slice(0,3).map(q => `<div class="coach-q">${q}</div>`).join('')}

      <div class="coach-head">BUGÃœN</div>
      <div class="coach-text">ðŸ‘‰ ${plan.today_step || ''}</div>

      <div class="coach-head">5 GÃœN</div>
      ${wp.slice(0,5).map(x => `<div class="coach-q">${x}</div>`).join('')}

      <div class="coach-head">TATLI SERT</div>
      <div class="coach-boost">"${plan.confidence_boost || ''}"</div>
    `;

    parent.appendChild(div);
    div.scrollIntoView({behavior:'smooth'});
  }
</script>
</body>
</html>
