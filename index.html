<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#FFFFFF">
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ 
    --primary: #00C897; 
    --primary-dark: #00A87E;
    --primary-soft: rgba(0, 200, 151, 0.12);
    --accent: #FFB300;
    --text-main: #1A1A1A;
    --text-muted: #4A4A4A;
    --font-main: 'Outfit', sans-serif;
    --border-light: #F0F0F0;
  }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
  
  body { 
    font-family: var(--font-main); 
    background: #000;
    height: 100dvh; display: flex; justify-content: center; 
    color: var(--text-main); 
    overscroll-behavior: none;
  }
  
  /* --- ANA SAHNE (TÃœM EKRAN RESÄ°M) --- */
  #app { 
    width: 100%; max-width: 480px; height: 100%; 
    position: relative; display: flex; flex-direction: column; 
    
    /* FALLBACK: resim yÃ¼klenmezse bu gÃ¶rÃ¼nÃ¼r */
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    background-position: center bottom;
    background-size: cover;
    background-repeat: no-repeat;
    
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    transition: background-image 0.25s ease-in-out;
  }

  /* YazÄ± okunurluÄŸu iÃ§in overlay (resmi BOÄMAYACAK ayar) */
  #app::after {
    content: ""; position: absolute; inset: 0;
    background: linear-gradient(to bottom, 
      rgba(255,255,255,0.70) 0%, 
      rgba(255,255,255,0.25) 35%, 
      rgba(255,255,255,0) 70%
    );
    pointer-events: none; z-index: 0;
  }

  /* --- HEADER --- */
  #topbar {
    height: 68px; display: flex; align-items: center; justify-content: space-between; 
    padding: 0 20px; z-index: 20; position: relative;
  }
  .brand { 
    font-weight: 800; color: var(--text-main); font-size: 24px; 
    display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; cursor: pointer;
  } 
  .brand i { color: var(--primary); font-size: 22px; } 
  .brand span { color: var(--primary); }
  .menu-btn { 
    font-size: 22px; color: var(--text-main); cursor: pointer; 
    width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.55); border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.06);
  }

  /* --- ORTA ALAN --- */
  #main { 
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding: 0 20px 220px 20px;
    position: relative; z-index: 10;
    display: flex; flex-direction: column;
  }

  .hero-content {
    margin-top: 40px; text-align: center;
    animation: fadeIn 0.6s ease;
  }
  .hero-title { 
    font-size: 36px; font-weight: 800; line-height: 1.1; margin-bottom: 10px;
    color: var(--text-main); letter-spacing: -1px;
    text-shadow: 0 2px 10px rgba(255,255,255,0.7);
  }
  .hero-desc { 
    font-size: 17px; font-weight: 600; color: var(--text-muted); 
    line-height: 1.4; text-shadow: 0 1px 6px rgba(255,255,255,0.6);
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Sohbet */
  .msg-container { margin-top: 20px; width: 100%; display: none; }
  .msg { display: flex; margin-bottom: 16px; }
  .msg.user { justify-content: flex-end; } .msg.ai { justify-content: flex-start; }
  .bubble { 
    max-width: 85%; padding: 14px 18px; border-radius: 20px; 
    font-size: 15px; line-height: 1.5; 
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); font-weight: 500;
  }
  .msg.user .bubble { background: var(--primary); color: #fff; border-bottom-right-radius: 4px; }
  .msg.ai .bubble { background: #fff; color: var(--text-main); border-bottom-left-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }

  /* Kartlar */
  .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
  .card { background: #fff; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; }
  .card-badge { position: absolute; top: 10px; left: 0; padding: 4px 10px; font-size: 10px; font-weight: 800; border-radius: 0 8px 8px 0; color: #fff; z-index: 2; }
  .card-badge.gold { background: linear-gradient(90deg, #FFB300, #FF8F00); }
  .card-badge.silver { background: linear-gradient(90deg, #9E9E9E, #757575); }
  .card-badge.value { background: linear-gradient(90deg, #00C897, #00A87E); }
  .pimg { width: 100%; height: 120px; object-fit: contain; margin-bottom: 10px; }
  .title { font-size: 13px; font-weight: 700; height: 36px; overflow: hidden; margin-bottom: 5px; color: #333; }
  .price { font-size: 16px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
  .btnLink { background: var(--primary); color: #fff; padding: 8px; border-radius: 8px; text-align: center; font-size: 12px; text-decoration: none; display: block; font-weight: 700; }
  .btnLink.btn-gold { background: #FFB300; } .btnLink.btn-silver { background: #9E9E9E; } .btnLink.btn-blue { background: #00C897; }

  /* --- BOTTOM AREA --- */
  #bottom { 
    position: absolute; bottom: 0; left: 0; right: 0; 
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    z-index: 50; padding-bottom: env(safe-area-inset-bottom);
    border-top: 1px solid rgba(0,0,0,0.06);
  }

  .suggestion-box {
    background: #fff; color: var(--primary); font-size: 13px; font-weight: 700;
    padding: 10px 20px; border-radius: 99px; margin: -20px auto 10px auto; 
    width: max-content; max-width: 90%; text-align: center; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid #E0E0E0;
  }

  .input-wrapper { padding: 10px 20px; display: flex; gap: 10px; align-items: center; }
  .search-bar {
    flex: 1; height: 54px; background: #fff; border: 1px solid #E0E0E0;
    border-radius: 27px; display: flex; align-items: center; padding: 0 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.3s;
  }
  .search-bar:focus-within { border-color: var(--primary); box-shadow: 0 4px 15px rgba(0, 200, 151, 0.2); }
  #text { flex: 1; border: none; background: transparent; font-size: 16px; margin: 0 10px; color: #333; }
  
  #sendBtn {
    width: 54px; height: 54px; border-radius: 50%; border: none;
    background: var(--primary); color: #fff; font-size: 20px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 200, 151, 0.3); transition: 0.2s;
  }
  #sendBtn:active { transform: scale(0.9); }
  #sendBtn:disabled { opacity: .65; }

  /* Dock */
  .dock-container { padding: 10px 20px 20px 20px; overflow-x: auto; display: flex; gap: 20px; scrollbar-width: none; }
  .dock-container::-webkit-scrollbar { display: none; }
  .dock-item { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 60px; opacity: 0.5; transition: 0.3s; cursor: pointer; }
  .dock-item.active { opacity: 1; transform: translateY(-3px); }
  .dock-icon-box { width: 48px; height: 48px; background: rgba(0,0,0,0.05); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #666; transition: 0.3s; }
  .dock-item.active .dock-icon-box { background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(0, 200, 151, 0.3); }
  .dock-label { font-size: 11px; font-weight: 800; color: #333; }

  .tool-btn { color: #999; font-size: 18px; padding: 5px; cursor: pointer; }
  .mic-active { color: #F44336 !important; animation: pulse 1s infinite; }
  @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
  #fileInput { display: none; }
</style>
</head>

<body>
<div id="app">
  <header id="topbar">
    <div class="brand" onclick="switchMode('shopping')">
      <i class="fa-solid fa-wand-magic-sparkles"></i> CAYNANA<span>.AI</span>
    </div>
    <div class="menu-btn"><i class="fa-solid fa-bars"></i></div>
  </header>

  <main id="main">
    <div id="heroContent" class="hero-content">
      <h1 class="hero-title" id="heroTitle">Almadan Ã¶nce<br>Caynanaâ€™ya sor.</h1>
      <p class="hero-desc" id="heroDesc">Sonra â€œkeÅŸkeâ€ dememek iÃ§in buradayÄ±m.</p>
    </div>
    <div id="chatContainer" class="msg-container"></div>
  </main>

  <footer id="bottom">
    <div class="suggestion-box" id="suggestionText">Her indirime atlayan sonunda pahalÄ± Ã¶der.</div>

    <div class="input-wrapper">
      <div class="search-bar">
        <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <input id="text" placeholder="Ne arÄ±yorsun evladÄ±m?" autocomplete="off"
               onkeypress="if(event.key==='Enter') send()">
        <div class="tool-btn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div class="dock-container" id="dock"></div>
  </footer>
</div>

<input type="file" id="fileInput" accept="image/*" capture="environment">

<script>
  const API_URL = "https://bikonomi-api-2.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-2.onrender.com/api/speak";

  let sessionId = "sess_" + Math.random().toString(36).slice(2, 10);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "shopping";
  let isSending = false;
  const chatHistory = {};

  marked.setOptions({ mangle: false, headerIds: false });

  // âœ… HERO GÃ–RSELLERÄ° BURADA (LOCAL)
  // Åu dosyalar images klasÃ¶rÃ¼nde olmalÄ±:
  // /images/hero-shopping.png
  // /images/hero-chat.png
  // /images/hero-fal.png
  // /images/hero-health.png
  // /images/hero-diet.png
  // /images/hero-food.png
  // /images/hero-law.png
  // /images/hero-dream.png
  // /images/hero-translate.png
  // /images/hero-astro.png
  const MODES = {
    shopping: { label:"AlÄ±ÅŸveriÅŸ", icon:"fa-bag-shopping", color:"#00C897",
      title:"Almadan Ã¶nce<br>Caynanaâ€™ya sor.", desc:"Sonra â€œkeÅŸkeâ€ dememek iÃ§in buradayÄ±m.",
      img:"/images/hero-shopping.png", ph:"Ne arÄ±yorsun evladÄ±m?", sugg:"Her indirime atlayan sonunda pahalÄ± Ã¶der.",
      gradient:"linear-gradient(135deg,#fdfbfb 0%,#ebedee 100%)"
    },
    chat: { label:"Sohbet", icon:"fa-comments", color:"#FFB300",
      title:"Caynana ile<br>iki lafÄ±n belini kÄ±r.", desc:"Biraz dur bakalÄ±m, neler anlatacaksÄ±n?",
      img:"/images/hero-chat.png", ph:"Naber Caynana?", sugg:"Benim zamanÄ±mda her ÅŸey daha gÃ¼zeldi ah ahâ€¦",
      gradient:"linear-gradient(135deg,#fff8e1 0%,#ffecb3 100%)"
    },
    fal: { label:"Fal", icon:"fa-mug-hot", color:"#8B5CF6",
      title:"Kahveni iÃ§tin mi?<br>Gel falÄ±na bakayÄ±m.", desc:"Fal eÄŸlencedir evladÄ±m, ama bazen tutar.",
      img:"/images/hero-fal.png", ph:"FincanÄ± kapattÄ±n mÄ±?", sugg:"Hemen inanma ama kulak da tÄ±ka.",
      gradient:"linear-gradient(135deg,#f3e5f5 0%,#ce93d8 100%)"
    },
    health: { label:"SaÄŸlÄ±k", icon:"fa-heart-pulse", color:"#EF4444",
      title:"Caynana SaÄŸlÄ±k'la<br>alÄ±ÅŸkanlÄ±k kazan.", desc:"Neren aÄŸrÄ±yor sÃ¶yle bakayÄ±m?",
      img:"/images/hero-health.png", ph:"Neren aÄŸrÄ±yor?", sugg:"Ã‡ay Ã¼stÃ¼ne sakÄ±n soÄŸuk su iÃ§me!",
      gradient:"linear-gradient(135deg,#ffebee 0%,#ef9a9a 100%)"
    },
    diet: { label:"Diyet", icon:"fa-carrot", color:"#84CC16",
      title:"Caynana Diyet'le<br>saÄŸlÄ±klÄ± beslen!", desc:"AÃ§lÄ±ktan deÄŸil, keyiften yiyin.",
      img:"/images/hero-diet.png", ph:"Boy kilo kaÃ§ evladÄ±m?", sugg:"Ekmek deÄŸil, yeÅŸillik ye yeÅŸillik.",
      gradient:"linear-gradient(135deg,#f1f8e9 0%,#aed581 100%)"
    },
    food: { label:"Yemek", icon:"fa-utensils", color:"#F97316",
      title:"Caynana Yemek'le<br>en lezzetli tarifler!", desc:"Ne piÅŸirsem evladÄ±m? EkranÄ± kokutalÄ±m mÄ±?",
      img:"/images/hero-food.png", ph:"Dolapta ne var?", sugg:"Malzemeyi ziyan etme, bereket kaÃ§ar.",
      gradient:"linear-gradient(135deg,#fff3e0 0%,#ffcc80 100%)"
    },
    law: { label:"Hukuk", icon:"fa-scale-balanced", color:"#3B82F6",
      title:"Caynana Hukuk'la<br>kim haklÄ± Ã¶ÄŸren!", desc:"Ben avukat deÄŸilim ama Ã§ok dava gÃ¶rdÃ¼m.",
      img:"/images/hero-law.png", ph:"Derdini kÄ±saca anlat.", sugg:"SÃ¶zleÅŸmeye bakmadan imza atma!",
      gradient:"linear-gradient(135deg,#e3f2fd 0%,#90caf9 100%)"
    },
    dream: { label:"RÃ¼ya", icon:"fa-cloud-moon", color:"#6366F1",
      title:"RÃ¼yada yÄ±lan mÄ±?<br>Gel tabir edeyim.", desc:"HayÄ±rdÄ±r inÅŸallah de bakalÄ±m.",
      img:"/images/hero-dream.png", ph:"Ne gÃ¶rdÃ¼n rÃ¼yanda?", sugg:"RÃ¼yalar tersine Ã§Ä±kar derler amaâ€¦",
      gradient:"linear-gradient(135deg,#e8eaf6 0%,#9fa8da 100%)"
    },
    translate: { label:"Ã‡eviri", icon:"fa-language", color:"#64748B",
      title:"UygarlÄ±k destanÄ±<br>ne demek Ä°talyanca?", desc:"SÃ¶yle Ã§evireyim evladÄ±m.",
      img:"/images/hero-translate.png", ph:"Ne yazÄ±yor orada?", sugg:"Dil bilmek altÄ±n bileziktir.",
      gradient:"linear-gradient(135deg,#eceff1 0%,#b0bec5 100%)"
    },
    astro: { label:"BurÃ§", icon:"fa-star", color:"#D946EF",
      title:"YÄ±ldÄ±zlar senin iÃ§in<br>ne diyor?", desc:"MerkÃ¼r retrosu falan, dikkat et.",
      img:"/images/hero-astro.png", ph:"Burcun ne senin?", sugg:"YÄ±ldÄ±znameye baktÄ±m, yolun aÃ§Ä±k.",
      gradient:"linear-gradient(135deg,#f3e5f5 0%,#e1bee7 100%)"
    }
  };

  function renderDock() {
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key => {
      const m = MODES[key];
      const div = document.createElement("div");
      div.className = `dock-item ${key === currentMode ? 'active' : ''}`;
      div.onclick = () => switchMode(key);
      div.innerHTML = `
        <div class="dock-icon-box"><i class="fa-solid ${m.icon}"></i></div>
        <span class="dock-label">${m.label}</span>
      `;
      dock.appendChild(div);
    });
  }

  // âœ… Resmi preload edip yÃ¼klendiyse background'a basÄ±yoruz.
  function setBackgroundSmart(imgPath, gradient){
    const app = document.getElementById("app");
    // Ã¶nce gradient
    app.style.backgroundImage = gradient;

    const bust = `${imgPath}?v=${Date.now()}`;
    const img = new Image();
    img.onload = () => { app.style.backgroundImage = `url("${bust}")`; };
    img.onerror = () => { /* gradient kalsÄ±n */ };
    img.src = bust;
  }

  function switchMode(newMode) {
    // audio reset
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove("playing");
      b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`;
    });

    // history
    const html = document.getElementById("chatContainer").innerHTML;
    chatHistory[currentMode] = html.length > 60000 ? html.slice(-60000) : html;

    currentMode = newMode;
    const m = MODES[newMode];

    // âœ… background
    setBackgroundSmart(m.img, m.gradient);

    // âœ… color
    document.documentElement.style.setProperty('--primary', m.color);

    // text
    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerText = m.desc;
    document.getElementById("text").placeholder = m.ph;
    document.getElementById("suggestionText").innerText = m.sugg;

    // restore chat
    const savedChat = chatHistory[newMode] || "";
    const chat = document.getElementById("chatContainer");
    chat.innerHTML = savedChat;

    if (savedChat.trim() !== "") {
      document.getElementById("heroContent").style.display = "none";
      chat.style.display = "block";
      document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
    } else {
      document.getElementById("heroContent").style.display = "block";
      chat.style.display = "none";
    }

    renderDock();
  }

  function resizeImage(base64Str, maxWidth = 1024) {
    return new Promise((resolve) => {
      let img = new Image();
      img.src = base64Str;
      img.onload = () => {
        let canvas = document.createElement('canvas');
        let width = img.width; 
        let height = img.height; 
        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
        canvas.width = width; canvas.height = height;
        let ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
      };
      img.onerror = () => resolve(base64Str);
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function safeLink(u){
    try{
      const url = new URL(u, location.href); 
      if (url.protocol === "http:" || url.protocol === "https:") return url.toString();
    }catch(e){}
    return "";
  }

  function safeImg(u){
    try{
      const url = new URL(u, location.href);
      if (url.protocol === "http:" || url.protocol === "https:") return url.toString();
    } catch(e){}
    return "https://via.placeholder.com/150?text=Resim+Yok";
  }

  async function send() {
    if (isSending) return;

    const txtEl = document.getElementById("text");
    let val = txtEl.value.trim();

    if (pendingImage && val === "") {
      if(currentMode === 'fal') val = "Bu fotoÄŸraftaki fala bak";
      else if(currentMode === 'translate') val = "Bunu Ã§evir";
      else val = "Buna bak evladÄ±m";
    }

    if (!val && !pendingImage) return;

    // alÄ±ÅŸveriÅŸte eski kartlarÄ± temizle
    if (currentMode === "shopping" && (val || pendingImage)) {
      document.querySelectorAll("#chatContainer .cards").forEach(el => el.remove());
    }

    isSending = true;
    document.getElementById("sendBtn").disabled = true;

    // hero -> chat
    document.getElementById("heroContent").style.display = "none";
    document.getElementById("chatContainer").style.display = "block";

    addBubble("user", val, false, null, pendingImage);
    txtEl.value = "";

    const loaderId = "loader_" + Date.now();
    addBubble("ai", "<i class='fa-solid fa-circle-notch fa-spin'></i> BakÄ±yorum...", true, null, null, loaderId);

    let finalImage = pendingImage;
    if(finalImage && finalImage.length > 250000) {
      try { finalImage = await resizeImage(finalImage); } catch(e){}
    }

    const payload = { message: val, session_id: sessionId, image: finalImage, mode: currentMode };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const data = await res.json();
      document.getElementById(loaderId)?.remove();

      addBubble("ai", data.assistant_text || "Hehâ€¦ bir ÅŸey diyemedim evladÄ±m.", false, data.speech_text || null);

      if (data.data && data.data.length) renderCards(data.data);

    }catch(e){
      const el = document.getElementById(loaderId);
      if (el) el.innerHTML = "Ä°nternet gitti galiba evladÄ±m.";
    }finally{
      isSending = false;
      document.getElementById("sendBtn").disabled = false;
    }
  }

  function addBubble(role, text, isLoader=false, speech=null, imgData=null, customId=null) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    if(customId) div.id = customId;

    let content = "";
    if (imgData) content += `<img src="${imgData}" style="max-width:100%; border-radius:10px; margin-bottom:10px;">`;

    let htmlContent = text;
    if (role === "ai" && !isLoader) {
      const raw = marked.parse(text);
      htmlContent = DOMPurify.sanitize(raw, { USE_PROFILES: { html: true } });
    } else if (role === "user") {
      htmlContent = escapeHtml(text);
    }

    div.innerHTML = `<div class="bubble">${content + htmlContent}</div>`;

    if (speech && role === "ai" && !isLoader) {
      const btn = document.createElement("div");
      btn.className = "audio-btn";
      btn.setAttribute("data-speech", speech);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`;
      div.querySelector(".bubble").appendChild(btn);
    }

    document.getElementById("chatContainer").appendChild(div);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  function pickBadge(p, idx) {
    const t = (p.caynana_trust?.badge || p.badge || p.rank || p.type || p.tag || "").toString().toLowerCase();
    if (t.includes("sponsor")) return { key:"gold", text:"SPONSORLU" };
    if (t.includes("gold") || t.includes("altÄ±n") || t.includes("efsane")) return { key:"gold", text:"ALTIN Ã–NERÄ°" };
    if (t.includes("silver") || t.includes("gÃ¼mÃ¼ÅŸ") || t.includes("iyi")) return { key:"silver", text:"GÃœMÃœÅ SEÃ‡Ä°M" };
    if (t.includes("perf") || t.includes("fiyat") || t.includes("value")) return { key:"value", text:"FÄ°YAT/PERF" };
    if (idx === 0) return { key:"gold", text:"ALTIN Ã–NERÄ°" };
    if (idx === 1) return { key:"silver", text:"GÃœMÃœÅ SEÃ‡Ä°M" };
    if (idx === 2) return { key:"value", text:"FÄ°YAT/PERF" };
    return null;
  }

  function renderCards(list) {
    const wrap = document.createElement("div");
    wrap.className = "cards";

    list.forEach((p, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      const badge = pickBadge(p, idx);
      const badgeHtml = badge ? `<div class="card-badge ${badge.key}">${badge.text}</div>` : "";

      const title = escapeHtml(String(p.title || ""));
      const price = escapeHtml(String(p.price || ""));
      const url = p.url ? safeLink(String(p.url)) : "";
      const img = p.image ? safeImg(String(p.image)) : 'https://via.placeholder.com/150?text=Resim+Yok';

      const btnClass = badge?.key === "gold" ? "btn-gold" : badge?.key === "silver" ? "btn-silver" : "btn-blue";
      const btnHTML = url ? `<a class="btnLink ${btnClass}" target="_blank" rel="noopener noreferrer" href="${url}">Ä°NCELE</a>` : "";
      const priceHTML = price ? `<div class="price">${price}</div>` : "";

      card.innerHTML = `
        ${badgeHtml}
        <img class="pimg" src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Resim+Yok'">
        <div class="title">${title}</div>
        ${priceHTML}
        ${btnHTML}
      `;

      wrap.appendChild(card);
    });

    document.getElementById("chatContainer").appendChild(wrap);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  // audio toggle
  async function playAudio(text, btn) {
    const wasPlayingThisBtn = btn.classList.contains('playing');

    if (currentAudio) { currentAudio.pause(); currentAudio = null; }

    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove('playing');
      b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`;
    });

    if (wasPlayingThisBtn) return;

    const originalText = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...`;

    try {
      const res = await fetch(SPEAK_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ text }) });
      const blob = await res.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = () => {
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`;
        btn.classList.remove('playing');
        currentAudio = null;
      };
      await currentAudio.play();
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sus KÄ±z!`;
      btn.classList.add('playing');
    } catch (e) {
      btn.innerHTML = "Hata";
      setTimeout(()=> btn.innerHTML = originalText, 1500);
    }
  }

  document.getElementById("chatContainer").addEventListener("click", (e) => {
    const btn = e.target.closest(".audio-btn");
    if (!btn) return;
    const speech = btn.getAttribute("data-speech");
    if (speech) playAudio(speech, btn);
  });

  // camera
  const fileEl = document.getElementById("fileInput");
  function openCamera(){ fileEl.value=""; fileEl.click(); }

  fileEl.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => { 
      pendingImage = reader.result;
      document.getElementById("text").value = "ğŸ“· FotoÄŸraf eklendi";
      document.getElementById("text").focus();
    };
    reader.readAsDataURL(file);
  });

  function startMic(){ alert("Mikrofon kÄ±smÄ± sende zaten Ã§alÄ±ÅŸÄ±yordu; gerekirse yine aÃ§arÄ±z."); }

  // init
  renderDock();
  switchMode("shopping");
</script>
</body>
</html>
