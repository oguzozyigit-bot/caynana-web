import os
import json
import base64
import requests
import uvicorn
import io
from typing import Optional, List, Dict, Any
from dotenv import load_dotenv

from fastapi import FastAPI, Request, Response
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import google.generativeai as genai
from openai import OpenAI # OpenAI Eklendi
from google.generativeai.types import HarmCategory, HarmBlockThreshold

load_dotenv()

# ---- AYARLAR ----
APP_NAME = "CAYNANA.AI API"
# Render Environment Variables'dan okur
GEMINI_KEY = os.getenv("GOOGLE_API_KEY") or os.getenv("GEMINI_API_KEY")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
SCRAPER_KEY = os.getenv("SCRAPER_API_KEY") or os.getenv("SCRAPERAPI_KEY")
SERP_KEY = os.getenv("SERP_API_KEY")

# ---- İSTEMCİLERİ BAŞLAT ----
genai.configure(api_key=GEMINI_KEY)
# OpenAI İstemcisi (Ses İçin)
openai_client = None
if OPENAI_KEY:
    openai_client = OpenAI(api_key=OPENAI_KEY)

# ---- MODEL SEÇİCİ ----
# Güvenlik ayarlarını gevşet (Rahat konuşsun)
SAFETY_SETTINGS = {
    HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
}

def get_active_model(system_instruction=None):
    # Öncelikli modeller
    models = ['gemini-1.5-flash', 'gemini-1.5-flash-001', 'gemini-1.5-pro']
    for m in models:
        try:
            return genai.GenerativeModel(m, safety_settings=SAFETY_SETTINGS, system_instruction=system_instruction)
        except:
            continue
    return None

app = FastAPI(title=APP_NAME)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ---- PERSONA (MOD) AYARLARI ----
PERSONAS = {
    "huysuz": {
        "voice": "alloy", "speed": 0.9,
        "instruction": "Sen 'Huysuz Caynana'sın. Eski toprak, teknolojiden anlamayan, sürekli sitem eden birisin. Kullanıcıya 'evladım' de ama hep bir iğneleme yap. Cevapların KISA olsun (Max 2 cümle)."
    },
    "sevecen": {
        "voice": "shimmer", "speed": 1.0,
        "instruction": "Sen 'Pamuk Caynana'sın. Çok tatlı, dua eden, pozitif bir teyzesin. Kullanıcıya 'kuzum', 'yavrum' de. Cevapların KISA ve tatlı olsun (Max 2 cümle)."
    },
    "itirazci": {
        "voice": "onyx", "speed": 1.0,
        "instruction": "Sen 'İtirazcı Caynana'sın. Hiçbir şeye inanmazsın, her şeye muhalefetsin. 'Emin misin?', 'Kandırıyorlar sizi!' de. Cevapların KISA olsun."
    },
    "kizgin": {
        "voice": "nova", "speed": 1.15,
        "instruction": "Sen 'Barut Caynana'sın. Çok sinirlisin, tahammülün yok! Kullanıcıya fırça at. 'Beni niye yoruyorsun!' de. Cevapların KISA ve SERT olsun!"
    }
}

class ChatRequest(BaseModel):
    message: str = ""
    session_id: str = ""
    mode: str = "shopping"
    image: Optional[str] = None
    persona: str = "huysuz" # Varsayılan mod

class ChatResponse(BaseModel):
    assistant_text: str
    speech_text: Optional[str] = None
    data: List[Dict[str, Any]] = []

# ---- ARAMA FONKSİYONLARI ----
def search_products(query: str):
    if SCRAPER_KEY:
        try:
            r = requests.get('https://api.scraperapi.com/structured/google_shopping', 
                           params={'api_key': SCRAPER_KEY, 'query': query, 'country_code': 'tr', 'tld': 'com.tr'}, timeout=15)
            if r.status_code == 200:
                return [{"title": i.get("title"), "price": f"{i.get('price_amount')} {i.get('price_currency')}", "image": i.get("image"), "url": i.get("link"), "badge": "Fırsat"} for i in r.json().get('shopping_results', [])[:4]]
        except: pass
    return []

# ---- ENDPOINTS ----

@app.post("/api/chat", response_model=ChatResponse)
async def api_chat(req: ChatRequest):
    # 1. Mod Seçimi
    persona_conf = PERSONAS.get(req.persona, PERSONAS["huysuz"])
    
    # 2. Modeli Hazırla (Karaktere büründür)
    model = get_active_model(system_instruction=persona_conf["instruction"])
    if not model:
        return ChatResponse(assistant_text="Ay başım ağrıdı, sistem çalışmıyor evladım.")

    try:
        # GÖRSEL VARSA
        if req.image:
            img_data = req.image.split(",")[1] if "base64," in req.image else req.image
            response = model.generate_content([req.message or "Bu nedir?", {"mime_type": "image/jpeg", "data": base64.b64decode(img_data)}])
            return ChatResponse(assistant_text=response.text, speech_text=response.text)

        # ALIŞVERİŞ MODU
        products = []
        if req.mode == "shopping":
            # Önce ürün arıyor mu kontrol et
            check = model.generate_content(f"Kullanıcı: '{req.message}'. Ürün aranıyorsa sadece 'EVET ürün_adı', aranmıyorsa 'HAYIR' yaz.")
            if "EVET" in check.text:
                query = check.text.replace("EVET", "").strip()
                products = search_products(query)
                context = f"Bulunan ürünler: {json.dumps(products)}. Bunları moduna uygun yorumla."
            else:
                context = "Sohbet et."
            
            final_res = model.generate_content(f"{context} Kullanıcı: {req.message}")
            return ChatResponse(assistant_text=final_res.text, speech_text=final_res.text, data=products)

        # NORMAL SOHBET
        response = model.generate_content(req.message)
        return ChatResponse(assistant_text=response.text, speech_text=response.text)

    except Exception as e:
        return ChatResponse(assistant_text=f"Tansiyonum düştü... (Hata: {str(e)})")

@app.post("/api/speak")
async def api_speak(request: Request):
    data = await request.json()
    text = data.get("text", "")
    persona_key = data.get("persona", "huysuz")
    
    if not openai_client:
        return {"error": "OpenAI API Key eksik"}

    # Moda göre ses ayarları
    settings = PERSONAS.get(persona_key, PERSONAS["huysuz"])
    
    try:
        response = openai_client.audio.speech.create(
            model="tts-1",
            voice=settings["voice"],
            input=text,
            speed=settings["speed"]
        )
        
        return Response(content=response.content, media_type="audio/mpeg")
    except Exception as e:
        return {"error": str(e)}

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)
