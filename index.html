<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
  <title>Caynana AI</title>
  <link rel="icon" href="data:," />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{
      --bg0:#07070a;
      --bg1:#0b0b12;
      --glass: rgba(22,22,30,.78);
      --glass2: rgba(22,22,30,.92);
      --border: rgba(255,255,255,.12);
      --text:#ececec;
      --muted:#a9a9b3;
      --primary:#E6C25B;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --r: 18px;
      --r2: 22px;
      --safe: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(230,194,91,.18), transparent 55%),
        radial-gradient(900px 700px at 90% 15%, rgba(145,120,255,.14), transparent 55%),
        radial-gradient(900px 700px at 40% 100%, rgba(129,199,132,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      overflow-x:hidden;
    }

    .app{
      max-width: 980px;
      margin: 0 auto;
      padding: calc(14px + var(--safe)) 14px 16px;
    }

    /* TOP BAR */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position: sticky;
      top: 0;
      padding: 10px 0 12px;
      z-index: 30;
      backdrop-filter: blur(12px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }

    /* Eye animated logo */
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .logo::before{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 30% 30%, rgba(230,194,91,.45), transparent 55%),
                  radial-gradient(circle at 70% 70%, rgba(145,120,255,.35), transparent 55%);
      transform: rotate(18deg);
      opacity:.9;
    }
    .eyes{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      z-index:2;
    }
    .eye{
      width:10px; height:10px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      position:relative;
      overflow:hidden;
      transform: translateY(1px);
      animation: blink 5.8s infinite;
    }
    .eye:nth-child(2){ animation-delay: .2s; }
    .pupil{
      width:4px; height:4px;
      border-radius:999px;
      background: rgba(0,0,0,.72);
      position:absolute;
      left:3px; top:3px;
      animation: look 4.2s ease-in-out infinite;
    }
    @keyframes blink{
      0%, 92%, 100%{ transform: scaleY(1) translateY(1px); }
      94%{ transform: scaleY(.12) translateY(1px); }
      96%{ transform: scaleY(1) translateY(1px); }
    }
    @keyframes look{
      0%, 100%{ transform: translate(0,0); }
      25%{ transform: translate(2px,1px); }
      50%{ transform: translate(-1px,2px); }
      75%{ transform: translate(1px,-1px); }
    }

    .brandTitle{
      line-height:1.05;
    }
    .brandTitle b{ font-size:14px; letter-spacing:.2px; }
    .brandTitle div{ font-size:12px; color:var(--muted); margin-top:2px; }

    .topActions{
      display:flex; align-items:center; gap:10px;
    }

    .iconBtn{
      width:42px; height:42px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      box-shadow: 0 8px 26px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn:active{ transform: scale(.98); }
    .iconBtn svg{ width:18px; height:18px; stroke: rgba(255,255,255,.85); fill:none; stroke-width:2; }

    /* HERO CARD */
    .hero{
      display:flex;
      gap:14px;
      padding: 14px;
      border-radius: var(--r2);
      background: var(--glass);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::after{
      content:"";
      position:absolute;
      right:-120px; top:-120px;
      width:280px; height:280px;
      background: radial-gradient(circle, rgba(230,194,91,.18), transparent 60%);
      filter: blur(0px);
      pointer-events:none;
    }
    .heroLeft{ flex:1; min-width: 0; }
    .heroTitle{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .heroDesc{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.45;
      margin-bottom: 12px;
    }
    .heroPills{ display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      font-size:12px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.85);
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px; height:8px;
      border-radius: 999px;
      background: var(--primary);
      box-shadow: 0 0 0 6px rgba(230,194,91,.12);
    }
    .heroRight{
      width: 120px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .heroImg{
      width:110px; height:110px;
      border-radius: 22px;
      object-fit: cover;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      transition: opacity .25s ease;
    }

    /* lines (alttaki renk √ßizgileri) */
    .oz-lines{
      display:flex;
      gap:8px;
      padding: 12px 4px 0;
      opacity: .9;
    }
    .oz-lines span{
      flex:1;
      height:5px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      transition: background .25s ease;
    }

    /* INPUT AREA */
    .panel{
      margin-top: 12px;
      border-radius: var(--r2);
      border:1px solid var(--border);
      background: var(--glass2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .chatArea{
      height: min(54vh, 520px);
      overflow:auto;
      padding: 12px;
      scroll-behavior:smooth;
    }
    .msg-row{ display:flex; margin: 10px 0; }
    .msg-row.user{ justify-content:flex-end; }
    .msg-row.bot{ justify-content:flex-start; }

    .msg-bubble{
      max-width: 82%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      line-height: 1.45;
      font-size: 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg-bubble.user{
      background: linear-gradient(180deg, rgba(230,194,91,.20), rgba(230,194,91,.10));
      border-color: rgba(230,194,91,.22);
    }
    .msg-bubble.bot{
      background: rgba(255,255,255,.06);
    }

    .composer{
      display:flex;
      gap:10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,.08);
      align-items:flex-end;
    }
    .inp{
      flex:1;
      min-height: 44px;
      max-height: 120px;
      resize:none;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      font-size:14px;
      line-height:1.3;
    }
    .sendBtn{
      width: 52px; height: 44px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(230,194,91,.14);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .sendBtn:active{ transform: scale(.98); }
    .sendBtn svg{ width:18px; height:18px; stroke: rgba(255,255,255,.88); fill:none; stroke-width:2; }

    /* DOCK */
    .dock{
      margin-top: 12px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 2px;
    }
    .dock-item{ flex:0 0 auto; cursor:pointer; }
    .dock-icon{
      width:54px; height:54px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      position:relative;
    }
    .dock-icon::after{
      content:"";
      position:absolute; inset: -1px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.08);
      pointer-events:none;
    }

    /* DRAWER (ALBENƒ∞Lƒ∞) */
    .drawerMask{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      z-index: 80;
    }
    .drawer{
      position:absolute;
      top:0; right:0;
      width: min(92vw, 360px);
      height: 100%;
      background: linear-gradient(180deg, rgba(22,22,30,.96), rgba(16,16,22,.96));
      border-left: 1px solid rgba(255,255,255,.10);
      box-shadow: -20px 0 60px rgba(0,0,0,.55);
      padding: calc(14px + var(--safe)) 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drawerTop{
      display:flex; align-items:center; justify-content:space-between;
    }
    .drawerTitle{
      font-weight:900;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .chip{
      font-size: 11px;
      color: rgba(255,255,255,.85);
      padding: 6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
    }

    .profileCard{
      border-radius: 18px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      padding: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      position:relative;
      overflow:hidden;
    }
    .profileCard::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(230,194,91,.18), transparent 50%),
                  radial-gradient(circle at 80% 40%, rgba(145,120,255,.16), transparent 50%);
      transform: rotate(20deg);
      opacity:.85;
      pointer-events:none;
    }
    .avatar{
      width:46px; height:46px;
      border-radius: 16px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      position:relative;
      z-index:1;
    }
    .pinfo{ position:relative; z-index:1; min-width:0; }
    .pname{ font-weight:900; }
    .pmeta{ color: var(--muted); font-size: 12px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .menuGroup{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .menuBtn{
      border-radius: 16px;
      padding: 11px 12px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    .menuBtn:active{ transform: scale(.99); }
    .menuBtn small{ color: var(--muted); font-weight:600; }

    .danger{
      background: rgba(255,82,82,.10);
      border-color: rgba(255,82,82,.20);
    }
    .danger small{ color: rgba(255,190,190,.9); }
    .ghost{
      background: rgba(255,255,255,.03);
    }

    .drawerFooter{
      margin-top:auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: rgba(255,255,255,.45);
      font-size: 12px;
    }

    /* AUTH MODAL */
    .modalMask{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 90;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      padding: 18px;
    }
    .modal{
      width:min(92vw, 440px);
      border-radius: 22px;
      background: rgba(22,22,30,.96);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .modalHead b{ letter-spacing:.2px; }
    .modalBody{ padding: 14px; }
    .stack{ display:flex; flex-direction:column; gap:10px; }
    .btn{
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      font-weight:800;
    }
    .btnLight{
      background: #fff;
      color:#000;
      border-color: rgba(255,255,255,.22);
    }
    .btn:active{ transform: scale(.99); }
    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Terms modal full */
    .termsBox{
      max-height: 52vh;
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 12px;
      color: rgba(255,255,255,.86);
      font-size: 13px;
      line-height: 1.5;
    }

    /* speaking badge */
    .speaking{
      position: fixed;
      left: 14px;
      bottom: 86px;
      z-index: 40;
      display:none;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .spinner{
      width:12px; height:12px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.85);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* Responsive */
    @media (max-width: 520px){
      .heroRight{ display:none; }
      .msg-bubble{ max-width: 92%; }
    }
  </style>

  <!-- FontAwesome varsa ikonlar; yoksa da kƒ±rƒ±lmaz -->
  <script src="https://kit.fontawesome.com/a2e0e6ad44.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="app">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div class="logo">
          <div class="eyes">
            <div class="eye"><div class="pupil"></div></div>
            <div class="eye"><div class="pupil"></div></div>
          </div>
        </div>
        <div class="brandTitle">
          <b>CAYNANA</b>
          <div>Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
        </div>
      </div>

      <div class="topActions">
        <div id="notifMount"><!-- notif.js buraya basar (fallback) --></div>

        <div class="iconBtn" id="hambBtn" title="Men√º">
          <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero">
      <div class="heroLeft">
        <div class="heroTitle" id="heroTitle">Caynana ile<br>Dertle≈ü.</div>
        <div class="heroDesc" id="heroDesc">Hadi gel evladƒ±m, anlat bakalƒ±m.</div>
        <div class="heroPills">
          <div class="pill"><span class="dot"></span><span id="whoPill">Misafir modundasƒ±n</span></div>
          <div class="pill">üîí <span id="termsPill">S√∂zle≈üme: kontrol ediliyor</span></div>
        </div>
      </div>
      <div class="heroRight">
        <img id="heroImage" class="heroImg" src="./images/hero-chat.png" alt="hero" />
      </div>
    </div>

    <div class="oz-lines">
      <span></span><span></span><span></span><span></span>
    </div>

    <!-- DOCK -->
    <div class="dock" id="dock"></div>

    <!-- CHAT PANEL -->
    <div class="panel">
      <div class="chatArea" id="chatContainer"></div>

      <div class="composer" id="stdInputArea">
        <textarea id="text" class="inp" rows="1" placeholder="Yaz bakalƒ±m evladƒ±m..."></textarea>
        <div class="sendBtn" id="sendBtn" title="G√∂nder">
          <svg viewBox="0 0 24 24"><path d="M22 2L11 13" /><path d="M22 2L15 22l-4-9-9-4 20-7z"/></svg>
        </div>
      </div>
    </div>

  </div>

  <!-- Speaking badge -->
  <div class="speaking" id="caynanaSpeaking">
    <div class="spinner"></div>
    <div id="speakingText">Yazƒ±yor...</div>
  </div>

  <!-- DRAWER -->
  <div class="drawerMask" id="drawerMask">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerTop">
        <div class="drawerTitle">Men√º <span class="chip" id="menuChip">‚Äî</span></div>
        <div class="iconBtn" id="drawerClose" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>

      <div class="profileCard">
        <img id="drawerAvatar" class="avatar" src="https://via.placeholder.com/150" alt="avatar" />
        <div class="pinfo">
          <div class="pname" id="drawerName">Misafir</div>
          <div class="pmeta" id="drawerMeta">Giri≈ü yaparsan seni tanƒ±rƒ±m.</div>
        </div>
      </div>

      <div class="menuGroup" id="menuActions"></div>

      <div class="drawerFooter">
        <span>¬© CaynanaAI</span>
        <span style="opacity:.7">O.√ñzyiƒüit</span>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modalMask modalMask" id="authModal">
    <div class="modal">
      <div class="modalHead">
        <b>Giri≈ü</b>
        <div class="iconBtn" id="authCloseX" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>
      <div class="modalBody">
        <div class="stack">
          <div class="hint">PC‚Äôde de telefonda da √ßalƒ±≈üsƒ±n diye iki y√∂ntem var: √ºstte ‚ÄúBaƒülan‚Äù (prompt) + altta Google butonu (fallback).</div>

          <div class="btn btnLight" id="googleLoginBtn">
            <i class="fa-brands fa-google"></i> Google ile Baƒülan
          </div>

          <!-- GIS fallback renderButton mount -->
          <div id="googleBtnMount" style="display:flex; justify-content:center;"></div>

          <div id="googleFallbackHint" class="hint" style="display:none;"></div>

          <div class="btn ghost" id="devLoginBtn">
            <i class="fa-solid fa-key"></i> Test Giri≈üi
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TERMS MODAL (tam ekran s√∂zle≈üme) -->
  <div class="modalMask modalMask" id="termsModal">
    <div class="modal">
      <div class="modalHead">
        <b>S√∂zle≈üme Onayƒ±</b>
        <!-- Anayasa: terms zorunluysa X'i CSS ile gizleyebilirsin -->
        <div class="iconBtn" id="termsCloseX" title="Kapat">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg>
        </div>
      </div>
      <div class="modalBody">
        <div class="termsBox" id="termsText">
          <b>√ñzet:</b> Bu i√ßerikler bilgilendirme ve eƒülence ama√ßlƒ±dƒ±r. Fal/eƒülence i√ßerikleri ger√ßeƒüi temsil etmez. Ki≈üisel verilerin yalnƒ±zca hizmet sunumu i√ßin i≈ülenir.
          <br><br>
          <b>Onay:</b> Devam ederek ≈üartlarƒ± kabul etmi≈ü sayƒ±lƒ±rsƒ±n.
        </div>

        <div class="stack" style="margin-top:12px;">
          <div class="btn btnLight" id="termsAcceptBtn">Okudum, Kabul Ediyorum</div>
          <div class="hint">Kabul etmeden i√ßeri giremezsin evladƒ±m. (Tamam, ben de annemden b√∂yle g√∂rd√ºm üòÑ)</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { BASE_DOMAIN, STORAGE_KEY, PLACEHOLDER_IMG } from "./js/config.js";
    import { initAuth, handleLogin, logout, acceptTerms } from "./js/auth.js";
    import { initUi } from "./js/ui_modals.js";
    import { initPartials } from "./js/partials.js";
    import { initNotif } from "./js/notif.js";

    // -----------------------------
    // Helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);
    const safeJson = (s, fb={}) => { try { return JSON.parse(s||""); } catch { return fb; } };
    const user = () => safeJson(localStorage.getItem(STORAGE_KEY), {});
    const firstName = (fullname="") => (String(fullname||"").trim().split(/\s+/)[0] || "");
    const hitap = (u) => (String(u?.hitap||"").trim() || firstName(u?.fullname) || "Misafir");

    // -----------------------------
    // Modes (dock)
    // -----------------------------
    const MODE_CONFIG = {
      chat:      { title: "Caynana ile<br>Dertle≈ü.", desc: "Hadi gel evladƒ±m, anlat bakalƒ±m.", color: "#E6C25B", icon: "fa-comments" },
      shopping:  { title: "Paranƒ± √áar√ßur Etme<br>Bana Sor.", desc: "En saƒülamƒ±nƒ± bulurum.", color: "#81C784", icon: "fa-bag-shopping" },
      dedikodu:  { title: "Dedikodu Odasƒ±<br>Bize √ñzel.", desc: "Duvarlarƒ±n kulaƒüƒ± var.", color: "#90A4AE", icon: "fa-user-secret" },
      fal:       { title: "Kapat Fincanƒ±<br>Gelsin Kƒ±smetin.", desc: "Fotoƒürafƒ± √ßek, niyetini tut.", color: "#CE93D8", icon: "fa-mug-hot" },
      astro:     { title: "Yƒ±ldƒ±zlar Ne Diyor<br>Bakalƒ±m.", desc: "Yƒ±ldƒ±zlar senin i√ßin parlƒ±yor.", color: "#7986CB", icon: "fa-star" },
      ruya:      { title: "R√ºyalar Alemi<br>Hayƒ±rdƒ±r.", desc: "Kabus mu g√∂rd√ºn?", color: "#81D4FA", icon: "fa-cloud-moon" },
      health:    { title: "√ñnce Saƒülƒ±k<br>Gerisi Yalan.", desc: "Neren aƒürƒ±yor?", color: "#E57373", icon: "fa-heart-pulse" },
      diet:      { title: "Boƒüazƒ±nƒ± Tut<br>Rahat Et.", desc: "Diyet Listeni Hazƒ±rladƒ±m.", color: "#AED581", icon: "fa-carrot" },
      trans:     { title: "Gavurca<br>Ne Demi≈üler?", desc: "Anlamadƒ±ƒüƒ±nƒ± sor.", color: "#FFB74D", icon: "fa-language" }
    };
    const MODULE_ORDER = ["chat","shopping","dedikodu","fal","astro","ruya","health","diet","trans"];
    window.currentAppMode = "chat";
    let lastBot = "";

    function initDock(){
      const dock = $("dock");
      if(!dock) return;
      dock.innerHTML = "";
      MODULE_ORDER.forEach(k => {
        const c = MODE_CONFIG[k];
        dock.innerHTML += `
          <div class="dock-item" data-mode="${k}">
            <div class="dock-icon" style="color:${c.color}; border-color:${c.color}40;">
              <i class="fa-solid ${c.icon}"></i>
            </div>
          </div>`;
      });
      dock.addEventListener("click", (e) => {
        const it = e.target.closest(".dock-item");
        if(!it) return;
        setMode(it.getAttribute("data-mode"));
      });
    }

    function setMode(m){
      if(!MODE_CONFIG[m]) return;
      window.currentAppMode = m;
      const c = MODE_CONFIG[m];
      $("heroTitle").innerHTML = c.title;
      $("heroDesc").innerHTML = c.desc;
      document.documentElement.style.setProperty("--primary", c.color);

      const img = $("heroImage");
      if(img){
        img.style.opacity = "0";
        setTimeout(() => {
          img.src = `./images/hero-${m}.png`;
          img.onload = () => img.style.opacity = "1";
        }, 160);
      }

      // lines
      const idx = MODULE_ORDER.indexOf(m);
      for(let i=0;i<4;i++){
        const line = document.querySelector(`.oz-lines span:nth-child(${i+1})`);
        const mk = MODULE_ORDER[(idx+i) % MODULE_ORDER.length];
        if(line) line.style.background = MODE_CONFIG[mk].color;
      }
    }

    // -----------------------------
    // Drawer (sidebar)
    // -----------------------------
    function openDrawer(){ $("drawerMask").style.display = "block"; }
    function closeDrawer(){ $("drawerMask").style.display = "none"; }

    function refreshDrawer(){
      const u = user();
      const logged = !!(u?.isSessionActive && u?.id);

      $("menuChip").innerText = logged ? "Aktif" : "Misafir";
      $("drawerAvatar").src = (u?.avatar || PLACEHOLDER_IMG);
      $("drawerName").innerText = hitap(u);
      $("drawerMeta").innerText = logged ? (u.email || "Google ile baƒülƒ±") : "Giri≈ü yaparsan seni tanƒ±rƒ±m.";

      const actions = $("menuActions");
      if(!actions) return;

      if(logged){
        actions.innerHTML = `
          <div class="menuBtn" id="goProfile"><span><b>Profil</b> <small>d√ºzenle</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goFaq"><span><b>S.S.S</b> <small>yardƒ±m</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goPrivacy"><span><b>Gizlilik</b> <small>metin</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goContact"><span><b>ƒ∞leti≈üim</b> <small>yaz bize</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn danger" id="logoutBtn"><span><b>√áƒ±kƒ±≈ü</b> <small>Google</small></span><span>‚éã</span></div>
          <div class="menuBtn danger" id="deleteBtn"><span><b>Hesabƒ±mƒ± Sil</b> <small>kalƒ±cƒ±</small></span><span>‚úï</span></div>
        `;
        $("termsPill").innerText = (u?.terms_accepted_at ? "S√∂zle≈üme: onaylƒ±" : "S√∂zle≈üme: bekliyor");
      } else {
        actions.innerHTML = `
          <div class="menuBtn" id="loginBtn"><span><b>Google ile Baƒülan</b> <small>PC + mobil</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn ghost" id="devBtn"><span><b>Test Giri≈üi</b> <small>debug</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goFaq"><span><b>S.S.S</b> <small>yardƒ±m</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goPrivacy"><span><b>Gizlilik</b> <small>metin</small></span><span>‚Ä∫</span></div>
          <div class="menuBtn" id="goContact"><span><b>ƒ∞leti≈üim</b> <small>yaz bize</small></span><span>‚Ä∫</span></div>
        `;
        $("termsPill").innerText = "S√∂zle≈üme: giri≈ü sonrasƒ±";
      }

      // who pill
      $("whoPill").innerText = logged ? `Merhaba ${hitap(u)} üëã` : "Misafir modundasƒ±n";

      // bind drawer actions (idempotent)
      actions.querySelectorAll(".menuBtn").forEach(btn => {
        const id = btn.id;
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);

        clone.addEventListener("click", async () => {
          closeDrawer();

          if(id === "loginBtn"){
            openAuth();
          } else if(id === "devBtn"){
            devLogin();
          } else if(id === "logoutBtn"){
            await doLogout();
          } else if(id === "deleteBtn"){
            await deleteAccount();
          } else if(id === "goProfile"){
            location.href = "pages/profil.html";
          } else if(id === "goFaq"){
            location.href = "pages/sss.html";
          } else if(id === "goPrivacy"){
            location.href = "pages/gizlilik.html";
          } else if(id === "goContact"){
            location.href = "pages/iletisim.html";
          }
        });
      });
    }

    // -----------------------------
    // Auth modal
    // -----------------------------
    function openAuth(){ $("authModal").style.display = "flex"; }
    function closeAuth(){ $("authModal").style.display = "none"; }

    // App entry point (auth.js √ßaƒüƒ±rƒ±yor)
    window.enterApp = () => {
      closeAuth();
      refreshDrawer();
    };

    async function doLogout(){
      try { logout(); } catch { localStorage.clear(); location.reload(); }
    }

    async function deleteAccount(){
      const u = user();
      if(!u?.id) return;

      const ok = confirm("Hesabƒ±nƒ± kalƒ±cƒ± silmek istiyor musun? Bu i≈ülem geri alƒ±namaz.");
      if(!ok) return;

      const idToken = (localStorage.getItem("google_id_token") || "").trim();

      // 1) varsa: /api/profile/delete
      try{
        const r = await fetch(`${BASE_DOMAIN}/api/profile/delete`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ user_id: u.id, email: u.email || "", google_id_token: idToken || "" })
        });
        if(r.ok){
          alert("Hesabƒ±n silindi.");
          localStorage.clear();
          location.reload();
          return;
        }
      }catch(e){}

      // 2) fallback: profile/update -> deleted_at
      try{
        const r2 = await fetch(`${BASE_DOMAIN}/api/profile/update`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            user_id: u.id,
            meta: { email: u.email || "", deleted_at: new Date().toISOString() },
            google_id_token: idToken || ""
          })
        });
        if(r2.ok){
          alert("Silme talebin alƒ±ndƒ±.");
          localStorage.clear();
          location.reload();
          return;
        }
      }catch(e){}

      alert("Silme i≈ülemi ≈üu an yapƒ±lamadƒ±. Backend endpoint'ini kontrol edelim.");
    }

    function devLogin(){
      const fake = { id:"dev@local", email:"dev@local", fullname:"Test Kullanƒ±cƒ±", avatar: PLACEHOLDER_IMG, provider:"dev", isSessionActive:true };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(fake));
      localStorage.setItem("auth_token", "dev_token_bypass");
      location.reload();
    }

    // -----------------------------
    // Chat (demo)
    // -----------------------------
    function addBubble(t, who){
      const c = $("chatContainer");
      c.innerHTML += `<div class="msg-row ${who}"><div class="msg-bubble ${who}">${t}</div></div>`;
      c.scrollTop = c.scrollHeight;
    }

    async function sendMessage(){
      const input = $("text");
      const txt = (input.value || "").trim();
      if(!txt) return;

      const u = user();
      const token = localStorage.getItem("auth_token") || "";
      const logged = !!(u?.isSessionActive && u?.id);

      input.value = "";
      addBubble(txt, "user");

      // giri≈ü yoksa auth a√ß
      if(!logged && token !== "dev_token_bypass"){
        openAuth();
        addBubble("√ñnce Google ile giri≈ü yap evladƒ±m.", "bot");
        return;
      }

      $("caynanaSpeaking").style.display = "flex";
      $("speakingText").innerText = "Yazƒ±yor...";

      // demo cevap (istersen backend /api/chat baƒülarƒ±z)
      setTimeout(() => {
        $("caynanaSpeaking").style.display = "none";
        lastBot = "Heh, ≈üimdi oldu. Anlat bakalƒ±m‚Ä¶";
        addBubble(lastBot, "bot");
      }, 650);
    }

    // -----------------------------
    // Boot
    // -----------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      // UI hooks + modal davranƒ±≈üƒ± (senin ui_modals.js i√ßindeki hooks da √ßalƒ±≈üƒ±r)
      try { initUi(); } catch(e) {}
      try { await initPartials(); } catch(e) {}
      try { await initNotif({ baseUrl: BASE_DOMAIN }); } catch(e) {}

      // Auth init
      try { initAuth(); } catch(e) {}

      initDock();
      setMode("chat");

      // hamburger + drawer
      $("hambBtn").addEventListener("click", () => { refreshDrawer(); openDrawer(); });
      $("drawerClose").addEventListener("click", closeDrawer);
      $("drawerMask").addEventListener("click", (e) => { if(e.target === $("drawerMask")) closeDrawer(); });

      // auth modal closers
      $("authCloseX").addEventListener("click", closeAuth);
      $("authModal").addEventListener("click", (e) => { if(e.target === $("authModal")) closeAuth(); });

      // login buttons
      $("googleLoginBtn").addEventListener("click", () => handleLogin("google"));
      $("devLoginBtn").addEventListener("click", devLogin);

      // terms accept
      $("termsAcceptBtn").addEventListener("click", async () => {
        const ok = await acceptTerms();
        if(ok){
          $("termsModal").style.display = "none";
          const u = user();
          u.terms_accepted_at = u.terms_accepted_at || new Date().toISOString();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(u));
          refreshDrawer();
        } else {
          alert("Onay kaydedilemedi. Backend'i kontrol edelim.");
        }
      });

      // chat send
      $("sendBtn").addEventListener("click", sendMessage);
      $("text").addEventListener("keydown", (e) => { if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

      // initial
      refreshDrawer();
    });
  </script>
</body>
</html>
