<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f18" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ --primary:#00C897; --font:'Outfit',sans-serif; }
  *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; }

  body{
    font-family:var(--font);
    background:#0b0f18;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* WEB: telefon √ßer√ßevesi */
  #app{
    width:100%;
    height:100%;
    max-width:480px;
    max-height:920px;
    aspect-ratio: 9 / 19.5;
    border-radius:22px;
    overflow:hidden;
    box-shadow:0 0 60px rgba(0,0,0,.60);

    position:relative;
    display:flex;
    flex-direction:column;

    background:linear-gradient(135deg,#0b1220 0%,#0b0f18 100%);
    background-position:60% 40%;
    background-size:cover;
    background-repeat:no-repeat;
    transition:background-image .25s ease, background-position .25s ease, background-size .25s ease;
  }

  /* Mobil: full */
  @media (max-width:520px){
    body{ display:block; background:#000; }
    #app{
      width:100vw; height:100vh;
      max-width:none; max-height:none;
      aspect-ratio:auto;
      border-radius:0;
      box-shadow:none;
    }
  }

  /* √úst okunurluk: hafif koyu overlay (beyaz yazƒ± i√ßin) */
  #app::before{
    content:"";
    position:absolute; inset:0;
    background:linear-gradient(to bottom,
      rgba(0,0,0,.60) 0%,
      rgba(0,0,0,.32) 20%,
      rgba(0,0,0,.10) 42%,
      rgba(0,0,0,0) 65%
    );
    pointer-events:none;
    z-index:1;
  }

  /* HEADER */
  #topbar{
    position:relative; z-index:10;
    height:84px;
    padding:14px 18px 10px 18px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
  }
  .brand-wrap{ display:flex; flex-direction:column; gap:4px; }
  .brand{
    display:flex; align-items:center; gap:10px;
    font-size:22px; font-weight:900; letter-spacing:-.4px;
    color:#fff;
  }
  .brand i{ color:var(--primary); font-size:20px; }
  .brand span{ color:var(--primary); }
  .brand-sub{ font-size:12px; font-weight:800; color:rgba(255,255,255,.85); }
  .menu-btn{
    width:44px; height:44px;
    border-radius:999px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.22);
    color:#fff;
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    cursor:pointer;
  }

  /* Hero metin: y√ºz√ºn √ºst√ºne binmesin diye yukarƒ±da + max geni≈ülik */
  #main{
    position:relative; z-index:8;
    flex:1;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    padding:0 18px 320px 18px;
  }

  #heroContent{
    margin-top:54px;
    text-align:left;
    max-width:360px;
  }
  #heroTitle{
    font-size:34px;
    font-weight:900;
    line-height:1.08;
    color:#fff;
    letter-spacing:-1px;
    text-shadow:0 10px 26px rgba(0,0,0,.45);
  }
  #heroDesc{
    margin-top:10px;
    font-size:16px;
    font-weight:800;
    color:rgba(255,255,255,.88);
    text-shadow:0 8px 20px rgba(0,0,0,.35);
  }

  /* CHAT */
  #chatContainer{ display:none; margin-top:18px; }
  .msg{ display:flex; margin-bottom:14px; }
  .msg.user{ justify-content:flex-end; }
  .msg.ai{ justify-content:flex-start; }
  .bubble{
    max-width:86%;
    padding:14px 16px;
    border-radius:18px;
    font-size:15px;
    line-height:1.5;
    font-weight:700;
  }
  .msg.user .bubble{
    background:var(--primary);
    color:#fff;
    border-bottom-right-radius:6px;
    box-shadow:0 12px 22px rgba(0,200,151,.25);
  }
  .msg.ai .bubble{
    background:rgba(255,255,255,.92);
    color:#111;
    border:1px solid rgba(0,0,0,.06);
    border-bottom-left-radius:6px;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
  }
  .audio-btn{
    margin-top:10px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    color:var(--primary);
    font-weight:900;
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }
  .audio-btn.playing{ background:#ffeaea; color:#d32f2f; border-color:#d32f2f; }

  /* CARDS */
  .cards{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px; }
  .card{
    background:rgba(255,255,255,.96);
    border-radius:16px;
    padding:10px;
    display:flex;
    flex-direction:column;
    position:relative;
    border:1px solid rgba(0,0,0,.05);
    box-shadow:0 12px 22px rgba(0,0,0,.10);
    overflow:hidden;
  }
  .card-badge{
    position:absolute; top:10px; left:0;
    padding:4px 10px;
    font-size:10px;
    font-weight:900;
    border-radius:0 10px 10px 0;
    color:#fff; z-index:2;
  }
  .card-badge.gold{ background:linear-gradient(90deg,#FFB300,#FF8F00); }
  .card-badge.silver{ background:linear-gradient(90deg,#9E9E9E,#757575); }
  .card-badge.value{ background:linear-gradient(90deg,#00C897,#00A87E); }
  .pimg{ width:100%; height:120px; object-fit:contain; margin-bottom:8px; }
  .title{ font-size:13px; font-weight:900; height:36px; overflow:hidden; margin-bottom:6px; color:#1b1b1b; }
  .price{ font-size:15px; font-weight:900; color:var(--primary); margin-bottom:8px; }
  .btnLink{
    padding:9px;
    border-radius:10px;
    text-align:center;
    font-size:12px;
    font-weight:900;
    text-decoration:none;
    color:#fff;
    background:var(--primary);
  }
  .btnLink.btn-gold{ background:#FFB300; }
  .btnLink.btn-silver{ background:#9E9E9E; }
  .btnLink.btn-blue{ background:#00C897; }

  /* BOTTOM fixed (ok kaybolmaz) */
  #bottom{
    position:fixed;
    left:0; right:0; bottom:0;
    z-index:20;
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    border-top:1px solid rgba(0,0,0,.06);
    padding-bottom:calc(env(safe-area-inset-bottom) + 18px);
  }
  #bottom .inner{ max-width:480px; margin:0 auto; width:100%; }
  @media (max-width:520px){ #bottom .inner{ max-width:none; } }

  #suggestionText{
    width:max-content;
    max-width:92%;
    margin:-18px auto 10px auto;
    padding:10px 18px;
    border-radius:999px;
    background:#fff;
    color:var(--primary);
    font-weight:900;
    font-size:13px;
    text-align:center;
    box-shadow:0 10px 22px rgba(0,0,0,.12);
    border:1px solid rgba(0,0,0,.06);
  }

  .input-wrapper{
    padding:10px 18px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .search-bar{
    flex:1;
    height:54px;
    border-radius:27px;
    background:rgba(255,255,255,.98);
    border:1px solid rgba(0,0,0,.10);
    display:flex;
    align-items:center;
    padding:0 14px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  .search-bar:focus-within{
    border-color:rgba(0,200,151,.55);
    box-shadow:0 10px 24px rgba(0,200,151,.18);
  }
  .tool-btn{ color:rgba(0,0,0,.45); font-size:18px; padding:6px; cursor:pointer; }
  #text{
    flex:1;
    border:none;
    background:transparent;
    font-size:16px;
    margin:0 10px;
    color:#222;
    outline:none;
  }
  #sendBtn{
    width:54px; height:54px;
    border-radius:50%;
    border:none;
    background:var(--primary);
    color:#fff;
    font-size:20px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    box-shadow:0 12px 24px rgba(0,200,151,.30);
    transition:.15s;
  }
  #sendBtn:active{ transform:scale(.92); }
  #sendBtn:disabled{ opacity:.65; }

  /* Dock (scroll) */
  #dock{
    padding:8px 18px 8px 18px;
    overflow-x:auto;
    display:flex;
    gap:16px;
    scrollbar-width:none;
  }
  #dock::-webkit-scrollbar{ display:none; }
  .dock-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    min-width:62px;
    opacity:.42;
    cursor:pointer;
    transition:.2s;
    user-select:none;
  }
  .dock-item.active{ opacity:1; transform:translateY(-2px); }
  .dock-icon-box{
    width:48px; height:48px;
    border-radius:16px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.35);
    color:#666;
    font-size:20px;
    transition:.2s;
  }
  .dock-item.active .dock-icon-box{
    background:var(--primary);
    color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .dock-label{ font-size:11px; font-weight:900; color:#333; white-space:nowrap; }

  .brand-footer{
    text-align:center;
    font-size:11px;
    font-weight:900;
    color:#666;
    padding:6px 0 10px;
    opacity:.85;
  }
  .it-flag{
    width:60px; height:4px;
    margin:6px auto 0;
    display:flex;
    border-radius:3px;
    overflow:hidden;
  }
  .it-flag span{ flex:1; }
  .it-flag .g{ background:#009246; }
  .it-flag .w{ background:#fff; }
  .it-flag .r{ background:#ce2b37; }

  #fileInput{ display:none !important; }
  .mic-active{ color:#F44336 !important; animation:pulse 1s infinite; }
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

  /* basit drawer */
  #drawerMask{
    position:absolute; inset:0;
    background:rgba(0,0,0,.45);
    z-index:50;
    display:none;
  }
  #drawer{
    position:absolute; top:0; right:0;
    height:100%; width:78%;
    max-width:340px;
    background:rgba(255,255,255,.96);
    z-index:60;
    transform:translateX(110%);
    transition:.22s;
    padding:18px;
  }
  #drawer.open{ transform:translateX(0); }
  #drawerMask.show{ display:block; }
  .drawerTitle{ font-weight:900; font-size:16px; margin-bottom:10px; }
  .drawerItem{ padding:10px 0; border-bottom:1px solid rgba(0,0,0,.06); font-weight:700; color:#222; }
</style>
</head>

<body>
<div id="app">

  <div id="drawerMask"></div>
  <div id="drawer">
    <div class="drawerTitle">Men√º</div>
    <div class="drawerItem">Hesap</div>
    <div class="drawerItem">Ayarlar</div>
    <div class="drawerItem">Gizlilik</div>
    <div class="drawerItem">Destek</div>
  </div>

  <div id="topbar">
    <div class="brand-wrap" onclick="switchMode('shopping')">
      <div class="brand">
        <i class="fa-solid fa-wand-magic-sparkles"></i>
        CAYNANA<span>.AI</span>
      </div>
      <div class="brand-sub">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div class="menu-btn" id="menuBtn"><i class="fa-solid fa-bars"></i></div>
  </div>

  <div id="main">
    <div id="heroContent">
      <div id="heroTitle">Almadan √∂nce<br>Caynana‚Äôya sor.</div>
      <div id="heroDesc">Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.</div>
    </div>
    <div id="chatContainer"></div>
  </div>

  <div id="bottom">
    <div class="inner">
      <div id="suggestionText">Her indirime atlayan sonunda pahalƒ± √∂der.</div>

      <div class="input-wrapper">
        <div class="search-bar">
          <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
          <input id="text" placeholder="Ne danƒ±≈ümak istersin?" autocomplete="off" onkeypress="if(event.key==='Enter') send()">
          <div class="tool-btn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
        </div>
        <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>

      <div id="dock"></div>

      <div class="brand-footer">
        @CaynanaAI by Italky Technology
        <div class="it-flag"><span class="g"></span><span class="w"></span><span class="r"></span></div>
      </div>
    </div>
  </div>

</div>

<input type="file" id="fileInput" accept="image/*" capture="environment" />

<script>
  // ===== API (Render Canlƒ± Sunucu) =====
  const BASE_DOMAIN = "https://bikonomi-api-2.onrender.com";
  const API_URL = `${BASE_DOMAIN}/api/chat`;
  const SPEAK_URL = `${BASE_DOMAIN}/api/speak`;

  let sessionId = "sess_" + Math.random().toString(36).slice(2,10);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "shopping";
  let isSending = false;
  const chatHistory = {};

  marked.setOptions({ mangle:false, headerIds:false });

  // ===== ASSET PATH (kritik: /images yerine base path) =====
  function basePath(){
    // /a/b/index.html -> /a/b/
    const p = location.pathname;
    if(p.endsWith("/")) return p;
    return p.substring(0, p.lastIndexOf("/") + 1);
  }
  function asset(rel){ return basePath() + rel.replace(/^\/+/, ""); }

  // ===== MODES =====
  const MODES = {
    shopping:{ label:"Alƒ±≈üveri≈ü", icon:"fa-bag-shopping", color:"#00C897",
      title:"Almadan √∂nce<br>Caynana‚Äôya sor.", desc:"Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.",
      img: asset("images/hero-shopping.png"),
      ph:"Ne danƒ±≈ümak istersin?", sugg:"Her indirime atlayan sonunda pahalƒ± √∂der.",
      pos:"50% 18%", size:"cover", heroTop:"54px"
    },
    chat:{ label:"Sohbet", icon:"fa-comments", color:"#FFB300",
      title:"Caynana ile<br>iki lafƒ±n belini kƒ±r.", desc:"Biraz dur bakalƒ±m, neler anlatacaksƒ±n?",
      img: asset("images/hero-chat.png"),
      ph:"Naber Caynana?", sugg:"Benim zamanƒ±mda her ≈üey daha g√ºzeldi ah ah‚Ä¶",
      pos:"55% 15%", size:"cover", heroTop:"54px"
    },
    fal:{ label:"Fal", icon:"fa-mug-hot", color:"#8B5CF6",
      title:"Kahveni i√ßtin mi?<br>Gel falƒ±na bakayƒ±m.", desc:"Fal eƒülencedir evladƒ±m, ama bazen tutar.",
      img: asset("images/hero-fal.png"),
      ph:"Fincanƒ± √ßektin mi?", sugg:"Kapat fincanƒ±, fotoƒürafƒ±nƒ± √ßek g√∂nder.",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    health:{ label:"Saƒülƒ±k", icon:"fa-heart-pulse", color:"#EF4444",
      title:"Caynana Saƒülƒ±k'la<br>alƒ±≈ükanlƒ±k kazan.", desc:"Neren aƒürƒ±yor s√∂yle bakayƒ±m?",
      img: asset("images/hero-health.png"),
      ph:"Neren aƒürƒ±yor?", sugg:"√áay √ºst√ºne sakƒ±n soƒüuk su i√ßme!",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    diet:{ label:"Diyet", icon:"fa-carrot", color:"#84CC16",
      title:"Caynana Diyet'le<br>saƒülƒ±klƒ± beslen!", desc:"A√ßlƒ±ktan deƒüil, keyiften yiyin.",
      img: asset("images/hero-diet.png"),
      ph:"Boy kilo ka√ß evladƒ±m?", sugg:"Ekmek deƒüil, ye≈üillik ye.",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    food:{ label:"Yemek", icon:"fa-utensils", color:"#F97316",
      title:"Caynana Yemek'le<br>ne pi≈üirsem derdi biter.", desc:"Dolapta ne var s√∂yle, tarif benden.",
      img: asset("images/hero-food.png"),
      ph:"Dolapta ne var?", sugg:"Malzemeyi ziyan etme, bereket ka√ßar.",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    law:{ label:"Hukuk", icon:"fa-scale-balanced", color:"#3B82F6",
      title:"Caynana Hukuk'la<br>kim haklƒ± √∂ƒüren.", desc:"Ben avukat deƒüilim ama √ßok dava g√∂rd√ºm.",
      img: asset("images/hero-law.png"),
      ph:"Derdini kƒ±saca anlat.", sugg:"S√∂zle≈ümeye bakmadan imza atma!",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    astro:{ label:"Bur√ß", icon:"fa-star", color:"#D946EF",
      title:"Yƒ±ldƒ±zlar senin i√ßin<br>ne diyor?", desc:"Merk√ºr retrosu falan‚Ä¶ dikkat et.",
      img: asset("images/hero-astro.png"),
      ph:"Burcun ne?", sugg:"Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k.",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    translate:{ label:"√áeviri", icon:"fa-language", color:"#64748B",
      title:"√áeviri lazƒ±m mƒ±?<br>S√∂yle √ßevireyim.", desc:"Metni yapƒ±≈ütƒ±r, ben hallederim.",
      img: asset("images/hero-translate.png"),
      ph:"Metni yapƒ±≈ütƒ±r.", sugg:"Dil bilmek altƒ±n bileziktir.",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    },
    dream:{ label:"R√ºya", icon:"fa-cloud-moon", color:"#6366F1",
      title:"R√ºyada yƒ±lan mƒ±?<br>Gel tabir edeyim.", desc:"Hayƒ±rdƒ±r in≈üallah‚Ä¶",
      img: asset("images/hero-dream.png"),
      ph:"Ne g√∂rd√ºn r√ºyanda?", sugg:"R√ºyalar tersine √ßƒ±kar derler ama‚Ä¶",
      pos:"55% 12%", size:"cover", heroTop:"54px"
    }
  };

  // ===== UI =====
  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key=>{
      const m = MODES[key];
      const div = document.createElement("div");
      div.className = "dock-item " + (key===currentMode ? "active":"");
      div.onclick = ()=> switchMode(key);
      div.innerHTML = `
        <div class="dock-icon-box"><i class="fa-solid ${m.icon}"></i></div>
        <div class="dock-label">${m.label}</div>
      `;
      dock.appendChild(div);
    });
  }

  function setBackground(mode){
    const app = document.getElementById("app");
    app.style.backgroundPosition = mode.pos || "50% 18%";
    app.style.backgroundSize = mode.size || "cover";

    // preload + cache bust
    const bust = `${mode.img}?v=${Date.now()}`;
    const img = new Image();
    img.onload = ()=>{ app.style.backgroundImage = `url("${bust}")`; };
    img.onerror = ()=>{ app.style.backgroundImage = "linear-gradient(135deg,#0b1220 0%,#0b0f18 100%)"; };
    img.src = bust;
  }

  function switchMode(newMode){
    // save chat
    const chat = document.getElementById("chatContainer");
    chatHistory[currentMode] = chat.innerHTML;

    currentMode = newMode;
    const m = MODES[newMode];

    document.documentElement.style.setProperty("--primary", m.color);
    setBackground(m);

    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerText = m.desc;
    document.getElementById("suggestionText").innerText = m.sugg;
    document.getElementById("text").placeholder = m.ph;
    document.getElementById("heroContent").style.marginTop = m.heroTop || "54px";

    chat.innerHTML = chatHistory[newMode] || "";
    if(chat.innerHTML.trim()){
      document.getElementById("heroContent").style.display="none";
      chat.style.display="block";
    }else{
      document.getElementById("heroContent").style.display="block";
      chat.style.display="none";
    }

    renderDock();
  }

  // ===== Security helpers =====
  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function safeLink(u){
    try{
      const url = new URL(u, location.href);
      if(url.protocol==="http:" || url.protocol==="https:") return url.toString();
    }catch(e){}
    return "";
  }
  function safeImg(u){
    try{
      const url = new URL(u, location.href);
      if(url.protocol==="http:" || url.protocol==="https:") return url.toString();
    }catch(e){}
    return "https://via.placeholder.com/150?text=Resim+Yok";
  }

  // ===== Cards =====
  function pickBadge(p, idx){
    const t = (p?.badge || p?.rank || p?.type || p?.tag || "").toString().toLowerCase();
    if(t.includes("sponsor")) return {key:"gold", text:"SPONSORLU"};
    if(t.includes("gold") || t.includes("altƒ±n") || t.includes("efsane")) return {key:"gold", text:"ALTIN √ñNERƒ∞"};
    if(t.includes("silver") || t.includes("g√ºm√º≈ü") || t.includes("iyi")) return {key:"silver", text:"G√úM√ú≈û SE√áƒ∞M"};
    if(t.includes("perf") || t.includes("fiyat") || t.includes("value")) return {key:"value", text:"Fƒ∞YAT/PERF"};
    if(idx===0) return {key:"gold", text:"ALTIN √ñNERƒ∞"};
    if(idx===1) return {key:"silver", text:"G√úM√ú≈û SE√áƒ∞M"};
    if(idx===2) return {key:"value", text:"Fƒ∞YAT/PERF"};
    return null;
  }

  function renderCards(list){
    const wrap = document.createElement("div");
    wrap.className="cards";

    (list||[]).forEach((p, idx)=>{
      const card = document.createElement("div");
      card.className="card";

      const badge = pickBadge(p, idx);
      const badgeHtml = badge ? `<div class="card-badge ${badge.key}">${badge.text}</div>` : "";

      const title = escapeHtml(String(p.title||""));
      const price = escapeHtml(String(p.price||""));
      const url = p.url ? safeLink(String(p.url)) : "";
      const img = p.image ? safeImg(String(p.image)) : "https://via.placeholder.com/150?text=Resim+Yok";

      const btnClass = badge?.key==="gold" ? "btn-gold" : badge?.key==="silver" ? "btn-silver" : "btn-blue";
      const btnHTML = url ? `<a class="btnLink ${btnClass}" target="_blank" rel="noopener noreferrer" href="${url}">ƒ∞NCELE</a>` : "";
      const priceHTML = price ? `<div class="price">${price}</div>` : "";

      card.innerHTML = `${badgeHtml}
        <img class="pimg" src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Resim+Yok'">
        <div class="title">${title}</div>
        ${priceHTML}
        ${btnHTML}
      `;
      wrap.appendChild(card);
    });

    document.getElementById("chatContainer").appendChild(wrap);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  // ===== Chat =====
  function addBubble(role, text, isLoader=false, speech=null, imgData=null, id=null){
    const div = document.createElement("div");
    div.className = "msg " + role;
    if(id) div.id=id;

    let content = "";
    if(imgData) content += `<img src="${imgData}" style="max-width:100%; border-radius:10px; margin-bottom:10px;">`;

    let htmlContent = text;
    if(role==="ai" && !isLoader){
      const raw = marked.parse(text);
      htmlContent = DOMPurify.sanitize(raw, { USE_PROFILES:{ html:true }});
    }else if(role==="user"){
      htmlContent = escapeHtml(text);
    }

    div.innerHTML = `<div class="bubble">${content + htmlContent}</div>`;

    if(speech && role==="ai" && !isLoader){
      const btn = document.createElement("div");
      btn.className="audio-btn";
      btn.setAttribute("data-speech", speech);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
      div.querySelector(".bubble").appendChild(btn);
    }

    document.getElementById("chatContainer").appendChild(div);
    document.getElementById("main").scrollTo(0, document.getElementById("main").scrollHeight);
  }

  async function send(){
    if(isSending) return;

    const input = document.getElementById("text");
    let val = input.value.trim();

    if(pendingImage && val===""){
      val = (currentMode==="translate") ? "Bunu √ßevir" :
            (currentMode==="fal") ? "Bu fotoƒüraftaki fala bak" :
            "Buna bak evladƒ±m";
    }
    if(!val && !pendingImage) return;

    // shopping: eski kartlarƒ± anƒ±nda sil
    if(currentMode==="shopping"){
      document.querySelectorAll("#chatContainer .cards").forEach(el=>el.remove());
    }

    isSending = true;
    document.getElementById("sendBtn").disabled = true;

    document.getElementById("heroContent").style.display="none";
    document.getElementById("chatContainer").style.display="block";

    addBubble("user", val, false, null, pendingImage);
    input.value = "";

    const loaderId = "loader_" + Date.now();
    addBubble("ai", "<i class='fa-solid fa-circle-notch fa-spin'></i> Bakƒ±yorum...", true, null, null, loaderId);

    const payload = { message: val, session_id: sessionId, image: pendingImage, mode: currentMode };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      const data = await res.json();
      document.getElementById(loaderId)?.remove();

      addBubble("ai", data.assistant_text || "Heh‚Ä¶ bir ≈üey diyemedim evladƒ±m.", false, data.speech_text || null);
      if(data.data && data.data.length) renderCards(data.data);

    }catch(e){
      const el = document.getElementById(loaderId);
      if(el) el.innerHTML="Backend √ßalƒ±≈ümƒ±yor evladƒ±m. /api/chat eri≈üimi yok.";
    }finally{
      isSending = false;
      document.getElementById("sendBtn").disabled = false;
    }
  }

  // ===== Audio (event delegation) =====
  async function playAudio(text, btn){
    const was = btn.classList.contains("playing");

    if(currentAudio){ currentAudio.pause(); currentAudio = null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove("playing");
      b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
    });
    if(was) return;

    const old = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...`;

    try{
      const r = await fetch(SPEAK_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ text }) });
      const blob = await r.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = ()=>{
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
        btn.classList.remove("playing");
        currentAudio = null;
      };
      await currentAudio.play();
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sus Kƒ±z!`;
      btn.classList.add("playing");
    }catch(e){
      btn.innerHTML = "Hata";
      setTimeout(()=> btn.innerHTML = old, 1200);
    }
  }

  document.getElementById("chatContainer").addEventListener("click", (e)=>{
    const btn = e.target.closest(".audio-btn");
    if(!btn) return;
    const speech = btn.getAttribute("data-speech");
    if(speech) playAudio(speech, btn);
  });

  // ===== Camera =====
  const fileEl = document.getElementById("fileInput");
  function openCamera(){ fileEl.value=""; fileEl.click(); }
  fileEl.addEventListener("change",(e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ()=>{
      pendingImage = r.result;
      document.getElementById("text").value = "üì∑ Fotoƒüraf eklendi";
      document.getElementById("text").focus();
    };
    r.readAsDataURL(file);
  });

  // ===== Mic =====
  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Mikrofon desteƒüi yok."); return; }
    const rec = new SR();
    rec.lang="tr-TR";
    const mic = document.getElementById("micBtn");
    mic.classList.add("mic-active");
    rec.onresult = (e)=>{
      document.getElementById("text").value = e.results[0][0].transcript;
      mic.classList.remove("mic-active");
      send();
    };
    rec.onend = ()=> mic.classList.remove("mic-active");
    rec.start();
  }

  // ===== Swipe =====
  let startX=0;
  document.getElementById("app").addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; }, {passive:true});
  document.getElementById("app").addEventListener("touchend", e=>{
    const diff = e.changedTouches[0].clientX - startX;
    if(Math.abs(diff) < 60) return;
    const keys = Object.keys(MODES);
    const i = keys.indexOf(currentMode);
    if(diff < 0) switchMode(keys[(i+1) % keys.length]);
    if(diff > 0) switchMode(keys[(i-1+keys.length) % keys.length]);
  }, {passive:true});

  // ===== Drawer =====
  const mask = document.getElementById("drawerMask");
  const drawer = document.getElementById("drawer");
  function openDrawer(){ mask.classList.add("show"); drawer.classList.add("open"); }
  function closeDrawer(){ mask.classList.remove("show"); drawer.classList.remove("open"); }
  document.getElementById("menuBtn").addEventListener("click", openDrawer);
  mask.addEventListener("click", closeDrawer);

  // INIT
  renderDock();
  switchMode("shopping");
</script>
</body>
</html>
