<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Caynana.AI</title>

<style>
:root{
  --bg: #050505;
  --amber: #ffb300;
  --amber-glow: #ff9100;
  --text: #e0e0e0;
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

body{
  margin: 0;
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  overflow: hidden;
  color: var(--text);
}

.phone{
  width: 100%;
  max-width: 420px;
  height: 100%;
  max-height: 900px;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  position: relative;
}

@media(min-width: 500px){
  .phone{
    border-radius: 40px;
    box-shadow: 0 0 0 10px #111, 0 30px 80px rgba(0,0,0,0.8);
    height: 95vh;
  }
}

/* HEADER */
.header{
  height: 180px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: radial-gradient(circle at center, rgba(255,179,0,0.1) 0%, #000 70%);
  position: relative;
  z-index: 10;
  flex-shrink: 0;
}

.menu-btn{
  position: absolute;
  left: 20px;
  top: 50px;
  width: 40px;
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  opacity: 0.6;
  font-size: 24px;
}

.eyes-container{
  display: flex;
  gap: 20px;
  transform: scale(0.9);
}

.eye-wrapper{
  width: 120px;
  height: 75px;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Neon √áer√ßeve */
.eye-frame{
  position: absolute;
  inset: 0;
  border-radius: 50% 50% 40% 40%;
  border: 3px solid #fff;
  box-shadow:
    0 0 4px #fff,
    0 0 10px var(--amber),
    0 0 25px var(--amber),
    inset 0 0 15px var(--amber);
  background: rgba(0,0,0,0.4);
  z-index: 5;
}

.pupil{
  width: 24px;
  height: 24px;
  background: #000;
  border: 2px solid #fff;
  border-radius: 50%;
  position: relative;
  z-index: 6;
  box-shadow: 0 0 12px var(--amber);
  transition: transform 0.1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

/* Lid */
.lid{
  position: absolute;
  top: -20%;
  left: -10%;
  width: 120%;
  height: 0%;
  background: var(--bg);
  z-index: 10;
  border-bottom: 2px solid #111;
  transition: height 0.3s ease;
}

/* MODLAR (D√úZELTƒ∞LDƒ∞: class eye-wrapper √ºst√ºnde) */
.eye-wrapper.blink .lid{ animation: blink 4s infinite; }
@keyframes blink{ 0%,96%,100%{height:0%} 98%{height:100%} }

.eye-wrapper.suspicious .lid{ height: 60%; }

.eye-wrapper.shock{ transform: scale(1.1); transition: 0.2s; }
.eye-wrapper.shock .pupil{ transform: scale(0.6); }

.eye-wrapper.rolling .pupil{ animation: roll 2s ease-in-out; }
@keyframes roll{ 0%{transform:translate(0,0)} 50%{transform:translate(0,-15px)} 100%{transform:translate(0,0)} }

/* CHAT */
.chat-area{
  flex: 1;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  overflow-y: auto;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}
.chat-area::-webkit-scrollbar{ width: 4px; }
.chat-area::-webkit-scrollbar-thumb{ background: #333; border-radius: 2px; }

.msg{
  max-width: 85%;
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.5;
  position: relative;
  animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn{ from{transform: translateY(8px); opacity: 0;} to{transform: translateY(0); opacity: 1;} }

.msg.caynana{
  align-self: flex-start;
  color: #ddd;
  background: transparent;
  border-left: 3px solid var(--amber);
  padding-left: 15px;
}

.msg.user{
  align-self: flex-end;
  background: #222;
  color: #fff;
  border-bottom-right-radius: 4px;
}

.msg.typing{
  align-self: flex-start;
  color:#777;
  font-size: 13px;
  border-left: 3px solid rgba(255,179,0,0.35);
  padding-left: 15px;
}

/* INPUT DOCK */
.input-dock{
  padding: 15px 20px 30px 20px;
  background: linear-gradient(to top, var(--bg) 80%, transparent);
  display: flex;
  align-items: center;
  gap: 12px;
  flex-shrink: 0;
}

.icon-btn{
  width: 44px;
  height: 44px;
  border: none;
  background: #111;
  border-radius: 50%;
  color: #888;
  font-size: 20px;
  cursor: pointer;
  display: flex; justify-content: center; align-items: center;
  transition: 0.2s;
}
.icon-btn:active{
  transform: scale(0.9);
  color: var(--amber);
  border: 1px solid var(--amber);
}

.input-wrapper{ flex: 1; position: relative; }

input{
  width: 100%;
  background: #111;
  border: 1px solid #333;
  border-radius: 25px;
  padding: 14px 20px;
  color: #fff;
  font-size: 16px;
  outline: none;
  transition: 0.3s;
}
input:focus{ border-color: var(--amber); box-shadow: 0 0 10px rgba(255,179,0,0.2); }
</style>
</head>

<body>
<div class="phone" id="phone">

  <div class="header">
    <div class="menu-btn">‚ò∞</div>

    <div class="eyes-container">
      <div class="eye-wrapper blink" id="eyeL">
        <div class="lid"></div>
        <div class="eye-frame"></div>
        <div class="pupil"></div>
      </div>
      <div class="eye-wrapper blink" id="eyeR">
        <div class="lid"></div>
        <div class="eye-frame"></div>
        <div class="pupil"></div>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="msg caynana">
      Ooo ho≈ü geldin...<br>
      Anlat bakalƒ±m, bug√ºn ne havadisler var?
    </div>
  </div>

  <div class="input-dock">
    <button class="icon-btn" id="btnCam">üì∑</button>
    <div class="input-wrapper">
      <input type="text" id="userInput" placeholder="Caynana'ya yaz..." autocomplete="off">
    </div>
    <button class="icon-btn" id="btnMic">üéôÔ∏è</button>
  </div>

</div>

<script>
/** ======================
 *  CONFIG
 *  ====================== */
const API_BASE = "https://bikonomi-api-2.onrender.com"; // ‚úÖ senin domain
const ENDPOINT = "/api/chat";

/** ======================
 *  DOM
 *  ====================== */
const phone = document.getElementById("phone");
const eyes = [document.getElementById("eyeL"), document.getElementById("eyeR")];
const pupils = [
  eyes[0].querySelector(".pupil"),
  eyes[1].querySelector(".pupil")
];
const input = document.getElementById("userInput");
const chatArea = document.getElementById("chatArea");

/** ======================
 *  USER STATE (v1)
 *  ====================== */
let userId = localStorage.getItem("caynana_user_id");
if (!userId) {
  userId = "u_" + Math.random().toString(16).slice(2);
  localStorage.setItem("caynana_user_id", userId);
}
let region = localStorage.getItem("caynana_region") || ""; // trakya/ege/karadeniz/dogu

/** ======================
 *  EYES TRACKING (mouse + touch)
 *  ====================== */
phone.addEventListener("mousemove", (e) => trackEyes(e.clientX, e.clientY));
phone.addEventListener("touchmove", (e) => {
  if (!e.touches || !e.touches[0]) return;
  trackEyes(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: true });

function trackEyes(x, y) {
  eyes.forEach((eye, i) => {
    if (eye.classList.contains("rolling")) return;
    const rect = eye.getBoundingClientRect();
    const dx = (x - rect.left - rect.width/2) / 8;
    const dy = (y - rect.top - rect.height/2) / 8;
    const clampedX = Math.max(-15, Math.min(15, dx));
    const clampedY = Math.max(-15, Math.min(15, dy));
    pupils[i].style.transform = `translate(${clampedX}px, ${clampedY}px)`;
  });
}

/** ======================
 *  MOOD
 *  ====================== */
function setMood(mood) {
  eyes.forEach(e => {
    e.classList.remove("blink", "suspicious", "shock", "rolling");
    e.classList.add(mood === "normal" ? "blink" : mood);
    // pupil reset
    const p = e.querySelector(".pupil");
    if (p) p.style.transform = "translate(0,0)";
  });

  if (mood === "rolling") setTimeout(() => setMood("normal"), 2000);
}

/** ======================
 *  CHAT UI
 *  ====================== */
function addMessage(text, type) {
  const div = document.createElement("div");
  div.className = `msg ${type}`;
  div.innerHTML = escapeHtml(text).replace(/\n/g, "<br>");
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
  return div;
}

function escapeHtml(s){
  return (s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/** typing bubble */
let typingEl = null;
function showTyping(){
  if (typingEl) return;
  typingEl = addMessage("Caynana yazƒ±yor‚Ä¶", "typing");
}
function hideTyping(){
  if (!typingEl) return;
  typingEl.remove();
  typingEl = null;
}

/** ======================
 *  BACKEND CALL
 *  ====================== */
async function callApi(message){
  const auth_token = localStorage.getItem("auth_token") || null; // Google token varsa
  const res = await fetch(`${API_BASE}${ENDPOINT}`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      message,
      auth_token,
      user_id: userId,      // token yoksa fallback
      region: region || null
    })
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data?.detail || "API error");
  return data; // {reply, intent, yp, used_model}
}

/** local fallback (api patlarsa) */
function localFallback(text){
  const lower = text.toLowerCase();
  let response = "Ee sonra? Devam et, dinliyorum ben.";
  let mood = "normal";

  if (lower.includes("para") || lower.includes("bor√ß") || lower.includes("fiyat")) {
    mood = "suspicious";
    response = "Bak g√∂z√ºm√ºn i√ßine... O parayƒ± ger√ßekten lazƒ±msa harca, keyfine harcama.";
  } else if (lower.includes("elti") || lower.includes("kaynana") || lower.includes("g√∂r√ºmce")) {
    mood = "rolling";
    response = "Ay yine mi o kadƒ±n? Vallahi i√ßim ≈üi≈üti sabah sabah. Ne yapmƒ±≈ü yine?";
  } else if (lower.includes("koca") || lower.includes("terk") || lower.includes("aldat")) {
    mood = "shock";
    response = "Neeey? Ciddi misin? Dur, anlat‚Ä¶ sakƒ±n tek ba≈üƒ±na kalma.";
  } else if (lower.includes("yorgun") || lower.includes("hasta") || lower.includes("√ºzg√ºn")) {
    mood = "normal";
    response = "Kƒ±yamam sana... Gel ≈ü√∂yle otur, bir nefes al. Ben buradayƒ±m.";
  }

  return { reply: response, mood, meta: "fallback" };
}

/** ======================
 *  SEND FLOW
 *  ====================== */
let busy = false;

async function sendMessage(){
  if (busy) return;
  const text = input.value.trim();
  if(!text) return;

  busy = true;
  addMessage(text, "user");
  input.value = "";
  showTyping();
  chatArea.scrollTop = chatArea.scrollHeight;

  try{
    const data = await callApi(text);
    hideTyping();

    // mood mapping (intent -> mood) v1
    let mood = "normal";
    const intent = (data.intent || "").toLowerCase();
    if (intent === "shopping") mood = "suspicious";
    if (intent === "therapy") mood = "normal";
    if (intent === "fal") mood = "normal";
    if (intent === "legal") mood = "normal";
    if (intent === "health") mood = "normal";

    // i√ßerikte ≈üok/dedikodu yakalarsan g√∂z tepkisi
    const l = text.toLowerCase();
    if (l.includes("elti") || l.includes("g√∂r√ºmce")) mood = "rolling";
    if (l.includes("terk") || l.includes("aldat")) mood = "shock";

    setMood(mood);

    const meta = `YP:${data.yp ?? "?"} ‚Ä¢ ${data.intent ?? "general"} ‚Ä¢ ${data.used_model ?? ""}`;
    addMessage(`${data.reply}`, "caynana");
    // meta istersen ayrƒ± g√∂sterebiliriz; ≈üimdilik kapalƒ± (sadelik)
    // addMessage(meta, "typing");

  }catch(e){
    hideTyping();
    const fb = localFallback(text);
    setMood(fb.mood);
    addMessage(fb.reply, "caynana");
  }finally{
    busy = false;
  }
}

input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter") sendMessage();
});

/** init */
setMood("normal");
</script>
</body>
</html>
