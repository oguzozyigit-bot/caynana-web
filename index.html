<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Caynana AI v3.4 Final Gold</title>
  <link rel="icon" href="data:,">
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* --- TEMEL AYARLAR --- */
    :root { --bg-outer: #000; --bg: #0e0e0e; --text: #ececec; --gold: #ffb300; --pistachio: #bef264; --glass: rgba(20, 20, 20, 0.98); --border: rgba(255, 255, 255, 0.12); --lip-color: #d84315; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: var(--bg-outer); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text); overflow: hidden; display: flex; align-items: center; justify-content: center; }

    /* Scrollbar Gizleme (Global) */
    ::-webkit-scrollbar { display: none; }
    * { -ms-overflow-style: none; scrollbar-width: none; }

    .mobile-frame { width: 100%; height: 100%; max-width: 480px; background: var(--bg); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(255, 255, 255, 0.05); overflow: hidden; }
    @media (min-width: 500px) { .mobile-frame { height: 95dvh; border-radius: 24px; border: 1px solid #333; } }

    /* --- TOPBAR --- */
    .topbar { flex: 0 0 65px; background: var(--glass); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; z-index: 3000; }
    .left-controls, .right-controls { display: flex; gap: 8px; align-items: center; }
    .hamb-btn { background: none; border: none; cursor: pointer; color: #aaa; font-size: 24px; padding: 5px; }

    /* TAHTERAVALLƒ∞ & LOGO */
    .brand-wrapper { display: flex; flex-direction: column; align-items: center; flex: 1; transition: transform 0.4s; }
    .logo-area { display: flex; align-items: center; gap: 6px; }
    .brand-name { font-weight: 700; font-size: 15px; color: #fff; }
    .slogan { font-size: 9px; color: #888; margin-top: 1px; font-weight: 500; }
    
    .seesaw-svg { width: 32px; height: 16px; overflow: visible; }
    .seesaw-bar { transform-origin: 20px 8px; transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    /* Animasyon Durumlarƒ± */
    .brand-wrapper.user-typing .seesaw-bar { transform: rotate(-15deg); } /* Sola */
    .brand-wrapper.bot-typing .seesaw-bar { transform: rotate(15deg); } /* Saƒüa */
    .brand-wrapper.thinking .seesaw-bar { animation: rock 1s infinite ease-in-out; } /* Sallan */
    @keyframes rock { 0%,100% {transform: rotate(-5deg);} 50% {transform: rotate(5deg);} }

    /* YP Widget (Enerji Barƒ±) */
    .yp-container { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; margin-right: 5px; }
    .yp-text { font-size: 8px; color: var(--gold); font-weight: bold; margin-bottom: 2px; }
    .yp-segments { display: flex; gap: 1px; }
    .yp-seg { width: 4px; height: 6px; background: #333; border-radius: 1px; transition: 0.3s; }
    .yp-seg.active { background: #bef264; box-shadow: 0 0 2px #bef264; }
    
    /* YP Popup */
    .yp-popup { position: absolute; top: 35px; right: -20px; width: 160px; background: #222; border: 1px solid var(--gold); padding: 10px; border-radius: 8px; font-size: 10px; color: #eee; z-index: 4000; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); line-height: 1.4; text-align: left; }
    .yp-popup::after { content: ""; position: absolute; top: -5px; right: 25px; border-width: 0 5px 5px 5px; border-style: solid; border-color: transparent transparent var(--gold) transparent; }
    .yp-popup.show { display: block; animation: popIn 0.2s; }
    @keyframes popIn { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

    .icon-btn-top { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; }
    .icon-btn-top svg { width: 22px; height: 22px; stroke: #aaa; fill: none; stroke-width: 2; transition: 0.2s; }
    .badge { position: absolute; top: 3px; right: 3px; width: 6px; height: 6px; background: #ff5252; border-radius: 50%; display: none; }

    /* --- CHAT ALANI --- */
    .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .bubble { max-width: 85%; padding: 10px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4; word-wrap: break-word; flex-shrink: 0; }
    .bubble.bot { align-self: flex-start; background: #1c1c1c; border-left: 2px solid var(--gold); color: #ddd; border-top-left-radius: 2px; }
    .bubble.user { align-self: flex-end; background: #222; border-right: 2px solid var(--pistachio); color: #fff; border-top-right-radius: 2px; text-align: right; }

    /* --- DOCK (YAZI ALANI) --- */
    .input-dock { flex: 0 0 auto; background: transparent; padding: 0 10px; z-index: 3000; display: flex; flex-direction: column; gap: 0; align-items: center; position: relative; margin-bottom: 5px; }
    
    .track-btn-wrapper { width: 100%; display: flex; justify-content: center; height: 24px; overflow: hidden; transition: 0.3s; opacity: 1; }
    .mobile-frame.tracking-active .track-btn-wrapper { height: 0; opacity: 0; }
    .track-toggle-btn { background: rgba(255,179,0,0.1); color: var(--gold); border: 1px solid var(--gold); padding: 2px 12px; border-radius: 12px; font-size: 10px; cursor: pointer; backdrop-filter: blur(4px); }

    .dock-inner { width: 100%; height: 50px; display: flex; align-items: center; gap: 5px; background: #1a1a1a; border: 1px solid #333; border-radius: 25px; padding: 0 5px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); transition: 0.3s; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
    .icon-btn svg { width: 18px; height: 18px; stroke: #aaa; stroke-width: 2; fill: none; transition: 0.2s; }
    .icon-btn:hover svg { stroke: var(--gold); }
    
    textarea { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 14px; padding: 10px 5px; height: 40px; max-height: 40px; font-family: inherit; resize: none; white-space: nowrap; overflow: hidden; }
    
    .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--pistachio); color: #000; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .send-btn svg { width: 18px; height: 18px; fill: none; stroke: #000; }

    /* --- FOOTER & LINKS --- */
    .footer-wrapper { background: #000; padding: 8px 0 12px 0; border-top: 1px solid #1a1a1a; width: 100%; display: flex; flex-direction: column; gap: 5px; }
    .footer-links-row { display: flex; justify-content: center; gap: 15px; }
    .footer-links-row a { color: #555; font-size: 10px; text-decoration: none; }
    .footer-copy { text-align: center; font-size: 9px; color: #333; font-weight: 600; }

    /* --- MENU --- */
    .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); display:flex; }
    .menu-overlay.open { opacity: 1; pointer-events: auto; }
    .menu-sidebar { width: 280px; height: 100%; background: #111; padding: 20px; transform: translateX(-100%); transition: 0.3s; display: flex; flex-direction: column; border-right: 1px solid #333; overflow-y: auto; }
    .menu-overlay.open .menu-sidebar { transform: translateX(0); }
    
    .new-chat-btn { width: 100%; background: var(--pistachio); color: #000; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; font-size: 12px; display:flex; justify-content:center; align-items:center; gap:5px; }
    .section-title { font-size: 9px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-top: 10px; }
    
    .recent-chat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #1a1a1a; border-radius: 6px; font-size: 12px; color: #ccc; cursor: pointer; margin-bottom: 4px; }
    .del-chat { background: none; border: none; font-size: 12px; cursor: pointer; opacity: 0.5; padding: 0 5px; color:#ff5252; }

    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 10px; }
    .menu-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .menu-card:hover { border-color: var(--gold); background: #222; }
    .mc-icon { font-size: 18px; }
    .mc-text { font-size: 10px; color: #bbb; }

    .regl-module { display: none; background: #2a0e0e; border: 1px solid #5c1818; border-radius: 8px; margin-top: 10px; margin-bottom: 10px; }
    .regl-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 11px; color: #ff8a80; font-weight: bold; }
    .regl-body { display: none; padding: 0 10px 10px 10px; font-size: 10px; color: #ccc; border-top: 1px solid #5c1818; }
    .regl-body.open { display: block; }

    /* MENU ACTIONS - BO≈ûLUKLU */
    .menu-actions { margin-top: auto; padding-top: 15px; border-top: 1px solid #222; display: flex; flex-direction: column; gap: 5px; }
    .action-link { font-size: 11px; color: #ccc; text-decoration: none; padding: 10px; cursor: pointer; display: block; background: #1a1a1a; border-radius: 6px; margin-bottom: 5px; text-align: center; }
    .delete-acc { background: transparent; border: 1px solid #333; color: #b71c1c !important; margin-top: 30px; } /* BO≈ûLUK VERƒ∞LDƒ∞ */

    /* --- FACE TRACKING (V2.6 MANTIƒûI) --- */
    .face-container { flex: 0 0 0px; background: linear-gradient(to bottom, var(--bg), transparent); overflow: hidden; transition: flex-basis 0.5s; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 2500; }
    .mobile-frame.tracking-active .face-container { flex-basis: 160px; }
    .face-panel-inner { opacity: 0; transition: 0.4s; transform: translateY(-20px); width: 100%; display: flex; flex-direction: column; align-items: center; }
    .mobile-frame.tracking-active .face-panel-inner { opacity: 1; transform: translateY(0); }
    
    .eyes-row { display: flex; gap: 24px; margin-bottom: 10px; }
    .eye { width: 90px; height: 65px; position: relative; --lidTop:0%; --lidBot:0%; --gx:0px; --gy:0px; transition: 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
    .sclera { width: 100%; height: 100%; background: #e0e0e0; border-radius: 50%; overflow: hidden; position: relative; border: 2px solid #1a1a1a; box-shadow: inset 0 0 10px rgba(0,0,0,0.8); }
    .iris { width: 32px; height: 32px; background: radial-gradient(circle, #5d4037 0%, #281a16 100%); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(calc(-50% + var(--gx)), calc(-50% + var(--gy))); border: 1px solid rgba(255,255,255,0.25); transition: transform 0.1s linear; }
    .pupil { width: 10px; height: 10px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .lid-top, .lid-bot { position: absolute; left: 0; width: 100%; background: var(--bg); z-index: 10; transition: height 0.3s ease-in-out; }
    .lid-top { top: 0; height: var(--lidTop); border-bottom: 2px solid #222; }
    .lid-bot { bottom: 0; height: var(--lidBot); border-top: 2px solid #222; }

    .mouth-wrapper { width: 60px; height: 26px; display: flex; justify-content: center; align-items: center; position: relative; margin-top: 8px; }
    .mouth { width: 40px; height: 10px; border-top: 3px solid var(--lip-color); border-radius: 50% 50% 0 0; position: absolute; top: 8px; transition: 0.15s; opacity: 0.9; }

    /* Uyku Modu */
    .mobile-frame.sleeping .eyes-row { animation: sleepBreath 4s infinite ease-in-out; opacity: 0.6; }
    @keyframes sleepBreath { 0%, 100% { transform: scale(1); } 50% { transform: scale(0.95) translateY(2px); } }

    #camVideo { display: none; }
    
    /* --- OVERLAYS (LOGIN & TERMS) --- */
    .full-overlay { position: absolute; inset: 0; background: #000; z-index: 6000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
    .full-overlay.active { opacity: 1; pointer-events: auto; }
    
    .login-card { width: 100%; max-width: 320px; text-align: center; }
    .auth-btn { width: 100%; padding: 12px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid #333; background: #fff; font-size: 13px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .login-links { margin-top: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; border-top: 1px solid #222; padding-top: 20px; }
    .login-links a { color: #666; font-size: 11px; text-decoration: none; transition: 0.2s; }
    .login-links a:hover { color: var(--gold); }
    .login-copy { margin-top: 20px; font-size: 12px; color: #444; font-weight: 600; }

    /* TERMS BOX */
    .agreement-box { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #888; justify-content: center; margin-top: 15px; margin-bottom: 15px; }
    .agreement-box input { width: 18px; height: 18px; accent-color: var(--gold); cursor: pointer; }
  </style>
</head>
<body>

<div class="mobile-frame" id="mobileFrame">

  <div class="topbar">
    <div class="left-controls"><button class="hamb-btn" onclick="window.toggleMenu()">‚ò∞</button></div>
    <div class="brand-wrapper" id="brandWrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20">
          <g class="seesaw-bar" id="seesawBar">
            <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
            <circle cx="3" cy="5" r="3" fill="#bef264" />
            <circle cx="37" cy="5" r="3" fill="#ffb300" id="orangeBall" />
          </g>
          <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
        </svg>
        <div class="brand-name">Caynana AI</div>
      </div>
      <div class="slogan">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div class="right-controls">
      <div class="yp-container" id="ypContainer">
        <div class="yp-text">YP</div>
        <div class="yp-segments" id="ypSegments">
          <div class="yp-seg"></div><div class="yp-seg"></div><div class="yp-seg"></div><div class="yp-seg"></div><div class="yp-seg"></div>
        </div>
        <div class="yp-popup" id="ypPopup">
          <strong>YP (Yakƒ±nla≈üma Puanƒ±)</strong><br>
          ‚Ä¢ Sƒ±k girersen artar (+5)<br>
          ‚Ä¢ Konu≈üursan artar (+0.5)<br>
          ‚Ä¢ Girmezsen d√º≈üer (-10)<br>
          Aranƒ± iyi tut evladƒ±m!
        </div>
      </div>
      <button class="icon-btn-top" onclick="document.getElementById('notifDropdown').classList.toggle('show')">
        <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <div class="badge" id="notifBadge"></div>
      </button>
      <button class="icon-btn-top" onclick="window.goProfile()">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      </button>
    </div>
  </div>

  <div class="notification-dropdown" id="notifDropdown">
    <div class="notif-header">Bildirimler</div>
    <div class="notif-list" id="notifList"></div>
  </div>

  <div class="menu-overlay" id="menuOverlay" onclick="if(event.target.id==='menuOverlay') window.toggleMenu()">
    <div class="menu-sidebar no-scroll">
      <button class="new-chat-btn" onclick="window.newChat()"><span>+</span> YENƒ∞ SOHBET</button>
      <div class="section-title">Son Sohbetler</div>
      <div class="recent-chats-list" id="recentChatsList"></div>
      
      <div class="section-title">Asistan</div>
      <div class="menu-grid">
        <div class="menu-card"><span class="mc-icon">üõçÔ∏è</span><span class="mc-text">Alƒ±≈üveri≈ü</span></div>
        <div class="menu-card"><span class="mc-icon">üó£Ô∏è</span><span class="mc-text">Terc√ºman</span></div>
        <div class="menu-card" onclick="location.href='pages/diyet.html'"><span class="mc-icon">ü•ó</span><span class="mc-text">Diyet</span></div>
        <div class="menu-card"><span class="mc-icon">‚ù§Ô∏è</span><span class="mc-text">Saƒülƒ±k</span></div>
        <div class="menu-card"><span class="mc-icon">üìÖ</span><span class="mc-text">√ñzel G√ºn</span></div>
        <div class="menu-card"><span class="mc-icon">‚è∞</span><span class="mc-text">Hatƒ±rlatƒ±cƒ±</span></div>
      </div>

      <div class="section-title">Mistik</div>
      <div class="menu-grid">
        <div class="menu-card" onclick="window.openFal()"><span class="mc-icon">‚òï</span><span class="mc-text">Kahve</span></div>
        <div class="menu-card"><span class="mc-icon">üîÆ</span><span class="mc-text">Tarot</span></div>
        <div class="menu-card" onclick="location.href='pages/burc.html'"><span class="mc-icon">‚ôà</span><span class="mc-text">Bur√ß</span></div>
        <div class="menu-card"><span class="mc-icon">üåô</span><span class="mc-text">R√ºya</span></div>
      </div>

      <div class="regl-module" id="reglModule">
        <div class="regl-header" onclick="document.getElementById('reglBody').classList.toggle('open')"><span>ü©∏ Regl Takibi</span><span>‚ñº</span></div>
        <div class="regl-body" id="reglBody">Son: 12 Ocak<br>Beklenen: 9 ≈ûubat</div>
      </div>

      <div class="menu-actions">
        <a class="action-link" id="logoutBtn" style="color:#fff;">üõ°Ô∏è G√ºvenli √áƒ±kƒ±≈ü</a>
        <a class="action-link delete-acc" id="deleteAccBtn">‚ö†Ô∏è Hesabƒ±mƒ± Sil</a>
        <div style="text-align:center; font-size:9px; color:#444; margin-top:10px;">@CaynanaAI By Ozyigits 2026</div>
      </div>
    </div>
  </div>

  <div class="face-container" id="faceContainer">
    <div class="face-panel-inner" id="faceInner">
      <div class="eyes-row">
        <div class="eye" id="eyeL">
          <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
          <div class="lid-top"></div><div class="lid-bot"></div>
        </div>
        <div class="eye" id="eyeR">
          <div class="sclera"><div class="iris"><div class="pupil"></div><div class="reflection"></div></div></div>
          <div class="lid-top"></div><div class="lid-bot"></div>
        </div>
      </div>
      <div class="mouth-wrapper"><div class="mouth"></div></div>
      <button class="track-toggle-btn" style="margin-top:10px;" onclick="window.toggleCam()">Kapat</button>
    </div>
  </div>

  <div class="chat-area no-scroll" id="chat"></div>

  <div class="input-dock">
    <div class="track-btn-wrapper"><button class="track-toggle-btn" onclick="window.toggleCam()">üëÅÔ∏è TAKƒ∞P ET</button></div>
    <div class="dock-inner">
      <button class="icon-btn" onclick="window.toggleCam()"><svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></button>
      <textarea id="msgInput" rows="1" placeholder="Ne lazƒ±m evladƒ±m?" spellcheck="false"></textarea>
      <button class="icon-btn" id="micBtn"><svg viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
      <button class="send-btn" id="sendBtn"><svg viewBox="0 0 24 24"><path d="M22 2L11 13"></path><path d="M22 2L15 22L11 13L2 9L22 2Z"></path></svg></button>
    </div>
  </div>

  <div class="footer-wrapper">
    <div class="footer-links-row">
      <a href="pages/hakkimizda.html">Hakkƒ±mƒ±zda</a>
      <a href="pages/sss.html">SSS</a>
      <a href="pages/gizlilik.html">Gizlilik</a>
      <a href="pages/iletisim.html">ƒ∞leti≈üim</a>
    </div>
    <div class="footer-copy">@CaynanaAI By Ozyigits 2026</div>
  </div>

</div>

<div class="full-overlay active" id="loginOverlay">
  <div class="login-card">
    <div style="display:flex; justify-content:center; margin-bottom:10px;">
      <svg class="seesaw-svg" viewBox="0 0 40 20" style="width:60px; height:30px;">
        <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
        <g class="seesaw-bar" style="animation: rock 2s infinite ease-in-out">
          <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
          <circle cx="3" cy="5" r="3" fill="#bef264" />
          <circle cx="37" cy="5" r="3" fill="#ffb300" />
        </g>
      </svg>
    </div>
    <div class="brand-name" style="font-size:24px; margin-bottom:5px;">Caynana.AI</div>
    <div style="font-size:12px; color:#888; margin-bottom:20px;">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    
    <button class="auth-btn" id="googleLogin">
      <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Google ile Devam Et
    </button>
    <button class="auth-btn" id="appleLogin" style="background:#000; color:#fff;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="#fff"><path d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24.02-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.74s2.57-.91 4.35-.68c.75.04 2.86.32 3.9 1.83-3.23 1.6-2.67 6.38 1.02 7.94-.75 1.49-1.81 2.97-2.89 4.01l-.22.25-.24-.12zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.54 4.33-3.74 4.25z"/></svg>
      Apple ile Devam Et
    </button>

    <div class="login-links">
      <a href="pages/hakkimizda.html">Hakkƒ±mƒ±zda</a>
      <a href="pages/sss.html">SSS</a>
      <a href="pages/gizlilik.html">Gizlilik</a>
      <a href="pages/sozlesme.html">Kullanƒ±m</a>
      <a href="pages/iletisim.html">ƒ∞leti≈üim</a>
    </div>
    <div class="login-copy">@CaynanaAI By Ozyigits</div>
  </div>
</div>

<div class="full-overlay" id="termsOverlay" style="z-index:6500; background:#000; display:none;">
  <div class="login-card" style="max-width:350px;">
    <div class="brand-name">S√∂zle≈üme</div>
    <div style="font-size:12px; color:#888; margin-bottom:10px;">Devam etmek i√ßin onayla evladƒ±m.</div>
    <div style="border:1px solid #333; height:200px; overflow-y:auto; font-size:10px; text-align:left; padding:10px; margin-bottom:10px;">
      <p>1. Caynana AI eƒülence ama√ßlƒ±dƒ±r...</p>
      <p>2. Verileriniz KVKK kapsamƒ±nda...</p>
    </div>
    <div class="agreement-box">
      <input type="checkbox" id="termsCheck"> <label for="termsCheck">Okudum, onaylƒ±yorum.</label>
    </div>
    <button class="auth-btn" id="termsAcceptBtn">Onayla ve Gir</button>
  </div>
</div>

<div class="full-overlay" id="falOverlay" style="background:#111; z-index:7000; display:none;">
  <button onclick="document.getElementById('falOverlay').style.display='none'" style="position:absolute; top:20px; right:20px; background:none; border:none; font-size:30px; color:#fff;">&times;</button>
  <div style="text-align:center; margin-top:60px; color:#d9f99d;"><h2>Kaynana Fal</h2></div>
  <div style="flex:1; display:flex; justify-content:center; align-items:center;">
    <label class="send-btn" style="width:80px; height:80px;"><input type="file" style="display:none;" onchange="alert('Fal resmi alƒ±ndƒ±.'); document.getElementById('falOverlay').style.display='none';"><svg viewBox="0 0 24 24" width="30"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></label>
  </div>
</div>

<video id="camVideo" autoplay playsinline muted></video>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

<script type="module">
const BASE_DOMAIN = "https://caynana-api-py310-final.onrender.com";
const STORAGE_KEY = "caynana_user_final"; // ANAHTAR SABƒ∞TLENDƒ∞
let chatHistory = [], deleteCounter = 0, idleTimer = null, isTracking = false;
const $ = (id) => document.getElementById(id);

// --- 1. INIT ---
window.onload = function() {
  checkLogin();
  resetIdle();
  setInterval(autoLook, 4000);
};

function checkLogin() {
  const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
  if(user && user.id) {
    if(!user.termsAccepted) {
      $("loginOverlay").classList.remove("active");
      $("termsOverlay").style.display = "flex";
    } else {
      $("loginOverlay").classList.remove("active");
      $("termsOverlay").style.display = "none";
      checkGender();
      renderHistory();
      updateYP("visit");
      // BO≈ûLUK D√úZELTƒ∞LDƒ∞
      typeWriter(`Ho≈ü geldin ${user.name || 'evladƒ±m'}. Ben Caynana.`);
    }
  } else {
    $("loginOverlay").classList.add("active");
  }
}

// --- 2. LOGIN / LOGOUT ---
$("googleLogin").onclick = () => {
  // Demo Login
  const u = {id:"u_123", name:"Sultan", gender:"Kadƒ±n", yp:50, termsAccepted:false};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(u));
  checkLogin();
};

$("termsAcceptBtn").onclick = () => {
  if(!$("termsCheck").checked) { alert("Onaylaman lazƒ±m evladƒ±m."); return; }
  const u = JSON.parse(localStorage.getItem(STORAGE_KEY));
  u.termsAccepted = true;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(u));
  checkLogin();
};

$("logoutBtn").onclick = () => {
  // √áIKI≈û MESAJI
  if(confirm("Beni terk etmek √ºzeresin, emin misin evladƒ±m?")) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
};

$("deleteAccBtn").onclick = () => {
  deleteCounter++;
  if(deleteCounter===1) alert("Hesabƒ±nƒ± silmek istediƒüine emin misin?");
  else if(deleteCounter===2) alert("Son ≈üans! Her ≈üey silinecek.");
  else if(deleteCounter===3) { localStorage.clear(); location.reload(); }
};

// --- 3. PROFILE CLICK ---
window.goProfile = () => {
  const u = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
  if(u && u.id) location.href = "pages/profil.html";
  else alert("Giri≈ü yapmadƒ±n ki evladƒ±m!");
};

// --- 4. CHAT (VERƒ∞ FORMATI D√úZELTƒ∞LDƒ∞) ---
$("sendBtn").onclick = sendMessage;
$("msgInput").onkeydown = (e) => { if(e.key==="Enter") sendMessage(); };

async function sendMessage() {
  const inp = $("msgInput");
  const txt = inp.value.trim();
  if(!txt) return;

  addBubble(txt, "user");
  inp.value = "";
  $("brandWrapper").classList.add("user-typing");
  updateYP("msg");
  chatHistory.push({ role: "user", content: txt });
  saveHistory(txt);

  setTimeout(() => {
    $("brandWrapper").classList.remove("user-typing");
    $("brandWrapper").classList.add("thinking");
  }, 400);

  try {
    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    // API CALL - FORMAT CORRECT
    const res = await fetch(`${BASE_DOMAIN}/api/chat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
            message: txt, 
            user_id: user.id || "guest", 
            history: chatHistory // Backend List[Dict] bekliyor, bu doƒüru.
        })
    });
    
    if(!res.ok) throw new Error("Sunucu: " + res.status);
    const data = await res.json();
    const reply = data.assistant_text || "Bir ≈üeyler oldu.";

    $("brandWrapper").classList.remove("thinking");
    $("brandWrapper").classList.add("bot-typing");
    chatHistory.push({ role: "assistant", content: reply });
    typeWriter(reply, () => $("brandWrapper").classList.remove("bot-typing"));
  } catch(e) {
    console.error(e);
    $("brandWrapper").classList.remove("thinking");
    addBubble("Baƒülantƒ± hatasƒ± evladƒ±m.", "bot");
  }
}

function addBubble(t, type) {
  const d = document.createElement("div");
  d.className = `bubble ${type}`;
  d.innerText = t;
  $("chat").appendChild(d);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function typeWriter(txt, cb) {
  const d = document.createElement("div");
  d.className = "bubble bot";
  $("chat").appendChild(d);
  let i=0;
  const t = setInterval(() => {
    d.innerText += txt.charAt(i);
    $("chat").scrollTop = $("chat").scrollHeight;
    i++;
    if(i>=txt.length) { clearInterval(t); if(cb) cb(); }
  }, 20);
}

// --- 5. G√ñZLER (V2.6 MANTIƒûI) ---
function setGaze(x, y) {
  const L=$("eyeL"), R=$("eyeR");
  if(!L || !R) return;
  const gx = Math.min(Math.max(x*20, -20), 20);
  const gy = Math.min(Math.max(y*15, -15), 15);
  L.style.setProperty('--gx', gx+'px'); L.style.setProperty('--gy', gy+'px');
  R.style.setProperty('--gx', gx+'px'); R.style.setProperty('--gy', gy+'px');
}
function setLids(top, bot=0) {
  const L=$("eyeL"), R=$("eyeR");
  if(!L || !R) return;
  [L,R].forEach(e=>{
     e.querySelector('.lid-top').style.height = top+'%';
     e.querySelector('.lid-bot').style.height = bot+'%';
  });
}
function autoLook() {
  if($("mobileFrame").classList.contains("sleeping") || isTracking) return;
  const rx = (Math.random()-0.5)*1.2, ry = (Math.random()-0.5)*0.5;
  setGaze(rx, ry);
  setTimeout(()=>setGaze(0,0), 1000);
}
function resetIdle() {
  $("mobileFrame").classList.remove("sleeping");
  setLids(0,0);
  clearTimeout(idleTimer);
  idleTimer = setTimeout(() => {
    if(!isTracking) {
       $("mobileFrame").classList.add("sleeping");
       setLids(60,20); // Uyku pozisyonu
    }
  }, 30000);
}
window.addEventListener("pointermove", (e) => {
  resetIdle();
  if(isTracking) return; 
  const rect = $("mobileFrame").getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
  const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
  setGaze(x,y);
});

// --- 6. EXTRAS ---
function updateYP(action) {
  let user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  let yp = user.yp || 50;
  if(action==="msg") yp+=0.5; if(action==="visit") yp+=5;
  yp = Math.min(100, Math.max(0, yp));
  
  // Segment Bar Update
  const segs = document.querySelectorAll('.yp-seg');
  const activeCount = Math.floor(yp / 20);
  segs.forEach((s,i) => s.classList.toggle('active', i < activeCount));
  
  user.yp = yp;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(user));
}
$("ypContainer").onclick = (e) => { e.stopPropagation(); $("ypPopup").classList.toggle("show"); };
document.body.onclick = () => $("ypPopup").classList.remove("show");

function checkGender() {
  const u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  $("reglModule").style.display = (u.gender === "Kadƒ±n") ? "block" : "none";
}

function saveHistory(msg) {
  let list = JSON.parse(localStorage.getItem("caynana_chats") || "[]");
  if(chatHistory.length===1) {
    list.unshift({id: Date.now(), title: msg.substring(0,10)+"..."});
    if(list.length>5) list=list.slice(0,5);
    localStorage.setItem("caynana_chats", JSON.stringify(list));
    renderHistory();
  }
}
function renderHistory() {
  $("recentChatsList").innerHTML = JSON.parse(localStorage.getItem("caynana_chats")||"[]").map(i => 
    `<div class="recent-chat-item"><span>${i.title}</span><button class="del-chat" onclick="window.delChat(${i.id})">üóëÔ∏è</button></div>`
  ).join("");
}
window.delChat = (id) => {
  let list = JSON.parse(localStorage.getItem("caynana_chats")||"[]").filter(x=>x.id!==id);
  localStorage.setItem("caynana_chats", JSON.stringify(list));
  renderHistory();
};

window.toggleMenu = () => $("menuOverlay").classList.toggle("open");
window.toggleCam = () => { $("mobileFrame").classList.toggle("tracking-active"); isTracking=!isTracking; resetIdle(); };
window.newChat = () => { chatHistory=[]; $("chat").innerHTML=""; $("menuOverlay").classList.remove("open"); };
window.openFal = () => { $("falOverlay").style.display="flex"; window.toggleMenu(); };
window.handleFalFile = () => { alert("Fal resmi y√ºklendi."); };
</script>
</body>
</html>
