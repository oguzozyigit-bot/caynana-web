<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>CAYNANA.AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{ --primary:#10B981; --bg:#F3F4F6; --white:#fff; --text:#111827; --muted:#6B7280; --border:#E5E7EB; }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  body{margin:0; font-family:'Inter', sans-serif; background:var(--bg); height:100dvh; display:flex; justify-content:center; overflow:hidden;}
  
  #app{width:100%; max-width:768px; height:100%; background:var(--white); position:relative; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,0,0,0.05);}
  
  /* --- HEADER --- */
  #topbar{
    height:64px; display:flex; align-items:center; justify-content:space-between; 
    padding:0 16px; border-bottom:1px solid var(--border);
    background: rgba(255,255,255,0.98); z-index: 20;
  }
  .brand-container { display: flex; flex-direction: column; justify-content: center; cursor: pointer; }
  .brand{ font-weight:900; color:var(--text); font-size:20px; display: flex; align-items: center; gap: 8px; } 
  .brand i { color: var(--primary); font-size: 22px; } .brand span{color:var(--primary);}
  .slogan { font-size: 10px; font-weight: 600; color: var(--muted); text-transform: uppercase; margin-top: 2px; margin-left: 30px; }
  .menu-btn { font-size: 20px; color: var(--text); cursor: pointer; padding: 5px; }
  
  /* --- SIDE MENU --- */
  #sideMenu {
    position: absolute; top:0; right:-100%; width: 280px; height: 100%;
    background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    z-index: 100; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 0; display: flex; flex-direction: column;
  }
  #sideMenu.open { right: 0; }
  
  .menu-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); background: #FAFAFA; }
  .close-btn { font-size: 24px; cursor: pointer; color: var(--muted); width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
  
  .menu-content { padding: 20px; overflow-y: auto; flex: 1; }

  .menu-item { display: flex; align-items: center; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border); color: var(--text); font-weight: 600; text-decoration: none; font-size: 14px; transition: 0.2s; cursor: pointer; }
  .menu-item:hover { color: var(--primary); padding-left: 5px; }
  .menu-item i { width: 20px; color: var(--primary); text-align: center; }
  
  .auth-buttons { margin-bottom: 25px; display: flex; flex-direction: column; gap: 10px; }
  .btn-auth { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px; border-radius: 8px; font-size: 13px; font-weight: 700; color: #fff; cursor: pointer; transition: 0.2s; }
  .btn-auth:active { transform: scale(0.98); }
  .btn-google { background: #DB4437; box-shadow: 0 2px 5px rgba(219, 68, 55, 0.3); } 
  .btn-facebook { background: #4267B2; box-shadow: 0 2px 5px rgba(66, 103, 178, 0.3); }
  
  .gold-promo { margin: 20px; padding: 15px; background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border: 1px solid #FCD34D; border-radius: 12px; font-size: 13px; color: #B45309; text-align: center; font-weight: 700; box-shadow: 0 4px 10px rgba(251, 191, 36, 0.2); display: flex; align-items: center; justify-content: center; gap: 8px; }
  
  #overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index: 90; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
  #overlay.active { display: block; opacity: 1; }

  /* --- MODAL (BÄ°LGÄ° PENCERESÄ°) --- */
  .modal {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 200; display: none;
    align-items: center; justify-content: center; padding: 20px;
    backdrop-filter: blur(3px);
  }
  .modal.active { display: flex; animation: fadeIn 0.2s; }
  .modal-box {
    background: #fff; width: 100%; max-width: 400px; border-radius: 16px;
    overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    transform: translateY(20px); animation: slideUp 0.3s forwards;
  }
  @keyframes slideUp { to { transform: translateY(0); } }
  
  .modal-header {
    background: var(--primary); color: #fff; padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
    font-weight: 700; font-size: 16px;
  }
  .modal-close { cursor: pointer; font-size: 20px; opacity: 0.8; }
  .modal-body { padding: 20px; line-height: 1.6; color: var(--text); font-size: 14px; max-height: 60vh; overflow-y: auto; }
  
  /* Form ElemanlarÄ± */
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 12px; color: var(--muted); }
  .form-group input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
  .form-group input:focus { border-color: var(--primary); }
  .btn-submit { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; }

  /* --- CHAT ALANI --- */
  #main{flex:1; overflow-y:auto; padding:16px; padding-bottom:240px; scroll-behavior: smooth;}
  .welcome-box { text-align: center; margin-bottom: 20px; padding: 10px 0; }
  .welcome-title { font-size: 18px; font-weight: 800; color: var(--text); margin-bottom: 8px; transition: 0.3s; }
  .welcome-desc { font-size: 13px; color: var(--muted); line-height: 1.5; max-width: 90%; margin: 0 auto; transition: 0.3s; }
  
  .msg{display:flex; margin-bottom:16px; animation: fadeIn 0.3s ease;}
  @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
  .msg.user{justify-content:flex-end;} .msg.ai{justify-content:flex-start;}
  
  .bubble{ max-width:90%; padding:14px 18px; border-radius:20px; font-size:14px; line-height:1.6; box-shadow:0 2px 4px rgba(0,0,0,.03); position: relative; }
  .msg.user .bubble{background:var(--primary); color:#fff; border-bottom-right-radius:4px;}
  .msg.ai .bubble{background:#F3F4F6; color:var(--text); border-bottom-left-radius:4px;}
  .bubble img.preview { max-width: 100%; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.2); }

  /* MARKDOWN STYLES */
  .bubble table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #eee; }
  .bubble th { background: #E5E7EB; color: #374151; font-weight: 800; text-align: left; padding: 8px; }
  .bubble td { border-top: 1px solid #eee; padding: 8px; color: #4B5563; }
  .bubble tr:nth-child(even) { background: #FAFAFA; }
  .bubble h3 { font-size: 14px; margin-top: 15px; margin-bottom: 5px; font-weight: 800; }
  .bubble ul { padding-left: 20px; margin: 5px 0; }
  
  .score-badge { background: linear-gradient(135deg, #10B981, #059669); color: white; font-weight: 900; font-size: 20px; padding: 10px; border-radius: 12px; display: block; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
  .score-label { font-size: 10px; text-transform: uppercase; opacity: 0.9; display: block; }
  
  /* CARDS */
  .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 4px; margin-top: 10px; }
  .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
  .pimg{ width:100%; height:130px; object-fit:contain; border-radius:8px; margin-bottom:8px; background: #fff; }
  .title{ font-size:12px; font-weight:700; color: var(--text); height:34px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; margin-bottom: 4px; }
  .price{ font-size:14px; font-weight:900; color:var(--primary); margin:4px 0; }
  .btnLink{ display:flex; align-items: center; justify-content: center; gap: 4px; text-decoration:none; padding:8px; border-radius:8px; font-size:10px; font-weight:800; color:#fff; transition:.2s; text-transform: uppercase; margin-top: auto; }
  .btnGold { background: linear-gradient(135deg, #F59E0B, #B45309); } 
  .btnSilver { background: linear-gradient(135deg, #9CA3AF, #4B5563); } 
  .btnBlue { background: linear-gradient(135deg, #3B82F6, #1E40AF); } 
  .btnGreen { background: var(--primary); }

  /* --- BOTTOM AREA --- */
  #bottom{ position:absolute; bottom:0; left:0; right:0; background:#fff; padding:0; border-top:1px solid var(--border); z-index: 50; }
  
  /* DOCK */
  #dock { display: flex; gap: 16px; overflow-x: auto; padding: 12px 16px; background: #fff; scrollbar-width: none; border-bottom: 1px solid rgba(0,0,0,0.03); }
  #dock::-webkit-scrollbar { display: none; }
  .dockItem { display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 64px; cursor: pointer; color: var(--muted); transition: 0.2s; opacity: 0.6; }
  .dockItem.active { color: var(--primary); opacity: 1; transform: scale(1.05); }
  .dockItem i { font-size: 22px; margin-bottom: 2px; }
  .dockItem span { font-size: 10px; font-weight: 700; white-space: nowrap; }

  /* INPUT */
  #inputArea { padding: 12px 16px; display:flex; gap:8px; align-items: center; }
  .iconBtn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg); color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; transition: 0.2s; }
  .iconBtn:hover { border-color: var(--primary); color: var(--primary); background: #fff; }
  .mic-active { background: #FEE2E2 !important; color: #EF4444 !important; border-color: #EF4444 !important; animation: pulseRed 1.2s infinite; }
  @keyframes pulseRed{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
  #text{ flex:1; padding:12px 16px; border:1px solid var(--border); background: var(--bg); border-radius:99px; outline:none; font-size: 15px; min-width: 0; }
  #sendBtn{ width:44px; height:44px; border-radius:50%; background:var(--primary); color:#fff; border:none; cursor:pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }

  /* FOOTER */
  #brandFooter { padding-bottom: 12px; padding-top: 4px; width: 100%; background: #FAFAFA; border-top: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center; }
  .footer-content { display: inline-block; text-align: center; }
  .brandText { font-size:10px; font-weight: 800; color:#9CA3AF; padding: 4px 0; letter-spacing: 0.5px; }
  .itFlag { width: 100%; height: 8px; display: flex; border-radius: 4px; overflow: hidden; margin-top: 2px; }
  .itFlag span { flex: 1; height: 100%; } .itFlag .g{ background:#009246; } .itFlag .w{ background:#FFFFFF; border-left:1px solid #eee; border-right:1px solid #eee; } .itFlag .r{ background:#CE2B37; }

  /* AUDIO */
  .audio-btn{ margin-top:10px; padding:10px 16px; background: linear-gradient(135deg, #8B5CF6, #6D28D9); border:none; border-radius:25px; font-size:13px; font-weight: 700; color: #fff; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow: 0 4px 10px rgba(109, 40, 217, 0.3); transition: 0.2s; }
  .audio-btn.playing{ background: linear-gradient(135deg, #EF4444, #B91C1C); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); animation: pulse 1.5s infinite; }
  
  #fileInput { display: none; }
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="brand-container" onclick="location.reload()">
      <div class="brand"><i class="fa-solid fa-robot"></i> CAYNANA<span>.AI</span></div>
      <div class="slogan">Sanal YaÅŸam KoÃ§unuz</div>
    </div>
    <div class="menu-btn" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
  </div>

  <div id="overlay" onclick="toggleMenu()"></div>
  
  <div id="sideMenu">
    <div class="menu-header">
        <div class="brand" style="font-size:18px;">CAYNANA<span>.AI</span></div>
        <div class="close-btn" onclick="toggleMenu()">&times;</div>
    </div>
    
    <div class="menu-content" id="authSection">
        <div style="text-align:center; color:#999; margin-top:20px;">YÃ¼kleniyor...</div>
    </div>

    <div class="menu-content" style="padding-top:0;">
        <hr style="border:0; border-top:1px solid #eee; width:100%; margin:15px 0;">
        <div class="menu-item" onclick="showModal('about')"><i class="fa-solid fa-info-circle"></i> HakkÄ±mÄ±zda</div>
        <div class="menu-item" onclick="showModal('privacy')"><i class="fa-solid fa-shield-halved"></i> Gizlilik PolitikasÄ±</div>
        <div class="menu-item" onclick="showModal('faq')"><i class="fa-solid fa-circle-question"></i> S.S.S.</div>
        <div class="menu-item" onclick="showModal('contact')"><i class="fa-solid fa-envelope"></i> Ä°letiÅŸim</div>
    </div>

    <div class="gold-promo">
        <i class="fa-solid fa-crown" style="color: #F59E0B; font-size:16px;"></i> Gold Ãœyelik Ã‡ok YakÄ±nda!
    </div>
  </div>

  <div class="modal" id="infoModal">
    <div class="modal-box">
      <div class="modal-header">
        <span id="modalTitle">BaÅŸlÄ±k</span>
        <span class="modal-close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modalContent">
        Ä°Ã§erik yÃ¼kleniyor...
      </div>
    </div>
  </div>

  <div id="main">
    <div class="welcome-box">
        <div class="welcome-title" id="welcomeTitle">AlÄ±ÅŸveriÅŸ UzmanÄ±</div>
        <div class="welcome-desc" id="welcomeDesc">AradÄ±ÄŸÄ±n Ã¼rÃ¼nÃ¼ yaz, link yapÄ±ÅŸtÄ±r dilersen fotoÄŸrafÄ±nÄ± Ã§ek. En iyi fiyatÄ± ve satÄ±cÄ±yÄ± bulayÄ±m.</div>
    </div>
  </div>

  <div id="bottom">
    <div id="dock"></div>
    <div id="inputArea">
      <button class="iconBtn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></button>
      <button class="iconBtn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></button>
      <input id="text" placeholder="Ne arÄ±yorsun evladÄ±m?" autocomplete="off" onkeypress="if(event.key==='Enter') send()">
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
    <div id="brandFooter">
      <div class="footer-content">
          <div class="brandText">@CAYNANA BY ITALKY TECHNOLOGY</div>
          <div class="itFlag"><span class="g"></span><span class="w"></span><span class="r"></span></div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" capture="environment">

<script>
  // API URL'leri (CanlÄ± Sunucu)
  const API_URL = "https://bikonomi-api-2.onrender.com/api/chat";
  const LOGIN_URL = "https://bikonomi-api-2.onrender.com/api/login";
  const REGISTER_URL = "https://bikonomi-api-2.onrender.com/api/register";
  const SPEAK_URL = "https://bikonomi-api-2.onrender.com/api/speak";
  
  let sessionId = "sess_" + Math.random().toString(36).substr(2, 9);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "shopping";
  let userToken = localStorage.getItem("caynana_token");
  let userData = JSON.parse(localStorage.getItem("caynana_user") || "null");

  // BAÅžLANGIÃ‡
  window.onload = () => {
      checkLoginStatus();
      renderDock();
  };

  // --- KULLANICI KONTROLÃœ ---
  function checkLoginStatus() {
      const authDiv = document.getElementById("authSection");
      if(userToken && userData) {
          // GiriÅŸ YapÄ±lmÄ±ÅŸ
          authDiv.innerHTML = `
              <div style="padding:15px; background:#ECFDF5; border-radius:12px; border:1px solid #10B981; margin-bottom:10px;">
                  <div style="font-weight:800; color:#065F46; font-size:16px; margin-bottom:4px;">Merhaba, ${userData.name}</div>
                  <div style="font-size:12px; color:#047857;">${userData.email}</div>
                  ${userData.is_gold ? '<div style="color:#F59E0B; font-size:12px; font-weight:700; margin-top:5px;"><i class="fa-solid fa-crown"></i> GOLD ÃœYE</div>' : ''}
              </div>
              <div class="menu-item" onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i> Ã‡Ä±kÄ±ÅŸ Yap</div>
          `;
      } else {
          // GiriÅŸ YapÄ±lmamÄ±ÅŸ
          authDiv.innerHTML = `
              <div class="auth-buttons">
                  <div class="btn-auth btn-google" onclick="showAuthModal('login')"><i class="fa-brands fa-google"></i> Google ile GiriÅŸ</div>
                  <div class="btn-auth btn-facebook" onclick="showAuthModal('login')"><i class="fa-brands fa-facebook"></i> Facebook ile GiriÅŸ</div>
              </div>
              <div class="menu-item" onclick="showAuthModal('register')"><i class="fa-solid fa-user-plus"></i> Ãœye Ol</div>
              <div class="menu-item" onclick="showAuthModal('login')"><i class="fa-solid fa-sign-in-alt"></i> GiriÅŸ Yap</div>
          `;
      }
  }

  function logout() {
      localStorage.removeItem("caynana_token");
      localStorage.removeItem("caynana_user");
      userToken = null;
      userData = null;
      alert("GÃ¼le gÃ¼le evladÄ±m, yine beklerim.");
      checkLoginStatus();
      toggleMenu();
  }

  // --- MODLAR ---
  const MODES = {
    shopping: { icon: "fa-bag-shopping", label: "AlÄ±ÅŸveriÅŸ", title: "AlÄ±ÅŸveriÅŸ UzmanÄ±", desc: "AradÄ±ÄŸÄ±n Ã¼rÃ¼nÃ¼ yaz, en iyisini bulayÄ±m.", ph: "Ne arÄ±yorsun evladÄ±m?" },
    health: { icon: "fa-heart-pulse", label: "SaÄŸlÄ±k", title: "SaÄŸlÄ±k DanÄ±ÅŸmanÄ±", desc: "Åžikayetini sÃ¶yle, tavsiye vereyim.", ph: "Neren aÄŸrÄ±yor?" },
    diet: { icon: "fa-carrot", label: "Diyet", title: "Diyetisyen", desc: "Boyunu kilonu sÃ¶yle diyet yazayÄ±m.", ph: "Kilo kaÃ§?" },
    food: { icon: "fa-utensils", label: "Yemek", title: "Åžef & Tarifler", desc: "Evdeki malzemeyi sÃ¶yle tarif vereyim.", ph: "Ne piÅŸireceksin?" },
    law: { icon: "fa-scale-balanced", label: "Hukuk", title: "Hukuk DanÄ±ÅŸmanÄ±", desc: "Hukuki derdini anlat.", ph: "Sorun nedir?" },
    translate: { icon: "fa-language", label: "Ã‡evirmen", title: "AnlÄ±k Ã‡eviri", desc: "Yaz Ã§evireyim.", ph: "Ne Ã§evrilecek?" },
    astro: { icon: "fa-star", label: "BurÃ§", title: "GÃ¼nlÃ¼k BurÃ§", desc: "Burcunu sÃ¶yle, yÄ±ldÄ±zlarÄ± okuyayÄ±m.", ph: "Burcun ne?" },
    dream: { icon: "fa-cloud-moon", label: "RÃ¼ya", title: "RÃ¼ya Tabiri", desc: "RÃ¼yanÄ± anlat hayra yoralÄ±m.", ph: "Ne gÃ¶rdÃ¼n?" },
    fal: { icon: "fa-mug-hot", label: "Fal", title: "FalcÄ± BacÄ±", desc: "Niyetini tut.", ph: "Niyet ettin mi?" }
  };

  // --- HTML FORMLARI ---
  const authForms = {
    login: `
      <h3>GiriÅŸ Yap</h3>
      <div class="form-group"><label>E-posta</label><input type="email" id="loginEmail" placeholder="ornek@mail.com"></div>
      <div class="form-group"><label>Åžifre</label><input type="password" id="loginPass" placeholder="******"></div>
      <button class="btn-submit" onclick="doLogin()">GiriÅŸ Yap</button>
    `,
    register: `
      <h3>Ãœye Ol (Ãœcretsiz)</h3>
      <div class="form-group"><label>AdÄ±n SoyadÄ±n</label><input type="text" id="regName" placeholder="Ad Soyad"></div>
      <div class="form-group"><label>E-posta</label><input type="email" id="regEmail" placeholder="ornek@mail.com"></div>
      <div class="form-group"><label>Åžifre Belirle</label><input type="password" id="regPass" placeholder="******"></div>
      <button class="btn-submit" onclick="doRegister()">KayÄ±t Ol</button>
    `
  };

  const staticContent = {
    about: "<h3>Biz Kimiz?</h3><p>Ben Caynana! Italky Teknoloji A.Åž. tarafÄ±ndan geliÅŸtirilen, yerli ve milli, biraz huysuz ama altÄ±n kalpli yapay zeka asistanÄ±nÄ±m.</p>",
    privacy: "<h3>Gizlilik PolitikasÄ±</h3><p>EvladÄ±m, verilerin benim namusumdur. KonuÅŸtuklarÄ±mÄ±z aramÄ±zda kalÄ±r.</p>",
    faq: "<h3>SÄ±kÃ§a Sorulan Sorular</h3><p><strong>Ãœcretli mi?</strong><br>Åžimdilik bedava evladÄ±m, tepe tepe kullan.</p>",
    contact: "<h3>Ä°letiÅŸim</h3><p>Firma: <strong>Italky Teknoloji A.Åž.</strong></p><p>E-posta: <strong>destek@caynana.com</strong></p><p>Adres: Teknopark, DÃ¼zce</p>"
  };

  // --- API Ä°ÅžLEMLERÄ° ---
  async function doLogin() {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      if(!email || !pass) { alert("E-posta ve ÅŸifreni yaz evladÄ±m."); return; }

      try {
          const res = await fetch(LOGIN_URL, {
              method: "POST", headers: {"Content-Type": "application/json"},
              body: JSON.stringify({email: email, password: pass})
          });
          const data = await res.json();
          if(data.ok) {
              localStorage.setItem("caynana_token", data.access_token);
              localStorage.setItem("caynana_user", JSON.stringify(data.user));
              userToken = data.access_token; userData = data.user;
              alert(data.msg); closeModal(); checkLoginStatus(); toggleMenu();
          } else { alert("Hata: " + data.msg); }
      } catch(e) { alert("Sunucuya baÄŸlanamadÄ±m."); }
  }

  async function doRegister() {
      const name = document.getElementById("regName").value;
      const email = document.getElementById("regEmail").value;
      const pass = document.getElementById("regPass").value;
      if(!name || !email || !pass) { alert("Hepsini doldur evladÄ±m."); return; }

      try {
          const res = await fetch(REGISTER_URL, {
              method: "POST", headers: {"Content-Type": "application/json"},
              body: JSON.stringify({full_name: name, email: email, password: pass})
          });
          const data = await res.json();
          if(data.ok) { alert(data.msg); showAuthModal('login'); } else { alert("Hata: " + data.msg); }
      } catch(e) { alert("KayÄ±t olunamadÄ±."); }
  }

  // --- DÄ°ÄžER FONKSÄ°YONLAR ---
  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key => {
        const m = MODES[key];
        const item = document.createElement("div");
        item.className = `dockItem ${key === currentMode ? 'active' : ''}`;
        item.onclick = () => switchMode(key);
        item.innerHTML = `<i class="fa-solid ${m.icon}"></i><span>${m.label}</span>`;
        dock.appendChild(item);
    });
  }

  function switchMode(key){
    currentMode = key;
    renderDock();
    const m = MODES[key];
    document.getElementById("text").placeholder = m.ph;
    const mainDiv = document.getElementById("main");
    mainDiv.innerHTML = `
        <div class="welcome-box">
            <div class="welcome-title" id="welcomeTitle">${m.title}</div>
            <div class="welcome-desc" id="welcomeDesc">${m.desc}</div>
        </div>
    `;
  }

  function toggleMenu(){
    const menu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    if(menu.classList.contains("open")){ menu.classList.remove("open"); overlay.classList.remove("active"); }
    else { menu.classList.add("open"); overlay.classList.add("active"); }
  }

  function closeModal() { document.getElementById('infoModal').classList.remove('active'); }

  function showModal(type) {
    toggleMenu();
    const modal = document.getElementById('infoModal');
    document.getElementById('modalTitle').innerText = (type==='about'?'HakkÄ±mÄ±zda':type==='contact'?'Ä°letiÅŸim':(type==='privacy'?'Gizlilik':'Bilgi'));
    document.getElementById('modalContent').innerHTML = staticContent[type] || "Ä°Ã§erik yok.";
    modal.classList.add('active');
  }

  function showAuthModal(type) {
    // toggleMenu(); // Mobilde menÃ¼ aÃ§Ä±k kalsÄ±n mÄ±? KapatalÄ±m daha temiz gÃ¶rÃ¼nÃ¼r
    const menu = document.getElementById("sideMenu");
    if(menu.classList.contains("open")) toggleMenu(); // MenÃ¼ aÃ§Ä±ksa kapat

    const modal = document.getElementById('infoModal');
    document.getElementById('modalTitle').innerText = (type==='login'?'GiriÅŸ Yap':'Ãœye Ol');
    document.getElementById('modalContent').innerHTML = authForms[type];
    modal.classList.add('active');
  }

  const fileEl = document.getElementById("fileInput");
  function openCamera(){ fileEl.value = ""; fileEl.click(); }
  fileEl.addEventListener("change", (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{ pendingImage = reader.result; document.getElementById("text").value = "ðŸ“· FotoÄŸraf eklendi"; send(); };
    reader.readAsDataURL(file);
  });

  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) { alert("Mikrofon desteÄŸi yok."); return; }
    const rec = new SR(); rec.lang = "tr-TR";
    const btn = document.getElementById("micBtn");
    btn.classList.add("mic-active");
    rec.onresult = (e) => { document.getElementById("text").value = e.results[0][0].transcript; btn.classList.remove("mic-active"); send(); };
    rec.onend = () => btn.classList.remove("mic-active");
    rec.start();
  }

  async function send(){
    const txtEl = document.getElementById("text");
    let val = txtEl.value.trim();
    if(pendingImage && (val.includes("FotoÄŸraf eklendi") || val === "")) val = "Bu fotoÄŸraftaki Ã¼rÃ¼nÃ¼ bul";
    if(!val && !pendingImage) return;
    
    addBubble("user", val, false, null, pendingImage);
    txtEl.value = "";
    
    const loader = addBubble("ai", "<i class='fa-solid fa-circle-notch fa-spin'></i> DÃ¼ÅŸÃ¼nÃ¼yorum evladÄ±m...", true);
    // TOKEN GÃ–NDERME
    const payload = { message: val, session_id: sessionId, image: pendingImage, mode: currentMode, token: userToken };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) });
      const data = await res.json();
      loader.remove();
      addBubble("ai", data.assistant_text, false, data.speech_text);
      if(data.data && data.data.length) renderCards(data.data);
    }catch(e){ loader.innerHTML = "Hata oluÅŸtu evladÄ±m."; }
  }

  function addBubble(role, text, isLoader=false, speech=null, imgData=null){
    const div = document.createElement("div");
    div.className = "msg " + role;
    let content = "";
    if(imgData) content += `<img src="${imgData}" class="preview">`;
    let processedText = text.replace(/\[PUAN:\s*(.*?)\]/g, '<div class="score-badge"><span class="score-label">Caynana PuanÄ±</span>$1</div>');
    let htmlContent = (role === "ai" && !isLoader) ? marked.parse(processedText) : processedText;
    content += htmlContent;
    div.innerHTML = `<div class="bubble">${content}</div>`;
    document.getElementById("main").appendChild(div);
    setTimeout(() => { div.scrollIntoView({behavior:"smooth", block:"start"}); }, 100);
    if(speech && role === "ai" && !isLoader){
        const btn = document.createElement("button");
        btn.className = "audio-btn";
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`;
        btn.onclick = () => playAudio(speech, btn);
        div.querySelector(".bubble").appendChild(btn);
    }
    return div;
  }

  function renderCards(list){
    const wrap = document.createElement("div");
    wrap.className = "cards";
    list.forEach((p, idx) => {
        let btnClass = "btnGreen"; let btnText = "CAYNANA Ã–NERÄ°SÄ°"; let icon = "";
        if(idx === 0) { btnClass = "btnGold"; btnText = "ALTIN TERCÄ°H"; icon="<i class='fa-solid fa-trophy'></i>"; }
        else if(idx === 1) { btnClass = "btnSilver"; btnText = "GÃœMÃœÅž TERCÄ°H"; icon="<i class='fa-solid fa-medal'></i>"; }
        else if(idx === 2) { btnClass = "btnBlue"; btnText = "FÄ°YAT/PERF."; icon="<i class='fa-solid fa-tag'></i>"; }
        const card = document.createElement("div");
        card.className = "card";
        const imgUrl = p.image || 'https://via.placeholder.com/150?text=Resim+Yok';
        let actionHtml = "";
        if(p.url && p.url.startsWith("http")){
            actionHtml = `<a href="${p.url}" target="_blank" class="btnLink ${btnClass}">${icon} ${btnText}</a>`;
        } else { actionHtml = `<div style="height:10px;"></div>`; }
        card.innerHTML = `<img class="pimg" src="${imgUrl}" onerror="this.src='https://via.placeholder.com/150?text=Hata'"><div class="title">${p.title}</div><div class="price">${p.price}</div>${actionHtml}`;
        wrap.appendChild(card);
    });
    document.getElementById("main").appendChild(wrap);
    setTimeout(() => { wrap.scrollIntoView({behavior:"smooth", block:"nearest"}); }, 100);
  }

  async function playAudio(text, btn){
    if(currentAudio) { currentAudio.pause(); currentAudio = null; btn.classList.remove("playing"); btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`; return; }
    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> YÃ¼kleniyor...`;
    try{
        const res = await fetch(SPEAK_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text: text}) });
        if(!res.ok) throw new Error("Ses hatasÄ±");
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        currentAudio.onended = () => { btn.classList.remove("playing"); btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`; currentAudio = null; };
        await currentAudio.play();
        btn.classList.add("playing");
        btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sustur`;
    }catch(e){ btn.innerHTML = "Ses HatasÄ±!"; setTimeout(() => btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana KonuÅŸuyor`, 2000); }
  }
  
  // Dock'u ilk kez Ã§iz
  renderDock();
</script>
</body>
</html>
