<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CAYNANA - Karar Danışmanım</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #10B981; /* Yeşil */
    --primary-dark: #059669;
    --bg: #F8FAFC;
    --card-bg: #FFFFFF;
    --text: #1E293B;
    --gray: #64748B;
    /* İtalya Renkleri */
    --italy-green: #009246;
    --italy-white: #F1F2F1;
    --italy-red: #CE2B37;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* --- HEADER --- */
  .header {
    background: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    position: sticky; top: 0; z-index: 10;
  }
  .logo { font-size: 20px; font-weight: 900; color: #111; letter-spacing: -0.5px; cursor: pointer; }
  .logo span { color: var(--primary); }
  
  .header-actions button {
    background: #F1F5F9; border: none; width: 36px; height: 36px;
    border-radius: 50%; color: var(--gray); font-size: 16px;
    cursor: pointer; margin-left: 8px; transition: 0.2s;
  }
  .header-actions button:hover { color: var(--primary); background: #ECFDF5; }

  /* --- MAIN CONTENT --- */
  main {
    flex: 1;
    padding: 20px;
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
  }

  /* Hero (Açılış) */
  .hero-section {
    text-align: center;
    margin-top: 40px;
    transition: all 0.4s ease;
  }
  .hero-section.minimized { display: none; }

  .hero-title { font-size: 32px; font-weight: 800; line-height: 1.1; margin-bottom: 10px; color: #111; }
  .hero-title span { color: var(--primary); }
  .hero-sub { color: var(--gray); font-size: 15px; margin-bottom: 30px; }

  /* Search Container */
  .search-wrapper { position: relative; margin-bottom: 20px; z-index: 5; }
  
  .search-box {
    width: 100%; height: 56px;
    border: 2px solid #E2E8F0; border-radius: 16px;
    padding: 0 100px 0 20px; /* Sağdaki ikonlar için yer */
    font-size: 16px; outline: none; background: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    transition: 0.3s;
  }
  .search-box:focus { border-color: var(--primary); }

  .input-tools {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    display: flex; gap: 5px;
  }
  .tool-btn {
    width: 40px; height: 40px; border: none; background: transparent;
    border-radius: 12px; color: var(--gray); font-size: 18px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .tool-btn:hover { color: var(--primary); background: #F8FAFC; }
  .tool-btn.send { color: white; background: var(--primary); }
  .tool-btn.mic.active { color: #EF4444; animation: pulse 1s infinite; }

  @keyframes pulse { 0% {opacity:1} 50% {opacity:0.5} 100% {opacity:1} }

  /* Chips */
  .chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
  .chips::-webkit-scrollbar { display: none; }
  .chip {
    background: white; border: 1px solid #E2E8F0;
    padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;
    color: var(--gray); white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px;
  }
  .chip:hover { border-color: var(--primary); color: var(--primary); }

  /* --- RESULT SECTION (Sonuçlar) --- */
  #result-section { display: none; margin-top: 20px; }
  
  .result-card {
    background: white; border-radius: 20px; padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px;
  }

  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
  .result-title { font-size: 18px; font-weight: 800; color: #111; }
  
  .audio-btn {
    background: #F1F5F9; border: none; padding: 6px 12px;
    border-radius: 15px; font-size: 12px; font-weight: 600;
    color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 5px;
  }
  .audio-btn:hover { background: #E2E8F0; }

  .result-text { font-size: 15px; line-height: 1.6; color: #333; margin-bottom: 20px; }

  /* Recommendations (Vertical Cards) */
  .rec-title {
    font-size: 12px; font-weight: 800; color: var(--gray);
    text-transform: uppercase; letter-spacing: 0.5px;
    margin: 20px 0 10px; text-align: center;
  }

  .rec-card {
    display: flex; align-items: center; background: white;
    border-radius: 16px; padding: 15px; margin-bottom: 12px;
    text-decoration: none; color: inherit;
    border: 1px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    position: relative; overflow: hidden; transition: transform 0.2s;
  }
  .rec-card:active { transform: scale(0.98); }
  .rec-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
    background: var(--primary);
  }
  /* Renkler */
  .rec-card.gold::before { background: #F59E0B; }
  .rec-card.silver::before { background: #64748B; }

  .rec-content { flex: 1; padding-left: 10px; }
  .badge {
    display: inline-block; font-size: 10px; font-weight: 800;
    padding: 3px 8px; border-radius: 6px; background: #ECFDF5;
    color: var(--primary-dark); margin-bottom: 4px;
  }
  .rec-name { font-weight: 700; font-size: 15px; color: #111; margin-bottom: 4px; }
  .rec-desc { font-size: 12px; color: var(--gray); }
  
  .rec-arrow {
    width: 32px; height: 32px; background: #F8FAFC;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: #CBD5E1;
  }

  /* --- FOOTER --- */
  .footer-spacer { flex: 1; }
  .footer {
    background: #F8FAFC; text-align: center; padding-top: 20px;
  }
  .footer-links {
    display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;
    font-size: 12px; color: var(--gray); margin-bottom: 15px;
  }
  .footer-links a { text-decoration: none; color: inherit; font-weight: 500; }
  .footer-links a:hover { color: var(--primary); }

  /* İTALYAN BAYRAĞI ŞERİDİ */
  .italy-bar {
    height: 6px; width: 100%;
    background: linear-gradient(90deg, 
      var(--italy-green) 0%, var(--italy-green) 33.3%, 
      var(--italy-white) 33.3%, var(--italy-white) 66.6%, 
      var(--italy-red) 66.6%, var(--italy-red) 100%
    );
  }

  /* Loading */
  .loader { display: none; text-align: center; padding: 30px; }
  .spinner {
    width: 30px; height: 30px; border: 3px solid #E2E8F0;
    border-top-color: var(--primary); border-radius: 50%;
    animation: spin 1s infinite linear; margin: 0 auto 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #fileInput { display: none; }
</style>
</head>
<body>

<div class="header">
  <div class="logo" onclick="location.reload()">CAYNANA<span>.AI</span></div>
  <div class="header-actions">
    <button onclick="location.reload()"><i class="fa-solid fa-rotate-right"></i></button>
    <button><i class="fa-solid fa-user"></i></button>
  </div>
</div>

<main>
  <div class="hero-section" id="hero">
    <div class="hero-title">Karar <br><span>Danışmanım.</span></div>
    <div class="hero-sub">Alışveriş, mekan, dert... Kaynanana danış, pişman olma.</div>
  </div>

  <div class="search-wrapper">
    <input type="text" id="searchInput" class="search-box" placeholder="Ne danışmak istersin?" autocomplete="off" onkeypress="if(event.key==='Enter') startSearch()">
    
    <div class="input-tools">
      <button class="tool-btn" onclick="triggerCam()"><i class="fa-solid fa-camera"></i></button>
      <button class="tool-btn" onclick="triggerMic()" id="micBtn"><i class="fa-solid fa-microphone"></i></button>
      <button class="tool-btn send" onclick="startSearch()"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
  </div>

  <div class="chips" id="chipsArea">
    <div class="chip" onclick="fill('Fal bak (Fincan)')"><i class="fa-solid fa-mug-hot"></i> Fal Bak</div>
    <div class="chip" onclick="fill('Airfryer önerisi')"><i class="fa-solid fa-fire-burner"></i> Airfryer</div>
    <div class="chip" onclick="fill('Bugün ne giysem?')"><i class="fa-solid fa-shirt"></i> Ne Giysem?</div>
    <div class="chip" onclick="fill('Robot süpürge')"><i class="fa-solid fa-robot"></i> Robot Süpürge</div>
  </div>

  <div class="loader" id="loader">
    <div class="spinner"></div>
    <div style="color:#64748B; font-size:13px;">Kaynanan araştırıyor...</div>
  </div>

  <div id="result-section">
    <div class="result-card">
      <div class="result-header">
        <div class="result-title">Sonuç</div>
        <button class="audio-btn" id="audioBtn" onclick="playVoice()">
          <i class="fa-solid fa-volume-high"></i> Dinle
        </button>
      </div>
      <div class="result-text" id="aiText">
        </div>
    </div>

    <div class="rec-title" id="recTitle">ÖNERİLER</div>
    <div id="recList">
      </div>
  </div>

</main>

<div class="footer-spacer"></div>

<div class="footer">
  <div class="footer-links">
    <a href="#">Hakkımızda</a>
    <a href="#">Anayasa</a>
    <a href="#">Sıkça Sorulan Sorular</a>
    <a href="#">Gizlilik</a>
    <a href="#">İletişim</a>
  </div>
  <div class="italy-bar"></div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(this.files[0])">

<script>
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-1.onrender.com/api/speak";
  
  const hero = document.getElementById('hero');
  const chipsArea = document.getElementById('chipsArea');
  const searchInput = document.getElementById('searchInput');
  const resultSection = document.getElementById('result-section');
  const loader = document.getElementById('loader');
  const aiTextField = document.getElementById('aiText');
  const recList = document.getElementById('recList');
  const recTitle = document.getElementById('recTitle');
  const audioBtn = document.getElementById('audioBtn');

  let currentImg = null;
  let currentAudio = null;
  let currentText = "";

  function fill(txt) {
    searchInput.value = txt;
    startSearch();
  }

  function triggerCam() { document.getElementById('fileInput').click(); }
  
  function handleFile(file) {
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      currentImg = e.target.result;
      searchInput.value = "Fincan fotoğrafı eklendi. Yorumla...";
      searchInput.focus();
    };
    reader.readAsDataURL(file);
  }

  function triggerMic() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition) return alert("Mikrofon yok.");
    const rec = new SpeechRecognition();
    rec.lang = 'tr-TR';
    const btn = document.getElementById('micBtn');
    
    rec.onstart = () => { btn.classList.add('active'); searchInput.placeholder = "Dinliyorum..."; };
    rec.onend = () => { btn.classList.remove('active'); searchInput.placeholder = "Ne danışmak istersin?"; };
    rec.onresult = (e) => {
      searchInput.value = e.results[0][0].transcript;
      startSearch();
    };
    rec.start();
  }

  async function startSearch() {
    const txt = searchInput.value.trim();
    if(!txt && !currentImg) return;

    // UI Geçişi
    hero.classList.add('minimized'); // Hero'yu gizle
    chipsArea.style.display = 'none'; // Çipleri gizle
    resultSection.style.display = 'none'; // Eski sonucu gizle
    loader.style.display = 'block'; // Loading aç

    const payload = {
      message: txt,
      image: currentImg,
      user: { city: 'İstanbul', gender: 'neutral' }
    };

    // Temizle
    currentImg = null;
    document.getElementById('fileInput').value = '';

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      
      loader.style.display = 'none';
      renderResult(data);

    } catch(e) {
      loader.style.display = 'none';
      alert("Bağlantı koptu evladım.");
    }
  }

  function renderResult(data) {
    resultSection.style.display = 'block';
    
    // Metin
    currentText = data.reply || data.assistant_text || "";
    aiTextField.innerHTML = currentText.replace(/\n/g, '<br>');
    
    // Ses Butonu Reset
    audioBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle';
    
    // Öneriler (Kartlar)
    recList.innerHTML = '';
    if(data.data && Array.isArray(data.data) && data.data.length > 0) {
        recTitle.style.display = 'block';
        data.data.forEach(item => {
            const el = document.createElement('a');
            el.className = 'rec-card';
            el.href = item.url || '#';
            el.target = '_blank';
            
            // Basit tema mantığı (fiyata göre vb. yapılabilir, şimdilik varsayılan)
            el.classList.add('default'); 

            el.innerHTML = `
                <div class="rec-content">
                    <div class="badge">${item.price || 'Öneri'}</div>
                    <div class="rec-name">${item.title}</div>
                    <div class="rec-desc">${item.desc || 'Detaylar için tıkla'}</div>
                </div>
                <div class="rec-arrow"><i class="fa-solid fa-chevron-right"></i></div>
            `;
            recList.appendChild(el);
        });
    } else {
        recTitle.style.display = 'none';
    }
  }

  async function playVoice() {
    if(currentAudio) { 
        currentAudio.pause(); currentAudio=null; 
        audioBtn.innerHTML='<i class="fa-solid fa-volume-high"></i> Dinle'; 
        return; 
    }
    
    if(!currentText) return;

    audioBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    try {
      // Tırnak temizliği
      const safeTxt = currentText.replace(/<[^>]*>?/gm, '').replace(/"/g, '');
      
      const res = await fetch(SPEAK_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: safeTxt})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      
      currentAudio.onended = () => { audioBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle'; };
      await currentAudio.play();
      audioBtn.innerHTML = '<i class="fa-solid fa-stop"></i> Durdur';
    } catch(e) {
      audioBtn.innerHTML = 'Hata';
    }
  }
</script>

</body>
</html>
