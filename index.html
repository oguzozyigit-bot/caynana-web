<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f18" />
  <title>CAYNANA.AI</title>

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root{
      --primary:#00C897;
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --safeB: env(safe-area-inset-bottom);
      --safeT: env(safe-area-inset-top);
      --font:'Plus Jakarta Sans', sans-serif;
    }
    *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
    html,body{ height:100%; }
    body{
      font-family:var(--font);
      background:#0b0f18;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #app{
      width:100%;
      height:100%;
      max-width:480px;
      max-height:920px;
      aspect-ratio: 9 / 19.5;
      background:#0b0f18;
      border-radius:24px;
      overflow:hidden;
      box-shadow:0 0 60px rgba(0,0,0,.55);
      position:relative;
      display:flex;
      flex-direction:column;
    }
    @media (max-width:520px){
      body{ display:block; background:#0b0f18; }
      #app{
        max-width:none; max-height:none; aspect-ratio:auto;
        width:100vw; height:100dvh;
        border-radius:0; box-shadow:none;
      }
    }

    /* HERO */
    #hero{
      flex:0 0 46%;
      position:relative;
      background-size:cover;
      background-repeat:no-repeat;
      background-position:center 28%;
      transition: background-image .30s ease, background-position .30s ease;
      touch-action: pan-y;
      user-select:none;
    }
    #hero::after{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(to bottom,
          rgba(0,0,0,.62) 0%,
          rgba(0,0,0,.25) 38%,
          rgba(255,255,255,0) 72%,
          rgba(255,255,255,.96) 100%);
      pointer-events:none;
    }

    /* HEADER */
    header{
      position:absolute;
      top:0; left:0; right:0;
      padding: calc(14px + var(--safeT)) 16px 10px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      z-index:6;
      pointer-events:none;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
      pointer-events:auto;
      cursor:pointer;
    }
    .brand .top{
      display:flex; align-items:center; gap:10px;
      font-weight:900; font-size:22px;
      color:#fff;
      text-shadow:0 10px 28px rgba(0,0,0,.45);
      letter-spacing:-.3px;
    }
    .brand .top i{ color:var(--primary); }
    .brand .top span{ color:var(--primary); }
    .brand .sub{
      font-size:12px;
      font-weight:900;
      color:rgba(255,255,255,.86);
      text-shadow:0 10px 28px rgba(0,0,0,.40);
    }
    .menu-btn{
      width:44px; height:44px;
      border-radius:999px;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.24);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex; align-items:center; justify-content:center;
      color:#fff;
      pointer-events:auto;
    }

    /* HERO TEXT */
    .hero-text{
      position:absolute;
      left:16px; right:16px;
      top: 112px;
      z-index:6;
      pointer-events:none;
    }
    .hero-text h1{
      font-size:34px;
      font-weight:950;
      line-height:1.05;
      color:#fff;
      letter-spacing:-.8px;
      text-shadow:0 14px 30px rgba(0,0,0,.50);
    }
    .hero-text p{
      margin-top:10px;
      font-size:15px;
      font-weight:900;
      color:rgba(255,255,255,.88);
      text-shadow:0 12px 26px rgba(0,0,0,.42);
      max-width: 92%;
    }

    /* MAIN */
    #main{
      flex:1;
      background: var(--bg);
      padding:16px 16px 280px 16px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .msg{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:18px;
      padding:16px 16px;
      font-size:15px;
      font-weight:900;
      color:#1f2937;
      box-shadow:0 10px 22px rgba(0,0,0,.07);
      margin-bottom:12px;
      word-break: break-word;
    }
    .msg.user{
      background: var(--primary);
      color:#fff;
      border-color: transparent;
    }

    .msg img{
      width:100%;
      border-radius:14px;
      margin-bottom:10px;
      display:block;
    }

    .audio-btn{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      color:var(--primary);
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .audio-btn.playing{
      background:#ffebee;
      color:#d32f2f;
      border-color:#d32f2f;
    }

    /* CARDS */
    .cards{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:10px 0 16px; }
    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      position:relative;
    }
    .card-badge{
      position:absolute; top:10px; left:0;
      padding:4px 10px;
      font-size:10px;
      font-weight:950;
      color:#fff;
      border-radius:0 10px 10px 0;
    }
    .card-badge.gold{ background:linear-gradient(90deg,#FFB300,#FF8F00); }
    .card-badge.silver{ background:linear-gradient(90deg,#9E9E9E,#757575); }
    .card-badge.value{ background:linear-gradient(90deg,#00C897,#00A87E); }
    .pimg{ width:100%; height:120px; object-fit:contain; margin:24px 0 8px; }
    .ptitle{ font-size:13px; font-weight:900; color:#111; height:38px; overflow:hidden; }
    .pprice{ margin-top:6px; font-size:16px; font-weight:950; color:var(--primary); }
    .plink{
      margin-top:auto;
      display:block;
      text-align:center;
      text-decoration:none;
      color:#fff;
      font-weight:950;
      padding:10px 10px;
      border-radius:12px;
      background:var(--primary);
    }
    .plink.btn-gold{ background:#FFB300; }
    .plink.btn-silver{ background:#9E9E9E; }
    .plink.btn-blue{ background:#00C897; }

    /* BOTTOM */
    #bottom{
      position:absolute;
      left:0; right:0; bottom:0;
      background:rgba(255,255,255,.96);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-top:1px solid rgba(0,0,0,.06);
      z-index:20;
      padding-bottom: calc(var(--safeB) + 12px);
    }

    #tip{
      width:max-content;
      max-width:92%;
      margin:-18px auto 10px auto;
      padding:10px 18px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 12px 26px rgba(0,0,0,.10);
      font-weight:950;
      color:var(--primary);
      text-align:center;
    }

    .row{
      padding:12px 16px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .iconBtn{
      width:44px; height:44px;
      display:flex; align-items:center; justify-content:center;
      color:#6b7280;
      border-radius:14px;
      flex:0 0 44px;
      cursor:pointer;
    }

    .inputBox{
      flex:1;
      height:52px;
      background:#f3f4f6;
      border:1px solid rgba(0,0,0,.06);
      border-radius:26px;
      display:flex;
      align-items:center;
      padding:0 10px;
      gap:8px;
      min-width:0;
    }
    .inputBox input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      font-size:15px;
      font-weight:900;
      color:#111;
      padding:0 6px;
      min-width: 0;
    }

    .sendBtn{
      width:52px; height:52px;
      border:none;
      border-radius:50%;
      background:var(--primary);
      color:#fff;
      font-size:18px;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 22px rgba(0,0,0,.12);
      cursor:pointer;
      flex:0 0 52px;
    }
    .sendBtn:disabled{ opacity:.65; }

    /* Translate language select */
    .langRow{
      padding: 0 16px 10px 16px;
      display:none;
    }
    .langRow select{
      width:100%;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      font-weight:900;
      padding:0 12px;
      outline:none;
    }

    /* Fal special */
    #falUI{ display:none; padding:12px 16px 14px 16px; }
    .bigFalBtn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:16px 16px;
      font-size:16px;
      font-weight:950;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      background: linear-gradient(135deg, var(--primary), #b88f23);
      box-shadow:0 14px 26px rgba(0,0,0,.18);
    }

    /* Dock */
    .dockWrap{
      padding: 8px 12px 0 12px;
      overflow-x:auto;
      scrollbar-width:none;
      scroll-snap-type: x mandatory;
    }
    .dockWrap::-webkit-scrollbar{ display:none; }
    .dock{
      display:flex;
      gap:14px;
      width:max-content;
      padding: 0 4px 8px 4px;
    }
    .tab{
      min-width:62px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      color:#9aa0a6;
      font-size:11px;
      font-weight:950;
      user-select:none;
      cursor:pointer;
      opacity:.78;
      transition:.2s;
      scroll-snap-align: start;
    }
    .tab i{
      width:48px; height:48px;
      border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background:#f3f4f6;
      color:#9aa0a6;
      font-size:20px;
      transition:.2s;
    }
    .tab.active{ opacity:1; color:#111; }
    .tab.active i{
      background:var(--primary);
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.12);
      transform: translateY(-2px);
    }

    .footer{
      text-align:center;
      font-size:11px;
      font-weight:950;
      color:#666;
      padding:8px 0 10px;
    }
    .flag{
      width:64px; height:4px;
      margin:6px auto 0;
      display:flex;
      border-radius:4px;
      overflow:hidden;
    }
    .flag span{ flex:1; }
    .g{ background:#009246; }
    .w{ background:#fff; }
    .r{ background:#CE2B37; }

    #fileInput, #docInput{ display:none !important; }
  </style>
</head>

<body>
  <div id="app">
    <header>
      <div class="brand" onclick="switchMode('shopping')">
        <div class="top"><i class="fa-solid fa-wand-magic-sparkles"></i> CAYNANA<span>.AI</span></div>
        <div class="sub">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
      </div>
      <div class="menu-btn"><i class="fa-solid fa-bars"></i></div>
    </header>

    <div id="hero">
      <div class="hero-text">
        <h1 id="heroTitle">Almadan √∂nce<br>Caynana‚Äôya sor.</h1>
        <p id="heroDesc">Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.</p>
      </div>
    </div>

    <div id="main"></div>

    <div id="bottom">
      <div id="tip">Her indirime atlayan sonunda pahalƒ± √∂der.</div>

      <!-- Translator only -->
      <div class="langRow" id="langRow">
        <select id="langSelect">
          <option value="tr">T√ºrk√ße</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="fr">Fran√ßais</option>
          <option value="it">Italiano</option>
          <option value="es">Espa√±ol</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
      </div>

      <!-- Standard UI -->
      <div class="row" id="standardUI">
        <div class="iconBtn" id="btnCamera" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <div class="iconBtn" id="btnDoc" onclick="openDoc()"><i class="fa-solid fa-paperclip"></i></div>

        <div class="inputBox">
          <input id="userInput" placeholder="Ne danƒ±≈ümak istersin?" />
          <div class="iconBtn" id="btnMic" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
        </div>

        <button class="sendBtn" id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>

      <!-- Fal UI -->
      <div id="falUI">
        <button class="bigFalBtn" onclick="takeFalPhoto()">
          <i class="fa-solid fa-camera"></i> Fincanƒ±nƒ± √áek ve Yorumla
        </button>
      </div>

      <div class="dockWrap">
        <div class="dock" id="dock"></div>
      </div>

      <div class="footer">
        @CaynanaAI by Italky Technology
        <div class="flag"><span class="g"></span><span class="w"></span><span class="r"></span></div>
      </div>
    </div>

    <input type="file" id="fileInput" accept="image/*" capture="environment" />
    <input type="file" id="docInput"  accept=".pdf,.doc,.docx,.txt,image/*" />
  </div>

<script>
  // Backend
  const API_URL   = "https://bikonomi-api-2.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-2.onrender.com/api/speak";

  const HERO_BASE = "images/";
  marked.setOptions({ mangle:false, headerIds:false });

  const dockOrder = ["shopping","chat","fal","dream","health","diet","food","law","astro","translate"];
  const dockLabels = { shopping:"Alƒ±≈üveri≈ü", chat:"Sohbet", fal:"Fal", dream:"R√ºya", health:"Saƒülƒ±k", diet:"Diyet", food:"Yemek", law:"Hukuk", astro:"Bur√ß", translate:"√áeviri" };
  const dockIcons  = {
    shopping:"fa-bag-shopping", chat:"fa-comments", fal:"fa-mug-hot", dream:"fa-moon",
    health:"fa-heart-pulse", diet:"fa-apple-whole", food:"fa-utensils", law:"fa-scale-balanced",
    astro:"fa-star", translate:"fa-language"
  };

  // Mode capabilities
  const MODE = {
    shopping:  { color:"#00C897", img:"hero-shopping.png",  pos:"center 18%", top:112,
      title:"Almadan √∂nce<br>Caynana‚Äôya sor.", desc:"Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.",
      tip:"Her indirime atlayan sonunda pahalƒ± √∂der.",
      placeholder:"Ne arƒ±yorsun evladƒ±m?",
      caps:{ text:true, mic:true, camera:true, doc:false, lang:false, falBtn:false } },

    chat:      { color:"#FFB300", img:"hero-chat.png",      pos:"center 22%", top:118,
      title:"Caynana ile<br>iki lafƒ±n belini kƒ±r.", desc:"Biraz dur bakalƒ±m, neler anlatacaksƒ±n?",
      tip:"Benim zamanƒ±mda her ≈üey daha g√ºzeldi ah ah‚Ä¶",
      placeholder:"Naber Caynana?",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    fal:       { color:"#D4AF37", img:"hero-fal.png",       pos:"center 20%", top:118,
      title:"Falƒ±na bakalƒ±m mƒ±?", desc:"Fincanƒ± √ßek, ben yorumlayayƒ±m.",
      tip:"Fincanƒ± kapattƒ±n mƒ±? √áek g√∂nder bakalƒ±m.",
      placeholder:"",
      caps:{ text:false, mic:false, camera:true, doc:false, lang:false, falBtn:true } },

    dream:     { color:"#6366F1", img:"hero-dream.png",     pos:"center 16%", top:110,
      title:"R√ºyada ne g√∂rd√ºn?", desc:"Anlat, tabir edeyim.",
      tip:"Hayƒ±rdƒ±r in≈üallah‚Ä¶",
      placeholder:"Ne g√∂rd√ºn r√ºyanda?",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    health:    { color:"#EF4444", img:"hero-health.png",    pos:"center 18%", top:110,
      title:"Caynana Saƒülƒ±k‚Äôla<br>alƒ±≈ükanlƒ±k kazan.", desc:"Neren aƒürƒ±yor s√∂yle bakayƒ±m?",
      tip:"Saƒülƒ±k ihmale gelmez.",
      placeholder:"Neren aƒürƒ±yor?",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    diet:      { color:"#84CC16", img:"hero-diet.png",      pos:"center 18%", top:110,
      title:"Caynana Diyet‚Äôle<br>saƒülƒ±klƒ± beslen!", desc:"A√ßlƒ±ktan deƒüil, keyiften yiyin.",
      tip:"Ekmek deƒüil, ye≈üillik ye.",
      placeholder:"Kilonu, boyunu, ya≈üƒ±nƒ± ve cinsiyetini s√∂yle‚Ä¶",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    food:      { color:"#F97316", img:"hero-food.png",      pos:"center 18%", top:110,
      title:"Caynana Yemek‚Äôle<br>ne pi≈üirsem derdi biter.", desc:"Dolapta ne var s√∂yle, tarif benden.",
      tip:"Malzemeyi ziyan etme, bereket ka√ßar.",
      placeholder:"Dolapta ne var?",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    law:       { color:"#3B82F6", img:"hero-law.png",       pos:"center 18%", top:110,
      title:"Caynana Hukuk‚Äôla<br>kim haklƒ± √∂ƒüren.", desc:"Ben avukat deƒüilim ama √ßok dava g√∂rd√ºm.",
      tip:"S√∂zle≈ümeye bakmadan imza atma!",
      placeholder:"Kƒ±saca anlat, yol g√∂stereyim.",
      caps:{ text:true, mic:true, camera:true, doc:true, lang:false, falBtn:false } },

    astro:     { color:"#D946EF", img:"hero-astro.png",     pos:"center 18%", top:110,
      title:"Yƒ±ldƒ±zlar senin i√ßin<br>ne diyor?", desc:"Merk√ºr retrosu falan‚Ä¶ dikkat et.",
      tip:"Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k.",
      placeholder:"Burcunu s√∂yle‚Ä¶",
      caps:{ text:true, mic:true, camera:false, doc:false, lang:false, falBtn:false } },

    translate: { color:"#9CA3AF", img:"hero-translate.png", pos:"center 18%", top:110,
      title:"√áeviri lazƒ±m mƒ±?<br>S√∂yle √ßevireyim.", desc:"Metni yapƒ±≈ütƒ±r, ben hallederim.",
      tip:"Dil bilmek altƒ±n bileziktir.",
      placeholder:"Metni yapƒ±≈ütƒ±r‚Ä¶",
      caps:{ text:true, mic:true, camera:true, doc:true, lang:true, falBtn:false } }
  };

  // State
  let currentMode = "shopping";
  let isSending = false;
  let sessionId = "sess_" + Math.random().toString(36).slice(2,10);

  let pendingImage = null;   // base64
  let pendingDoc = null;     // base64
  let pendingDocName = null;

  let currentAudio = null;

  const $ = (id)=>document.getElementById(id);

  function setTheme(color){
    document.documentElement.style.setProperty("--primary", color);
  }

  let lastBg = "";
  function setHeroBackground(file, pos){
    const hero = $("hero");
    hero.style.backgroundPosition = pos || "center 28%";
    const url = `${HERO_BASE}${file}?v=${Date.now()}`;
    const img = new Image();
    img.onload = () => {
      lastBg = `url("${url}")`;
      hero.style.backgroundImage = lastBg;
    };
    img.onerror = () => { if(lastBg) hero.style.backgroundImage = lastBg; };
    img.src = url;
  }

  function setHeroText(topPx, title, desc){
    document.querySelector(".hero-text").style.top = (topPx||112) + "px";
    $("heroTitle").innerHTML = title;
    $("heroDesc").innerText = desc;
  }

  function setTip(t){ $("tip").innerText = t || ""; }

  function renderDock(){
    const dock = $("dock");
    dock.innerHTML = "";
    dockOrder.forEach(k=>{
      const tab = document.createElement("div");
      tab.className = "tab" + (k===currentMode ? " active":"");
      tab.innerHTML = `<i class="fa-solid ${dockIcons[k]}"></i><span>${dockLabels[k]}</span>`;
      tab.onclick = ()=> switchMode(k);
      dock.appendChild(tab);
    });
  }

  function applyCapabilities(){
    const m = MODE[currentMode];
    const c = m.caps;

    // show/hide fal UI
    $("falUI").style.display = c.falBtn ? "block" : "none";
    $("standardUI").style.display = c.falBtn ? "none" : "flex";

    // buttons
    $("btnCamera").style.display = c.camera ? "flex" : "none";
    $("btnDoc").style.display    = c.doc    ? "flex" : "none";
    $("btnMic").style.display    = c.mic    ? "flex" : "none";

    // input
    $("userInput").style.display = c.text ? "block" : "none";
    $("userInput").placeholder = m.placeholder || "";

    // lang selector
    $("langRow").style.display = c.lang ? "block" : "none";

    // clear pending attachments when mode changes (avoid surprises)
    pendingImage = null;
    pendingDoc = null;
    pendingDocName = null;
  }

  function switchMode(modeName){
    if(!MODE[modeName]) return;
    currentMode = modeName;
    const m = MODE[modeName];

    // stop audio
    stopAllAudio();

    setTheme(m.color);
    setHeroBackground(m.img, m.pos);
    setHeroText(m.top, m.title, m.desc);
    setTip(m.tip);
    applyCapabilities();
    renderDock();

    // Mode change: keep messages, but in shopping clear old product cards on next send (handled in send)
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  function safeLink(u){
    try{
      const url = new URL(u, location.href);
      if(url.protocol==="http:" || url.protocol==="https:") return url.toString();
    }catch(e){}
    return "";
  }
  function safeImg(u){
    try{
      const url = new URL(u, location.href);
      if(url.protocol==="http:" || url.protocol==="https:") return url.toString();
    }catch(e){}
    return "https://via.placeholder.com/150?text=Resim+Yok";
  }

  function addMsg(role, text, speechText=null, imgBase64=null){
    const main = $("main");
    const div = document.createElement("div");
    div.className = "msg" + (role==="user" ? " user" : "");

    let html = "";
    if(imgBase64){
      html += `<img src="${imgBase64}" alt="image">`;
    }

    // AI: markdown + sanitize, USER: escape
    if(role === "ai"){
      const raw = marked.parse(text || "");
      html += DOMPurify.sanitize(raw, { USE_PROFILES: { html:true } });
    } else {
      html += escapeHtml(text || "");
    }

    div.innerHTML = html;

    // speech button
    if(speechText){
      const btn = document.createElement("div");
      btn.className = "audio-btn";
      btn.setAttribute("data-speech", speechText);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
      div.appendChild(btn);
    }

    main.appendChild(div);
    main.scrollTo({ top: main.scrollHeight, behavior:"smooth" });
  }

  function renderCards(list){
    const main = $("main");
    const wrap = document.createElement("div");
    wrap.className = "cards";

    (list||[]).forEach((p, idx)=>{
      const card = document.createElement("div");
      card.className = "card";

      const badge = pickBadge(p, idx);
      const badgeHtml = badge ? `<div class="card-badge ${badge.key}">${badge.text}</div>` : "";

      const title = escapeHtml(p.title || "");
      const price = escapeHtml(p.price || "");
      const url   = p.url ? safeLink(p.url) : "";
      const img   = p.image ? safeImg(p.image) : "https://via.placeholder.com/150?text=Resim+Yok";

      let btnClass = "plink";
      if(badge?.key==="gold") btnClass += " btn-gold";
      else if(badge?.key==="silver") btnClass += " btn-silver";
      else if(badge?.key==="value") btnClass += " btn-blue";

      const priceHTML = price ? `<div class="pprice">${price}</div>` : "";
      const linkHTML  = url ? `<a class="${btnClass}" target="_blank" rel="noopener noreferrer" href="${url}">ƒ∞NCELE</a>` : "";

      card.innerHTML = `
        ${badgeHtml}
        <img class="pimg" src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Resim+Yok'">
        <div class="ptitle">${title}</div>
        ${priceHTML}
        ${linkHTML}
      `;

      wrap.appendChild(card);
    });

    main.appendChild(wrap);
    main.scrollTo({ top: main.scrollHeight, behavior:"smooth" });
  }

  function pickBadge(p, idx){
    const t = (p.caynana_trust?.badge || p.badge || p.rank || p.type || p.tag || "").toString().toLowerCase();
    if (t.includes("sponsor")) return { key:"gold", text:"SPONSORLU" };
    if (t.includes("gold") || t.includes("altƒ±n") || t.includes("efsane")) return { key:"gold", text:"ALTIN √ñNERƒ∞" };
    if (t.includes("silver") || t.includes("g√ºm√º≈ü") || t.includes("iyi")) return { key:"silver", text:"G√úM√ú≈û SE√áƒ∞M" };
    if (t.includes("perf") || t.includes("fiyat") || t.includes("value")) return { key:"value", text:"Fƒ∞YAT/PERF" };
    if (idx===0) return { key:"gold", text:"ALTIN √ñNERƒ∞" };
    if (idx===1) return { key:"silver", text:"G√úM√ú≈û SE√áƒ∞M" };
    if (idx===2) return { key:"value", text:"Fƒ∞YAT/PERF" };
    return null;
  }

  // SEND (tek endpoint)
  async function send(){
    if(isSending) return;

    const m = MODE[currentMode];
    const caps = m.caps;

    // Fal modunda yazƒ± yok; foto zorunlu
    let text = ($("userInput")?.value || "").trim();

    if(!caps.text) text = "";

    if(currentMode === "fal" && !pendingImage){
      // fal butonuna basƒ±lmadan g√∂nderme olmasƒ±n
      return;
    }

    if(!text && !pendingImage && !pendingDoc) return;

    // shopping: yeni aramada eski √ºr√ºn kartlarƒ±nƒ± temizle (mesajlar kalsƒ±n)
    if(currentMode === "shopping"){
      document.querySelectorAll("#main .cards").forEach(el=>el.remove());
    }

    isSending = true;
    $("sendBtn").disabled = true;

    // user bubble
    const shownText = text || (pendingImage ? "üì∑ Fotoƒüraf g√∂nderdim" : pendingDoc ? "üìé Dosya y√ºkledim" : "");
    addMsg("user", shownText, null, pendingImage);

    if(caps.text) $("userInput").value = "";

    // loader
    const loaderId = "ldr_" + Date.now();
    const main = $("main");
    const ldiv = document.createElement("div");
    ldiv.className = "msg";
    ldiv.id = loaderId;
    ldiv.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Bakƒ±yorum‚Ä¶`;
    main.appendChild(ldiv);
    main.scrollTo({ top: main.scrollHeight, behavior:"smooth" });

    // payload
    const payload = {
      message: text,
      session_id: sessionId,
      mode: currentMode
    };

    // translator target language
    if(currentMode === "translate"){
      payload.target_language = $("langSelect").value;
    }

    // attach
    if(pendingImage) payload.image = pendingImage;
    if(pendingDoc){
      payload.file = pendingDoc;
      payload.file_name = pendingDocName || "document";
    }

    // clear pending now (so next send clean)
    pendingImage = null;
    pendingDoc = null;
    pendingDocName = null;

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));
      document.getElementById(loaderId)?.remove();

      const aText = data.assistant_text || "Bir ≈üey diyemedim evladƒ±m‚Ä¶";
      const sText = data.speech_text || null;

      addMsg("ai", aText, (MODE[currentMode].caps.mic ? sText : null));

      if(data.data && Array.isArray(data.data) && data.data.length){
        renderCards(data.data);
      }

    }catch(e){
      const el = document.getElementById(loaderId);
      if(el) el.innerText = "Baƒülantƒ± koptu evladƒ±m.";
    }finally{
      isSending = false;
      $("sendBtn").disabled = false;
    }
  }

  // AUDIO
  function stopAllAudio(){
    if(currentAudio){
      try{ currentAudio.pause(); }catch(e){}
      currentAudio = null;
    }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove("playing");
      b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
    });
  }

  async function playAudio(text, btn){
    const wasPlayingThis = btn.classList.contains("playing");

    stopAllAudio();
    if(wasPlayingThis) return;

    const original = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor‚Ä¶`;

    try{
      const res = await fetch(SPEAK_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text })
      });

      const blob = await res.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = () => {
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Caynana Konu≈üuyor`;
        btn.classList.remove("playing");
        currentAudio = null;
      };

      await currentAudio.play();
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Sus Kƒ±z!`;
      btn.classList.add("playing");
    }catch(e){
      btn.innerHTML = "Hata";
      setTimeout(()=> btn.innerHTML = original, 1200);
    }
  }

  // Event delegation for audio buttons
  document.addEventListener("click",(e)=>{
    const btn = e.target.closest(".audio-btn");
    if(!btn) return;
    const speech = btn.getAttribute("data-speech");
    if(speech) playAudio(speech, btn);
  });

  // FILE / CAMERA
  function openCamera(){
    if(!MODE[currentMode].caps.camera) return;
    $("fileInput").value = "";
    $("fileInput").click();
  }

  function openDoc(){
    if(!MODE[currentMode].caps.doc) return;
    $("docInput").value = "";
    $("docInput").click();
  }

  function takeFalPhoto(){
    // fal i√ßin kamera a√ß
    openCamera();
  }

  $("fileInput").addEventListener("change",(e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      pendingImage = reader.result;
      // fal modunda foto se√ßildiƒüi an otomatik g√∂nder
      if(currentMode === "fal") send();
    };
    reader.readAsDataURL(file);
  });

  $("docInput").addEventListener("change",(e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    // √áok b√ºy√ºk dosyayƒ± JSON base64 ta≈üƒ±mak riskli ‚Üí yine de pratikte k√º√ß√ºk dosya √∂ner
    if(file.size > 3 * 1024 * 1024){
      alert("Dosya b√ºy√ºk. 3MB altƒ± dosya y√ºkle (PDF/TXT/DOCX) evladƒ±m.");
      return;
    }

    pendingDocName = file.name;
    const reader = new FileReader();
    reader.onload = ()=> {
      pendingDoc = reader.result; // data:...base64
    };
    reader.readAsDataURL(file);
  });

  // MIC (≈üimdilik browser speech-to-text; istersen kapatƒ±rƒ±z)
  function startMic(){
    if(!MODE[currentMode].caps.mic) return;

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Mikrofon desteklenmiyor."); return; }

    const rec = new SR();
    rec.lang = "tr-TR";
    rec.onresult = (e)=>{
      $("userInput").value = e.results[0][0].transcript;
      // otomatik g√∂ndermeyelim; kullanƒ±cƒ± isterse ‚Äúok‚Äùa bassƒ±n
    };
    rec.start();
  }

  // HERO swipe
  let sx = 0;
  $("hero").addEventListener("touchstart",(e)=>{ sx=e.touches[0].clientX; }, {passive:true});
  $("hero").addEventListener("touchend",(e)=>{
    const dx = e.changedTouches[0].clientX - sx;
    if(Math.abs(dx) < 60) return;
    const i = dockOrder.indexOf(currentMode);
    if(dx < 0 && i < dockOrder.length-1) switchMode(dockOrder[i+1]);
    if(dx > 0 && i > 0) switchMode(dockOrder[i-1]);
  }, {passive:true});

  // Enter to send
  $("userInput").addEventListener("keydown",(e)=>{
    if(e.key === "Enter") send();
  });

  // INIT
  renderDock();
  switchMode("shopping");
</script>
</body>
</html>
