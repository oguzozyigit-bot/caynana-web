<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f18" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

<style>
  :root{ --primary:#FFB300; --font:'Outfit',sans-serif; }
  *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; user-select:none; }
  input, textarea { user-select:text; -webkit-user-select:text; }
  #text { user-select:text; -webkit-user-select:text; }

  html,body{ height:100%; width: 100%; overflow: hidden; }
  body{ font-family:var(--font); background:#050505; display:flex; align-items:center; justify-content:center; }

  #app{
    width:100%; height:100%; max-width:440px; max-height:880px;
    border-radius:24px; overflow:hidden; position:relative; display:flex; flex-direction:column;
    box-shadow: 0 0 0 10px #1a1a1a, 0 20px 50px rgba(0,0,0,0.8);
    background:#0b0f18;
  }
  @media (max-width:500px){
    body{ display:block; background:#000; }
    #app{ width:100%; height:100dvh; max-width:none; max-height:none; border-radius:0; box-shadow:none; }
  }

  #heroImage{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:0; transition: opacity 0.3s ease; }
  #app::before{ content:""; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(0,0,0,.20) 0%, rgba(0,0,0,.10) 50%, rgba(0,0,0,.60) 100%); pointer-events:none; z-index:1; }

  #topbar{ position:relative; z-index:10; height:70px; padding:12px 18px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
  .brand-wrap{ display:flex; flex-direction:column; gap:2px; cursor:pointer; }
  .brand{ display:flex; align-items:center; gap:8px; font-size:20px; font-weight:900; letter-spacing:-.5px; color:#fff; }
  .brand i{ color:var(--primary); font-size:18px; } .brand span{ color:var(--primary); }
  .brand-sub{ font-size:10px; font-weight:700; color:rgba(255,255,255,.7); letter-spacing:0.5px; }
  .top-actions { display:flex; gap:10px; }
  .menu-btn{ width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.15); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.1); color:#fff; cursor:pointer; }
  .menu-btn:active { transform: scale(0.95); background:rgba(255,255,255,.25); }

  #main{ position:relative; z-index:8; flex:1; display:flex; flex-direction:column; overflow:hidden; }

  #heroContent{
    position:absolute; pointer-events:none; padding:0 24px; z-index:9; transition:all 0.4s ease;
    width:100%; top:100px; left:0;
  }
  #heroTitle{ font-size:36px; font-weight:900; line-height:1.05; color:#fff; letter-spacing:-1.5px; text-shadow:0 10px 30px rgba(0,0,0,.6); }
  #heroDesc{ margin-top:12px; font-size:16px; font-weight:600; color:rgba(255,255,255,.95); line-height:1.4; text-shadow:0 5px 15px rgba(0,0,0,.5); }

  #chatContainer{
    display:none; width:100%; height:100%;
    overflow-y:auto; -webkit-overflow-scrolling:touch;
    padding:20px 20px 240px 20px;
    background:rgba(0,0,0,0.4);
    backdrop-filter:blur(15px); -webkit-backdrop-filter:blur(15px);
    border-radius:24px 24px 0 0; border:1px solid rgba(255,255,255,0.1);
    scrollbar-width:none;
  }
  #chatContainer::-webkit-scrollbar { display:none; }

  /* ‚úÖ Fal modunda alttaki b√ºy√ºk panel chat'i √∂rtmesin */
  body.fal-mode #chatContainer{
    padding-bottom: 420px;
  }

  .msg{ display:flex; margin-bottom:12px; animation: fadeIn 0.3s ease; flex-direction: column; }
  .msg.user{ align-items:flex-end; } .msg.ai{ align-items:flex-start; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

  .bubble{ max-width:95%; padding:12px 16px; border-radius:18px; font-size:15px; line-height:1.5; font-weight:600; position:relative; user-select:text; }
  .msg.user .bubble{ background:var(--primary); color:#fff; border-bottom-right-radius:4px; box-shadow:0 5px 15px rgba(0,0,0,.2); }
  .msg.ai .bubble{ background:#ffffff; color:#111; border-bottom-left-radius:4px; box-shadow:0 5px 15px rgba(0,0,0,.1); }

  .typing-cursor::after { content:'|'; animation: blink 1s infinite; margin-left:2px; }
  @keyframes blink { 50% { opacity:0; } }

  .audio-btn{
    margin-top:6px; margin-left:4px; display:inline-flex; align-items:center; gap:8px;
    padding:8px 14px; border-radius:20px; background:#fff; color:var(--primary);
    font-size:12px; font-weight:800; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.15);
    transition: transform 0.2s; width:fit-content;
  }
  .audio-btn.playing{ background:#ffebee; color:#d32f2f; border-color:#ffcdd2; }
  .audio-btn:active { transform: scale(0.95); }

  #bottom{
    position:absolute; bottom:0; left:0; right:0; z-index:20;
    background:rgba(255,255,255,.95);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    border-top-left-radius:24px; border-top-right-radius:24px;
    padding:15px 18px calc(env(safe-area-inset-bottom) + 20px) 18px;
    box-shadow:0 -10px 40px rgba(0,0,0,.15);
  }

  #suggestionText{
    position:absolute; top:-15px; left:50%; transform:translateX(-50%);
    background:#fff; color:var(--primary); padding:6px 14px; border-radius:20px;
    font-size:12px; font-weight:800; box-shadow:0 -5px 15px rgba(0,0,0,.08);
    white-space:nowrap; z-index:25; opacity:0.98; transition: all 0.3s ease; pointer-events:none;
  }

  .input-wrapper{ display:flex; align-items:center; gap:8px; width:100%; }
  .search-bar{
    flex:1; height:50px; background:#ffffff; border-radius:25px;
    display:flex; align-items:center; padding:0 5px 0 15px;
    border:1px solid #e0e0e0; transition:0.3s; min-width:0;
    box-shadow:0 4px 10px rgba(0,0,0,0.05);
  }
  .search-bar:focus-within{ border-color:var(--primary); box-shadow:0 5px 15px rgba(0,0,0,.1); }
  #text{ flex:1; border:none; background:transparent; font-size:15px; color:#333; outline:none; min-width:0; }
  .tool-btn{ padding:8px; color:#999; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .tool-btn:active{ color:var(--primary); }
  #sendBtn{ width:50px; height:50px; border-radius:50%; border:none; background:var(--primary); color:#fff; font-size:20px; flex-shrink:0; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,.2); }
  #sendBtn:active{ transform:scale(0.95); }

  #dock{ display:flex; gap:20px; overflow-x:auto; padding:15px 5px 10px 5px; scrollbar-width:none; cursor:grab; }
  #dock::-webkit-scrollbar{ display:none; }
  .dock-item{ display:flex; flex-direction:column; align-items:center; gap:6px; opacity:0.5; transition:0.3s; min-width:55px; }
  .dock-item.active{ opacity:1; transform:translateY(-3px); }
  .icon-box{ width:42px; height:42px; border-radius:14px; background:#eee; color:#666; display:flex; align-items:center; justify-content:center; font-size:18px; transition:0.3s; }
  .dock-item.active .icon-box{ background:var(--primary); color:#fff; box-shadow:0 5px 15px rgba(0,0,0,.2); }
  .dock-label{ font-size:10px; font-weight:800; color:#444; }

  .brand-footer{ margin-top:12px; display:flex; flex-direction:column; align-items:center; gap:6px; width:fit-content; margin-left:auto; margin-right:auto; }
  .footer-text-line1{ font-size:13px; font-weight:800; color:#36454F; letter-spacing:0.5px; white-space:nowrap; }
  .footer-text-line2{ font-size:12px; font-weight:600; color:#666; letter-spacing:0.5px; }
  .oz-lines{ display:flex; gap:6px; height:5px; width:100%; }
  .oz-lines span{ height:100%; flex:1; border-radius:3px; }
  .oz-l-dynamic{ background: var(--primary); transition: background 0.3s ease; }
  .oz-l-red{ background:#D32F2F; }
  .oz-l-white{ background:#ffffff; border:1px solid #eee; }
  .oz-l-black{ background:#222; }

  #personaModal { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; display:none; align-items:center; justify-content:center; backdrop-filter: blur(8px); }
  #personaModal.show { display:flex; animation: fadeIn 0.2s ease; }
  .persona-content { background:#fff; width:85%; max-width:320px; border-radius:24px; padding:25px; box-shadow:0 10px 40px rgba(0,0,0,0.3); text-align:center; }
  .persona-title { font-size:20px; font-weight:800; margin-bottom:20px; color:#333; }
  .persona-opt { padding:15px; border-radius:16px; background:#f9f9f9; margin-bottom:12px; font-weight:700; cursor:pointer; transition: 0.2s; border:2px solid transparent; display:flex; align-items:center; justify-content:space-between; font-size:14px; }
  .persona-opt:active { transform: scale(0.98); }
  .persona-opt.selected { border-color: var(--primary); background:#fff8e1; color:var(--primary); }
  .persona-close { margin-top:15px; color:#999; font-size:13px; font-weight:700; cursor:pointer; padding:10px; }

  #drawerMask{ position:absolute; inset:0; background:rgba(0,0,0,.6); z-index:50; display:none; }
  #drawer{ position:absolute; top:0; right:0; height:100%; width:280px; background:#fff; z-index:60; padding:20px; transform:translateX(100%); transition:0.3s; }
  #drawer.open{ transform:translateX(0); }
  #drawerMask.show{ display:block; }
  #fileInput{ display:none; }

  #photoModal{ position:absolute; inset:0; z-index:120; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.65); backdrop-filter: blur(8px); }
  .photoBox{ width:86%; max-width:340px; background:#fff; border-radius:22px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35); }
  .photoTitle{ font-weight:900; font-size:16px; margin-bottom:10px; color:#222; }
  #photoPreview{ width:100%; height:220px; object-fit:cover; border-radius:16px; background:#f2f2f2; }
  .photoActions{ display:flex; gap:10px; margin-top:12px; }
  .photoBtn{ flex:1; height:44px; border-radius:14px; font-weight:900; cursor:pointer; }
  #photoCancelBtn{ border:1px solid #e5e5e5; background:#fff; }
  #photoOkBtn{ border:none; background:var(--primary); color:#fff; }

  /* ‚úÖ FAL MODE UI */
  .fal-only{ display:none; }
  body.fal-mode #bottom .input-wrapper{ display:none !important; }
  body.fal-mode .fal-only{ display:block; }
  .fal-cam-wrap{ width:100%; display:flex; align-items:center; justify-content:center; padding: 10px 0 6px 0; }
  .fal-cam-btn{ width:86px; height:86px; border-radius:28px; border:none; background: var(--primary); color:#fff; font-size:34px;
    display:flex; align-items:center; justify-content:center; box-shadow:0 14px 30px rgba(0,0,0,.25); cursor:pointer; }
  .fal-cam-btn:active{ transform: scale(0.96); }
  .fal-step-text{ margin-top:10px; text-align:center; font-weight:900; font-size:12px; color:#222; }
  .fal-step-sub{ margin-top:4px; text-align:center; font-weight:700; font-size:11px; color:#666; }
</style>
</head>

<body>
<div id="app">
  <img id="heroImage" src="" alt="Hero Background">

  <div id="personaModal" onclick="closePersonaMenu(event)">
    <div class="persona-content">
      <div class="persona-title">Caynana Modunu Se√ß</div>
      <div class="persona-opt selected" onclick="selectPersona('normal', this)"><span>üëµ G√∂rm√º≈ü Ge√ßirmi≈ü Kaynana</span><i class="fa-solid fa-check"></i></div>
      <div class="persona-opt" onclick="selectPersona('sevecen', this)"><span>ü•∞ Anne Tadƒ±nda Kaynana</span><i class="fa-solid fa-check" style="display:none"></i></div>
      <div class="persona-opt" onclick="selectPersona('kizgin', this)"><span>üò† Kaynana Gibi Kaynana</span><i class="fa-solid fa-check" style="display:none"></i></div>
      <div class="persona-opt" onclick="selectPersona('huysuz', this)"><span>ü§ï Bir Ayaƒüƒ± √áukurda Kaynana</span><i class="fa-solid fa-check" style="display:none"></i></div>
      <div class="persona-opt" onclick="selectPersona('itirazci', this)"><span>üò§ Her≈üeye Muhalif Kaynana</span><i class="fa-solid fa-check" style="display:none"></i></div>
      <div class="persona-close" onclick="document.getElementById('personaModal').classList.remove('show')">Kapat</div>
    </div>
  </div>

  <div id="photoModal">
    <div class="photoBox">
      <div class="photoTitle" id="photoTitle">Fotoƒüraf hazƒ±r</div>
      <img id="photoPreview" src="" alt="preview">
      <div class="photoActions">
        <button class="photoBtn" id="photoCancelBtn">Vazge√ß</button>
        <button class="photoBtn" id="photoOkBtn">Tamam</button>
      </div>
      <div id="photoHint" style="margin-top:10px; font-size:12px; color:#666; font-weight:700;">
        Tamam deyince Caynana hemen yoruma ba≈ülayacak.
      </div>
    </div>
  </div>

  <div id="drawerMask"></div>
  <div id="drawer">
    <h3 style="margin-bottom:20px;">Men√º</h3>
    <div style="padding:10px 0; border-bottom:1px solid #eee;">Hesap</div>
    <div style="padding:10px 0; border-bottom:1px solid #eee;">Ayarlar</div>
  </div>

  <div id="topbar">
    <div class="brand-wrap" onclick="cycleMode(1)">
      <div class="brand"><i class="fa-solid fa-wand-magic-sparkles"></i>CAYNANA<span>.AI</span></div>
      <div class="brand-sub">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
    </div>
    <div class="top-actions">
      <div class="menu-btn" onclick="openPersonaMenu()"><i class="fa-solid fa-masks-theater"></i></div>
      <div class="menu-btn" id="menuBtn"><i class="fa-solid fa-bars"></i></div>
    </div>
  </div>

  <div id="main">
    <div id="heroContent">
      <div id="heroTitle"></div>
      <div id="heroDesc"></div>
    </div>
    <div id="chatContainer"></div>
  </div>

  <div id="bottom">
    <div id="suggestionText"></div>

    <!-- ‚úÖ Fal Modu: sadece fotoƒüraf -->
    <div class="fal-only">
      <div class="fal-cam-wrap">
        <button class="fal-cam-btn" onclick="openFalCamera()" aria-label="Fal fotoƒüraf √ßek">
          <i class="fa-solid fa-camera"></i>
        </button>
      </div>
      <div class="fal-step-text" id="falStepText">Fal i√ßin 3 fotoƒüraf √ßek</div>
      <div class="fal-step-sub" id="falStepSub">1/3: √ústten √ßek</div>
    </div>

    <div class="input-wrapper">
      <div class="search-bar">
        <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <input id="text" placeholder="Bir ≈üey yaz..." autocomplete="off" onkeypress="if(event.key==='Enter') send()">
        <div class="tool-btn" id="micBtn" onclick="startMic()"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="sendBtn" onclick="send()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div id="dock"></div>

    <div class="brand-footer">
      <div class="footer-text-line1">@CaynanaAI By Ozyigits</div>
      <div class="oz-lines"><span class="oz-l-dynamic"></span><span class="oz-l-red"></span><span class="oz-l-white"></span><span class="oz-l-black"></span></div>
      <div class="footer-text-line2">2026</div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" capture="environment" />

<script>
  const BASE_DOMAIN = "https://bikonomi-api-2.onrender.com";
  const API_URL = `${BASE_DOMAIN}/api/chat`;
  const SPEAK_URL = `${BASE_DOMAIN}/api/speak`;
  const FAL_CHECK_URL = `${BASE_DOMAIN}/api/fal/check`;

  let sessionId = "sess_" + Math.random().toString(36).slice(2,10);
  let currentAudio = null;
  let pendingImage = null;
  let currentMode = "chat";
  let currentPersona = "normal";
  let isSending = false;

  const modeChats = {};

  // ‚úÖ Fal: 3 foto
  let falImages = [];
  const FAL_STEPS = ["1/3: √ústten √ßek", "2/3: Yandan √ßek", "3/3: Diƒüer yandan √ßek"];

  marked.setOptions({ mangle:false, headerIds:false });

  function scrollToBottom(force=false){
    const c = document.getElementById("chatContainer");
    if(!c) return;
    if(force){ requestAnimationFrame(()=>{ c.scrollTop = c.scrollHeight; }); return; }
    const nearBottom = (c.scrollHeight - c.scrollTop - c.clientHeight) < 260;
    if(!nearBottom) return;
    requestAnimationFrame(()=>{ c.scrollTop = c.scrollHeight; });
  }
  window.addEventListener("resize", ()=> scrollToBottom(true));

  function typeWriterEffect(element, text, speed=26) {
    return new Promise((resolve) => {
      let i = 0;
      element.innerHTML = "";
      element.classList.add("typing-cursor");
      function type() {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          scrollToBottom(true);
          setTimeout(type, speed);
        } else {
          element.classList.remove("typing-cursor");
          element.innerHTML = DOMPurify.sanitize(marked.parse(text));
          scrollToBottom(true);
          resolve();
        }
      }
      type();
    });
  }

  async function addBubble(role, text, isLoader=false, speech=null, imgData=null, id=null){
    const div = document.createElement("div");
    div.className = "msg " + role;
    if(id) div.id = id;

    let content = "";
    if(imgData){
      content += `<img src="${imgData}" style="max-width:100%; border-radius:12px; margin-bottom:8px;">`;
    }

    div.innerHTML = `<div class="bubble">${content}</div>`;
    const bubble = div.querySelector(".bubble");

    const c = document.getElementById("chatContainer");
    c.appendChild(div);

    document.getElementById("heroContent").style.display = "none";
    c.style.display = "block";
    scrollToBottom(true);

    if(role==="ai" && !isLoader){
      await typeWriterEffect(bubble, text);
    } else {
      bubble.innerHTML += (role==="user" ? escapeHtml(text) : text);
      scrollToBottom(true);
    }

    // ‚úÖ Fal dahil her modda konu≈üsun (speech bo≈üsa bile yine de buton koy)
    if(role==="ai"){
      const sp = (speech && speech.trim()) ? speech : (text || "").replace(/[*_`#>-]/g, "").slice(0, 280);
      const btn = document.createElement("div");
      btn.className="audio-btn";
      btn.setAttribute("data-speech", sp);
      btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Kaynana Konu≈üuyor`;
      div.appendChild(btn);
      scrollToBottom(true);
    }

    return div;
  }

  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

  function saveCurrentModeChat(){
    const c = document.getElementById("chatContainer");
    modeChats[currentMode] = c.innerHTML || "";
  }
  function loadModeChat(modeKey){
    const c = document.getElementById("chatContainer");
    c.innerHTML = modeChats[modeKey] || "";
    const hc = document.getElementById("heroContent");
    if(!c.innerHTML.trim()){
      hc.style.display = "block";
      c.style.display = "none";
    }else{
      hc.style.display = "none";
      c.style.display = "block";
      scrollToBottom(true);
    }
  }

  function setFalStepUI(){
    const t = document.getElementById("falStepText");
    const s = document.getElementById("falStepSub");
    if(!t || !s) return;
    if(falImages.length < 3){
      t.textContent = "Fal i√ßin 3 fotoƒüraf √ßek";
      s.textContent = FAL_STEPS[falImages.length] || "1/3: √ústten √ßek";
    }else{
      t.textContent = "Fal hazƒ±r‚Ä¶";
      s.textContent = "Yorum hazƒ±rlanƒ±yor";
    }
  }
  function resetFalCapture(){
    falImages = [];
    setFalStepUI();
  }

  async function send(){
    if(isSending) return;

    const input = document.getElementById("text");
    let val = (input.value || "").trim();
    if(pendingImage && val==="") val = "Bu resmi yorumla";
    if(!val && !pendingImage) return;

    isSending = true;
    document.getElementById("sendBtn").disabled = true;

    document.getElementById("heroContent").style.display="none";
    document.getElementById("chatContainer").style.display="block";

    await addBubble("user", val, false, null, pendingImage);
    input.value = "";

    const loaderId = "ldr_" + Date.now();
    await addBubble("ai", "<i class='fa-solid fa-spinner fa-spin'></i>", true, null, null, loaderId);

    const payload = { message: val, session_id: sessionId, image: pendingImage, mode: currentMode, persona: currentPersona };
    pendingImage = null;

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      const data = await res.json();

      document.getElementById(loaderId)?.remove();
      await addBubble("ai", data.assistant_text || "Bir ≈üey diyemedim evladƒ±m.", false, data.speech_text || "");

      // Shopping kartlarƒ±nƒ± buraya dokunmuyorum (senin sisteminde renderCards vardƒ±; istersen geri koyarƒ±z)
      scrollToBottom(true);
      saveCurrentModeChat();
    } catch(e){
      document.getElementById(loaderId)?.remove();
      await addBubble("ai", "Baƒülantƒ± hatasƒ± oldu evladƒ±m. Bir daha dene.", false, "");
      saveCurrentModeChat();
    } finally{
      isSending = false;
      document.getElementById("sendBtn").disabled = false;
    }
  }

  const MODES = {
    chat:{ label:"Sohbet", icon:"fa-comments", color:"#FFB300", title:"Caynana ile<br>iki lafƒ±n belini kƒ±r.", desc:"Biraz dur bakalƒ±m, neler anlatacaksƒ±n?", img: asset("images/hero-chat.png"), ph:"Naber Caynana?", sugg:"Benim zamanƒ±mda her ≈üey daha g√ºzeldi ah ah‚Ä¶", heroStyle: { top:"100px", left:"24px", textAlign:"left", width:"auto", maxWidth:"70%" } },
    shopping:{ label:"Alƒ±≈üveri≈ü", icon:"fa-bag-shopping", color:"#00C897", title:"Almadan √∂nce<br>Caynana‚Äôya sor.", desc:"Sonra ‚Äúke≈üke‚Äù dememek i√ßin buradayƒ±m.", img: asset("images/hero-shopping.png"), ph:"Ne arƒ±yorsun evladƒ±m?", sugg:"Her indirime atlayan sonunda pahalƒ± √∂der.", heroStyle: { top:"110px", left:"0", textAlign:"center", width:"100%", maxWidth:"100%" } },
    fal:{ label:"Fal", icon:"fa-mug-hot", color:"#8B5CF6", title:"Fincanƒ± kapat<br>tabakla g√∂nder.", desc:"3 a√ßƒ± √ßek: √ºstten, yandan, diƒüer yandan.", img: asset("images/hero-fal.png"), ph:"", sugg:"Sadece fincan + tabak.", heroStyle: { top:"100px", left:"0", textAlign:"center", width:"100%", maxWidth:"100%" } },
    health:{ label:"Saƒülƒ±k", icon:"fa-heart-pulse", color:"#EF4444", title:"Caynana Saƒülƒ±k'la<br>turp gibi ol.", desc:"Neren aƒürƒ±yor s√∂yle bakayƒ±m?", img: asset("images/hero-health.png"), ph:"≈ûikayetin ne?", sugg:"√áay √ºst√ºne sakƒ±n soƒüuk su i√ßme!", heroStyle: { top:"110px", left:"24px", textAlign:"left", width:"auto", maxWidth:"70%" } },
    diet:{ label:"Diyet", icon:"fa-carrot", color:"#84CC16", title:"Saƒülƒ±klƒ± beslen<br>zinde kal!", desc:"A√ßlƒ±ktan deƒüil, keyiften yiyin.", img: asset("images/hero-diet.png"), ph:"Boy kilo ka√ß?", sugg:"Ekmek deƒüil, ye≈üillik ye.", heroStyle: { top:"100px", left:"24px", textAlign:"left", width:"auto", maxWidth:"75%" } },
    food:{ label:"Yemek", icon:"fa-utensils", color:"#F97316", title:"Bug√ºn ne<br>pi≈üirsem derdi biter.", desc:"Dolapta ne var s√∂yle, tarif benden.", img: asset("images/hero-food.png"), ph:"Dolapta ne var?", sugg:"Malzemeyi ziyan etme, bereket ka√ßar.", heroStyle: { top:"110px", left:"24px", textAlign:"left", width:"auto", maxWidth:"75%" } },
    law:{ label:"Hukuk", icon:"fa-scale-balanced", color:"#3B82F6", title:"Hukuk i≈üleri<br>≈üakaya gelmez.", desc:"Ben avukat deƒüilim ama √ßok dava g√∂rd√ºm.", img: asset("images/hero-law.png"), ph:"Derdini anlat.", sugg:"S√∂zle≈ümeye bakmadan imza atma!", heroStyle: { top:"110px", left:"0", textAlign:"center", width:"100%", maxWidth:"100%" } },
    astro:{ label:"Bur√ß", icon:"fa-star", color:"#D946EF", title:"Yƒ±ldƒ±zlar senin i√ßin<br>ne diyor?", desc:"Merk√ºr retrosu falan‚Ä¶ dikkat et.", img: asset("images/hero-astro.png"), ph:"Burcun ne?", sugg:"Yƒ±ldƒ±znameye baktƒ±m, yolun a√ßƒ±k.", heroStyle: { top:"110px", left:"24px", textAlign:"left", width:"auto", maxWidth:"70%" } },
    translate:{ label:"√áeviri", icon:"fa-language", color:"#64748B", title:"√áeviri lazƒ±m mƒ±?<br>S√∂yle √ßevireyim.", desc:"Metni yapƒ±≈ütƒ±r veya fotoƒürafƒ±nƒ± √ßek.", img: asset("images/hero-translate.png"), ph:"Metni yaz.", sugg:"Bir lisan bir insan.", heroStyle: { top:"110px", left:"0", textAlign:"center", width:"100%", maxWidth:"100%" } },
    dream:{ label:"R√ºya", icon:"fa-cloud-moon", color:"#6366F1", title:"R√ºyalar alemine<br>ho≈ü geldin.", desc:"Hayƒ±rdƒ±r in≈üallah‚Ä¶", img: asset("images/hero-dream.png"), ph:"Ne g√∂rd√ºn?", sugg:"R√ºyalar tersine √ßƒ±kar derler ama‚Ä¶", heroStyle: { top:"110px", left:"0", textAlign:"center", width:"100%", maxWidth:"100%" } }
  };

  function basePath(){ const p = location.pathname; return p.endsWith("/") ? p : p.substring(0, p.lastIndexOf("/") + 1); }
  function asset(rel){ return basePath() + rel.replace(/^\/+/, ""); }

  function applyHero(modeKey){
    const m = MODES[modeKey] || MODES.chat;
    document.documentElement.style.setProperty("--primary", m.color);
    document.getElementById("heroImage").src = m.img;
    document.getElementById("heroTitle").innerHTML = m.title;
    document.getElementById("heroDesc").innerHTML = m.desc;

    const hc = document.getElementById("heroContent");
    const hs = m.heroStyle || {};
    hc.style.top = hs.top || "100px";
    hc.style.left = hs.left || "24px";
    hc.style.textAlign = hs.textAlign || "left";
    hc.style.width = hs.width || "auto";
    hc.style.maxWidth = hs.maxWidth || "70%";

    document.getElementById("text").placeholder = m.ph || "Bir ≈üey yaz...";
    document.getElementById("suggestionText").textContent = m.sugg || "";
    document.querySelector(".oz-l-dynamic").style.background = m.color;
  }

  function switchMode(modeKey){
    if(modeKey === currentMode) return;
    saveCurrentModeChat();
    currentMode = modeKey;

    document.querySelectorAll(".dock-item").forEach(el=>{
      el.classList.toggle("active", el.getAttribute("data-mode") === modeKey);
    });

    applyHero(modeKey);
    loadModeChat(modeKey);

    document.body.classList.toggle("fal-mode", modeKey === "fal");
    if(modeKey === "fal") resetFalCapture();
  }

  function renderDock(){
    const dock = document.getElementById("dock");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(k=>{
      const m = MODES[k];
      const item = document.createElement("div");
      item.className = "dock-item" + (k===currentMode ? " active" : "");
      item.setAttribute("data-mode", k);
      item.innerHTML = `
        <div class="icon-box"><i class="fa-solid ${m.icon}"></i></div>
        <div class="dock-label">${m.label}</div>
      `;
      item.onclick = ()=> switchMode(k);
      dock.appendChild(item);
    });
  }

  // --- FOTO MODAL / FAL CHECK ---
  const fileEl = document.getElementById("fileInput");
  const photoModal = document.getElementById("photoModal");
  const photoPreview = document.getElementById("photoPreview");
  const photoOkBtn = document.getElementById("photoOkBtn");
  const photoCancelBtn = document.getElementById("photoCancelBtn");
  const photoTitle = document.getElementById("photoTitle");
  const photoHint = document.getElementById("photoHint");

  function openCamera(){ fileEl.value=""; fileEl.click(); }
  function openFalCamera(){ openCamera(); }

  async function falCheckOneImage(dataUrl){
    try{
      const r = await fetch(FAL_CHECK_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ image: dataUrl })
      });
      const j = await r.json();
      return j;
    }catch(e){
      return { ok:false, reason:"Kontrol edemedim, tekrar dene." };
    }
  }

  fileEl.addEventListener("change", async e=>{
    const f = e.target.files[0];
    if(!f) return;

    const r = new FileReader();
    r.onload = async ()=>{
      const imgData = r.result;

      // ‚úÖ Fal modunda: her foto anƒ±nda doƒürulanacak
      if(currentMode === "fal"){
        const check = await falCheckOneImage(imgData);
        if(!check.ok){
          await addBubble("ai", check.reason || "Evladƒ±m bu fincan-tabak deƒüil. Yeniden √ßek.", false, "");
          // aynƒ± adƒ±mda kal
          resetModalOnly();
          setTimeout(()=> openFalCamera(), 200);
          return;
        }

        falImages.push(imgData);
        setFalStepUI();

        pendingImage = imgData;
        photoPreview.src = pendingImage;
        photoTitle.textContent = "Fal fotoƒürafƒ±";
        photoHint.textContent = (falImages.length < 3)
          ? `Tamam deyince ${FAL_STEPS[falImages.length] || "bir sonraki a√ßƒ±ya"} ge√ßiyoruz.`
          : "Tamam deyince fala bakƒ±yorum.";
        photoModal.style.display = "flex";
        return;
      }

      // diƒüer modlar
      pendingImage = imgData;
      photoPreview.src = pendingImage;
      photoTitle.textContent = "Fotoƒüraf hazƒ±r";
      photoHint.textContent = "Tamam deyince Caynana hemen yoruma ba≈ülayacak.";
      photoModal.style.display = "flex";
    };
    r.readAsDataURL(f);
  });

  function resetModalOnly(){
    pendingImage = null;
    photoPreview.src = "";
    photoModal.style.display = "none";
    fileEl.value = "";
  }

  photoCancelBtn.onclick = ()=>{
    if(currentMode === "fal"){
      // son √ßekimi geri al
      falImages = falImages.slice(0, Math.max(0, falImages.length - 1));
      setFalStepUI();
    }
    resetModalOnly();
  };

  photoOkBtn.onclick = async ()=>{
    photoModal.style.display = "none";

    if(currentMode === "fal"){
      if(falImages.length < 3){
        setTimeout(()=> openFalCamera(), 220);
        return;
      }

      const collage = await makeFalCollage(falImages);
      pendingImage = collage;

      // Fal mesajƒ±nƒ± otomatik veriyoruz
      const input = document.getElementById("text");
      if(input) input.value = "Fal bak: fincanƒ± 3 a√ßƒ±dan g√∂nderdim. Ger√ßek√ßi ve insani anlat.";

      await send();
      resetFalCapture();
      return;
    }

    document.getElementById("text").value = "";
    await send();
  };

  async function makeFalCollage(imgList){
    const imgs = await Promise.all(imgList.map(loadImage));
    const W = 900, H = 900;
    const canvas = document.createElement("canvas");
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    const pad = 18;
    const cellW = (W - pad*3)/2;
    const cellH = (H - pad*3)/2;

    drawContain(ctx, imgs[0], pad, pad, cellW, cellH);
    drawContain(ctx, imgs[1], pad*2 + cellW, pad, cellW, cellH);
    drawContain(ctx, imgs[2], pad, pad*2 + cellH, W - pad*2, cellH);

    return canvas.toDataURL("image/jpeg", 0.92);
  }

  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const im = new Image();
      im.onload = ()=> resolve(im);
      im.onerror = reject;
      im.src = src;
    });
  }

  function drawContain(ctx, img, x, y, w, h){
    const iw = img.width, ih = img.height;
    const ir = iw/ih;
    const r = w/h;
    let dw=w, dh=h, dx=x, dy=y;
    if(ir > r){ dh = w/ir; dy = y + (h - dh)/2; }
    else { dw = h*ir; dx = x + (w - dw)/2; }

    ctx.save();
    roundRect(ctx, x, y, w, h, 16);
    ctx.clip();
    ctx.fillStyle = "#f6f6f6";
    ctx.fillRect(x,y,w,h);
    ctx.drawImage(img, dx, dy, dw, dh);
    ctx.restore();

    ctx.strokeStyle = "rgba(0,0,0,0.08)";
    ctx.lineWidth = 3;
    roundRect(ctx, x, y, w, h, 16);
    ctx.stroke();
  }

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  // --- SES ---
  async function playAudio(text, btn){
    if(currentAudio){ currentAudio.pause(); currentAudio=null; }
    document.querySelectorAll(".audio-btn.playing").forEach(b=>{
      b.classList.remove("playing");
      b.innerHTML = `<i class="fa-solid fa-volume-high"></i> Kaynana Konu≈üuyor`;
    });

    const oldHtml = btn.innerHTML;
    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor`;

    try{
      const r = await fetch(SPEAK_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ text, persona: currentPersona })
      });
      const blob = await r.blob();
      currentAudio = new Audio(URL.createObjectURL(blob));
      currentAudio.onended = ()=>{
        btn.classList.remove("playing");
        btn.innerHTML = `<i class="fa-solid fa-volume-high"></i> Kaynana Konu≈üuyor`;
      };
      await currentAudio.play();
      btn.classList.add("playing");
      btn.innerHTML = `<i class="fa-solid fa-stop"></i> Durdur`;
    } catch(e){
      btn.innerHTML = oldHtml;
    }
  }
  document.getElementById("chatContainer").addEventListener("click", e=>{
    const btn = e.target.closest(".audio-btn");
    if(btn) playAudio(btn.getAttribute("data-speech"), btn);
  });

  // --- MIC ---
  function startMic(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return alert("Tarayƒ±cƒ± desteklemiyor");
    const r = new SR();
    r.lang="tr-TR";
    r.onresult = e=>{
      document.getElementById("text").value = e.results[0][0].transcript;
      send();
    };
    r.start();
  }

  // --- DRAWER ---
  const mask=document.getElementById("drawerMask"), drawer=document.getElementById("drawer");
  document.getElementById("menuBtn").onclick=()=>{ mask.style.display="block"; drawer.classList.add("open"); };
  mask.onclick=()=>{ mask.style.display="none"; drawer.classList.remove("open"); };

  // --- PERSONA ---
  function openPersonaMenu(){ document.getElementById('personaModal').classList.add('show'); }
  function closePersonaMenu(e){ if(e.target.id === 'personaModal') document.getElementById('personaModal').classList.remove('show'); }
  function selectPersona(personaId, el){
    currentPersona = personaId;
    document.querySelectorAll('.persona-opt').forEach(opt => {
      opt.classList.remove('selected');
      opt.querySelector('i').style.display = 'none';
    });
    el.classList.add('selected');
    el.querySelector('i').style.display = 'block';
    setTimeout(()=> document.getElementById('personaModal').classList.remove('show'), 200);
  }

  // INIT
  renderDock();
  applyHero("chat");
  loadModeChat("chat");
  document.body.classList.remove("fal-mode");
</script>
</body>
</html>
