<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>CAYNANA.AI</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

<style>
  /* --- ORÄ°JÄ°NAL TASARIM CSS --- */
  :root { --primary: #D4AF37; --bg-dark: #0b0f18; --font: 'Plus Jakarta Sans', sans-serif; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; padding: 0; font-family: var(--font); 
    background-color: #000; height: 100%; overflow: hidden; 
    display: flex; justify-content: center; align-items: center; 
  }
  
  #app { 
    width: 100%; height: 100%; position: relative; 
    background-color: var(--bg-dark); display: flex; flex-direction: column; overflow: hidden; 
    max-width: 480px; max-height: 920px; border-radius: 24px; 
    box-shadow: 0 0 50px rgba(0,0,0,0.5); 
    background-size: cover; background-position: center; 
    transition: background-image 0.4s ease-in-out; 
  }
  
  @media (max-width: 520px) { 
    #app { max-width: none; max-height: none; border-radius: 0; height: 100dvh; } 
  }
  
  #app::after { 
    content: ''; position: absolute; inset: 0; 
    background: linear-gradient(to top, rgba(11,15,24,1) 0%, rgba(11,15,24,0.95) 15%, rgba(11,15,24,0.4) 50%, rgba(11,15,24,0.6) 100%); 
    pointer-events: none; z-index: 1; 
  }

  header { 
    position: relative; z-index: 10; padding: 16px 20px; 
    display: flex; justify-content: space-between; align-items: center; 
    padding-top: max(16px, env(safe-area-inset-top)); 
  }
  
  .logo { font-weight: 800; font-size: 24px; color: #fff; display: flex; align-items: center; gap: 8px; }
  .logo i, .logo span { color: var(--primary); }
  .slogan { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); margin-top: 2px; }
  
  .menu-btn { 
    width: 40px; height: 40px; border-radius: 50%; 
    background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); 
    display: flex; align-items: center; justify-content: center; 
    color: #fff; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
  }

  #container { 
    flex: 1; position: relative; z-index: 5; overflow-y: auto; 
    padding: 20px; padding-bottom: 150px; scrollbar-width: none; 
  }
  
  #hero-text { text-align: center; margin-top: 60px; transition: opacity 0.3s; }
  #hero-title { font-size: 36px; font-weight: 800; line-height: 1.1; color: #fff; text-shadow: 0 4px 20px rgba(0,0,0,0.6); margin-bottom: 10px; }
  #hero-desc { font-size: 16px; color: rgba(255,255,255,0.9); font-weight: 500; }
  
  .msg-row { display: flex; margin-bottom: 16px; animation: slideUp 0.3s ease; }
  .msg-row.user { justify-content: flex-end; }
  
  .bubble { 
    max-width: 85%; padding: 14px 18px; border-radius: 20px; 
    font-size: 15px; line-height: 1.5; word-wrap: break-word; 
  }
  .msg-row.ai .bubble { background: rgba(255, 255, 255, 0.95); color: #1a1a1a; border-bottom-left-radius: 4px; }
  .msg-row.user .bubble { background: var(--primary); color: #fff; border-bottom-right-radius: 4px; }

  /* Ses Butonu Stili */
  .audio-btn {
    margin-top: 5px; font-size: 12px; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 700;
  }
  
  /* Kart TasarÄ±mÄ± */
  .cards-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
  .card { background: #fff; border-radius: 16px; padding: 10px; display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
  .badge { position: absolute; top: 8px; left: 0; padding: 4px 8px; font-size: 10px; font-weight: 800; color: #fff; border-top-right-radius: 8px; border-bottom-right-radius: 8px; z-index: 2; }
  .badge.gold { background: linear-gradient(90deg, #FFD700, #FFA500); }
  .badge.value { background: linear-gradient(90deg, #00C897, #009688); }
  .card-img { width: 100%; height: 110px; object-fit: cover; border-radius: 10px; margin-bottom: 8px; background: #f0f0f0; }
  .card-title { font-size: 12px; font-weight: 700; color: #333; margin-bottom: 4px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
  .card-price { font-size: 14px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
  .card-btn { margin-top: auto; background: #f0f0f0; color: #333; text-align: center; padding: 8px; border-radius: 8px; font-size: 11px; font-weight: 700; text-decoration: none; }
  
  /* Alt Bar */
  #bottom-bar { 
    position: absolute; bottom: 0; left: 0; right: 0; z-index: 20; 
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); 
    border-top: 1px solid rgba(255,255,255,0.3); 
    border-top-left-radius: 24px; border-top-right-radius: 24px; 
    padding-bottom: calc(env(safe-area-inset-bottom) + 15px); padding-top: 15px; 
    display: flex; flex-direction: column; gap: 12px; 
  }
  
  #suggestion { 
    position: absolute; top: -45px; left: 50%; transform: translateX(-50%); 
    background: #fff; padding: 8px 16px; border-radius: 20px; 
    font-size: 12px; font-weight: 700; color: var(--primary); 
    box-shadow: 0 5px 20px rgba(0,0,0,0.15); white-space: nowrap; animation: bounce 2s infinite; 
  }
  
  .input-area { padding: 0 15px; display: flex; align-items: center; gap: 10px; }
  .input-box { flex: 1; height: 50px; background: #fff; border-radius: 25px; display: flex; align-items: center; padding: 0 6px; border: 1px solid rgba(0,0,0,0.05); }
  .tool-btn { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; }
  #user-input { flex: 1; border: none; outline: none; font-size: 15px; padding: 0 8px; font-family: var(--font); background: transparent; }
  #send-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--primary); color: #fff; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
  
  .dock { display: flex; gap: 12px; padding: 0 15px; overflow-x: auto; scrollbar-width: none; }
  .dock-item { display: flex; flex-direction: column; align-items: center; gap: 4px; opacity: 0.5; transition: 0.3s; cursor: pointer; min-width: 60px; }
  .dock-item.active { opacity: 1; transform: translateY(-3px); }
  .dock-icon { width: 44px; height: 44px; border-radius: 14px; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; font-size: 18px; color: #333; }
  .dock-item.active .dock-icon { background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  .dock-label { font-size: 10px; font-weight: 700; color: #333; }
  
  .footer-info { text-align: center; font-size: 10px; color: #888; font-weight: 600; margin-top: -5px; padding-bottom: 5px; }
  .it-flag { display: inline-block; width: 20px; height: 12px; background: linear-gradient(90deg, #009246 33%, #fff 33%, #fff 66%, #ce2b37 66%); vertical-align: middle; margin-left: 5px; border-radius: 2px; }

  /* Ayarlar ModalÄ± (Ses SeÃ§imi Ä°Ã§in) */
  #settings-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; justify-content:center; align-items:center; }
  .modal-box { background:#fff; width:80%; max-width:300px; padding:20px; border-radius:20px; text-align:center; }
  .modal-title { font-weight:800; margin-bottom:15px; color:#333; }
  #voice-select { width:100%; padding:10px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; }
  .close-btn { background:var(--primary); color:#fff; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; font-weight:700; width:100%; }

  @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes bounce { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -5px); } }
  #file-upload { display: none; }
  .image-preview { width: 100%; border-radius: 10px; margin-bottom: 10px; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="brand-group">
      <div class="logo"><i class="fa-solid fa-wand-magic-sparkles"></i>CAYNANA<span>.AI</span></div>
      <div class="slogan">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
    </div>
    <div class="menu-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></div>
  </header>

  <div id="container">
    <div id="hero-text">
      <div id="hero-title">Almadan Ã¶nce<br>Caynanaâ€™ya sor.</div>
      <div id="hero-desc">Sonra â€œkeÅŸkeâ€ dememek iÃ§in buradayÄ±m.</div>
    </div>
    <div id="chat-area"></div>
  </div>

  <div id="bottom-bar">
    <div id="suggestion">Her indirime atlayan sonunda pahalÄ± Ã¶der.</div>
    
    <div class="input-area">
      <div class="input-box">
        <div class="tool-btn" onclick="openCamera()"><i class="fa-solid fa-camera"></i></div>
        <input type="text" id="user-input" placeholder="Ne danÄ±ÅŸmak istersin?" autocomplete="off">
        <div class="tool-btn" id="mic-btn"><i class="fa-solid fa-microphone"></i></div>
      </div>
      <button id="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>

    <div class="dock" id="dock-container"></div>
    <div class="footer-info">@CaynanaAI by Italky Technology <span class="it-flag"></span></div>
  </div>

  <div id="settings-modal">
    <div class="modal-box">
      <div class="modal-title">Ses AyarlarÄ±</div>
      <select id="voice-select"><option>YÃ¼kleniyor...</option></select>
      <button class="close-btn" onclick="closeSettings()">Kaydet</button>
    </div>
  </div>
</div>

<input type="file" id="file-upload" accept="image/*">

<script>
  // ğŸ”¥ LOKAL TEST Ä°Ã‡Ä°N BUNU KULLAN:
  const API_BASE = "http://127.0.0.1:8000"; 
  
  const MODES = {
    shopping: { label: "AlÄ±ÅŸveriÅŸ", icon: "fa-bag-shopping", color: "#00C897", img: "images/hero-shopping.png", title: "Almadan Ã¶nce<br>Caynanaâ€™ya sor.", desc: "Sonra â€œkeÅŸkeâ€ dememek iÃ§in buradayÄ±m.", sugg: "Her indirime atlayan sonunda pahalÄ± Ã¶der.", ph: "Neye bakmÄ±ÅŸtÄ±n evladÄ±m?" },
    chat: { label: "Sohbet", icon: "fa-comments", color: "#FFB300", img: "images/hero-chat.png", title: "Caynana ile<br>dertleÅŸ.", desc: "Anlat bakalÄ±m, canÄ±nÄ± sÄ±kan ne?", sugg: "Eskiden komÅŸuluk vardÄ±, ÅŸimdi wifi var...", ph: "Naber Caynana?" },
    fal: { label: "Fal", icon: "fa-mug-hot", color: "#8B5CF6", img: "images/hero-fal.png", title: "Kahveni iÃ§tin mi?<br>Gel falÄ±na bakayÄ±m.", desc: "Neyse halin, Ã§Ä±ksÄ±n falin.", sugg: "Kapat fincanÄ±, fotoÄŸrafÄ±nÄ± Ã§ek gÃ¶nder.", ph: "FincanÄ± Ã§ektin mi?" },
    dream: { label: "RÃ¼ya", icon: "fa-moon", color: "#6366F1", img: "images/hero-dream.png", title: "RÃ¼yalar<br>haberci olabilir.", desc: "HayÄ±rdÄ±r inÅŸallah de...", sugg: "Suya anlat derler ama sen bana anlat.", ph: "RÃ¼yanda ne gÃ¶rdÃ¼n?" },
    health: { label: "SaÄŸlÄ±k", icon: "fa-heart-pulse", color: "#EF4444", img: "images/hero-health.png", title: "SaÄŸlÄ±k olsun<br>gerisi boÅŸ.", desc: "Neren aÄŸrÄ±yor evladÄ±m?", sugg: "Terli terli soÄŸuk su iÃ§me!", ph: "Åikayetin ne?" },
    diet: { label: "Diyet", icon: "fa-apple-whole", color: "#84CC16", img: "images/hero-diet.png", title: "SaÄŸlÄ±klÄ± beslen<br>zinde kal.", desc: "AÃ§ kalarak deÄŸil, dengeli ye.", sugg: "AkÅŸam 7'den sonra buzdolabÄ±na kÃ¼s.", ph: "Hedefin ne?" },
    food: { label: "Yemek", icon: "fa-utensils", color: "#F97316", img: "images/hero-food.png", title: "BugÃ¼n ne<br>piÅŸirsem?", desc: "Dolapta ne var sÃ¶yle, tarif vereyim.", sugg: "Malzemeyi ziyan etme, bereket kaÃ§ar.", ph: "Hangi malzemeler var?" },
    law: { label: "Hukuk", icon: "fa-scale-balanced", color: "#3B82F6", img: "images/hero-law.png", title: "HakkÄ±nÄ±<br>yedirme.", desc: "DanÄ±ÅŸmadan imza atma evladÄ±m.", sugg: "SÃ¶z uÃ§ar yazÄ± kalÄ±r.", ph: "Sorun nedir?" },
    astro: { label: "BurÃ§", icon: "fa-star", color: "#D946EF", img: "images/hero-astro.png", title: "YÄ±ldÄ±zlar<br>ne diyor?", desc: "MerkÃ¼r retrosuna dikkat.", sugg: "YÄ±ldÄ±znameye baktÄ±m, yolun aÃ§Ä±k.", ph: "Burcun ne?" },
    translate: { label: "Ã‡eviri", icon: "fa-language", color: "#64748B", img: "images/hero-translate.png", title: "Dil bilmek<br>altÄ±n bileziktir.", desc: "AnlamadÄ±ÄŸÄ±n yazÄ±yÄ± gÃ¶ster Ã§evireyim.", sugg: "Turist gelince mahcup olma.", ph: "Ã‡evrilecek metin ne?" }
  };

  let currentMode = "shopping";
  let pendingImage = null;
  let chatHistory = {};
  let currentAudio = null;
  let selectedVoiceId = localStorage.getItem("caynana_voice_id") || "";

  function init() { renderDock(); switchMode("shopping"); loadVoices(); }
  
  function renderDock() {
    const dock = document.getElementById("dock-container");
    dock.innerHTML = "";
    Object.keys(MODES).forEach(key => {
      const m = MODES[key];
      const el = document.createElement("div");
      el.className = `dock-item ${key === currentMode ? "active" : ""}`;
      el.onclick = () => switchMode(key);
      el.innerHTML = `<div class="dock-icon"><i class="fa-solid ${m.icon}"></i></div><div class="dock-label">${m.label}</div>`;
      dock.appendChild(el);
    });
  }

  function switchMode(mode) {
    if(!MODES[mode]) return;
    const chatArea = document.getElementById("chat-area");
    chatHistory[currentMode] = chatArea.innerHTML;
    currentMode = mode;
    const m = MODES[mode];
    document.documentElement.style.setProperty("--primary", m.color);
    document.getElementById("hero-title").innerHTML = m.title;
    document.getElementById("hero-desc").innerHTML = m.desc;
    document.getElementById("suggestion").innerText = m.sugg;
    document.getElementById("user-input").placeholder = m.ph;
    document.getElementById("app").style.backgroundImage = `url('${m.img}')`;
    renderDock();
    chatArea.innerHTML = chatHistory[mode] || "";
    toggleHero(chatArea.innerHTML.trim() === "");
  }

  function toggleHero(show) {
    const hero = document.getElementById("hero-text");
    hero.style.opacity = show ? "1" : "0";
    hero.style.pointerEvents = show ? "all" : "none";
    document.getElementById("chat-area").style.display = show ? "none" : "block";
  }

  async function loadVoices() {
    try {
      const res = await fetch(`${API_BASE}/api/voices`);
      const data = await res.json();
      const select = document.getElementById("voice-select");
      select.innerHTML = "";
      data.voices.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.text = v.name;
        if(v.id === selectedVoiceId) opt.selected = true;
        select.appendChild(opt);
      });
      if(!selectedVoiceId && data.voices.length) selectedVoiceId = data.voices[0].id;
    } catch(e) { console.log(e); }
  }

  async function sendMessage() {
    const input = document.getElementById("user-input");
    const txt = input.value.trim();
    if(!txt && !pendingImage) return;
    
    toggleHero(false);
    if(currentMode === "shopping") document.querySelectorAll(".cards-wrapper").forEach(el => el.remove());
    
    addMessage("user", txt, pendingImage);
    input.value = "";
    
    const loadingId = addLoading();
    const payload = { message: txt, mode: currentMode, image: pendingImage };
    pendingImage = null;

    try {
      const res = await fetch(`${API_BASE}/api/chat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      removeLoading(loadingId);
      
      addMessage("ai", data.assistant_text, null, true);
      playAudio(data.assistant_text); // Otomatik konuÅŸ
      
      if(data.data && data.data.length > 0) renderCards(data.data);
    } catch(e) {
      removeLoading(loadingId);
      addMessage("ai", "Ah evladÄ±m internetim kesildi galiba. Backend adresini kontrol et.");
    }
  }

  async function playAudio(text) {
    if(currentAudio) currentAudio.pause();
    try {
      const res = await fetch(`${API_BASE}/api/speak`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text, voice_id: selectedVoiceId })
      });
      if(res.ok && res.status !== 204) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        currentAudio = new Audio(url);
        currentAudio.play();
      }
    } catch(e) { console.error(e); }
  }

  function addMessage(role, text, imgData, hasAudio=false) {
    const area = document.getElementById("chat-area");
    const row = document.createElement("div");
    row.className = `msg-row ${role}`;
    let content = "";
    if(imgData) content += `<img src="${imgData}" class="image-preview">`;
    if(role === "ai") {
        content += DOMPurify.sanitize(marked.parse(text));
        if(hasAudio) content += `<div class='audio-btn' onclick="playAudio('${text.replace(/'/g, "\\'")}')"><i class='fa-solid fa-volume-high'></i> Tekrar Oku</div>`;
    } else {
        content += text;
    }
    row.innerHTML = `<div class="bubble">${content}</div>`;
    area.appendChild(row);
    document.getElementById("container").scrollTo(0, document.getElementById("container").scrollHeight);
  }

  function addLoading() {
    const id = "loading-" + Date.now();
    const area = document.getElementById("chat-area");
    const row = document.createElement("div");
    row.className = "msg-row ai";
    row.id = id;
    row.innerHTML = `<div class="bubble"><i class="fa-solid fa-circle-notch fa-spin"></i> BakÄ±yorum evladÄ±m...</div>`;
    area.appendChild(row);
    return id;
  }
  function removeLoading(id) { const el = document.getElementById(id); if(el) el.remove(); }

  function renderCards(list) {
    const area = document.getElementById("chat-area");
    const wrapper = document.createElement("div");
    wrapper.className = "cards-wrapper";
    list.forEach(item => {
      const badgeClass = item.badge || "silver";
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<div class="badge ${badgeClass}">${badgeClass === "gold" ? "Ã–NERÄ°LEN" : "EKONOMÄ°K"}</div><img src="${item.image}" class="card-img" onerror="this.src='https://via.placeholder.com/150'"><div class="card-title">${item.title}</div><div class="card-price">${item.price}</div><a href="${item.url}" target="_blank" class="card-btn">Ä°NCELE</a>`;
      wrapper.appendChild(card);
    });
    area.appendChild(wrapper);
    document.getElementById("container").scrollTo(0, document.getElementById("container").scrollHeight);
  }

  function openCamera() { document.getElementById("file-upload").click(); }
  document.getElementById("file-upload").addEventListener("change", function(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) { pendingImage = evt.target.result; document.getElementById("user-input").focus(); document.getElementById("user-input").value = "ğŸ“· FotoÄŸraf eklendi"; };
    reader.readAsDataURL(file);
  });
  
  function openSettings() { document.getElementById("settings-modal").style.display = "flex"; }
  function closeSettings() { 
      document.getElementById("settings-modal").style.display = "none";
      const sel = document.getElementById("voice-select");
      if(sel.value) { selectedVoiceId = sel.value; localStorage.setItem("caynana_voice_id", sel.value); }
  }

  document.getElementById("user-input").addEventListener("keypress", function(e) { if(e.key === "Enter") sendMessage(); });
  init();
</script>
</body>
</html>
