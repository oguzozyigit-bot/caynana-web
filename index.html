<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Caynana.AI</title>

<style>
:root{
  --bg: #050505;
  --amber: #ffb300;
  --amber-glow: #ff9100;
  --text: #e0e0e0;
  --drawer-bg: #141414;
}

*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}

body{
  margin: 0;
  background: #000;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  overflow: hidden;
  color: var(--text);
}

.phone{
  width: 100%;
  max-width: 420px;
  height: 100%;
  max-height: 900px;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
}

@media(min-width: 500px){
  .phone{
    border-radius: 40px;
    box-shadow: 0 0 0 10px #111, 0 30px 80px rgba(0,0,0,0.8);
    height: 95vh;
  }
}

/* --- TOPBAR --- */
.topbar {
  position: absolute;
  top: 0; left: 0; width: 100%;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  z-index: 50;
}

.menuBtn {
  background: none; border: none;
  font-size: 24px; color: #666; cursor: pointer;
  padding: 5px;
  transition: 0.3s;
}
.menuBtn:hover { color: var(--amber); }

.brand { opacity: 0; }
.authDot {
  width: 8px; height: 8px;
  background: #444;
  border-radius: 50%;
}
.authDot.active { background: var(--amber); box-shadow: 0 0 5px var(--amber); }

/* --- DRAWER --- */
.drawerMask {
  position: absolute; inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(2px);
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 90;
}
.drawerMask.open { opacity: 1; pointer-events: auto; }

.drawer {
  position: absolute; top: 0; left: 0; bottom: 0;
  width: 280px;
  background: var(--drawer-bg);
  transform: translateX(-100%);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
  display: flex; flex-direction: column;
  box-shadow: 5px 0 20px rgba(0,0,0,0.5);
  border-right: 1px solid #222;
}
.drawer.open { transform: translateX(0); }

.drawerHead {
  padding: 20px;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid #222;
}
.drawerTitle { font-weight: bold; color: var(--amber); font-size: 18px; }
.drawerClose { background:none; border:none; color:#666; font-size:20px; cursor:pointer; }

.drawerProfile {
  padding: 20px;
  display: flex; align-items: center; gap: 15px;
  background: #111;
}
.avatar {
  width: 50px; height: 50px;
  border-radius: 50%;
  background: #333;
  object-fit: cover;
  border: 2px solid #222;
}
.dpName { font-size: 15px; font-weight: 600; color: #fff; }
.dpCN { font-size: 12px; color: #666; margin-top: 2px; }

.drawerItem {
  background: none; border: none;
  text-align: left;
  padding: 15px 20px;
  color: #ccc;
  font-size: 15px;
  cursor: pointer;
  border-bottom: 1px solid #1a1a1a;
  transition: 0.2s;
}
.drawerItem:hover { background: #1f1f1f; color: var(--amber); padding-left: 25px; }
.drawerItem.danger { color: #ff4444; margin-top: auto; border-top: 1px solid #222; border-bottom: none;}
.drawerHr { border: 0; border-top: 1px solid #222; margin: 0; }

/* --- HEADER & EYES --- */
.header{
  height: 210px;
  display: flex; justify-content: center; align-items: center;
  background: radial-gradient(circle at center, rgba(255,179,0,0.10) 0%, #000 72%);
  position: relative; z-index: 10; flex-shrink: 0;
  margin-top: 20px;
}

/* Kadƒ±n g√∂z√º vibe */
.eyes-container{
  display: flex;
  gap: 24px;
  transform: scale(0.92);
}

.eye-wrapper{
  width: 150px;
  height: 110px;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Ka≈ü */
.brow{
  position: absolute;
  top: 0px;
  left: 50%;
  transform: translateX(-50%) rotate(-6deg);
  width: 116px;
  height: 26px;
  z-index: 30;
  filter: drop-shadow(0 3px 8px rgba(0,0,0,0.75));
  opacity: 0.96;
}
.brow::before{
  content:"";
  position:absolute; inset:0;
  border-radius: 40px;
  background:
    radial-gradient(140px 40px at 50% 78%, rgba(0,0,0,0) 58%, rgba(10,10,10,0.95) 62%, rgba(0,0,0,0) 72%),
    radial-gradient(140px 40px at 50% 80%, rgba(0,0,0,0) 58%, rgba(35,35,35,0.9) 62%, rgba(0,0,0,0) 74%);
  clip-path: polygon(0% 70%, 12% 42%, 28% 24%, 46% 18%, 66% 22%, 84% 38%, 100% 66%, 100% 100%, 0% 100%);
}
.brow::after{
  content:"";
  position:absolute;
  right: 4px; top: 10px;
  width: 28px; height: 10px;
  background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0.95));
  border-radius: 10px;
  transform: rotate(-10deg);
  opacity: 0.85;
}

/* Kirpik */
.lashes{
  position:absolute;
  top: 22px;
  left: 50%;
  transform: translateX(-50%);
  width: 160px;
  height: 62px;
  z-index: 22;
  pointer-events:none;
  filter: drop-shadow(0 4px 10px rgba(0,0,0,0.8));
}
.lashes::before{
  content:"";
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(
      105deg,
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0) 7px,
      rgba(255,255,255,0.09) 8px,
      rgba(255,255,255,0.09) 9px,
      rgba(0,0,0,0) 10px,
      rgba(0,0,0,0) 14px
    );
  opacity: 0.65;
  mask-image: radial-gradient(160px 88px at 50% 92%, rgba(0,0,0,0) 50%, rgba(0,0,0,1) 64%);
}
.lashes::after{
  content:"";
  position:absolute; left: 10px; right: 10px; top: 10px; bottom: 0;
  border-top: 3px solid rgba(0,0,0,0.92);
  border-radius: 0 0 70px 70px;
  transform: rotate(-2deg);
  opacity: 0.8;
}

/* Eyeliner */
.eyeliner{
  position: absolute;
  top: 34px;
  left: 50%;
  transform: translateX(-50%);
  width: 154px;
  height: 44px;
  z-index: 18;
  pointer-events:none;
}
.eyeliner::before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(150px 60px at 50% 100%, rgba(0,0,0,0) 55%, rgba(0,0,0,0.95) 62%, rgba(0,0,0,0) 72%),
    linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.9) 24%, rgba(0,0,0,0.9) 76%, rgba(0,0,0,0) 100%);
  clip-path: polygon(0% 85%, 10% 58%, 25% 40%, 46% 33%, 64% 36%, 80% 46%, 92% 62%, 100% 80%, 100% 100%, 0% 100%);
  opacity: 0.85;
}
.eyeliner::after{
  content:"";
  position:absolute;
  right: -8px; top: 20px;
  width: 28px; height: 10px;
  background: linear-gradient(90deg, rgba(0,0,0,0.95), rgba(0,0,0,0));
  border-radius: 10px;
  transform: rotate(-12deg);
  opacity: 0.92;
}

/* Badem g√∂z √ßer√ßevesi */
.eye-frame{
  position: absolute;
  top: 30px; left: 50%;
  transform: translateX(-50%);
  width: 150px;
  height: 82px;
  border-radius: 58% 58% 45% 45% / 70% 70% 45% 45%;
  border: 3px solid rgba(255,255,255,0.95);
  background: rgba(0,0,0,0.35);
  z-index: 10;
  box-shadow:
    0 0 4px rgba(255,255,255,0.85),
    0 0 12px rgba(255,179,0,0.85),
    0 0 26px rgba(255,179,0,0.7),
    inset 0 -10px 18px rgba(0,0,0,0.85),
    inset 0 0 16px rgba(255,179,0,0.45);
}

/* Iris (daha canlƒ±) */
.iris{
  position:absolute;
  top: 56px;
  left: 50%;
  transform: translateX(-50%);
  width: 48px; height: 48px;
  border-radius: 50%;
  background:
    radial-gradient(circle at 35% 35%, rgba(255,179,0,0.55) 0%, rgba(255,179,0,0.18) 28%, rgba(0,0,0,0.0) 60%),
    radial-gradient(circle at 55% 70%, rgba(255,145,0,0.28) 0%, rgba(0,0,0,0) 55%),
    radial-gradient(circle at 50% 50%, rgba(255,255,255,0.06) 0%, rgba(0,0,0,0) 58%);
  border: 2px solid rgba(255,255,255,0.35);
  box-shadow: 0 0 18px rgba(255,179,0,0.35);
  z-index: 11;
  pointer-events:none;
  opacity: 0.96;
}

/* Pupil (kapsayƒ±cƒ±) */
.pupil{
  position:absolute;
  top: 66px;
  left: 50%;
  transform: translateX(-50%);
  width: 26px; height: 26px;
  border-radius: 50%;
  background: #000;
  border: 2px solid rgba(255,255,255,0.95);
  box-shadow: 0 0 12px rgba(255,179,0,0.9);
  z-index: 16;
  overflow: hidden;
  transition: transform 0.08s linear;
}
.pupil::after{
  content:"";
  position:absolute; inset:0;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.09) 25%, rgba(0,0,0,0) 55%);
  pointer-events:none;
}

/* G√∂z i√ßinde g√∂z */
.mini-eye{
  position:absolute;
  left:50%; top:50%;
  width: 14px; height: 9px;
  transform: translate(-50%,-50%);
  border-radius: 55% 55% 45% 45% / 70% 70% 45% 45%;
  border: 1px solid rgba(255,255,255,0.92);
  background: rgba(0,0,0,0.55);
  box-shadow:
    0 0 2px rgba(255,255,255,0.7),
    0 0 6px rgba(255,179,0,0.75),
    inset 0 0 6px rgba(255,179,0,0.35);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity: 0.96;
}
.mini-pupil{
  width: 4px; height: 4px;
  border-radius: 50%;
  background: #000;
  border: 1px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 4px rgba(255,179,0,0.95);
  transition: transform 0.08s linear;
}

/* Kapak (blink) */
.lid{
  position: absolute;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  width: 170px;
  height: 0%;
  background: var(--bg);
  z-index: 25;
  border-bottom: 2px solid #111;
  transition: height 0.08s linear;
  border-radius: 60px;
}

/* Tek g√∂z kƒ±rpma i√ßin zorla kapama */
.eye-wrapper.force-blink .lid{ height: 84% !important; }

/* --- CHAT --- */
.chat-area{
  flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px;
  overflow-y: auto; scroll-behavior: smooth;
}
.chat-area::-webkit-scrollbar{ width: 0; }

.msg{ max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; animation: popIn 0.3s ease; }
@keyframes popIn{ from{transform: scale(0.95); opacity: 0;} to{transform: scale(1); opacity: 1;} }
.msg.caynana{ align-self: flex-start; color: #ddd; border-left: 3px solid var(--amber); padding-left: 15px; }
.msg.user{ align-self: flex-end; background: #222; color: #fff; border-bottom-right-radius: 4px; }
.typing-indicator{ font-size: 12px; color: #666; margin-left: 15px; display: none; }

/* --- INPUT --- */
.input-dock{
  padding: 15px 20px 30px 20px; background: linear-gradient(to top, var(--bg) 80%, transparent);
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}
.icon-btn{
  width: 44px; height: 44px;
  border: none; background: #111; border-radius: 50%;
  color: #888; font-size: 20px; cursor: pointer; transition: 0.2s;
}
.icon-btn:hover{ color: var(--amber); }
.icon-btn.active{
  color: var(--amber);
  box-shadow: 0 0 0 1px rgba(255,179,0,0.35), 0 0 14px rgba(255,179,0,0.25);
}
.input-wrapper{ flex: 1; }
input{
  width: 100%;
  background: #111;
  border: 1px solid #333;
  border-radius: 25px;
  padding: 14px 20px;
  color: #fff;
  font-size: 16px;
  outline: none;
  transition: 0.3s;
}
input:focus{ border-color: var(--amber); }

/* Mood */
.blink .lid{ animation: blink 4s infinite; }
@keyframes blink{ 0%,96%,100%{height:0%} 98%{height:84%} }
.suspicious .brow{ transform: translateX(-50%) translateY(5px) rotate(-10deg); }
.shock .brow{ transform: translateX(-50%) translateY(-8px) rotate(-4deg); }
.rolling .brow{ transform: translateX(-50%) rotate(10deg); }
.rolling .pupil{ animation: roll 1.7s ease-in-out; }
@keyframes roll{
  0%{transform:translateX(-50%) translate(0,0)}
  50%{transform:translateX(-50%) translate(0,-14px)}
  100%{transform:translateX(-50%) translate(0,0)}
}

/* Kamera gizli video */
#camVideo{
  position: absolute;
  width: 1px; height: 1px;
  opacity: 0;
  pointer-events: none;
  left: -9999px; top: -9999px;
}
</style>
</head>
<body>

<div class="phone" id="phone">

  <header class="topbar">
    <button id="menuBtn" class="menuBtn" aria-label="Men√º">‚ò∞</button>
    <div class="brand"></div>
    <div id="authDot" class="authDot" title="Giri≈ü durumu"></div>
  </header>

  <div id="drawerMask" class="drawerMask"></div>

  <aside id="drawer" class="drawer">
    <div class="drawerHead">
      <div class="drawerTitle">Caynana</div>
      <button id="drawerClose" class="drawerClose">‚úï</button>
    </div>

    <div class="drawerProfile">
      <div class="avatar" style="display:flex; align-items:center; justify-content:center; color:#555;">?</div>
      <div>
        <div id="dpName" class="dpName">Misafir</div>
        <div id="dpCN" class="dpCN">Giri≈ü Yapƒ±lmadƒ±</div>
      </div>
    </div>

    <button id="openProfileBtn" class="drawerItem">üë§ Profil</button>
    <button id="openLoginBtn" class="drawerItem">üîê Google ile giri≈ü</button>

    <hr class="drawerHr">

    <button id="aboutBtn" class="drawerItem">‚ÑπÔ∏è Hakkƒ±mƒ±zda</button>
    <button id="faqBtn" class="drawerItem">‚ùì SSS</button>
    <button id="contactBtn" class="drawerItem">‚úâÔ∏è ƒ∞leti≈üim</button>
    <button id="privacyBtn" class="drawerItem">üîí Gizlilik</button>

    <button id="logoutBtn" class="drawerItem danger">üö™ √áƒ±kƒ±≈ü</button>
  </aside>

  <div class="header">
    <div class="eyes-container">
      <div class="eye-wrapper blink" id="eyeL">
        <div class="brow"></div>
        <div class="lashes"></div>
        <div class="eyeliner"></div>
        <div class="lid"></div>
        <div class="eye-frame"></div>
        <div class="iris"></div>
        <div class="pupil">
          <div class="mini-eye"><div class="mini-pupil"></div></div>
        </div>
      </div>

      <div class="eye-wrapper blink" id="eyeR">
        <div class="brow"></div>
        <div class="lashes"></div>
        <div class="eyeliner"></div>
        <div class="lid"></div>
        <div class="eye-frame"></div>
        <div class="iris"></div>
        <div class="pupil">
          <div class="mini-eye"><div class="mini-pupil"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="msg caynana">
      Ooo ho≈ü geldin...<br>
      Anlat bakalƒ±m, bug√ºn ne havadisler var?
    </div>
  </div>
  <div class="typing-indicator" id="typing">Caynana yazƒ±yor...</div>

  <div class="input-dock">
    <button class="icon-btn" id="camBtn" title="Kamera ile takip">üì∑</button>
    <div class="input-wrapper">
      <input type="text" id="userInput" placeholder="Caynana'ya yaz..." autocomplete="off">
    </div>
    <button class="icon-btn">üéôÔ∏è</button>
  </div>

  <video id="camVideo" autoplay playsinline></video>
</div>

<script>
/* --- DRAWER --- */
const menuBtn = document.getElementById('menuBtn');
const drawer = document.getElementById('drawer');
const mask = document.getElementById('drawerMask');
const closeBtn = document.getElementById('drawerClose');

function toggleDrawer(open) {
  if(open) { drawer.classList.add('open'); mask.classList.add('open'); }
  else { drawer.classList.remove('open'); mask.classList.remove('open'); }
}
menuBtn.addEventListener('click', () => toggleDrawer(true));
closeBtn.addEventListener('click', () => toggleDrawer(false));
mask.addEventListener('click', () => toggleDrawer(false));

/* --- G√ñZ & CHAT --- */
const phone = document.getElementById("phone");
const eyeL = document.getElementById("eyeL");
const eyeR = document.getElementById("eyeR");
const eyes = [eyeL, eyeR];

const pupils = document.querySelectorAll(".pupil");
const miniPupils = document.querySelectorAll(".mini-pupil");

const input = document.getElementById("userInput");
const chatArea = document.getElementById("chatArea");
const typingIndicator = document.getElementById("typing");

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function trackEyes(screenX, screenY) {
  eyes.forEach((eye, i) => {
    if(!eye.classList.contains("rolling")){
      const rect = eye.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;

      const dx = (screenX - cx) / 11;
      const dy = (screenY - cy) / 11;

      const px = clamp(dx, -14, 14);
      const py = clamp(dy, -10, 10);

      pupils[i].style.transform = `translateX(-50%) translate(${px}px, ${py}px)`;

      const mx = clamp(-px * 0.35, -4, 4);
      const my = clamp(-py * 0.35, -3, 3);
      miniPupils[i].style.transform = `translate(${mx}px, ${my}px)`;
    }
  });
}

/* mouse/touch fallback */
phone.addEventListener("mousemove", (e) => { if(!cameraRunning) trackEyes(e.clientX, e.clientY); });
phone.addEventListener("touchmove", (e) => {
  if(cameraRunning) return;
  if(!e.touches || !e.touches[0]) return;
  trackEyes(e.touches[0].clientX, e.touches[0].clientY);
},{passive:true});

function setMood(mood) {
  eyes.forEach((e, i) => {
    e.classList.remove("blink", "suspicious", "shock", "rolling");
    pupils[i].style.transform = "translateX(-50%) translate(0,0)";
    miniPupils[i].style.transform = "translate(0,0)";
    if(mood === "normal") e.classList.add("blink"); else e.classList.add(mood);
  });
  if(mood === "rolling") setTimeout(() => setMood("normal"), 1800);
}

input.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && input.value.trim() !== "") {
    const text = input.value;
    addMessage(text, "user");
    input.value = "";
    typingIndicator.style.display = "block";
    chatArea.scrollTop = chatArea.scrollHeight;

    setTimeout(() => {
      typingIndicator.style.display = "none";
      generateResponse(text);
    }, 800);
  }
});

function addMessage(text, type) {
  const div = document.createElement("div");
  div.className = `msg ${type}`;
  div.innerHTML = text;
  chatArea.appendChild(div);
  chatArea.scrollTop = chatArea.scrollHeight;
}

function generateResponse(text) {
  const lower = text.toLowerCase();
  let response = "", mood = "normal";

  if (lower.includes("para")) { mood = "suspicious"; response = "O parayƒ± harcarken bana mƒ± sordun? Tutumlu ol biraz."; }
  else if (lower.includes("elti")) { mood = "rolling"; response = "Ay yine mi o? Vallahi ≈üi≈ütim, anlat ne yaptƒ±?"; }
  else if (lower.includes("koca")) { mood = "shock"; response = "Neeey? Ciddi misin? Sakƒ±n alttan alma!"; }
  else { response = "Ee sonra? Devam et, dinliyorum."; }

  setMood(mood);
  addMessage(response, "caynana");
}

setMood("normal");
</script>

<!-- Kamera ile y√ºz takibi + tek g√∂z kƒ±rpma (MediaPipe Face Landmarker) -->
<script type="module">
/*
Kaynak yakla≈üƒ±m: MediaPipe Face Landmarker web √∂rnekleri + FilesetResolver/FaceLandmarker CDN kullanƒ±m mantƒ±ƒüƒ±. Ó®Å0Ó®Ç
*/
import vision from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";
const { FaceLandmarker, FilesetResolver } = vision;

const camBtn = document.getElementById("camBtn");
const video = document.getElementById("camVideo");
const phone = document.getElementById("phone");
const eyeL = document.getElementById("eyeL");
const eyeR = document.getElementById("eyeR");

let faceLandmarker = null;
let cameraRunning = false;
window.cameraRunning = false;

let rafId = null;
let stream = null;

/* blink stabilitesi i√ßin */
let leftBlinkHold = 0;
let rightBlinkHold = 0;

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

function lmAvg(lms, idxs){
  let x=0,y=0;
  for(const i of idxs){ x += lms[i].x; y += lms[i].y; }
  return { x: x/idxs.length, y: y/idxs.length };
}

function dist(a,b){
  const dx = a.x-b.x, dy = a.y-b.y;
  return Math.hypot(dx,dy);
}

/* FaceMesh indeksleri (Face Landmarker 478 landmark seti ile uyumlu pratik indeksler) */
const LEFT_EYE_TOP = 159, LEFT_EYE_BOT = 145, LEFT_EYE_L = 33, LEFT_EYE_R = 133;
const RIGHT_EYE_TOP = 386, RIGHT_EYE_BOT = 374, RIGHT_EYE_L = 362, RIGHT_EYE_R = 263;
const NOSE_TIP = 1;

/* iris noktalarƒ± */
const LEFT_IRIS = [468,469,470,471,472];
const RIGHT_IRIS = [473,474,475,476,477];

async function ensureModel(){
  if(faceLandmarker) return;

  const filesetResolver = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
  );

  faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
    baseOptions: {
      modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",
      delegate: "GPU"
    },
    runningMode: "VIDEO",
    numFaces: 1
  });
}

function setEyeBlink(eyeEl, isClosed){
  if(isClosed) eyeEl.classList.add("force-blink");
  else eyeEl.classList.remove("force-blink");
}

function trackEyes(screenX, screenY) {
  const pupils = document.querySelectorAll(".pupil");
  const miniPupils = document.querySelectorAll(".mini-pupil");
  const eyes = [eyeL, eyeR];

  eyes.forEach((eye, i) => {
    if(!eye.classList.contains("rolling")){
      const rect = eye.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;

      const dx = (screenX - cx) / 11;
      const dy = (screenY - cy) / 11;

      const px = clamp(dx, -14, 14);
      const py = clamp(dy, -10, 10);

      pupils[i].style.transform = `translateX(-50%) translate(${px}px, ${py}px)`;
      const mx = clamp(-px * 0.35, -4, 4);
      const my = clamp(-py * 0.35, -3, 3);
      miniPupils[i].style.transform = `translate(${mx}px, ${my}px)`;
    }
  });
}

async function startCamera(){
  await ensureModel();

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" },
    audio: false
  });

  video.srcObject = stream;
  await video.play();

  cameraRunning = true;
  window.cameraRunning = true;
  camBtn.classList.add("active");

  loop();
}

function stopCamera(){
  cameraRunning = false;
  window.cameraRunning = false;
  camBtn.classList.remove("active");

  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;

  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;

  setEyeBlink(eyeL, false);
  setEyeBlink(eyeR, false);
}

function loop(){
  if(!cameraRunning) return;

  const now = performance.now();
  const results = faceLandmarker.detectForVideo(video, now);

  if(results && results.faceLandmarks && results.faceLandmarks.length){
    const lms = results.faceLandmarks[0];

    /* y√ºz merkezini ekrana map et -> g√∂zler seni takip etsin */
    const nose = lms[NOSE_TIP];
    const phoneRect = phone.getBoundingClientRect();

    const screenX = phoneRect.left + nose.x * phoneRect.width;
    const screenY = phoneRect.top + nose.y * phoneRect.height;

    trackEyes(screenX, screenY);

    /* tek g√∂z kƒ±rpma (eye openness ratio) */
    const lTop = lms[LEFT_EYE_TOP], lBot = lms[LEFT_EYE_BOT], lL = lms[LEFT_EYE_L], lR = lms[LEFT_EYE_R];
    const rTop = lms[RIGHT_EYE_TOP], rBot = lms[RIGHT_EYE_BOT], rL = lms[RIGHT_EYE_L], rR = lms[RIGHT_EYE_R];

    const lOpen = dist(lTop,lBot) / (dist(lL,lR) + 1e-6);
    const rOpen = dist(rTop,rBot) / (dist(rL,rR) + 1e-6);

    /* e≈üikler: ki≈üiye g√∂re ufak oynar */
    const BLINK_THR = 0.18;

    const lClosed = lOpen < BLINK_THR;
    const rClosed = rOpen < BLINK_THR;

    /* jitter azalt: kapalƒ±yken 2 frame tut */
    if(lClosed) leftBlinkHold = Math.min(3, leftBlinkHold + 1);
    else leftBlinkHold = Math.max(0, leftBlinkHold - 1);

    if(rClosed) rightBlinkHold = Math.min(3, rightBlinkHold + 1);
    else rightBlinkHold = Math.max(0, rightBlinkHold - 1);

    setEyeBlink(eyeL, leftBlinkHold >= 2);
    setEyeBlink(eyeR, rightBlinkHold >= 2);

    /* (Bonus) iris merkezini istersen ileride daha ‚Äútam g√∂z takibi‚Äù i√ßin kullanabiliriz */
    // const lIris = lmAvg(lms, LEFT_IRIS);
    // const rIris = lmAvg(lms, RIGHT_IRIS);
  }

  rafId = requestAnimationFrame(loop);
}

camBtn.addEventListener("click", async () => {
  try{
    if(!cameraRunning) await startCamera();
    else stopCamera();
  }catch(err){
    console.error(err);
    stopCamera();
    alert("Kamera a√ßƒ±lamadƒ±. HTTPS/localhost ≈üart. Tarayƒ±cƒ± izinlerini kontrol et.");
  }
});
</script>

</body>
</html>
