<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CAYNANA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #10B981;
    --primary-dark: #059669;
    --bg: #FFFFFF;
    --chat-bg: #F9FAFB;
    --user-msg: #10B981;
    --ai-msg: #F3F4F6;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- HERO SECTION --- */
  #hero-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.4s ease;
    padding: 20px;
    z-index: 5;
  }
  
  /* Chat başlayınca Hero küçülür */
  #hero-section.minimized {
    flex: 0;
    padding: 10px 20px;
    border-bottom: 1px solid #E5E7EB;
    flex-direction: row;
    justify-content: space-between;
    height: 60px;
    background: rgba(255,255,255,0.95);
  }

  .logo {
    font-size: 42px;
    font-weight: 800;
    color: #1F2937;
    letter-spacing: -1px;
    margin-bottom: 30px;
    transition: all 0.4s ease;
    cursor: pointer;
  }
  .logo span { color: var(--primary); }
  
  #hero-section.minimized .logo {
    font-size: 20px;
    margin-bottom: 0;
  }

  /* --- CHAT AREA --- */
  #chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: none;
    flex-direction: column;
    gap: 15px;
    background: var(--chat-bg);
    scroll-behavior: smooth;
  }
  #chat-container.active { display: flex; }

  .msg-row { display: flex; flex-direction: column; width: 100%; max-width: 800px; margin: 0 auto; animation: popIn 0.3s ease; }
  .msg-row.user { align-items: flex-end; }
  .msg-row.ai { align-items: flex-start; }

  .bubble {
    padding: 12px 18px;
    border-radius: 20px;
    font-size: 15px;
    line-height: 1.5;
    max-width: 85%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    position: relative;
  }
  .msg-row.user .bubble { background: var(--user-msg); color: white; border-bottom-right-radius: 4px; }
  .msg-row.ai .bubble { background: var(--ai-msg); color: #1F2937; border-bottom-left-radius: 4px; border: 1px solid #E5E7EB; }

  /* Audio Btn */
  .audio-btn {
    margin-top: 5px; background: none; border: none; cursor: pointer;
    color: #6B7280; font-size: 12px; display: flex; align-items: center; gap: 5px;
  }
  .audio-btn:hover { color: var(--primary); }

  @keyframes popIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

  /* --- INPUT WRAPPER --- */
  .input-wrapper {
    width: 100%;
    max-width: 600px;
    position: relative;
    transition: all 0.4s ease;
  }
  /* Chat başlayınca input aşağı footer'a iner */
  #chat-footer .input-wrapper { max-width: 100%; }

  .search-box {
    width: 100%;
    padding: 16px 50px 16px 20px;
    border: 2px solid #E5E7EB;
    border-radius: 30px;
    font-size: 16px;
    outline: none;
    background: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transition: 0.3s;
  }
  .search-box:focus { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1); }

  .action-btn {
    position: absolute;
    right: 10px; top: 50%; transform: translateY(-50%);
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--primary); color: white;
    border: none; font-size: 18px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .action-btn:active { transform: translateY(-50%) scale(0.9); }

  /* --- CHIPS --- */
  .chips {
    display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center;
  }
  #hero-section.minimized .chips { display: none; }

  .chip {
    background: #F3F4F6; padding: 8px 16px; border-radius: 20px;
    font-size: 13px; font-weight: 600; color: #4B5563;
    cursor: pointer; border: 1px solid transparent; transition: 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .chip:hover { border-color: var(--primary); color: var(--primary); background: #ECFDF5; }
  .chip i { color: var(--primary); }

  /* --- BOTTOM LINKS (FOOTER) --- */
  .bottom-links {
    margin-top: 40px;
    display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
    font-size: 12px; color: #9CA3AF;
  }
  .bottom-links a { text-decoration: none; color: inherit; font-weight: 500; transition:0.2s; }
  .bottom-links a:hover { color: var(--primary); }
  
  /* Chat başlayınca alttaki linkler kaybolur */
  #hero-section.minimized .bottom-links { display: none; }

  /* --- CHAT FOOTER (Input Area) --- */
  #chat-footer {
    padding: 15px 20px;
    background: white;
    border-top: 1px solid #E5E7EB;
    display: none; /* Başlangıçta gizli */
  }
  #chat-footer.active { display: block; }

  .typing { display: none; font-size: 12px; color: #9CA3AF; padding: 10px; text-align: center; font-style: italic; }

</style>
</head>
<body>

<div id="hero-section">
  <div class="logo" onclick="location.reload()">CAYNANA<span>.AI</span></div>
  
  <div class="input-wrapper" id="mainInputWrap">
    <input type="text" id="mainInput" class="search-box" placeholder="Ne danışmak istersin evladım?" autocomplete="off" onkeypress="if(event.key==='Enter') startChat()">
    <button class="action-btn" onclick="startChat()"><i class="fa-solid fa-paper-plane"></i></button>
  </div>

  <div class="chips">
    <div class="chip" onclick="fill('Fal bak (Fincan)')"><i class="fa-solid fa-mug-hot"></i> Kahve Falı</div>
    <div class="chip" onclick="fill('İngilizceye çevir: Seni seviyorum')"><i class="fa-solid fa-language"></i> Çevirmen</div>
    <div class="chip" onclick="fill('Bugün ne giysem?')"><i class="fa-solid fa-shirt"></i> Yaşam Koçu</div>
    <div class="chip" onclick="fill('Nöbetçi eczane')"><i class="fa-solid fa-pills"></i> Eczane</div>
  </div>

  <div class="bottom-links">
    <a href="#">Hakkımızda</a>
    <a href="#">Nasıl Çalışır?</a>
    <a href="#">SSS</a>
    <a href="#">Gizlilik</a>
    <a href="#">İletişim</a>
    <span>© 2026 Caynana.AI</span>
  </div>
</div>

<div id="chat-container"></div>
<div class="typing" id="typingIndicator">Kaynanan yazıyor...</div>

<div id="chat-footer"></div>

<script>
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-1.onrender.com/api/speak";
  
  const hero = document.getElementById('hero-section');
  const chatContainer = document.getElementById('chat-container');
  const chatFooter = document.getElementById('chat-footer');
  const inputWrap = document.getElementById('mainInputWrap');
  const mainInput = document.getElementById('mainInput');
  const typing = document.getElementById('typingIndicator');
  
  let isChatActive = false;
  let currentAudio = null;

  function fill(txt) {
    mainInput.value = txt;
    startChat();
  }

  function startChat() {
    const txt = mainInput.value.trim();
    if(!txt) return;

    if (!isChatActive) {
        // UI Dönüşümü (Google -> Chat)
        isChatActive = true;
        hero.classList.add('minimized');
        chatContainer.classList.add('active');
        chatFooter.classList.add('active');
        chatFooter.appendChild(inputWrap); // Inputu aşağı taşı
        mainInput.focus();
    }

    addMsg(txt, 'user');
    mainInput.value = '';
    
    // API Çağrısı
    typing.style.display = 'block';
    chatContainer.scrollTop = chatContainer.scrollHeight;

    const payload = {
        message: txt,
        user: { city: 'İstanbul', gender: 'neutral' }
    };

    fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        typing.style.display = 'none';
        const aiText = data.reply || data.assistant_text || "Bir şeyler ters gitti.";
        addMsg(aiText, 'ai');
        
        // Otomatik Seslendirme Opsiyonel:
        // playVoice(null, aiText); 
        
        // Kartlar varsa
        if(data.data && Array.isArray(data.data)) {
            let cardsText = data.data.map(c => `• ${c.title} (${c.price || c.desc})`).join('<br>');
            if(cardsText) addMsg(cardsText, 'ai');
        }
    })
    .catch(() => {
        typing.style.display = 'none';
        addMsg("Bağlantı koptu evladım.", 'ai');
    });
  }

  function addMsg(txt, type) {
    const row = document.createElement('div');
    row.className = `msg-row ${type}`;
    
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = txt.replace(/\n/g, '<br>');
    row.appendChild(bubble);

    if(type === 'ai') {
        const btn = document.createElement('button');
        btn.className = 'audio-btn';
        btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle';
        // Tırnakları temizle
        const safeTxt = txt.replace(/<[^>]*>?/gm, '').replace(/"/g, ''); 
        btn.onclick = function() { playVoice(this, safeTxt); };
        row.appendChild(btn);
    }

    chatContainer.appendChild(row);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  async function playVoice(btn, text) {
    if(currentAudio) { currentAudio.pause(); currentAudio=null; }
    
    let originalHTML = '';
    if(btn) {
        originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    }
    
    try {
      const res = await fetch(SPEAK_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      
      currentAudio.onended = () => { if(btn) btn.innerHTML = originalHTML; };
      await currentAudio.play();
      
      if(btn) {
          btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
          btn.onclick = function() { 
              currentAudio.pause(); 
              btn.innerHTML = originalHTML; 
              btn.onclick = function() { playVoice(this, text); }; // Fonksiyonu geri yükle
          };
      }
    } catch(e) {
      if(btn) btn.innerHTML = originalHTML;
      alert("Ses çalınamadı.");
    }
  }
</script>

</body>
</html>
