<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CAYNANA - Alışveriş Danışmanı</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --primary: #10B981; /* Alışveriş Yeşili */
    --primary-dark: #059669;
    --bg: #FFFFFF;
    --chat-bg: #F9FAFB;
    --user-msg: #10B981;
    --ai-msg: #F3F4F6;
    /* İtalya Bayrağı Renkleri */
    --italy-green: #009246;
    --italy-white: #F1F2F1;
    --italy-red: #CE2B37;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--bg);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* --- HEADER --- */
  .header {
    background: rgba(255,255,255,0.95);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between; /* İkonlar sağa yaslansın diye */
    border-bottom: 1px solid #E5E7EB;
    z-index: 10;
  }
  
  /* Sol Üst Köşe Logo Alanı */
  .logo-container {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
  }

  /* İtalya Bayrağı Logosu */
  .italy-flag-logo {
    display: flex;
    width: 30px;
    height: 20px;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .flag-stripe { flex: 1; height: 100%; }
  .flag-green { background-color: var(--italy-green); }
  .flag-white { background-color: var(--italy-white); }
  .flag-red { background-color: var(--italy-red); }

  .logo-text {
    font-size: 20px;
    font-weight: 800;
    color: #1F2937;
    letter-spacing: -0.5px;
  }
  .logo-text span { color: var(--primary); }

  /* Header Sağ Taraf İkonları */
  .header-icons {
    display: flex;
    align-items: center;
    gap: 15px;
    color: #6B7280;
  }
  .header-icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: inherit;
    padding: 5px;
    transition: color 0.2s;
  }
  .header-icon-btn:hover { color: var(--primary); }

  /* --- CHAT AREA --- */
  #chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    background: var(--chat-bg);
    scroll-behavior: smooth;
  }

  .msg-row { display: flex; flex-direction: column; width: 100%; max-width: 800px; margin: 0 auto; animation: popIn 0.3s ease; }
  .msg-row.user { align-items: flex-end; }
  .msg-row.ai { align-items: flex-start; }

  .bubble {
    padding: 14px 18px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.5;
    max-width: 85%;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    position: relative;
  }
  .msg-row.user .bubble { background: var(--user-msg); color: white; border-bottom-right-radius: 4px; }
  .msg-row.ai .bubble { background: var(--ai-msg); color: #1F2937; border-bottom-left-radius: 4px; border: 1px solid #E5E7EB; }

  /* GÖRSEL KARTLAR (Alışveriş Önerileri) */
  .cards-scroll {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 5px 20px 5px;
    width: 100%;
    scrollbar-width: none; /* Firefox gizle */
  }
  .cards-scroll::-webkit-scrollbar { display: none; /* Chrome gizle */ }

  .card {
    min-width: 240px;
    max-width: 240px;
    background: white;
    border-radius: 16px;
    padding: 12px;
    border: 1px solid #E5E7EB;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s;
    flex-shrink: 0;
  }
  .card:active { transform: scale(0.98); }
  
  .card img {
    width: 100%;
    height: 140px;
    object-fit: contain; /* Ürün resmi tam görünsün */
    border-radius: 10px;
    margin-bottom: 10px;
    background: #fff;
  }
  
  .card-title {
    font-weight: 700;
    font-size: 14px;
    color: #111;
    margin-bottom: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 40px; /* Sabit yükseklik */
  }
  
  .card-price {
    font-size: 15px;
    font-weight: 800;
    color: var(--primary);
    margin-top: auto;
  }
  
  .card-store {
    font-size: 11px;
    color: #6B7280;
    margin-top: 4px;
  }

  /* Audio Btn */
  .audio-btn {
    margin-top: 6px; background: none; border: none; cursor: pointer;
    color: #6B7280; font-size: 12px; display: flex; align-items: center; gap: 5px;
    font-weight: 600; transition: 0.2s;
  }
  .audio-btn:hover { color: var(--primary); }

  @keyframes popIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }

  /* --- FOOTER --- */
  .footer {
    background: white;
    border-top: 1px solid #E5E7EB;
    padding: 15px 20px;
    padding-bottom: max(15px, env(safe-area-inset-bottom));
  }

  /* Chips */
  .chips {
    display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px;
    scrollbar-width: none;
  }
  .chips::-webkit-scrollbar { display: none; }
  
  .chip {
    background: #F3F4F6; padding: 8px 16px; border-radius: 20px;
    font-size: 13px; font-weight: 600; color: #4B5563;
    white-space: nowrap; cursor: pointer; border: 1px solid transparent;
    display: flex; align-items: center; gap: 6px; transition: 0.2s;
  }
  .chip:hover { border-color: var(--primary); color: var(--primary); background: #ECFDF5; }
  .chip i { color: var(--primary); }

  /* Input Bar */
  .input-bar {
    display: flex; align-items: center; gap: 10px;
    background: #F9FAFB;
    border: 1px solid #E5E7EB;
    border-radius: 30px;
    padding: 8px 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
  }
  .input-bar:focus-within { border-color: var(--primary); background: white; }

  .tool-btn {
    width: 36px; height: 36px; border-radius: 50%; border: none;
    background: transparent; color: #6B7280; font-size: 18px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .tool-btn:hover { color: var(--primary); background: #F3F4F6; }

  .text-input {
    flex: 1; border: none; background: transparent;
    font-size: 16px; outline: none; padding: 0 5px;
  }

  .send-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: var(--primary); color: white; font-size: 16px;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); transition: 0.2s;
  }
  .send-btn:active { transform: scale(0.9); }

  /* Helpers */
  #fileInput { display: none; }
  .typing { display: none; font-size: 12px; color: #9CA3AF; padding: 10px; text-align: center; font-style: italic; }

</style>
</head>
<body>

<div class="header">
  <div class="logo-container" onclick="location.reload()">
    <div class="italy-flag-logo">
      <div class="flag-stripe flag-green"></div>
      <div class="flag-stripe flag-white"></div>
      <div class="flag-stripe flag-red"></div>
    </div>
    <div class="logo-text">CAYNANA<span>.AI</span></div>
  </div>

  <div class="header-icons">
    <button class="header-icon-btn" onclick="triggerCamera()"><i class="fa-solid fa-camera"></i></button>
    <button class="header-icon-btn"><i class="fa-solid fa-microphone"></i></button>
  </div>
</div>

<div id="chat-container">
  <div class="msg-row ai">
    <div class="bubble">
      Hoş geldin evladım. Ben Kaynanan.<br>
      Senin paran kıymetli, çarçur etme. Ne alacaksan bana sor, en iyisini en ucuza bulayım.
    </div>
    <button class="audio-btn" onclick="playVoice(this, 'Hoş geldin evladım. Ben Kaynanan. Senin paran kıymetli, çarçur etme. Ne alacaksan bana sor, en iyisini en ucuza bulayım.')">
        <i class="fa-solid fa-volume-high"></i> Dinle
    </button>
  </div>
</div>

<div class="typing" id="typingIndicator">Kaynanan araştırıyor...</div>

<div class="footer">
  <div class="chips">
    <div class="chip" onclick="fill('Airfryer önerisi')"><i class="fa-solid fa-fire-burner"></i> Airfryer</div>
    <div class="chip" onclick="fill('Robot süpürge fiyatları')"><i class="fa-solid fa-robot"></i> Robot Süpürge</div>
    <div class="chip" onclick="fill('Ucuz laptop önerisi')"><i class="fa-solid fa-laptop"></i> Laptop</div>
    <div class="chip" onclick="triggerCamera()"><i class="fa-solid fa-camera"></i> Fal Bak</div>
  </div>

  <div class="input-bar">
    <button class="tool-btn" onclick="triggerCamera()"><i class="fa-solid fa-camera"></i></button>
    <input type="text" id="msgInput" class="text-input" placeholder="Ne alacaksın evladım?" autocomplete="off" onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleFile(this.files[0])">
  </div>
</div>

<script>
  const API_URL = "https://bikonomi-api-1.onrender.com/api/chat";
  const SPEAK_URL = "https://bikonomi-api-1.onrender.com/api/speak";
  
  const chatContainer = document.getElementById('chat-container');
  const msgInput = document.getElementById('msgInput');
  const typing = document.getElementById('typingIndicator');
  
  let currentImg = null;
  let currentAudio = null;

  function fill(txt) {
    msgInput.value = txt;
    sendMessage();
  }

  function triggerCamera() {
    document.getElementById('fileInput').click();
  }

  function handleFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      currentImg = e.target.result;
      addMessage("Fotoğraf eklendi. Yorumla bakalım.", 'user', currentImg);
      // Otomatik gönder (fal için)
      sendMessage(true);
    };
    reader.readAsDataURL(file);
  }

  function addMessage(text, type, imgBase64 = null) {
    const row = document.createElement('div');
    row.className = `msg-row ${type}`;
    
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    
    if (imgBase64) {
        const img = document.createElement('img');
        img.src = imgBase64;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '10px';
        img.style.marginBottom = '8px';
        img.style.display = 'block';
        bubble.appendChild(img);
    }
    
    // Güvenli metin ekleme
    const textSpan = document.createElement('span');
    textSpan.innerHTML = text.replace(/\n/g, '<br>');
    bubble.appendChild(textSpan);
    
    row.appendChild(bubble);

    // AI ise ses butonu
    if(type === 'ai' && text) {
        const btn = document.createElement('button');
        btn.className = 'audio-btn';
        btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle';
        // Tırnakları temizle
        const safeTxt = text.replace(/<[^>]*>?/gm, '').replace(/"/g, ''); 
        btn.onclick = function() { playVoice(this, safeTxt); };
        row.appendChild(btn);
    }

    chatContainer.appendChild(row);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    return row; // Referans döndür (kart eklemek için)
  }

  // --- KARTLARI ÇİZEN FONKSİYON (ÖNERİLER) ---
  function renderCards(cards) {
    const scrollDiv = document.createElement('div');
    scrollDiv.className = 'cards-scroll';
    
    cards.forEach(c => {
        const a = document.createElement('a');
        a.className = 'card';
        a.href = c.url || '#';
        a.target = '_blank';
        
        // Resim (Yoksa ikon)
        if(c.image) {
            const img = document.createElement('img');
            img.src = c.image;
            a.appendChild(img);
        } else {
            const iconDiv = document.createElement('div');
            iconDiv.style.height = '140px';
            iconDiv.style.background = '#f9fafb';
            iconDiv.style.display = 'flex';
            iconDiv.style.alignItems = 'center';
            iconDiv.style.justifyContent = 'center';
            iconDiv.style.borderRadius = '10px';
            iconDiv.style.marginBottom = '10px';
            iconDiv.innerHTML = '<i class="fa-solid fa-shop" style="font-size:30px; color:#ccc;"></i>';
            a.appendChild(iconDiv);
        }

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = c.title || 'Ürün';
        a.appendChild(title);

        const price = document.createElement('div');
        price.className = 'card-price';
        price.textContent = c.subtitle || c.price || '';
        a.appendChild(price);

        const store = document.createElement('div');
        store.className = 'card-store';
        store.textContent = c.footer || 'Satıcı';
        a.appendChild(store);

        scrollDiv.appendChild(a);
    });

    chatContainer.appendChild(scrollDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  async function sendMessage(isAuto = false) {
    let txt = msgInput.value.trim();
    if (isAuto && !txt) txt = "Şu fotoğrafı yorumla.";
    if (!txt && !currentImg) return;

    if (!isAuto && !currentImg) addMessage(txt, 'user');
    
    msgInput.value = '';
    typing.style.display = 'block';
    chatContainer.scrollTop = chatContainer.scrollHeight;

    const payload = {
        message: txt,
        image: currentImg,
        user: { city: 'İstanbul', gender: 'neutral' }
    };

    currentImg = null;
    document.getElementById('fileInput').value = "";

    try {
        const res = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const data = await res.json();
        typing.style.display = 'none';

        addMessage(data.reply || data.assistant_text || "Bir şeyler ters gitti.", 'ai');

        // Eğer ürün kartları varsa çiz
        if (data.data) {
            if(Array.isArray(data.data)) renderCards(data.data);
            else if(data.data.cards) {
                // Tarot gibi özel kartlar (metin olarak bas şimdilik)
                addMessage("Kartlar: " + data.data.cards.join(", "), 'ai');
            }
        }

    } catch (e) {
        typing.style.display = 'none';
        addMessage("Bağlantı koptu evladım.", 'ai');
    }
  }

  async function playVoice(btn, text) {
    if(currentAudio) { 
        currentAudio.pause(); 
        currentAudio = null;
        if(btn) btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle';
        return;
    }
    
    if(btn) btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    
    try {
      const res = await fetch(SPEAK_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
      });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      currentAudio = new Audio(url);
      
      currentAudio.onended = () => { if(btn) btn.innerHTML = '<i class="fa-solid fa-volume-high"></i> Dinle'; };
      await currentAudio.play();
      
      if(btn) btn.innerHTML = '<i class="fa-solid fa-stop"></i> Durdur';

    } catch(e) {
      if(btn) btn.innerHTML = 'Hata';
    }
  }

  // Enter Key
  msgInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") sendMessage();
  });

</script>

</body>
</html>
