<script type="module">
  import { initPartials } from './js/partials.js';
  import { initNotif } from './js/notif.js';

  import { initAuth, handleLogin, logout, acceptTerms } from './js/auth.js';
  import { addUserBubble } from './js/chat.js';
  import { BASE_DOMAIN, STORAGE_KEY } from './js/config.js';
  import { openFalPanel, closeFalPanel, handleFalPhoto } from './js/fal.js';

  // --- HAFIZA (HISTORY) YÃ–NETÄ°MÄ° ---
  let chatHistory = []; 

  // --- YARDIMCI FONKSÄ°YONLAR ---
  function firstNameOnly(fullname="") {
    const s = (fullname || "").trim();
    if(!s) return "";
    return s.split(/\s+/)[0]; 
  }

  function getProfileMeta(){
    try{ return JSON.parse(localStorage.getItem("caynana_profile_v2") || "{}"); }catch(e){ return {}; }
  }

  function getCaynanaWho(user, profile){
    const hitap = (profile?.hitap || "").trim();
    if(hitap) return hitap;
    const n = firstNameOnly(user?.fullname || user?.name || "");
    if(n) return n;
    return "EvladÄ±m";
  }

  function iconFor(type){
    if(type==="match") return "âš½";
    if(type==="horoscope") return "â™ˆ";
    if(type==="diet") return "ðŸ¥—";
    if(type==="spouse_bday") return "ðŸŽ‚";
    if(type==="child_bday") return "ðŸ§’";
    if(type==="wedding") return "ðŸ’";
    if(type==="period_check") return "ðŸŒ™";
    return "ðŸ””";
  }

  function timeLabel(daysLeft){
    if(daysLeft === 0) return "BugÃ¼n";
    if(daysLeft === 1) return "YarÄ±n";
    if(daysLeft > 1) return daysLeft + " gÃ¼n kaldÄ±";
    return "";
  }
  
  function escapeHtml(s=""){ 
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); 
  }

  // --- BÄ°LDÄ°RÄ°MLER ---
  async function fetchNotificationsToday(){
    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if(!user?.id) return [];
    try{
      const res = await fetch(`${BASE_DOMAIN}/api/reminders/today?user_id=${encodeURIComponent(user.id)}`);
      const data = await res.json();
      return data?.items || [];
    }catch(e){ return []; }
  }

  async function refreshNotifications(){
    const items = await fetchNotificationsToday();
    const badge = document.getElementById("notifBadge");
    const list = document.getElementById("notifList");
    if(!list) return;

    if (badge) badge.style.display = items.length ? "block" : "none";

    if(!items.length){
      list.innerHTML = `
        <div class="notif-item">
          <div class="notif-icon">ðŸ§¿</div>
          <div class="notif-content">
            <div class="notif-title">BugÃ¼n sakin</div>
            <div class="notif-desc">EvladÄ±m bugÃ¼n hatÄ±rlatmam yok. Ben yine buradayÄ±m.</div>
            <div class="notif-time">â€”</div>
          </div>
        </div>`;
      return;
    }

    list.innerHTML = items.map(it => {
      const clickable = it.action_url ? "cursor:pointer;" : "";
      const onclick = it.action_url ? `location.href='${it.action_url}'` : "";
      return `
        <div class="notif-item" style="${clickable}" onclick="${onclick}">
          <div class="notif-icon">${iconFor(it.type)}</div>
          <div class="notif-content">
            <div class="notif-title">${escapeHtml(it.title || "")}</div>
            <div class="notif-desc">${escapeHtml(it.message || "")}</div>
            <div class="notif-time">${timeLabel(it.days_left)}</div>
          </div>
        </div>`;
    }).join("");
  }

  // --- APP GÄ°RÄ°Åž ---
  window.enterApp = function () {
    document.getElementById('loginOverlay')?.classList.remove('active');
    window.hideTermsOverlay?.();

    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const profile = getProfileMeta();
    const who = getCaynanaWho(user, profile);
    const bot = profile?.bot_name || user?.bot_name || user?.botName || "Caynana";

    setTimeout(() => {
      window.typeWriter(`HoÅŸ geldin ${who}. Ben ${bot}.`);
      chatHistory.push({ role: "assistant", content: `HoÅŸ geldin ${who}. Ben ${bot}.` });
    }, 400);

    refreshNotifications();
  };

  // --- GLOBAL EXPORTS ---
  window.handleLogin = handleLogin;
  window.logout = logout;
  window.openFal = openFalPanel;
  window.closeFal = closeFalPanel;
  window.handleFalFile = (input) => handleFalPhoto(input);

  window.showTermsOverlay = function(){ document.getElementById("termsOverlay").classList.add("active"); };
  window.hideTermsOverlay = function(){ document.getElementById("termsOverlay").classList.remove("active"); };
  window.acceptTermsAndEnter = async function(){
    const cb = document.getElementById("termsCheck");
    if(!cb || !cb.checked){ alert("Onay kutusunu iÅŸaretle evladÄ±m."); return; }
    const ok = await acceptTerms();
    if(ok) window.enterApp();
    else alert("Onay kaydedilemedi evladÄ±m.");
  };

  // --- KAMERA & MÄ°KROFON & SES ---
  let isTracking = false;
  window.toggleCam = function() {
    const frame = document.getElementById('mobileFrame');
    const camBtn = document.getElementById('camBtn');
    if(frame.classList.contains('tracking-active')) {
      frame.classList.remove('tracking-active');
      camBtn.classList.remove('active');
      isTracking = false;
    } else {
      frame.classList.add('tracking-active');
      camBtn.classList.add('active');
      isTracking = true;
      wakeUp();
    }
  };

  window.startDictation = function() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.lang = "tr-TR";
      recognition.start();
      recognition.onresult = function(e) {
        document.getElementById('msgInput').value = e.results[0][0].transcript;
        recognition.stop();
        sendMessage();
      };
    } else {
      alert("Ses desteÄŸi yok evladÄ±m.");
    }
  };

  async function playVoice(text) {
    try {
      const res = await fetch(`${BASE_DOMAIN}/api/speech`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      const data = await res.json();
      if(data.audio_data) {
        const audio = new Audio("data:audio/mp3;base64," + data.audio_data);
        audio.play();
      }
    } catch(e) { console.error("Ses hatasÄ±:", e); }
  }

  // --- MENÃœ ---
  const menuOverlay = document.getElementById('menuOverlay');
  window.toggleMenu = function() {
    if(menuOverlay.classList.contains('open')) menuOverlay.classList.remove('open');
    else menuOverlay.classList.add('open');
  };
  window.toggleNotif = function() {
    document.getElementById('notifDropdown').classList.toggle('show');
  };

  // --- CHAT VE TYPEWRITER ---
  window.typeWriter = function(text, elementId = 'chat') {
    const chatDiv = document.getElementById(elementId);
    if(!chatDiv) return;
    const brandWrapper = document.getElementById('brandWrapper');
    brandWrapper.classList.add('talking');

    const bubbleRow = document.createElement("div");
    bubbleRow.className = "bubble bot";
    chatDiv.appendChild(bubbleRow);

    let i = 0; const speed = 20;
    function type() {
      if (i < text.length) {
        bubbleRow.textContent += text.charAt(i);
        i++;
        chatDiv.scrollTop = chatDiv.scrollHeight;
        setTimeout(type, speed);
      } else {
        brandWrapper.classList.remove('talking');
      }
    }
    type();
  };

  // --- MESAJ GÃ–NDERME (HAFIZALI) ---
  async function sendMessage() {
    const inputEl = document.getElementById('msgInput');
    const txt = inputEl.value.trim();
    if(!txt) return;

    addUserBubble(txt);
    inputEl.value = '';
    inputEl.blur();

    chatHistory.push({ role: "user", content: txt });
    if(chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

    const brandWrapper = document.getElementById('brandWrapper');
    brandWrapper.classList.add('thinking');

    try {
      const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      
      const response = await fetch(`${BASE_DOMAIN}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
              text: txt,
              user_id: user.id || "guest",
              history: chatHistory
          })
      });

      const data = await response.json();
      brandWrapper.classList.remove('thinking');

      if(data && data.text) {
        window.typeWriter(data.text);
        chatHistory.push({ role: "assistant", content: data.text });
        await playVoice(data.text);
      }
    } catch(e) {
      console.error("Chat Error:", e);
      brandWrapper.classList.remove('thinking');
      window.typeWriter("EvladÄ±m tansiyonum dÃ¼ÅŸtÃ¼, internetine bir bakÄ±ver.");
    }
  }

  // --- EVENT LISTENERS ---
  const sendBtn = document.getElementById('sendBtn');
  if(sendBtn) sendBtn.addEventListener('click', sendMessage);
  const msgInput = document.getElementById('msgInput');
  if(msgInput) msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
  
  const hambBtn = document.getElementById('hambBtn');
  if(hambBtn) hambBtn.addEventListener('click', () => window.toggleMenu());
  if(menuOverlay) menuOverlay.addEventListener('click', (e) => { if(e.target === menuOverlay) window.toggleMenu(); });

  // --- GÃ–Z TAKÄ°P ---
  let isMouseActive = false; let sleepTimer = null; let gazeTimer = null;
  const SLEEP_DELAY = 30000; const GAZE_DELAY = 2000; const AUTO_LOOK_FREQ = 5000;
  const eyeL = document.getElementById('eyeL'), eyeR = document.getElementById('eyeR'), frame = document.getElementById('mobileFrame');

  window.addEventListener('pointermove', (e) => {
    if(!isTracking || frame.classList.contains('sleeping')) { if(frame.classList.contains('sleeping')) wakeUp(); }
    resetIdle(); isMouseActive = true; clearTimeout(gazeTimer);
    const rect = frame.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    const y = ((e.clientY - rect.top) / rect.height) * 2 - 1;
    setGaze(x, y);
    gazeTimer = setTimeout(() => { isMouseActive = false; centerEyes(); }, GAZE_DELAY);
  });

  function resetIdle() { clearTimeout(sleepTimer); sleepTimer = setTimeout(goSleep, SLEEP_DELAY); }
  function goSleep() { if(frame.classList.contains('sleeping')) return; frame.classList.add('sleeping'); setLids(100, 100); }
  function wakeUp() { frame.classList.remove('sleeping'); setLids(0, 0); resetIdle(); }
  function centerEyes() { setGaze(0, 0); }
  function autoLookBehavior() {
    if (isMouseActive || frame.classList.contains('sleeping') || !isTracking) return;
    const rX = (Math.random() - 0.5) * 0.8; const rY = (Math.random() - 0.5) * 0.5;
    setGaze(rX, rY); setTimeout(() => setGaze(0, 0), 1000);
  }
  function setGaze(x, y) {
    const gx = Math.min(Math.max(x * 20, -20), 20); const gy = Math.min(Math.max(y * 15, -15), 15);
    [eyeL, eyeR].forEach(e => { e.style.setProperty('--gx', gx+'px'); e.style.setProperty('--gy', gy+'px'); });
  }
  function setLids(top, bot=0) { [eyeL, eyeR].forEach(e => { e.style.setProperty('--lidTop', top+'%'); e.style.setProperty('--lidBot', bot+'%'); }); }

  const openTrackBtn = document.getElementById('openTrackBtn');
  if(openTrackBtn) openTrackBtn.addEventListener('click', ()=>{ isTracking=true; frame.classList.add('tracking-active'); wakeUp(); });
  const closeTrackBtn = document.getElementById('closeTrackBtn');
  if(closeTrackBtn) closeTrackBtn.addEventListener('click', ()=>{ isTracking=false; frame.classList.remove('tracking-active'); });

  // --- ONLOAD & INIT ---
  window.onload = async function() {
    if(typeof initAuth === 'function') initAuth();

    await initPartials();                // âœ… menu+notif partial load
    initNotif({ baseUrl: BASE_DOMAIN }); // âœ… /api/reminders/today

    // !!! GOOGLE GÄ°RÄ°Åž DÃœZELTMESÄ° !!!
    const googleBtn = document.getElementById('googleLoginBtn') || document.querySelector('.google-login-btn');
    if (googleBtn) {
        googleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            handleLogin('google');
        });
        console.log("Google Login butonu JavaScript ile baÄŸlandÄ±.");
    }

    const user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if(user && user.isSessionActive && user.email) {
       if(!user.terms_accepted_at) window.showTermsOverlay();
       else window.enterApp();
    }
    
    // History demo temizleme
    const historyListEl = document.getElementById('historyList');
    if(historyListEl) {
        historyListEl.innerHTML = ""; 
    }

    setInterval(autoLookBehavior, AUTO_LOOK_FREQ);
    resetIdle();
    
    refreshNotifications();
    setInterval(refreshNotifications, 60000);
  };
</script>
