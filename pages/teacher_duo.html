<!-- FILE: /pages/teacher_duo.html -->
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Duo Practice</title>
  <link rel="icon" href="data:,"/>

  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;height:100dvh;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial}
    body{background:#070812;color:#fff}

    .wrap{width:100%;max-width:480px;height:100%;margin:0 auto;position:relative}

    .back{
      position:absolute;top:12px;left:12px;z-index:30;
      width:46px;height:46px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);color:#fff;
      font-size:22px;font-weight:1000;
      display:flex;align-items:center;justify-content:center;
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      user-select:none; cursor:pointer;
    }
    .back:active{transform:translateY(1px)}

    .pill{
      position:absolute; top:12px; right:12px; z-index:30;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);
      font-weight:950;
      font-size:12px;
      backdrop-filter: blur(10px);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      max-width:62vw;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      user-select:none;
    }

    .grid{
      position:absolute; inset:0;
      display:grid;
      grid-template-rows: 1fr 86px 1fr;
      gap:10px;
      padding:70px 12px 14px;
    }

    .pane{
      border-radius:26px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow:0 28px 90px rgba(0,0,0,.6);
      backdrop-filter: blur(10px);
      position:relative;
    }

    /* √úST: √ñƒürenci B (ters) */
    .top{
      background:
        radial-gradient(900px 360px at 20% 0%, rgba(40,120,255,.22), transparent 62%),
        rgba(0,0,0,.18);
      transform: rotate(180deg);
    }

    /* ALT: √ñƒürenci A (d√ºz, sana bakan) */
    .bottom{
      background:
        radial-gradient(900px 360px at 20% 0%, rgba(120,20,35,.72), transparent 64%),
        rgba(0,0,0,.18);
    }

    .bar{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center;
      background:rgba(0,0,0,.18);
      font-weight:1000;
      gap:10px;
    }
    .name{opacity:.95; font-weight:1000}
    .score{opacity:.85; font-weight:1000}

    .progressWrap{
      padding: 10px 12px 0;
    }
    .progress{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(190,242,100,.95), rgba(255,179,0,.85));
      transition: width .25s ease;
    }
    .pmeta{
      margin-top:8px;
      font-size:12px;
      font-weight:950;
      opacity:.78;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .body{padding:16px;display:flex;flex-direction:column;gap:10px}
    .word{font-size:30px;font-weight:1000;letter-spacing:.2px}
    .meaning{
      font-weight:950;
      font-size:14px;
      opacity:.90;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .meaning .tag{
      font-size:11px;
      font-weight:1000;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      opacity:.9;
    }
    .hint{opacity:.82;font-weight:900;font-size:12px;line-height:1.35}

    .btnrow{
      padding:14px;
      display:flex;
      justify-content:center;
      gap:10px;
    }
    .btn{
      border:none;
      border-radius:18px;
      padding:12px 14px;
      font-weight:1000;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      min-width:160px;
      user-select:none;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.14);
    }
    .btn.primary{
      background:rgba(190,242,100,.16);
      border-color:rgba(190,242,100,.28);
      box-shadow: 0 14px 30px rgba(190,242,100,.10), inset 0 1px 0 rgba(255,255,255,.14);
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;transform:none}

    /* Orta dalga */
    .wave{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.26);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
      box-shadow:0 22px 70px rgba(0,0,0,.55);
    }
    .wave .label{
      font-weight:1000;
      font-size:12px;
      opacity:.86;
      letter-spacing:.2px;
      user-select:none;
    }
    .bars{display:flex;align-items:center;gap:6px;height:34px}
    .barw{
      width:6px;height:10px;border-radius:99px;
      background: rgba(255,255,255,.22);
      transform-origin:center;
    }

    .wave.teaching .barw{
      background: rgba(190,242,100,.75);
      box-shadow: 0 0 18px rgba(190,242,100,.18);
      animation: w 650ms ease-in-out infinite;
    }
    .wave.teaching .barw:nth-child(2){animation-delay:.06s}
    .wave.teaching .barw:nth-child(3){animation-delay:.12s}
    .wave.teaching .barw:nth-child(4){animation-delay:.18s}
    .wave.teaching .barw:nth-child(5){animation-delay:.24s}
    .wave.teaching .barw:nth-child(6){animation-delay:.30s}
    .wave.teaching .barw:nth-child(7){animation-delay:.36s}

    .wave.listening .barw{
      background: rgba(190,242,100,.55);
      animation: w 560ms ease-in-out infinite;
    }

    @keyframes w{
      0%{ height:10px; opacity:.55 }
      45%{ height:34px; opacity:1 }
      100%{ height:12px; opacity:.65 }
    }

    /* ‚úÖ Paneli kaplayan OK/X overlay (sadece o taraf) */
    .panel-overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:25;
      font-weight:1000;
      text-align:center;
      user-select:none;
      backdrop-filter: blur(4px);
    }
    .panel-overlay.show{ display:flex; }
    .panel-overlay.ok{
      background: radial-gradient(900px 520px at 50% 30%, rgba(190,242,100,.40), rgba(0,0,0,.78));
    }
    .panel-overlay.bad{
      background: radial-gradient(900px 520px at 50% 30%, rgba(255,82,82,.40), rgba(0,0,0,.82));
    }
    .panel-overlay .big{
      font-size:92px;
      line-height:1;
      text-shadow: 0 20px 80px rgba(0,0,0,.65);
    }
    .panel-overlay .sub{
      margin-top:14px;
      font-size:14px;
      font-weight:950;
      opacity:.92;
      padding:10px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.28);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      max-width: 80%;
    }

    /* Final modal */
    .modal{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .modal.show{display:flex}
    .card{
      width: min(420px, 92vw);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,10,12,.88);
      box-shadow: 0 30px 90px rgba(0,0,0,.7);
      padding: 14px;
    }
    .card .h{
      font-weight:1000;
      font-size:14px;
      margin-bottom:10px;
    }
    .card .line{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight:950;
      margin-bottom:10px;
    }
    .card .btns{display:flex;gap:10px}
    .card button{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .card button.primary{
      background: rgba(190,242,100,.16);
      border-color: rgba(190,242,100,.28);
      color:#fff;
    }
    .card button:active{transform:translateY(1px)}
  </style>
</head>

<body>
<div class="wrap">
  <button class="back" id="backBtn">‚Üê</button>
  <div class="pill" id="langPill">üÜö Duo Practice</div>

  <div class="grid">

    <!-- √úST: √ñƒürenci B (ters) -->
    <section class="pane top" id="paneB">
      <div class="bar">
        <div class="name" id="nameB">√ñƒürenci B (Student B)</div>
        <div class="score" id="scoreB">Set: 0</div>
      </div>

      <div class="progressWrap">
        <div class="progress"><div id="fillB"></div></div>
        <div class="pmeta"><span id="corrB">Doƒüru: 0/20</span><span id="turnB">‚Äî</span></div>
      </div>

      <div class="body">
        <div class="word" id="wordB">‚Äî</div>
        <div class="meaning"><span class="tag">T√ºrk√ße</span> <span id="meaningB">‚Äî</span></div>
        <div class="hint" id="hintB">Sƒ±ra sende deƒüil.</div>
      </div>
      <div class="btnrow">
        <button class="btn primary" id="micB">S√∂yle</button>
      </div>

      <div class="panel-overlay" id="overlayB">
        <div>
          <div class="big" id="overlayIcoB">‚úÖ</div>
          <div class="sub" id="overlayTxtB">Great!</div>
        </div>
      </div>
    </section>

    <!-- ORTA: Ses dalgasƒ± -->
    <div class="wave" id="waveBox">
      <div class="label" id="waveLabel">√ñƒüretmen okuyor‚Ä¶</div>
      <div class="bars" aria-hidden="true">
        <div class="barw"></div><div class="barw"></div><div class="barw"></div><div class="barw"></div>
        <div class="barw"></div><div class="barw"></div><div class="barw"></div>
      </div>
    </div>

    <!-- ALT: √ñƒürenci A (d√ºz) -->
    <section class="pane bottom" id="paneA">
      <div class="bar">
        <div class="name" id="nameA">√ñƒürenci A (Student A)</div>
        <div class="score" id="scoreA">Set: 0</div>
      </div>

      <div class="progressWrap">
        <div class="progress"><div id="fillA"></div></div>
        <div class="pmeta"><span id="corrA">Doƒüru: 0/20</span><span id="turnA">‚Äî</span></div>
      </div>

      <div class="body">
        <div class="word" id="wordA">‚Äî</div>
        <div class="meaning"><span class="tag">T√ºrk√ße</span> <span id="meaningA">‚Äî</span></div>
        <div class="hint" id="hintA">Sƒ±ran sende. Tek hak.</div>
      </div>
      <div class="btnrow">
        <button class="btn primary" id="micA">S√∂yle</button>
      </div>

      <div class="panel-overlay" id="overlayA">
        <div>
          <div class="big" id="overlayIcoA">‚úÖ</div>
          <div class="sub" id="overlayTxtA">Great!</div>
        </div>
      </div>
    </section>

  </div>

  <!-- Final modal -->
  <div class="modal" id="finalModal">
    <div class="card">
      <div class="h">20 kelime bitti. Yeni a≈üamaya ge√ßilsin mi?</div>
      <div class="line"><span>√ñƒürenci A</span><span id="finalA">Set: 0</span></div>
      <div class="line"><span>√ñƒürenci B</span><span id="finalB">Set: 0</span></div>
      <div class="btns">
        <button class="primary" id="yesBtn">Yes</button>
        <button id="noBtn">No</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG + WORD BANK
   ========================= */
function getLang(){
  const u = new URL(location.href);
  const q = (u.searchParams.get("lang") || "en").toLowerCase().trim();
  return ["en","de","fr","it"].includes(q) ? q : "en";
}
const lang = getLang();

const LOCALES = { en:"en-US", de:"de-DE", fr:"fr-FR", it:"it-IT" };
const LANG_LABEL = { en:"üá¨üáß Duo Practice", de:"üá©üá™ Duo Practice", fr:"üá´üá∑ Duo Practice", it:"üáÆüáπ Duo Practice" };

const WORDS = {
  en: [
    { t:"apple", tr:"elma" }, { t:"water", tr:"su" }, { t:"bread", tr:"ekmek" }, { t:"menu", tr:"men√º" }, { t:"price", tr:"fiyat" },
    { t:"yes", tr:"evet" }, { t:"no", tr:"hayƒ±r" }, { t:"hello", tr:"merhaba" }, { t:"goodbye", tr:"g√ºle g√ºle" }, { t:"thank you", tr:"te≈üekk√ºrler" },
    { t:"please", tr:"l√ºtfen" }, { t:"help", tr:"yardƒ±m" }, { t:"toilet", tr:"tuvalet" }, { t:"the bill", tr:"hesap" }, { t:"hot", tr:"sƒ±cak" },
    { t:"cold", tr:"soƒüuk" }, { t:"today", tr:"bug√ºn" }, { t:"excuse me", tr:"affedersiniz" }, { t:"very good", tr:"√ßok g√ºzel" }, { t:"i don't understand", tr:"anlamƒ±yorum" }
  ],
  de: [
    { t:"apfel", tr:"elma" }, { t:"wasser", tr:"su" }, { t:"brot", tr:"ekmek" }, { t:"speisekarte", tr:"men√º" }, { t:"preis", tr:"fiyat" },
    { t:"ja", tr:"evet" }, { t:"nein", tr:"hayƒ±r" }, { t:"hallo", tr:"merhaba" }, { t:"tsch√ºss", tr:"g√ºle g√ºle" }, { t:"danke", tr:"te≈üekk√ºrler" },
    { t:"bitte", tr:"l√ºtfen" }, { t:"hilfe", tr:"yardƒ±m" }, { t:"toilette", tr:"tuvalet" }, { t:"die rechnung", tr:"hesap" }, { t:"hei√ü", tr:"sƒ±cak" },
    { t:"kalt", tr:"soƒüuk" }, { t:"heute", tr:"bug√ºn" }, { t:"entschuldigung", tr:"affedersiniz" }, { t:"sehr gut", tr:"√ßok g√ºzel" }, { t:"ich verstehe nicht", tr:"anlamƒ±yorum" }
  ],
  fr: [
    { t:"pomme", tr:"elma" }, { t:"eau", tr:"su" }, { t:"pain", tr:"ekmek" }, { t:"menu", tr:"men√º" }, { t:"prix", tr:"fiyat" },
    { t:"oui", tr:"evet" }, { t:"non", tr:"hayƒ±r" }, { t:"bonjour", tr:"merhaba" }, { t:"au revoir", tr:"g√ºle g√ºle" }, { t:"merci", tr:"te≈üekk√ºrler" },
    { t:"s'il vous pla√Æt", tr:"l√ºtfen" }, { t:"aide", tr:"yardƒ±m" }, { t:"toilettes", tr:"tuvalet" }, { t:"l'addition", tr:"hesap" }, { t:"chaud", tr:"sƒ±cak" },
    { t:"froid", tr:"soƒüuk" }, { t:"aujourd'hui", tr:"bug√ºn" }, { t:"excusez-moi", tr:"affedersiniz" }, { t:"tr√®s bien", tr:"√ßok g√ºzel" }, { t:"je ne comprends pas", tr:"anlamƒ±yorum" }
  ],
  it: [
    { t:"mela", tr:"elma" }, { t:"acqua", tr:"su" }, { t:"pane", tr:"ekmek" }, { t:"menu", tr:"men√º" }, { t:"prezzo", tr:"fiyat" },
    { t:"s√¨", tr:"evet" }, { t:"no", tr:"hayƒ±r" }, { t:"ciao", tr:"merhaba" }, { t:"arrivederci", tr:"g√ºle g√ºle" }, { t:"grazie", tr:"te≈üekk√ºrler" },
    { t:"per favore", tr:"l√ºtfen" }, { t:"aiuto", tr:"yardƒ±m" }, { t:"bagno", tr:"tuvalet" }, { t:"il conto", tr:"hesap" }, { t:"caldo", tr:"sƒ±cak" },
    { t:"freddo", tr:"soƒüuk" }, { t:"oggi", tr:"bug√ºn" }, { t:"scusi", tr:"affedersiniz" }, { t:"molto bene", tr:"√ßok g√ºzel" }, { t:"non capisco", tr:"anlamƒ±yorum" }
  ],
};

document.getElementById("langPill").textContent = LANG_LABEL[lang] || "üÜö Duo Practice";

/* =========================
   UTIL
   ========================= */
function norm(s){
  return String(s||"").toLowerCase().trim().replace(/[‚Äô']/g,"'").replace(/[.,!?;:]/g,"").replace(/\s+/g," ");
}
function similarity(a,b){
  a=norm(a); b=norm(b);
  if(!a || !b) return 0;
  if(a===b) return 1;
  const m=a.length,n=b.length;
  const dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++)dp[i][0]=i;
  for(let j=0;j<=n;j++)dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const c=a[i-1]===b[j-1]?0:1;
      dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);
    }
  }
  return 1-dp[m][n]/Math.max(m,n);
}

/* =========================
   WAVE
   ========================= */
function setWaveMode(mode){
  const w = document.getElementById("waveBox");
  w.classList.remove("teaching","listening");
  if(mode) w.classList.add(mode);
}
function setWaveLabel(txt){
  document.getElementById("waveLabel").textContent = txt;
}
function setButtonsEnabled(enabled){
  document.getElementById("micA").disabled = !enabled;
  document.getElementById("micB").disabled = !enabled;
}

/* =========================
   SFX (MP3 with fallback beep)
   ========================= */
let okAudio=null, badAudio=null;
try{
  okAudio = new Audio("/assets/sfx/ok.mp3");
  badAudio = new Audio("/assets/sfx/bad.mp3");
  okAudio.preload="auto"; badAudio.preload="auto";
  okAudio.volume=.9; badAudio.volume=.9;
}catch{}

let __ctx=null;
function ensureCtx(){
  const AC = window.AudioContext || window.webkitAudioContext;
  if(!AC) return null;
  if(!__ctx) __ctx = new AC();
  return __ctx;
}
function playTone(freq, durMs, type="sine", gain=0.06){
  const ctx = ensureCtx();
  if(!ctx) return;
  try{
    if(ctx.state==="suspended") ctx.resume().catch(()=>{});
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.type=type; o.frequency.value=freq;
    g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{try{o.stop()}catch{}}, durMs);
  }catch{}
}
function beepOk(){ playTone(880,90,"sine",0.07); setTimeout(()=>playTone(1320,120,"sine",0.06),110); }
function beepBad(){ playTone(180,120,"square",0.05); setTimeout(()=>playTone(140,140,"square",0.05),140); }

async function sfxOK(){
  if(okAudio){
    try{ okAudio.currentTime=0; await okAudio.play(); return; }catch{}
  }
  beepOk();
}
async function sfxBAD(){
  if(badAudio){
    try{ badAudio.currentTime=0; await badAudio.play(); return; }catch{}
  }
  beepBad();
}

// unlock
document.addEventListener("pointerdown", ()=>{
  try{ okAudio && okAudio.play().then(()=>{okAudio.pause();okAudio.currentTime=0}).catch(()=>{}); }catch{}
  try{ badAudio && badAudio.play().then(()=>{badAudio.pause();badAudio.currentTime=0}).catch(()=>{}); }catch{}
},{once:true});

/* =========================
   OVERLAY per side
   ========================= */
function showOverlay(side, ok, msg){
  const ov = document.getElementById(side==="A" ? "overlayA" : "overlayB");
  const ico = document.getElementById(side==="A" ? "overlayIcoA" : "overlayIcoB");
  const txt = document.getElementById(side==="A" ? "overlayTxtA" : "overlayTxtB");
  ov.classList.remove("ok","bad","show");
  ov.classList.add(ok ? "ok" : "bad");
  ico.textContent = ok ? "‚úÖ" : "‚ùå";
  txt.textContent = msg;
  ov.classList.add("show");
  clearTimeout(ov.__t);
  ov.__t=setTimeout(()=>ov.classList.remove("show"), 2000);
}

/* =========================
   SPEECH
   ========================= */
function makeRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR) return null;
  const r = new SR();
  r.lang = LOCALES[lang] || "en-US";
  r.interimResults = false;
  r.continuous = false;
  return r;
}
function teacherSpeak(text){
  return new Promise((resolve)=>{
    if(!("speechSynthesis" in window)){ resolve(false); return; }
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(String(text||""));
      u.lang = LOCALES[lang] || "en-US";
      u.rate = 0.95;
      u.pitch = 1.0;
      u.onend = ()=> resolve(true);
      u.onerror = ()=> resolve(false);
      window.speechSynthesis.speak(u);
    }catch{ resolve(false); }
  });
}

/* =========================
   GAME STATE
   ========================= */
const pool = (WORDS[lang] || WORDS.en).slice();
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
let stageWords = shuffle(pool).slice(0,20);
let wordIndex = 0;

let turn = "A"; // A starts (near)
let busy = false;

let correctA = 0, correctB = 0;      // correct count in this 20-word game
let setA = 0, setB = 0;              // winner set score (1/0/0)
let stageNo = 1;

function updateBars(){
  document.getElementById("fillA").style.width = `${(correctA/20)*100}%`;
  document.getElementById("fillB").style.width = `${(correctB/20)*100}%`;
  document.getElementById("corrA").textContent = `Doƒüru: ${correctA}/20`;
  document.getElementById("corrB").textContent = `Doƒüru: ${correctB}/20`;

  document.getElementById("scoreA").textContent = `Set: ${setA}`;
  document.getElementById("scoreB").textContent = `Set: ${setB}`;

  document.getElementById("turnA").textContent = (turn==="A") ? "Sƒ±ra sende" : "‚Äî";
  document.getElementById("turnB").textContent = (turn==="B") ? "Sƒ±ra sende" : "‚Äî";
}

function setHints(){
  document.getElementById("hintA").textContent = (turn==="A")
    ? `Sƒ±ran sende. Tek hak. (${wordIndex+1}/20)`
    : "Sƒ±ra kar≈üƒ± tarafta.";

  document.getElementById("hintB").textContent = (turn==="B")
    ? `Sƒ±ran sende. Tek hak. (${wordIndex+1}/20)`
    : "Sƒ±ra kar≈üƒ± tarafta.";
}

function renderWord(){
  const w = stageWords[wordIndex];
  document.getElementById("wordA").textContent = w.t;
  document.getElementById("wordB").textContent = w.t;
  document.getElementById("meaningA").textContent = w.tr;
  document.getElementById("meaningB").textContent = w.tr;
}

async function teacherPhase(){
  setButtonsEnabled(false);
  setWaveLabel("√ñƒüretmen okuyor‚Ä¶");
  setWaveMode("teaching");
  await teacherSpeak(stageWords[wordIndex].t);
  setWaveMode(null);
  setWaveLabel(turn==="A" ? "Sƒ±ra √ñƒürenci A" : "Sƒ±ra √ñƒürenci B");
  setButtonsEnabled(true);
}

function funnyWrong(){
  const pool = [
    "Wrong üòÖ",
    "Nope! üö´",
    "That was‚Ä¶ creative üòÑ",
    "Teacher says: try harder üëÄ",
    "Almost‚Ä¶ but not today!"
  ];
  return pool[Math.floor(Math.random()*pool.length)];
}

async function endGame(){
  // decide set (winner)
  if(correctA > correctB){ setA = 1; setB = 0; }
  else if(correctB > correctA){ setA = 0; setB = 1; }
  else { setA = 0; setB = 0; }

  updateBars();

  // show modal
  document.getElementById("finalA").textContent = `Set: ${setA}`;
  document.getElementById("finalB").textContent = `Set: ${setB}`;
  document.getElementById("finalModal").classList.add("show");
}

async function nextWord(){
  wordIndex++;
  if(wordIndex >= 20){
    await endGame();
    return;
  }
  // next word, A starts again (sen istersen sƒ±rayƒ± devam ettirebiliriz)
  turn = "A";
  updateBars();
  setHints();
  renderWord();
  await teacherPhase();
}

async function handleResult(player, ok){
  // show overlay 2s and wait
  if(ok){
    await sfxOK();
    showOverlay(player, true, "Nice! ‚úÖ");
    if(player==="A") correctA++; else correctB++;
  }else{
    await sfxBAD();
    showOverlay(player, false, funnyWrong());
  }

  updateBars();

  // wait 2s before any move
  await new Promise(r=>setTimeout(r, 2000));

  // rule:
  // - if correct => next word immediately
  // - if wrong AND player was A => teacher repeats once, then B attempts same word
  // - if wrong AND player was B => next word
  if(ok){
    await nextWord();
  }else{
    if(player === "A"){
      // teacher repeats once before B
      turn = "B";
      setHints();
      setWaveLabel("√ñƒüretmen tekrar okuyor‚Ä¶");
      setWaveMode("teaching");
      await teacherSpeak(stageWords[wordIndex].t);
      setWaveMode(null);
      setWaveLabel("Sƒ±ra √ñƒürenci B");
      updateBars();
      setButtonsEnabled(true);
    }else{
      // B wrong -> next word
      await nextWord();
    }
  }
}

function listenFor(player){
  if(busy) return;
  if(player !== turn){
    toast("Sƒ±ra sende deƒüil.");
    return;
  }

  const rec = makeRec();
  if(!rec){
    alert("Bu cihaz konu≈ümayƒ± yazƒ±ya √ßevirmiyor.");
    return;
  }

  busy = true;
  setButtonsEnabled(false);
  setWaveLabel("Dinliyorum‚Ä¶");
  setWaveMode("listening");

  rec.onresult = async (e)=>{
    const said = e.results?.[0]?.[0]?.transcript || "";
    const expected = stageWords[wordIndex].t;
    const sc = similarity(expected, said);
    const ok = sc >= 0.92;

    setWaveMode(null);
    setWaveLabel("‚Äî");
    busy = false;

    // restore buttons depending on next state inside handleResult
    setButtonsEnabled(true);

    await handleResult(player, ok);
  };

  rec.onerror = async ()=>{
    setWaveMode(null);
    setWaveLabel("‚Äî");
    busy = false;
    setButtonsEnabled(true);
    await handleResult(player, false);
  };

  try{ rec.start(); }
  catch{
    setWaveMode(null);
    setWaveLabel("‚Äî");
    busy = false;
    setButtonsEnabled(true);
    toast("Mikrofon a√ßƒ±lamadƒ±.");
  }
}

/* =========================
   Modal actions
   ========================= */
document.getElementById("yesBtn").addEventListener("click", async ()=>{
  document.getElementById("finalModal").classList.remove("show");

  // new stage
  stageNo++;
  // reshuffle & new 20
  stageWords = shuffle((WORDS[lang]||WORDS.en).slice()).slice(0,20);
  wordIndex = 0;
  correctA = 0; correctB = 0;
  // keep set scores as last set; if you want cumulative, say and I'll change
  // For now set scores stay as last match result.
  turn = "A";
  updateBars();
  setHints();
  renderWord();
  await teacherPhase();
});

document.getElementById("noBtn").addEventListener("click", ()=>{
  document.getElementById("finalModal").classList.remove("show");
  alert("Tamam evladƒ±m. Duo Practice bitti üòÑ");
});

/* =========================
   Boot
   ========================= */
document.getElementById("backBtn").addEventListener("click", ()=>{
  if(history.length>1) history.back();
  else location.href="/pages/chat.html";
});

document.getElementById("micA").addEventListener("click", ()=> listenFor("A"));
document.getElementById("micB").addEventListener("click", ()=> listenFor("B"));

updateBars();
setHints();
renderWord();
teacherPhase();
</script>

</body>
</html>
