<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Diyet PlanÄ±m</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="/css/style.css?v=1" />

  <style>
    :root{
      --gold:#ffb300;
      --pistachio:#bef264;
      --red:#ff5252;
    }

    .menu-overlay { display:none; pointer-events:none; }
    .menu-overlay.open { display:flex; pointer-events:auto; }

    .diet-wrap{
      padding: 16px;
      padding-bottom: 100px;
      display:flex;
      flex-direction:column;
      gap:16px;
      overflow-y:auto;
      height:100%;
    }

    .card{
      background: linear-gradient(145deg, rgba(30,30,30,0.9), rgba(10,10,10,0.95));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
    }

    #profileSetup{ display:none; }
    #dietDashboard{ display:none; }

    .setup-head{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .setup-ico{
      width:44px; height:44px; border-radius:16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,179,0,.14);
      border:1px solid rgba(255,179,0,.30);
      font-size:22px;
    }
    .setup-title{ font-weight:900; color:#fff; font-size:16px; margin:0; }
    .setup-desc{ margin:8px 0 14px; color: rgba(255,255,255,.70); font-size: 13px; line-height: 1.35; }

    .form-row{ display:flex; gap:10px; }
    .form-group{ flex:1; display:flex; flex-direction:column; gap:6px; }
    .form-label{
      font-size: 11px; font-weight: 900;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-left: 4px;
    }

    .diet-input, .diet-select{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      padding: 12px;
      border-radius: 14px;
      font-size: 14px;
      outline: none;
      width:100%;
    }
    .diet-input:focus, .diet-select:focus{ border-color: rgba(255,179,0,.75); }
    .diet-input:disabled, .diet-select:disabled{ opacity:.6; cursor:not-allowed; }

    .btn-primary{
      width:100%;
      border:none;
      border-radius: 18px;
      padding: 14px 16px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      background: var(--gold);
      color:#111;
      box-shadow: 0 12px 26px rgba(255,179,0,.18);
    }

    .btn-yes{
      width:100%;
      border:none;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      background: var(--pistachio);
      color:#111;
      box-shadow: 0 0 18px rgba(190,242,100,.28);
    }

    .bmi-hero{ display:flex; justify-content:space-between; align-items:center; gap:16px; }
    .bmi-left h2{
      margin:0 0 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .7px;
      color: rgba(255,255,255,.55);
      font-weight: 900;
    }
    .bmi-big{ font-size: 38px; font-weight: 1000; color:#fff; line-height:1; }
    .bmi-status{
      display:inline-block;
      margin-top:8px;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 1000;
      letter-spacing: .7px;
      text-transform: uppercase;
    }
    .bmi-status.ok{ background: rgba(190,242,100,.14); color: var(--pistachio); }
    .bmi-status.warn{ background: rgba(255,179,0,.14); color: var(--gold); }
    .bmi-status.bad{ background: rgba(255,82,82,.14); color: var(--red); }

    .bmi-gauge{ width:70px; height:70px; }
    .bg-circle{ fill:none; stroke:#333; stroke-width:6; }
    .val-circle{
      fill:none; stroke: var(--gold);
      stroke-width:6; stroke-linecap:round;
      stroke-dasharray:175; stroke-dashoffset:175;
      transition: 1s ease;
    }

    .bmi-talk{
      margin-top: 12px;
      color: rgba(255,255,255,.88);
      font-size: 13px;
      line-height: 1.45;
      font-weight: 650;
    }
    .bmi-talk b{ color: #fff; }

    .meal-list{ display:flex; flex-direction:column; gap:12px; margin-top:10px; }
    .meal-card{
      background: rgba(25,25,25,.55);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .meal-icon{
      width:44px; height:44px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      font-size: 20px;
      flex-shrink:0;
    }
    .meal-name{
      font-size:12px; font-weight: 1000;
      color: var(--gold);
      text-transform: uppercase;
      letter-spacing: .6px;
      margin-bottom: 4px;
    }
    .meal-desc{
      font-size:13px;
      color: rgba(255,255,255,.92);
      line-height: 1.35;
      font-weight: 650;
    }
    .meal-meta{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255,255,255,.55);
      font-weight: 800;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .meal-meta span{ display:inline-flex; gap:6px; align-items:center; }
    .meal-meta .cal::before{ content:"ğŸ”¥"; font-size: 10px; }
    .meal-meta .time::before{ content:"ğŸ•’"; font-size: 10px; }

    .diet-notif{
      position: fixed;
      top: 80px; left: 50%;
      transform: translateX(-50%);
      background: rgba(190,242,100,0.95);
      color:#111;
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      box-shadow: 0 10px 30px rgba(0,0,0,.55);
      z-index: 9001;
      display:none;
      animation: slideDown .45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes slideDown { from{ top:-50px; opacity:0 } to{ top:80px; opacity:1 } }

    /* DoÄŸum tarihi 3'lÃ¼ seÃ§im dÃ¼zeni */
    .dob-row{ display:flex; gap:10px; }
  </style>
</head>

<body>
<div class="mobile-frame" id="mobileFrame">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="left-controls">
      <button class="hamb-btn" id="hambBtn">â˜°</button>
    </div>

    <div class="brand-wrapper" id="brandWrapper">
      <div class="logo-area">
        <svg class="seesaw-svg" viewBox="0 0 40 20">
          <g class="seesaw-bar" id="seesawBar">
            <line x1="0" y1="8" x2="40" y2="8" stroke="#ccc" stroke-width="2" stroke-linecap="round" />
            <circle cx="3" cy="5" r="3" fill="#bef264" />
            <circle cx="37" cy="5" r="3" fill="#ffb300" id="orangeBall" />
          </g>
          <polygon points="17,14 23,14 20,8" fill="none" stroke="#666" stroke-width="1.5" />
        </svg>
        <div class="brand-name">Caynana AI</div>
      </div>
      <div class="slogan">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
    </div>

    <div class="right-controls">
      <div class="notif-row">
        <div class="notif-topline">
          <button class="icon-btn-top" id="notifBtn" aria-label="Bildirimler">
            <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            <div class="badge" id="notifBadge"></div>
          </button>
          <div id="planChip" class="plan-chip">FREE</div>
        </div>

        <div class="notification-dropdown" id="notifDropdown">
          <div class="notif-header">Bildirimler</div>
          <div class="notif-list" id="notifList"></div>
        </div>

        <div class="yp-chip">
          <div class="yp-label">SAMÄ°MÄ°YET</div>
          <div class="yp-meter"><div class="yp-fill" id="ypFill"></div></div>
          <div class="yp-num" id="ypNum">19%</div>
        </div>

        <button class="icon-btn-top" id="profileBtn" aria-label="Profil">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- MENU -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-sidebar">
      <button class="new-chat-btn" id="newChatBtn"><span>+</span> YENÄ° SOHBET BAÅLAT</button>

      <div class="profile-shortcut-wrap" id="profileShortcutMount">
        <div class="profile-shortcut-btn" id="profileShortcutBtn">
          <div class="profile-shortcut-ico" id="profileShortcutIco">ğŸ‘¤</div>
          <div class="profile-shortcut-text">
            <div class="profile-shortcut-title">Profil DÃ¼zenle</div>
            <div class="profile-shortcut-sub" id="profileShortcutName">â€”</div>
          </div>
        </div>
      </div>

      <div class="section-title" id="historyTitle">GEÃ‡MÄ°Å SOHBETLER</div>
      <div class="history-list" id="historyList"></div>

      <div class="menu-block asistan">
        <div class="block-head">Asistan</div>
        <div class="menu-grid" id="menuAsistan"></div>
      </div>

      <div class="menu-block astro">
        <div class="block-head">Astro AI</div>
        <div class="menu-grid" id="menuAstro"></div>
      </div>

      <div class="menu-block kurumsal">
        <div class="block-head">Kurumsal</div>
        <div class="menu-grid" id="menuKurumsal"></div>
      </div>

      <div class="menu-footer-actions">
        <a class="action-link" id="logoutBtn">ğŸ›¡ï¸ GÃ¼venli Ã‡Ä±kÄ±ÅŸ</a>
        <a class="action-link delete-acc" id="deleteAccountBtn">ğŸ—‘ï¸ HesabÄ±mÄ± Sil</a>
        <div class="footer-copy">@CaynanaAI By Ozyigit's 2026</div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="diet-wrap">

    <div id="profileSetup" class="card">
      <div class="setup-head">
        <div class="setup-ico">ğŸ“</div>
        <div>
          <div class="setup-title">Diyet iÃ§in birkaÃ§ bilgi</div>
          <div style="font-size:12px; color: rgba(255,255,255,.55); font-weight:800; margin-top:2px;">
            DoÄŸum tarihi & cinsiyet bir kere alÄ±nÄ±r, sonra deÄŸiÅŸmez.
          </div>
        </div>
      </div>

      <div class="setup-desc">
        Boy ve kiloyu gÃ¼ncel tut evladÄ±m. Profilinde doÄŸum tarihi ve cinsiyet varsa burada dokunamayÄ±z.
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Boy (cm)</label>
          <input type="number" id="inpHeight" class="diet-input" placeholder="170" inputmode="numeric" />
        </div>
        <div class="form-group">
          <label class="form-label">Kilo (kg)</label>
          <input type="number" id="inpWeight" class="diet-input" placeholder="70" inputmode="numeric" />
        </div>
      </div>

      <!-- DOB: YÄ±l / Ay / GÃ¼n -->
      <div class="dob-row">
        <div class="form-group">
          <label class="form-label">YÄ±l</label>
          <select id="dobYear" class="diet-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Ay</label>
          <select id="dobMonth" class="diet-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">GÃ¼n</label>
          <select id="dobDay" class="diet-select"></select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1;">
          <label class="form-label">Cinsiyet</label>
          <select id="inpGender" class="diet-select">
            <option value="">SeÃ§</option>
            <option value="Kadin">KadÄ±n</option>
            <option value="Erkek">Erkek</option>
          </select>
        </div>
      </div>

      <button class="btn-primary" id="btnCalc">VÃœCUT ENDEKSÄ°MÄ° HESAPLA</button>
    </div>

    <div id="dietDashboard" class="card">
      <div class="bmi-hero">
        <div class="bmi-left">
          <h2>VÃ¼cut Kitle Ä°ndeksi</h2>
          <div class="bmi-big" id="bmiVal">--</div>
          <div class="bmi-status" id="bmiStatus">â€”</div>
        </div>
        <div class="bmi-gauge">
          <svg width="70" height="70" style="transform:rotate(-90deg)">
            <circle class="bg-circle" cx="35" cy="35" r="30"></circle>
            <circle class="val-circle" cx="35" cy="35" r="30" id="bmiCircle"></circle>
          </svg>
        </div>
      </div>

      <div class="bmi-talk" id="bmiTalk">â€”</div>

      <div style="height:10px"></div>

      <button class="btn-yes" id="btnGenerate">GÃœNLÃœK DÄ°YET MENÃœMÃœ VER</button>

      <div class="meal-list" id="mealList"></div>
    </div>

  </div>

  <div class="diet-notif" id="dietNotif">ğŸ”” BugÃ¼n diyet menÃ¼n geldi, incele evladÄ±m!</div>

  <div class="footer-container">
    <div class="footer-links">
      <a href="/pages/hakkimizda.html">HakkÄ±mÄ±zda</a>
      <a href="/pages/sss.html">SSS</a>
      <a href="/pages/gizlilik.html">Gizlilik</a>
      <a href="/pages/iletisim.html">Ä°letiÅŸim</a>
    </div>
    <div class="footer-brand">@CaynanaAI By Ozyigits 2026</div>
  </div>

</div>

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from "/js/config.js";
  const DIET_API = "/api/diet/today";

  function $(id){ return document.getElementById(id); }
  function safeJson(s){ try{return JSON.parse(s||"{}");}catch{return {};} }
  function todayStr(){ return new Date().toISOString().split("T")[0]; }
  function baseUrl(){ return (BASE_DOMAIN || "").replace(/\/+$/, ""); }

  function getUserLocal(){
    const a = safeJson(localStorage.getItem(STORAGE_KEY));
    if (a && Object.keys(a).length) return a;
    return safeJson(localStorage.getItem("caynana_user_v1"));
  }
  function setUserLocal(obj){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
    localStorage.setItem("caynana_user_v1", JSON.stringify(obj));
  }

  function show(elId){
    $("profileSetup").style.display = "none";
    $("dietDashboard").style.display = "none";
    $(elId).style.display = "block";
  }

  function showNotif(){
    const n = $("dietNotif");
    n.style.display = "block";
    setTimeout(()=> n.style.display="none", 5000);
  }

  async function postDiet(payload){
    const res = await fetch(`${baseUrl()}${DIET_API}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  function extractCalories(text) {
    const m = String(text || "").match(/\((\s*\d+\s*(?:-\s*\d+)?\s*kcal)\s*\)/i);
    return m ? m[1].replace(/\s+/g, " ").trim() : "";
  }
  function cleanText(text) {
    return String(text || "").replace(/\(\s*\d+\s*(?:-\s*\d+)?\s*kcal\s*\)/ig, "").trim();
  }
  function currentMealStartIndex(){
    const h = new Date().getHours();
    if (h >= 6 && h < 10) return 0;
    if (h >= 10 && h < 12) return 1;
    if (h >= 12 && h < 16) return 2;
    if (h >= 16 && h < 18) return 3;
    if (h >= 18 && h < 22) return 4;
    return 5;
  }

  function bmiLabelAndTalk(bmi){
    const v = Number(bmi);
    if(v >= 30) return { cls:"bad", label:"OBEZ", talk:"<b>Obezsin evladÄ±m.</b> Her gÃ¼n sana gÃ¼nlÃ¼k ne yemen lazÄ±m onu vereceÄŸim." };
    if(v >= 25) return { cls:"warn", label:"KÄ°LOLU", talk:"<b>Kilolusun evladÄ±m.</b> DÃ¼zenli gidersen toparlarÄ±z. Her gÃ¼n menÃ¼ vereceÄŸim." };
    if(v < 18.5) return { cls:"warn", label:"ZAYIF", talk:"<b>ZayÄ±fsÄ±n evladÄ±m.</b> SaÄŸlÄ±klÄ± toparlayalÄ±m. Her gÃ¼n menÃ¼ vereceÄŸim." };
    return { cls:"ok", label:"NORMAL", talk:"<b>Normalsin evladÄ±m.</b> Formu koruyalÄ±m. Her gÃ¼n menÃ¼ vereceÄŸim." };
  }

  function calculateAndShowBMI(u){
    const h = Number(u.height_cm)/100;
    const w = Number(u.weight_kg);
    const bmi = (w/(h*h)).toFixed(1);

    $("bmiVal").textContent = bmi;

    const meta = bmiLabelAndTalk(bmi);
    const st = $("bmiStatus");
    st.className = `bmi-status ${meta.cls}`;
    st.textContent = meta.label;

    $("bmiTalk").innerHTML = meta.talk;

    const circle = $("bmiCircle");
    const maxVal = 40;
    const dash = 175;
    const offset = dash - ((Math.min(Number(bmi), maxVal)/maxVal)*dash);
    setTimeout(()=>{
      circle.style.strokeDashoffset = offset;
      circle.style.stroke = (meta.cls==="bad") ? "var(--red)" : (meta.cls==="warn" ? "var(--gold)" : "var(--pistachio)");
    }, 50);

    return bmi;
  }

  function renderMeals(plan){
    const list = $("mealList");
    list.innerHTML = "";

    const start = currentMealStartIndex();
    const items = [
      { k:"kahvalti", t:"KahvaltÄ±", i:"ğŸ³", cal:"350-400 kcal", time:"08:30" },
      { k:"ara",      t:"Ara Ã–ÄŸÃ¼n", i:"ğŸ", cal:"100-150 kcal", time:"11:00" },
      { k:"ogle",     t:"Ã–ÄŸle",     i:"ğŸ¥—", cal:"450-500 kcal", time:"13:30" },
      { k:"ara2",     t:"Ara Ã–ÄŸÃ¼n", i:"ğŸ", cal:"100-150 kcal", time:"16:30" },
      { k:"aksam",    t:"AkÅŸam",    i:"ğŸŒ™", cal:"300-350 kcal", time:"19:30" },
      { k:"su",       t:"Su",       i:"ğŸ’§", cal:"0 kcal",       time:"GÃ¼n boyu" }
    ];

    items.slice(start).forEach(item=>{
      let val = "â€”";
      if (item.k === "ara" || item.k === "ara2") {
        val = plan?.ara_ogun || plan?.ara || "â€”";
      } else {
        val = plan?.[item.k] || plan?.[item.k + "_ogun"] || "â€”";
      }

      const cal = extractCalories(val);
      val = cleanText(val);

      const html = `
        <div class="meal-card">
          <div class="meal-icon">${item.i}</div>
          <div style="flex:1">
            <div class="meal-name">${item.t}</div>
            <div class="meal-desc">${val}</div>
            <div class="meal-meta">
              <span class="time">${item.time}</span>
              <span class="cal">${cal ? cal : item.cal}</span>
            </div>
          </div>
        </div>
      `;
      list.insertAdjacentHTML("beforeend", html);
    });
  }

  // DOB dropdownlar
  function pad2(n){ return String(n).padStart(2,"0"); }
  function getDobFromSelects(){
    const y = $("dobYear").value;
    const m = $("dobMonth").value;
    const d = $("dobDay").value;
    if(!y || !m || !d) return "";
    return `${y}-${pad2(m)}-${pad2(d)}`; // YYYY-MM-DD
  }

  function daysInMonth(year, month){
    return new Date(Number(year), Number(month), 0).getDate(); // month: 1-12
  }

  function buildDobOptions(){
    const yearSel = $("dobYear");
    const monthSel = $("dobMonth");
    const daySel = $("dobDay");

    const nowY = new Date().getFullYear();
    const minY = nowY - 90;
    const maxY = nowY - 10;

    yearSel.innerHTML = `<option value="">YÄ±l</option>`;
    for(let y=maxY; y>=minY; y--){
      yearSel.insertAdjacentHTML("beforeend", `<option value="${y}">${y}</option>`);
    }

    monthSel.innerHTML = `<option value="">Ay</option>`;
    for(let m=1; m<=12; m++){
      monthSel.insertAdjacentHTML("beforeend", `<option value="${m}">${pad2(m)}</option>`);
    }

    function refreshDays(){
      const y = yearSel.value || maxY;
      const m = monthSel.value || 1;
      const maxD = daysInMonth(y, m);
      const prev = daySel.value;

      daySel.innerHTML = `<option value="">GÃ¼n</option>`;
      for(let d=1; d<=maxD; d++){
        daySel.insertAdjacentHTML("beforeend", `<option value="${d}">${pad2(d)}</option>`);
      }
      if(prev && Number(prev) <= maxD) daySel.value = prev;
    }

    yearSel.addEventListener("change", refreshDays);
    monthSel.addEventListener("change", refreshDays);
    refreshDays();
  }

  function setDobSelectsFromISO(iso){
    // iso: YYYY-MM-DD
    try{
      const [y,m,d] = String(iso||"").split("-");
      if(y) $("dobYear").value = y;
      if(m) $("dobMonth").value = String(Number(m));
      // gÃ¼n listesi ay/yÄ±l deÄŸiÅŸince yeniden kurulduÄŸu iÃ§in Ã¶nce tetikle:
      $("dobMonth").dispatchEvent(new Event("change"));
      if(d) $("dobDay").value = String(Number(d));
    }catch{}
  }

  async function runAutoDietFetch(){
    try{
      const userLocal = getUserLocal();
      const userId = userLocal.id || userLocal.user_id || "guest";
      const today = todayStr();

      const data = await postDiet({ user_id: userId, date: today });
      if(data?.ok){
        data.date = today;
        localStorage.setItem("caynana_last_diet", JSON.stringify(data));
        renderMeals(data.plan);
        showNotif();
      }
    }catch{}
  }

  function scheduleDailyRefresh(){
    const now = new Date();
    const target = new Date();
    target.setHours(6,0,0,0);
    if(now > target) target.setDate(target.getDate()+1);

    const ms = target - now;
    setTimeout(async ()=>{
      localStorage.removeItem("caynana_last_diet");
      await runAutoDietFetch();
      scheduleDailyRefresh();
    }, ms);
  }

  async function init(){
    buildDobOptions();

    const userLocal = getUserLocal();

    // doldur
    if(userLocal?.height_cm) $("inpHeight").value = userLocal.height_cm;
    if(userLocal?.weight_kg) $("inpWeight").value = userLocal.weight_kg;
    if(userLocal?.gender) $("inpGender").value = userLocal.gender;
    if(userLocal?.birth_date) setDobSelectsFromISO(userLocal.birth_date);

    // kilitle (dob+gender varsa)
    $("inpHeight").disabled = false;
    $("inpWeight").disabled = false;

    const hasDob = !!userLocal?.birth_date;
    const hasGender = !!userLocal?.gender;

    $("dobYear").disabled = hasDob;
    $("dobMonth").disabled = hasDob;
    $("dobDay").disabled = hasDob;
    $("inpGender").disabled = hasGender;

    const isComplete = userLocal.height_cm && userLocal.weight_kg && userLocal.birth_date && userLocal.gender;

    if(!isComplete){
      show("profileSetup");
      scheduleDailyRefresh();
      return;
    }

    show("dietDashboard");
    calculateAndShowBMI(userLocal);

    const today = todayStr();
    const lastDiet = safeJson(localStorage.getItem("caynana_last_diet"));
    if(lastDiet && lastDiet.ok && lastDiet.date === today){
      renderMeals(lastDiet.plan);
    }

    scheduleDailyRefresh();
  }

  $("btnCalc").onclick = async () => {
    const h = $("inpHeight").value;
    const w = $("inpWeight").value;
    if(!h || !w) return alert("Boy ve kiloyu gir evladÄ±m.");

    const userLocal = getUserLocal();
    const userId = userLocal.id || userLocal.user_id || "guest";

    const payload = { user_id: userId, height_cm: Number(h), weight_kg: Number(w), date: todayStr() };

    // DOB sadece yoksa al (dropdownâ€™dan)
    if(!userLocal.birth_date){
      const dob = getDobFromSelects();
      if(!dob) return alert("DoÄŸum tarihini seÃ§ evladÄ±m.");
      payload.birth_date = dob;
    }

    // Gender sadece yoksa al
    if(!userLocal.gender){
      const g = $("inpGender").value;
      if(!g) return alert("Cinsiyet seÃ§ evladÄ±m.");
      payload.gender = g;
    }

    // local gÃ¼ncelle
    const updated = { ...userLocal, ...payload };
    delete updated.date;
    setUserLocal(updated);

    try{
      const data = await postDiet(payload);
      if(data?.ok){
        data.date = todayStr();
        localStorage.setItem("caynana_last_diet", JSON.stringify(data));
        show("dietDashboard");
        calculateAndShowBMI(updated);
        renderMeals(data.plan);
        showNotif();
      } else {
        alert(data?.message || "Hata oluÅŸtu.");
      }
    } catch {
      alert("BaÄŸlantÄ± hatasÄ± evladÄ±m.");
    }
  };

  $("btnGenerate").onclick = async () => {
    const btn = $("btnGenerate");
    const old = btn.textContent;
    btn.textContent = "HazÄ±rlanÄ±yor...";
    btn.disabled = true;

    const userLocal = getUserLocal();
    const userId = userLocal.id || userLocal.user_id || "guest";

    try{
      const data = await postDiet({ user_id: userId, date: todayStr() });
      if(data?.ok){
        data.date = todayStr();
        localStorage.setItem("caynana_last_diet", JSON.stringify(data));
        renderMeals(data.plan);
        showNotif();
      } else {
        alert("MenÃ¼ Ã§Ä±kmadÄ± evladÄ±m: " + (data?.message || "Bilinmiyor"));
      }
    } catch {
      alert("BaÄŸlantÄ± hatasÄ± evladÄ±m.");
    } finally {
      btn.disabled = false;
      btn.textContent = old;
    }
  };

  init();
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const hamb = document.getElementById("hambBtn");
    const overlay = document.getElementById("menuOverlay");

    if(hamb && overlay){
      hamb.addEventListener("click", () => overlay.classList.add("open"));
      overlay.addEventListener("click", (e) => { if(e.target === overlay) overlay.classList.remove("open"); });
    }

    try {
      const u = JSON.parse(localStorage.getItem("caynana_user_v1") || "{}");
      const pic = u.picture || u.avatar || u.avatar_url;
      const name = u.fullname || u.name || "â€”";

      const ico = document.getElementById("profileShortcutIco");
      if(ico && pic) ico.innerHTML = `<img src="${pic}" alt="avatar">`;

      const nm = document.getElementById("profileShortcutName");
      if(nm) nm.textContent = name;
    } catch(e) {}
  });
</script>

</body>
</html>
