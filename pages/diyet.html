<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from "/js/config.js";

  const DIET_API = "/api/diet/today";
  const PROFILE_API = "/api/profile/me"; // EKLENDƒ∞

  function $(id) { return document.getElementById(id); }
  function safeJson(s) { try { return JSON.parse(s || "{}"); } catch { return {}; } }
  function todayStr() { return new Date().toISOString().split("T")[0]; }

  function showSection(id) {
    ["profileSetup", "askBox", "dietDashboard"].forEach(k => $(k).style.display = "none");
    $(id).style.display = (id === "profileSetup" || id === "dietDashboard") ? "flex" : "block";
  }

  function calculateAndShowBMI(u) {
    const h = Number(u.height_cm) / 100;
    const w = Number(u.weight_kg);
    const bmi = (w / (h * h)).toFixed(1);

    $("bmiVal").textContent = bmi;

    const statusEl = $("bmiStatus");
    const circle = $("bmiCircle");

    let statusText = "NORMAL";
    let color = "#bef264";

    if (bmi < 18.5) { statusText = "ZAYIF"; color = "#ffb300"; statusEl.className = "bmi-status warn"; }
    else if (bmi > 25 && bmi < 30) { statusText = "Kƒ∞LOLU"; color = "#ffb300"; statusEl.className = "bmi-status warn"; }
    else if (bmi >= 30) { statusText = "OBEZ"; color = "#ff5252"; statusEl.className = "bmi-status bad"; }
    else { statusEl.className = "bmi-status ok"; }

    statusEl.textContent = statusText;

    const maxVal = 40;
    const dash = 175;
    const offset = dash - ((Math.min(Number(bmi), maxVal) / maxVal) * dash);
    setTimeout(() => {
      circle.style.strokeDashoffset = offset;
      circle.style.stroke = color;
    }, 100);
  }

  // YENƒ∞: Backend‚Äôden profil √ßek
  async function fetchProfile(userId) {
    try {
      const res = await fetch(`${BASE_DOMAIN}${PROFILE_API}?user_id=${encodeURIComponent(userId)}`, {
        method: "GET",
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) return null;
      const data = await res.json();
      return data?.ok ? data.profile : null;
    } catch {
      return null;
    }
  }

  // YENƒ∞: Backend‚Äôe profil kaydet
  async function saveProfileToBackend(userId, profile) {
    try {
      const res = await fetch(`${BASE_DOMAIN}${PROFILE_API}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, ...profile })
      });
      const data = await res.json().catch(() => ({}));
      return !!data?.ok;
    } catch {
      return false;
    }
  }

  function fillFormFromProfile(p) {
    if (p?.height_cm) $("inpHeight").value = p.height_cm;
    if (p?.weight_kg) $("inpWeight").value = p.weight_kg;
    if (p?.birth_date) $("inpDob").value = p.birth_date;
    if (p?.gender) $("inpGender").value = p.gender;
  }

  function renderMeals(plan) {
    const list = $("mealList");
    list.innerHTML = "";

    const currentHour = new Date().getHours();
    const skipBreakfast = currentHour >= 13;

    // Backend‚Äôin d√∂nd√ºƒü√º yapƒ±yƒ± destekle:
    // plan = {
    //   meals: [
    //     { key:"kahvalti", title:"Kahvaltƒ±", icon:"üç≥", time:"08:30", items:"...", calories: 380 },
    //     ...
    //   ],
    //   water: { time:"G√ºn boyu", items:"2-2.5L", calories:0 }
    // }
    const meals = Array.isArray(plan?.meals) ? plan.meals : null;

    if (meals) {
      meals.forEach(m => {
        if (m.key === "kahvalti" && skipBreakfast) return;

        const calText = (m.calories !== undefined && m.calories !== null)
          ? `${m.calories} kcal`
          : (m.cal_range ? m.cal_range : "");

        const timeText = m.time ? `üïí ${m.time}` : "";

        const html = `
          <div class="meal-card">
            <div class="meal-icon">${m.icon || "üçΩÔ∏è"}</div>
            <div class="meal-info">
              <div class="meal-name">${m.title || "-"}</div>
              <div class="meal-desc">${m.items || "‚Äî"}</div>
              <div class="meal-cal">${[timeText, calText].filter(Boolean).join(" ‚Ä¢ ")}</div>
            </div>
          </div>
        `;
        list.insertAdjacentHTML("beforeend", html);
      });
      return;
    }

    // ESKƒ∞ fallback (mevcut API yapƒ±n bozulmasƒ±n diye)
    const items = [
      { k: "kahvalti", t: "Kahvaltƒ±", i: "üç≥", cal: "350-400 kcal" },
      { k: "ara", t: "Ara √ñƒü√ºn", i: "üçè", cal: "100-150 kcal" },
      { k: "ogle", t: "√ñƒüle Yemeƒüi", i: "ü•ó", cal: "450-500 kcal" },
      { k: "aksam", t: "Ak≈üam Yemeƒüi", i: "üåô", cal: "300-350 kcal" },
      { k: "su", t: "Su", i: "üíß", cal: "0 kcal" }
    ];

    items.forEach(item => {
      if(item.k === "kahvalti" && skipBreakfast) return;

      let val = plan[item.k] || plan[item.k + "_ogun"] || "‚Äî";
      if(val === "‚Äî" && item.k === "ara") val = plan["ara_ogun"] || "‚Äî";

      const html = `
        <div class="meal-card">
          <div class="meal-icon">${item.i}</div>
          <div class="meal-info">
            <div class="meal-name">${item.t}</div>
            <div class="meal-desc">${val}</div>
            <div class="meal-cal">${item.cal}</div>
          </div>
        </div>
      `;
      list.insertAdjacentHTML("beforeend", html);
    });
  }

  function showNotification() {
    const n = $("dietNotif");
    n.style.display = "block";
    setTimeout(() => { n.style.display = "none"; }, 5000);

    // (Opsiyonel) Tarayƒ±cƒ± bildirimi (sayfa a√ßƒ±kken)
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification("Caynana", { body: "Bug√ºn diyet men√ºn geldi, incele evladƒ±m!" });
    }
  }

  function scheduleDailyRefresh() {
    const now = new Date();
    const target = new Date();
    target.setHours(6, 0, 0, 0);
    if (now > target) target.setDate(target.getDate() + 1);

    const ms = target - now;
    setTimeout(() => {
      localStorage.removeItem("caynana_last_diet");
      location.reload();
    }, ms);
  }

  async function initPage() {
    const userLocal = safeJson(localStorage.getItem(STORAGE_KEY));
    const userId = userLocal.id || userLocal.user_id || "guest";

    // 0) Bildirim iznini nazik√ße hazƒ±rla (zorlamƒ±yoruz)
    if ("Notification" in window && Notification.permission === "default") {
      // kullanƒ±cƒ±yla ilk etkile≈üim sonrasƒ± istemek daha iyi, burada dokunmuyoruz
    }

    // 1) PROFƒ∞Lƒ∞ BACKEND'DEN √áEK (profil sayfasƒ± kaynaƒüƒ±)
    const profileFromDb = await fetchProfile(userId);
    const merged = { ...userLocal, ...(profileFromDb || {}) };

    // local‚Äôƒ± g√ºncel tut
    localStorage.setItem(STORAGE_KEY, JSON.stringify(merged));

    const isProfileComplete = merged.height_cm && merged.weight_kg && merged.birth_date && merged.gender;

    if (!isProfileComplete) {
      showSection("profileSetup");
      fillFormFromProfile(merged);
      scheduleDailyRefresh();
      return;
    }

    calculateAndShowBMI(merged);

    // 2) BUG√úN√úN Dƒ∞YETƒ∞ VAR MI?
    const today = todayStr();
    const lastDiet = safeJson(localStorage.getItem("caynana_last_diet"));

    if (lastDiet && lastDiet.date === today && lastDiet.ok) {
      showSection("dietDashboard");
      renderMeals(lastDiet.plan);
    } else {
      showSection("askBox");
    }

    scheduleDailyRefresh();
  }

  // A) Profili Kaydet + Backend‚Äôe yaz
  $("btnSaveProfile").onclick = async () => {
    const h = $("inpHeight").value;
    const w = $("inpWeight").value;
    const d = $("inpDob").value;
    const g = $("inpGender").value;

    if(!h || !w || !d || !g) return alert("Hepsini doldur evladƒ±m.");

    const user = safeJson(localStorage.getItem(STORAGE_KEY));
    const userId = user.id || user.user_id || "guest";

    const newProfile = { height_cm: Number(h), weight_kg: Number(w), birth_date: d, gender: g };

    // local
    const updated = { ...user, ...newProfile };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));

    // backend (profil sayfasƒ±yla aynƒ± kaynak olsun)
    await saveProfileToBackend(userId, newProfile);

    // akƒ±≈üa devam
    location.reload();
  };

  // B) Diyet Olu≈ütur (API Call) ‚Äî tekrar etmeme i√ßin ‚Äúson men√º id‚Äôleri‚Äù g√∂nder
  $("btnGenerate").onclick = async () => {
    const btn = $("btnGenerate");
    btn.textContent = "Hazƒ±rlanƒ±yor...";
    btn.disabled = true;

    const user = safeJson(localStorage.getItem(STORAGE_KEY));
    const userId = user.id || user.user_id || "guest";

    const today = todayStr();
    const prev = safeJson(localStorage.getItem("caynana_last_diet"));
    const recentMenuIds = safeJson(localStorage.getItem("caynana_recent_menu_ids"));
    const recentIdsArr = Array.isArray(recentMenuIds?.ids) ? recentMenuIds.ids : [];

    const currentHour = new Date().getHours();
    const skipBreakfast = currentHour >= 13;

    try {
      const res = await fetch(`${BASE_DOMAIN}${DIET_API}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          date: today,
          skip_breakfast: skipBreakfast,
          avoid_menu_ids: recentIdsArr.slice(-10) // son 10 men√º tekrar etmesin
        })
      });

      const data = await res.json();

      if (data.ok) {
        data.date = today;
        localStorage.setItem("caynana_last_diet", JSON.stringify(data));

        // men√º id listesi g√ºncelle (backend data.menu_id d√∂nd√ºrmeli)
        if (data.menu_id) {
          const next = [...recentIdsArr, data.menu_id].slice(-20);
          localStorage.setItem("caynana_recent_menu_ids", JSON.stringify({ ids: next }));
        }

        showSection("dietDashboard");
        renderMeals(data.plan);
        showNotification();

        // Bildirim izni istersen burada sor (kullanƒ±cƒ± tƒ±kladƒ±ktan sonra ideal)
        if ("Notification" in window && Notification.permission === "default") {
          try { await Notification.requestPermission(); } catch {}
        }
      } else {
        alert("Bir hata oldu: " + (data.message || "Bilinmiyor"));
        btn.textContent = "Tekrar Dene";
        btn.disabled = false;
      }
    } catch(e) {
      alert("Baƒülantƒ± hatasƒ± evladƒ±m.");
      btn.textContent = "Tekrar Dene";
      btn.disabled = false;
    }
  };

  initPage();
</script>
