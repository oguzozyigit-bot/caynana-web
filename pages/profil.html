Kodu kopyala
Html
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profil Ayarlarƒ±</title>

<style>
  :root{
    --bg:#0e0e0e; --text:#ececec; --gold:#ffb300; --pist:#bef264; --card:#141414;
    --border:#2a2a2a; --soft:#8c8c8c;
    --ok:#22c55e;
    --p: 10; /* progress 0-100 */
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; scrollbar-width:none; -ms-overflow-style:none; }
  *::-webkit-scrollbar{ display:none; width:0; height:0; }

  body{
    margin:0; background:#000; color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex; justify-content:center; height:100vh; overflow:hidden;
  }

  .frame{ width:100%; max-width:480px; height:100%; background:var(--bg); display:flex; flex-direction:column; }
  @media (min-width:500px){
    .frame{
      height:95vh; margin-top:2.5vh; border-radius:24px; border:1px solid #333;
      box-shadow:0 0 50px rgba(255,255,255,.05);
    }
  }

  .header{
    padding:16px 16px 14px; border-bottom:1px solid var(--border);
    background:rgba(20,20,20,.95);
    display:flex; align-items:center; gap:12px;
  }
  .back-btn{
    width:38px; height:38px; border-radius:12px; border:1px solid #333;
    background:#121212; color:#fff; cursor:pointer; font-size:18px;
    display:flex; align-items:center; justify-content:center;
  }
  .title-wrap{ flex:1; text-align:center; margin-right:38px; }
  .title-wrap h2{ margin:0; font-size:16px; font-weight:800; }
  .title-wrap p{ margin:4px 0 0; font-size:12px; color:var(--soft); }

  .content{
    flex:1; overflow:auto; padding:16px;
    display:flex; flex-direction:column; gap:16px;
    padding-bottom:110px; /* ‚úÖ alttaki sabit kaydet barƒ± i√ßin */
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius:16px; padding:14px;
  }

  /* ‚úÖ Premium Progress Hero */
  .hero{
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(1200px 400px at 0% 0%, rgba(255,179,0,.10), rgba(0,0,0,0) 60%),
      radial-gradient(900px 400px at 100% 0%, rgba(34,197,94,.10), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,0));
    position:relative;
    overflow:hidden;
  }
  /* ‚úÖ hero yarƒ±m g√∂r√ºnme fix */
  .hero > *{ position:relative; z-index:1; }
  .hero .spark{ position:absolute; z-index:0; pointer-events:none; }

  .hero-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .hero-title{ font-weight:900; font-size:13px; letter-spacing:.2px; }
  .hero-badge{
    font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.35);
    white-space:nowrap;
  }
  .hero-sub{ margin-top:8px; font-size:12px; color:rgba(255,255,255,.72); line-height:1.35; }
  .bar{
    margin-top:12px;
    height:10px; border-radius:999px;
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.08);
    overflow:hidden;
  }
  .bar > span{
    display:block; height:100%; width:calc(var(--p) * 1%);
    background:linear-gradient(90deg, rgba(255,179,0,.95), rgba(190,242,100,.95), rgba(34,197,94,.95));
    filter:saturate(1.1);
    transition:width .35s ease;
  }
  .hero-foot{
    margin-top:10px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:11px; color:rgba(255,255,255,.62);
  }
  .hero-chip{
    margin-top:10px;
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:11px;
    font-weight:900;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.28);
    width:max-content;
  }
  .hero-chip.low{ border-color: rgba(255,179,0,.35); color:#ffb300; }
  .hero-chip.ok{ border-color: rgba(190,242,100,.35); color:#bef264; }
  .hero-chip.great{ border-color: rgba(34,197,94,.35); color:#22c55e; }

  .spark{
    inset:auto -40px -80px -40px; height:220px;
    opacity:.75;
  }

  .pill{
    display:inline-flex; gap:6px; align-items:center; font-size:11px; font-weight:800;
    background:var(--pist); color:#111; padding:4px 10px; border-radius:999px;
  }
  .muted{ color:#9a9a9a; font-size:12px; line-height:1.35; margin-top:8px; }

  .section-title{
    font-size:11px; color:var(--pist); font-weight:800; letter-spacing:1px; text-transform:uppercase;
    border-bottom:1px solid #232323; padding-bottom:8px; margin-bottom:10px;
  }

  .form-group{ display:flex; flex-direction:column; gap:8px; margin-bottom:6px; }
  label{ font-size:12px; color:#aaa; font-weight:600; margin-left:4px; }

  input, select{
    width:100%; background:#1a1a1a; border:1px solid #444; color:#fff;
    padding:14px; border-radius:12px; font-size:14px; outline:none; font-family:inherit;
    transition:.2s;
  }
  input:focus, select:focus{ border-color:var(--gold); background:#222; }

  .row{ display:flex; gap:12px; }
  .row > div{ flex:1; min-width:0; }

  .date-row{ display:flex; gap:8px; }
  .date-row select{ flex:1; padding:14px 8px; text-align:center; appearance:none; }

  .id-copy-box{
    display:flex; align-items:center; gap:10px; background:#111;
    padding:12px; border-radius:10px; border:1px dashed #444;
  }
  .id-text{ flex:1; font-family:monospace; color:var(--gold); font-size:12px; word-break:break-all; }
  .copy-btn{ background:none; border:none; cursor:pointer; font-size:18px; color:#777; }

  .conditional{ display:none; border-left:2px solid var(--gold); padding-left:14px; margin-left:4px; }
  .conditional.show{ display:block; animation:fadeIn .25s ease; }
  @keyframes fadeIn{ from{ opacity:0; transform:translateY(-6px);} to{opacity:1; transform:translateY(0);} }

  .children-wrap{ display:flex; flex-direction:column; gap:10px; }
  .child-card{
    background:#121212; border:1px solid #262626; border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .mini{ font-size:11px; color:#8a8a8a; margin-left:4px; }

  /* ‚úÖ Sabit Kaydet Barƒ± (telefon ekranƒ±nda alt g√∂r√ºnmeme biter) */
  .save-dock{
    position:sticky;
    bottom:0;
    padding:12px 16px 14px;
    background: linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,.92));
    border-top:1px solid rgba(255,255,255,.06);
    z-index:50;
  }
  .save-btn{
    background:var(--gold); color:#000; border:none; padding:16px;
    border-radius:14px;
    font-weight:950; font-size:15px; cursor:pointer; width:100%;
    box-shadow:0 8px 20px rgba(255,179,0,.15);
  }

  /* ‚úÖ Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:98px; z-index:9999;
    min-width:240px; max-width:92vw;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(10,10,10,.85);
    color:#fff;
    box-shadow:0 10px 30px rgba(0,0,0,.55);
    display:none;
    font-size:12px; line-height:1.35;
  }
  .toast.show{ display:block; animation:pop .18s ease; }
  @keyframes pop{ from{ opacity:0; transform:translateX(-50%) translateY(10px);} to{opacity:1; transform:translateX(-50%) translateY(0);} }

  /* ‚úÖ Footer: stil bozulmasƒ±n */
  .footer{
    border-top:0 !important;
    background: linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,.75)) !important;
    padding:10px 10px 8px !important;
    text-align:center;
  }
  .footer .brand{
    color: rgba(255,255,255,.62) !important;
    font-size:11px !important;
    font-weight:700; letter-spacing:.3px;
  }
  .footer .slogan{ display:none !important; }
</style>
</head>

<body>
<div class="frame">
  <div class="header">
    <button class="back-btn" onclick="goBack()" title="Geri">‚Üê</button>
    <div class="title-wrap">
      <h2>Profil Ayarlarƒ±</h2>
      <p>Doldurursan Kaynana asistanƒ±n olur.</p>
    </div>
  </div>

  <div class="content">

    <div class="hero" id="hero">
      <svg class="spark" viewBox="0 0 600 220" preserveAspectRatio="none" aria-hidden="true">
        <path d="M0,170 C120,120 160,40 260,70 C340,95 360,170 430,160 C520,146 540,85 600,95 L600,220 L0,220 Z"
              fill="rgba(255,179,0,.08)"></path>
        <path d="M0,185 C120,150 190,60 290,92 C360,115 380,185 455,175 C535,164 548,120 600,125 L600,220 L0,220 Z"
              fill="rgba(34,197,94,.08)"></path>
      </svg>

      <div class="hero-top">
        <div class="hero-title">Kaynana Samimiyet G√∂stergesi</div>
        <div class="hero-badge" id="heroPct">%10</div>
      </div>

      <div class="hero-sub" id="heroSub">
        Biraz daha doldur, Kaynana ‚Äúgelinim/damadƒ±m‚Äù moduna ge√ßsin üòÑ
      </div>

      <div class="bar"><span id="heroBar"></span></div>

      <div class="hero-foot">
        <div id="heroHint">Doldurduk√ßa ye≈üile d√∂ner.</div>
        <div id="heroPts">Kaynana Samimiyeti: 10%</div>
      </div>

      <div class="hero-chip low" id="heroChip">+1 yakla≈ütƒ±n</div>
    </div>

    <div class="card">
      <div class="pill">üßø Kaynana Asistan</div>
      <div class="muted">
        Bu alanlarƒ± doldurursan g√ºn√º gelince <b>bildirimle hatƒ±rlatƒ±rƒ±m</b>:
        ‚ÄúBug√ºn e≈üinin doƒüum g√ºn√º‚Äù gibi‚Ä¶
      </div>
    </div>

    <div class="card">
      <div class="section-title">Kimlik</div>

      <div class="form-group">
        <label>ID Numarasƒ± (Deƒüi≈ümez)</label>
        <div class="id-copy-box">
          <span id="formID" class="id-text">...</span>
          <button class="copy-btn" onclick="copyID()" title="Kopyala">üìã</button>
        </div>
        <div class="mini" id="emailDisplay">Email: ‚Äî</div>

        <div class="form-group" style="margin-top:10px;">
          <label>Ad Soyad</label>
          <input type="text" id="formFullname" placeholder="‚Äî" readonly disabled>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <label>Profil Fotoƒürafƒ±</label>
          <div style="display:flex; align-items:center; gap:12px;">
            <img id="avatarImg" src="" alt="avatar"
                 style="width:54px;height:54px;border-radius:999px;border:1px solid #333;object-fit:cover;display:none;">
            <div class="mini" id="avatarHint">‚Äî</div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="section-title">Temel Bilgiler</div>

      <div class="form-group">
        <label>Caynana sana nasƒ±l hitap etsin?</label>
        <input type="text" id="formHitap" placeholder="√ñrn: Oƒülum, Kƒ±zƒ±m">
      </div>

      <div class="form-group">
        <label>Caynana'ya bir isim ver</label>
        <input type="text" id="formBotName" placeholder="√ñrn: Sultan Hanƒ±m">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Cinsiyet</label>
          <select id="formGender" onchange="toggleGenderFields()">
            <option value="">Se√ß</option>
            <option value="Kadƒ±n">Kadƒ±n</option>
            <option value="Erkek">Erkek</option>
          </select>
        </div>
        <div class="form-group">
          <label>Medeni Durum</label>
          <select id="formStatus" onchange="toggleMarriedFields()">
            <option value="">Se√ß</option>
            <option value="Bekar">Bekar</option>
            <option value="Evli">Evli</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Ya≈üadƒ±ƒüƒ± ƒ∞l</label>
          <select id="formCity"><option value="">Se√ß</option></select>
        </div>
        <div class="form-group">
          <label>Doƒüduƒüu ƒ∞l</label>
          <select id="formBirthCity"><option value="">Se√ß</option></select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Tuttuƒüu Takƒ±m</label>
          <input type="text" id="formTeam" placeholder="√ñrn: Be≈üikta≈ü">
        </div>
      </div>

      <div class="form-group">
        <label>Doƒüum Tarihi (Yƒ±l / Ay / G√ºn)</label>
        <div class="date-row">
          <select id="yearSelect"><option value="">Yƒ±l</option></select>
          <select id="monthSelect" disabled>
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="daySelect" disabled><option value="">G√ºn</option></select>
        </div>
        <div class="mini">√ñnce yƒ±l ‚Üí sonra ay ‚Üí sonra g√ºn.</div>
      </div>
    </div>

    <div class="card conditional" id="periodFields">
      <div class="section-title">Regl Takibi</div>

      <div class="form-group" style="margin-top:10px;">
        <label>Takip a√ßƒ±k mƒ±?</label>
        <select id="periodEnabled">
          <option value="false">Kapalƒ±</option>
          <option value="true">A√ßƒ±k</option>
        </select>
      </div>

      <div class="form-group">
        <label>Son adet ba≈ülangƒ±√ß tarihi</label>
        <input type="date" id="lastPeriodStart">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Ortalama d√∂ng√º (g√ºn)</label>
          <input type="number" id="cycleLength" value="28" min="21" max="35">
        </div>
        <div class="form-group">
          <label>Ortalama adet s√ºresi (g√ºn)</label>
          <input type="number" id="periodLength" value="5" min="3" max="8">
        </div>
      </div>
    </div>

    <div class="card conditional" id="marriedFields">
      <div class="section-title">√ñzel G√ºnler</div>

      <div class="form-group">
        <label>E≈üinin Adƒ±</label>
        <input type="text" id="formSpouse" placeholder="Ad">
      </div>

      <!-- ‚úÖ AY ‚Üí G√úN (≈ûubat 30 se√ßilemez) -->
      <div class="form-group">
        <label>E≈üinin Doƒüum G√ºn√º (Ay / G√ºn)</label>
        <div class="date-row">
          <select id="spouseBMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="spouseBDay" disabled><option value="">G√ºn</option></select>
        </div>
      </div>

      <div class="form-group">
        <label>Evlilik G√ºn√º (Ay / G√ºn)</label>
        <div class="date-row">
          <select id="wMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="wDay" disabled><option value="">G√ºn</option></select>
        </div>
      </div>

      <div class="form-group">
        <label>Ni≈üan G√ºn√º (Ay / G√ºn)</label>
        <div class="date-row">
          <select id="eMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="eDay" disabled><option value="">G√ºn</option></select>
        </div>
      </div>

      <div class="form-group">
        <label>ƒ∞lk Tanƒ±≈üma G√ºn√º (Ay / G√ºn)</label>
        <div class="date-row">
          <select id="mMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="mDay" disabled><option value="">G√ºn</option></select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">√áocuklar</div>

      <div class="form-group">
        <label>√áocuk Sayƒ±sƒ±</label>
        <select id="formChildCount" onchange="toggleChildFields()">
          <option value="0">Yok</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <div class="conditional" id="childFields">
        <div class="children-wrap" id="childrenContainer"></div>
      </div>
    </div>

    <!-- ‚úÖ Sabit Kaydet bar -->
    <div class="save-dock">
      <button class="save-btn" onclick="saveProfile()">KAYDET VE BA≈ûLA</button>
    </div>

  </div>

  <div class="footer">
    <div class="brand">@CaynanaAI By Ozyigit's 2026</div>
    <div class="slogan">Yapay Zek√¢nƒ±n Geleneksel Aklƒ±</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from '../js/config.js';

  const PROFILE_KEY = "caynana_profile_v2";
  const PROFILE_BONUS_KEY = "caynana_profile_bonus_v1";
  const GENERATED_IDS_KEY = "caynana_generated_ids_v1";
  const pad2 = (n) => String(n).padStart(2, "0");

  const TR_CITIES_81 = [
    "Adana","Adƒ±yaman","Afyonkarahisar","Aƒürƒ±","Amasya","Ankara","Antalya","Artvin","Aydƒ±n","Balƒ±kesir",
    "Bilecik","Bing√∂l","Bitlis","Bolu","Burdur","Bursa","√áanakkale","√áankƒ±rƒ±","√áorum","Denizli",
    "Diyarbakƒ±r","Edirne","Elazƒ±ƒü","Erzincan","Erzurum","Eski≈üehir","Gaziantep","Giresun","G√ºm√º≈ühane","Hakkari",
    "Hatay","Isparta","Mersin","ƒ∞stanbul","ƒ∞zmir","Kars","Kastamonu","Kayseri","Kƒ±rklareli","Kƒ±r≈üehir",
    "Kocaeli","Konya","K√ºtahya","Malatya","Manisa","Kahramanmara≈ü","Mardin","Muƒüla","Mu≈ü","Nev≈üehir",
    "Niƒüde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","Tekirdaƒü","Tokat",
    "Trabzon","Tunceli","≈ûanlƒ±urfa","U≈üak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman",
    "Kƒ±rƒ±kkale","Batman","≈ûƒ±rnak","Bartƒ±n","Ardahan","Iƒüdƒ±r","Yalova","Karab√ºk","Kilis","Osmaniye","D√ºzce"
  ];

  function toast(msg){
    const t = document.getElementById("toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.classList.remove("show"), 2300);
  }

  function norm(v){ return String(v || "").trim(); }

  // ---- ID generator (2 harf + 8 rakam, ardƒ±≈üƒ±k yok) ----
  function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
  function pickLetter(except){
    const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let ch = "";
    for(let t=0;t<50;t++){
      ch = A[randInt(0, A.length-1)];
      if(ch !== except) return ch;
    }
    return ch || "X";
  }
  function buildNonSequentialDigits(len=8){
    const digits = [];
    for(let i=0;i<len;i++){
      let d = randInt(0,9);
      for(let t=0;t<100;t++){
        const prev = digits[i-1];
        const prev2 = digits[i-2];
        const ok1 = (prev === undefined) ? true : (d !== prev && Math.abs(d - prev) !== 1);
        const ok2 = (prev2 === undefined) ? true : (d !== prev2);
        if(ok1 && ok2) break;
        d = randInt(0,9);
      }
      digits.push(d);
    }
    return digits.join("");
  }
  function getGeneratedIds(){
    try{
      const a = JSON.parse(localStorage.getItem(GENERATED_IDS_KEY) || "[]");
      return Array.isArray(a) ? a : [];
    }catch(e){ return []; }
  }
  function saveGeneratedId(id){
    const ids = getGeneratedIds();
    if(!ids.includes(id)) ids.push(id);
    try{ localStorage.setItem(GENERATED_IDS_KEY, JSON.stringify(ids)); }catch(e){}
  }
  function generateStableRandomId(){
    const used = new Set(getGeneratedIds());
    for(let tries=0; tries<200; tries++){
      const a = pickLetter("");
      const b = pickLetter(a);
      const nums = buildNonSequentialDigits(8);
      const id = `${a}${b}${nums}`;
      if(!used.has(id)){
        saveGeneratedId(id);
        return id;
      }
    }
    const fallback = `XZ${buildNonSequentialDigits(8)}`;
    saveGeneratedId(fallback);
    return fallback;
  }

  function ensureIdentity(user){
    if(!user || typeof user !== "object") user = {};
    user.id = norm(user.id);
    user.user_id = norm(user.user_id);
    user.email = norm(user.email);

    if(!user.id && user.user_id) user.id = user.user_id;
    if(!user.user_id && user.id) user.user_id = user.id;

    if(!user.id){
      const newId = generateStableRandomId();
      user.id = newId;
      user.user_id = user.user_id || newId;
    }
    return user;
  }

  function safeUpdateUser(patch){
    let u = {};
    try{ u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){}
    u = ensureIdentity(u);
    u = { ...u, ...(patch || {}) };
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(u)); }catch(e){}
    return u;
  }

  function getUser(){
    let user = {};
    try { user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch {}
    user = ensureIdentity(user);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); } catch {}
    return user;
  }

  function fillCitySelects(){
    const s1 = document.getElementById("formCity");
    const s2 = document.getElementById("formBirthCity");
    if(!s1 || !s2) return;
    if(s1.dataset.filled === "1") return;

    const opts = TR_CITIES_81.map(c => `<option value="${c}">${c}</option>`).join("");
    s1.insertAdjacentHTML("beforeend", opts);
    s2.insertAdjacentHTML("beforeend", opts);
    s1.dataset.filled = "1";
    s2.dataset.filled = "1";
  }

  // ‚úÖ DM max days by month (leap-year safe -> Feb 29)
  function maxDaysByMonth(mm){
    const m = parseInt(mm,10);
    if(!m) return 31;
    return new Date(2024, m, 0).getDate(); // 2024: ≈ûubat 29
  }

  function fillDayOptionsForDM(daySelectId, monthVal){
    const s = document.getElementById(daySelectId);
    if(!s) return;
    const max = maxDaysByMonth(monthVal);
    const cur = s.value || "";
    s.innerHTML = `<option value="">G√ºn</option>`;
    for(let i=1;i<=max;i++){
      s.innerHTML += `<option value="${pad2(i)}">${i}</option>`;
    }
    const n = parseInt(cur,10) || 0;
    if(n >= 1 && n <= max) s.value = pad2(n);
  }

  function wireMonthDay(monthId, dayId){
    const mEl = document.getElementById(monthId);
    const dEl = document.getElementById(dayId);
    if(!mEl || !dEl) return;

    const sync = ()=>{
      const mv = mEl.value || "";
      dEl.disabled = !mv;
      if(!mv) dEl.value = "";
      fillDayOptionsForDM(dayId, mv);
    };

    mEl.addEventListener("change", ()=>{ sync(); renderProgress(); });
    dEl.addEventListener("change", ()=>{ renderProgress(); });
    // init
    sync();
  }

  // birth Y/M/D
  function daysInMonth(year, month){
    const y = parseInt(year,10);
    const m = parseInt(month,10);
    if(!y || !m) return 31;
    return new Date(y, m, 0).getDate();
  }
  function fillBirthDayOptions(maxDays){
    const s = document.getElementById("daySelect");
    if(!s) return;
    const cur = s.value || "";
    s.innerHTML = `<option value="">G√ºn</option>`;
    for(let i=1;i<=maxDays;i++){
      s.innerHTML += `<option value="${pad2(i)}">${i}</option>`;
    }
    const n = parseInt(cur,10) || 0;
    if(n >= 1 && n <= maxDays) s.value = pad2(n);
  }
  function fillYearOptions(selectId, start=1950){
    const s = document.getElementById(selectId);
    if(!s) return;
    if(s.dataset.filled === "1") return;
    const nowY = new Date().getFullYear();
    for(let y=nowY; y>=start; y--){
      s.innerHTML += `<option value="${y}">${y}</option>`;
    }
    s.dataset.filled = "1";
  }
  function refreshBirthFlow(){
    const y = document.getElementById("yearSelect")?.value || "";
    const m = document.getElementById("monthSelect")?.value || "";
    const monthSel = document.getElementById("monthSelect");
    const daySel = document.getElementById("daySelect");

    if(monthSel){
      monthSel.disabled = !y;
      if(!y) monthSel.value = "";
    }
    if(daySel){
      daySel.disabled = !(y && m);
      if(!y || !m) daySel.value = "";
    }
    if(y && m) fillBirthDayOptions(daysInMonth(y, m));
    else fillBirthDayOptions(31);
  }
  function getBirthDate(){
    const y = document.getElementById('yearSelect')?.value || "";
    const m = document.getElementById('monthSelect')?.value || "";
    const d = document.getElementById('daySelect')?.value || "";

    const any = !!(y || m || d);
    const full = !!(y && m && d);
    if(any && !full) return { ok:false, value:"" };

    if(full){
      const max = daysInMonth(y, m);
      const dd = parseInt(d,10);
      if(!dd || dd<1 || dd>max) return { ok:false, value:"" };
      return { ok:true, value: `${d}.${m}.${y}` };
    }
    return { ok:true, value:"" };
  }
  function setBirthDate(val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===3){
      const d = p[0], m=p[1], y=p[2];
      const yEl = document.getElementById("yearSelect");
      const mEl = document.getElementById("monthSelect");
      const dEl = document.getElementById("daySelect");
      if(yEl) yEl.value = y;
      refreshBirthFlow();
      if(mEl) mEl.value = m;
      refreshBirthFlow();
      if(dEl) dEl.value = d;
      refreshBirthFlow();
    }
  }

  async function safeCopy(text){
    const t = String(text || "");
    if(!t) return false;
    try{ await navigator.clipboard.writeText(t); return true; }
    catch(e){
      try{
        const ta = document.createElement("textarea");
        ta.value = t; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }catch(e2){ return false; }
    }
  }

  // DM string helpers
  function getDM(dayId, monthId){
    const d = document.getElementById(dayId)?.value || "";
    const m = document.getElementById(monthId)?.value || "";
    if((d && !m) || (!d && m)) return { ok:false, value:"" };
    return { ok:true, value: (d && m) ? `${d}.${m}` : "" };
  }
  function setDM(dayId, monthId, val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===2){
      const d = document.getElementById(dayId);
      const m = document.getElementById(monthId);
      if(m) m.value = p[1];
      if(d) d.value = p[0];
      // day options month'a g√∂re yeniden bas
      fillDayOptionsForDM(dayId, p[1]);
      if(d) d.value = p[0];
    }
  }
  function isValidDM(d, m){
    const dd = parseInt(d,10);
    const mm = parseInt(m,10);
    if(!dd || !mm) return false;
    if(mm < 1 || mm > 12) return false;
    const max = maxDaysByMonth(mm);
    return dd >= 1 && dd <= max;
  }

  // -------------------- Progress --------------------
  function readMetaDraft(){
    const gender = document.getElementById('formGender')?.value || "";
    const bd = getBirthDate().value || "";

    const meta = {
      hitap: document.getElementById('formHitap')?.value || "",
      bot_name: document.getElementById('formBotName')?.value || "",
      gender,
      marital_status: document.getElementById('formStatus')?.value || "",
      region: document.getElementById('formCity')?.value || "",
      birth_city: document.getElementById('formBirthCity')?.value || "",
      team: document.getElementById('formTeam')?.value || "",
      birth_date: bd,

      spouse_name: document.getElementById('formSpouse')?.value || "",
      spouse_bday_dm: getDM("spouseBDay","spouseBMonth").value,
      wedding_dm: getDM("wDay","wMonth").value,
      engagement_dm: getDM("eDay","eMonth").value,
      met_dm: getDM("mDay","mMonth").value,

      child_count: String(parseInt(document.getElementById('formChildCount')?.value,10) || 0),
      children: [],

      period_tracking_enabled: (gender === "Kadƒ±n") ? (document.getElementById('periodEnabled')?.value === "true") : false,
      last_period_start: document.getElementById('lastPeriodStart')?.value || "",
      cycle_length_days: document.getElementById('cycleLength')?.value || "",
      period_length_days: document.getElementById('periodLength')?.value || ""
    };

    const cc = parseInt(meta.child_count || "0", 10) || 0;
    const maxKids = Math.min(cc, 5);
    const kids = [];
    for(let i=1;i<=maxKids;i++){
      const name = (document.getElementById(`child_name_${i}`)?.value || "").trim();
      const m = document.getElementById(`child_month_${i}`)?.value || "";
      const d = document.getElementById(`child_day_${i}`)?.value || "";
      const dm = (d && m) ? `${d}.${m}` : "";
      if(name || dm) kids.push({ name, bday_dm: dm });
    }
    meta.children = kids;

    return meta;
  }

  function isFullProfile(meta){
    const baseOk =
      !!String(meta.hitap||"").trim() &&
      !!String(meta.bot_name||"").trim() &&
      !!String(meta.gender||"").trim() &&
      !!String(meta.birth_date||"").trim() &&
      !!String(meta.region||"").trim() &&
      !!String(meta.birth_city||"").trim();
    if(!baseOk) return false;

    if(String(meta.marital_status||"") === "Evli"){
      const spouseOk = !!String(meta.spouse_name||"").trim();
      const anyDay = !!(meta.spouse_bday_dm || meta.wedding_dm || meta.engagement_dm || meta.met_dm);
      if(!spouseOk || !anyDay) return false;
    }

    const cc = parseInt(meta.child_count || "0", 10) || 0;
    if(cc > 0){
      const kids = Array.isArray(meta.children) ? meta.children : [];
      const hasKidData = kids.some(k => (k?.name && String(k.name).trim()) || (k?.bday_dm && String(k.bday_dm).trim()));
      if(!hasKidData) return false;
    }

    if(meta.period_tracking_enabled){
      if(!String(meta.last_period_start||"").trim()) return false;
      if(!String(meta.cycle_length_days||"").trim()) return false;
      if(!String(meta.period_length_days||"").trim()) return false;
    }

    return true;
  }

  function computeCompletion(meta){
    let score = 0;
    const add = (ok, pts)=>{ if(ok) score += pts; };

    add(!!String(meta.hitap||"").trim(), 12);
    add(!!String(meta.bot_name||"").trim(), 12);
    add(!!String(meta.gender||"").trim(), 12);
    add(!!String(meta.birth_date||"").trim(), 12);
    add(!!String(meta.region||"").trim(), 12);
    add(!!String(meta.birth_city||"").trim(), 12);

    if(String(meta.marital_status||"") === "Evli"){
      add(!!String(meta.spouse_name||"").trim(), 7);
      const anyDay = !!(meta.spouse_bday_dm || meta.wedding_dm || meta.engagement_dm || meta.met_dm);
      add(anyDay, 7);
    }else{
      add(!!String(meta.marital_status||"").trim(), 6);
    }

    const cc = parseInt(meta.child_count || "0", 10) || 0;
    if(cc > 0){
      const kids = Array.isArray(meta.children) ? meta.children : [];
      const hasKidData = kids.some(k => (k?.name && String(k.name).trim()) || (k?.bday_dm && String(k.bday_dm).trim()));
      add(hasKidData, 8);
    }else{
      add(true, 4);
    }

    if(meta.period_tracking_enabled){
      add(!!String(meta.last_period_start||"").trim(), 4);
      add(!!String(meta.cycle_length_days||"").trim(), 3);
      add(!!String(meta.period_length_days||"").trim(), 3);
    }else{
      add(true, 4);
    }

    add(!!String(meta.team||"").trim(), 4);

    score = Math.max(0, Math.min(100, Math.round(score)));
    return score;
  }

  function renderProgress(){
    const u = getUser();
    const meta = readMetaDraft();
    const pct = computeCompletion(meta);

    document.documentElement.style.setProperty("--p", String(pct));

    const heroPct = document.getElementById("heroPct");
    if(heroPct) heroPct.textContent = `%${pct}`;

    const sub = document.getElementById("heroSub");
    if(sub){
      if(pct < 35) sub.textContent = "Azƒ±cƒ±k daha‚Ä¶ Kaynana g√∂z ucuyla izliyor üòÑ";
      else if(pct < 70) sub.textContent = "ƒ∞yi gidiyorsun! Kaynana samimiyeti y√ºkseliyor.";
      else if(pct < 95) sub.textContent = "Efsane! Birka√ß detay kaldƒ±, tamamlanƒ±nca +5 geliyor.";
      else sub.textContent = "Tam dolu! Kaynana samimiyet puanƒ±n artmaya hazƒ±r üßø";
    }

    const pts = document.getElementById("heroPts");
    if(pts){
      const base = Number(u?.yp_percent ?? 10);
      const shown = base > 0 ? base : pct;
      pts.textContent = `Kaynana Samimiyeti: ${Math.round(shown)}%`;
    }

    const chip = document.getElementById("heroChip");
    if(chip){
      chip.classList.remove("low","ok","great");
      if(pct < 35){
        chip.textContent = "+1 yakla≈ütƒ±n";
        chip.classList.add("low");
      }else if(pct < 70){
        chip.textContent = "+1 daha!";
        chip.classList.add("ok");
      }else if(pct < 95){
        chip.textContent = "Son d√ºzl√ºktesin";
        chip.classList.add("great");
      }else{
        chip.textContent = "Tebrikler! +5 hazƒ±r üßø";
        chip.classList.add("great");
      }
    }

    const bar = document.getElementById("heroBar");
    if(bar){
      const hue = Math.round((Math.max(0, Math.min(100, pct)) / 100) * 120);
      bar.style.background = `linear-gradient(90deg, hsl(${hue}, 85%, 55%), hsl(${Math.min(120, hue+10)}, 85%, 45%))`;
      bar.style.boxShadow = `0 10px 28px hsla(${hue}, 85%, 55%, .22)`;
    }
  }

  // -------------------- UI --------------------
  window.goBack = function(){
    if(window.history.length > 1) window.history.back();
    else window.location.href = "../index.html";
  };

  window.copyID = async function(){
    const t = document.getElementById('formID')?.innerText || "";
    const ok = await safeCopy(t);
    toast(ok ? "ID kopyalandƒ±" : "Kopyalanamadƒ±");
  };

  window.toggleMarriedFields = function(){
    const val = document.getElementById('formStatus')?.value || "";
    document.getElementById('marriedFields')?.classList.toggle('show', val === 'Evli');
    renderProgress();
  };

  window.toggleGenderFields = function(){
    const g = document.getElementById('formGender')?.value || "";
    document.getElementById('periodFields')?.classList.toggle('show', g === 'Kadƒ±n');
    renderProgress();
  };

  window.toggleChildFields = function(){
    const val = parseInt(document.getElementById('formChildCount')?.value,10) || 0;
    const div = document.getElementById('childFields');
    const container = document.getElementById('childrenContainer');
    if(!div || !container) return;

    if(val <= 0){
      div.classList.remove('show');
      container.innerHTML = "";
      renderProgress();
      return;
    }
    div.classList.add('show');

    const count = Math.min(val, 5);
    container.innerHTML = "";
    for(let i=1;i<=count;i++){
      const box = document.createElement('div');
      box.className = "child-card";
      box.innerHTML = `
        <div class="mini">√áocuk ${i}</div>

        <div class="form-group" style="margin:0;">
          <label>Ad</label>
          <input type="text" id="child_name_${i}" placeholder="√ñrn: Ali">
        </div>

        <div class="form-group" style="margin:0;">
          <label>Doƒüum G√ºn√º (Ay / G√ºn)</label>
          <div class="date-row">
            <select id="child_month_${i}">
              <option value="">Ay</option>
              <option value="01">Oca</option><option value="02">≈ûub</option><option value="03">Mar</option>
              <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
              <option value="07">Tem</option><option value="08">Aƒüu</option><option value="09">Eyl</option>
              <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
            </select>
            <select id="child_day_${i}" disabled><option value="">G√ºn</option></select>
          </div>
        </div>
      `;
      container.appendChild(box);

      wireMonthDay(`child_month_${i}`, `child_day_${i}`);

      box.querySelectorAll("input,select").forEach(el=>{
        el.addEventListener("input", renderProgress);
        el.addEventListener("change", renderProgress);
      });
    }
    renderProgress();
  };

  // -------------------- Fill form from meta --------------------
  function fillFormFields(meta){
    if(!meta || typeof meta !== "object") return;

    if(meta.hitap) document.getElementById('formHitap').value = meta.hitap;
    if(meta.bot_name) document.getElementById('formBotName').value = meta.bot_name;

    if(meta.gender){
      document.getElementById('formGender').value = meta.gender;
      window.toggleGenderFields();
    }
    if(meta.marital_status){
      document.getElementById('formStatus').value = meta.marital_status;
      window.toggleMarriedFields();
    }

    if(meta.region) document.getElementById('formCity').value = meta.region;
    if(meta.birth_city) document.getElementById('formBirthCity').value = meta.birth_city;
    if(meta.team) document.getElementById('formTeam').value = meta.team;

    if(meta.birth_date) setBirthDate(meta.birth_date);

    if(meta.spouse_name) document.getElementById('formSpouse').value = meta.spouse_name;
    setDM("spouseBDay","spouseBMonth", meta.spouse_bday_dm);
    setDM("wDay","wMonth", meta.wedding_dm);
    setDM("eDay","eMonth", meta.engagement_dm);
    setDM("mDay","mMonth", meta.met_dm);

    if(meta.child_count !== undefined && meta.child_count !== null){
      document.getElementById('formChildCount').value = String(meta.child_count);
      window.toggleChildFields();

      const kids = Array.isArray(meta.children) ? meta.children : [];
      kids.forEach((k, idx) => {
        const i = idx + 1;
        const nameEl = document.getElementById(`child_name_${i}`);
        if(nameEl && k?.name) nameEl.value = k.name;

        if(k?.bday_dm){
          const p = String(k.bday_dm).split(".");
          if(p.length===2){
            const dEl = document.getElementById(`child_day_${i}`);
            const mEl = document.getElementById(`child_month_${i}`);
            if(mEl) mEl.value = p[1];
            wireMonthDay(`child_month_${i}`, `child_day_${i}`);
            if(dEl) dEl.value = p[0];
          }
        }
      });
    }

    if(meta.period_tracking_enabled !== undefined){
      document.getElementById('periodEnabled').value = String(!!meta.period_tracking_enabled);
    }
    if(meta.last_period_start){
      document.getElementById('lastPeriodStart').value = meta.last_period_start;
    }
    if(meta.cycle_length_days){
      document.getElementById('cycleLength').value = meta.cycle_length_days;
    }
    if(meta.period_length_days){
      document.getElementById('periodLength').value = meta.period_length_days;
    }
  }

  // -------------------- Save profile --------------------
  window.saveProfile = async function(){
    const user = getUser();

    const bd = getBirthDate();
    if(!bd.ok){
      toast("Doƒüum tarihini Yƒ±l/Ay/G√ºn tam se√ß ya da tamamen bo≈ü bƒ±rak.");
      return;
    }

    // √∂zel g√ºn validasyonu
    const pairs = [
      { label:"E≈üinin doƒüum g√ºn√º", d: document.getElementById("spouseBDay")?.value, m: document.getElementById("spouseBMonth")?.value },
      { label:"Evlilik g√ºn√º", d: document.getElementById("wDay")?.value, m: document.getElementById("wMonth")?.value },
      { label:"Ni≈üan g√ºn√º", d: document.getElementById("eDay")?.value, m: document.getElementById("eMonth")?.value },
      { label:"ƒ∞lk tanƒ±≈üma g√ºn√º", d: document.getElementById("mDay")?.value, m: document.getElementById("mMonth")?.value }
    ];
    for(const p of pairs){
      const any = !!(p.d || p.m);
      const full = !!(p.d && p.m);
      if(any && !full){
        toast(`${p.label}: Ay/G√ºn ikilisini ya tam se√ß, ya bo≈ü bƒ±rak.`);
        return;
      }
      if(full && !isValidDM(p.d, p.m)){
        toast(`${p.label}: ge√ßersiz tarih.`);
        return;
      }
    }

    const spouseB = getDM("spouseBDay","spouseBMonth");
    const wed = getDM("wDay","wMonth");
    const eng = getDM("eDay","eMonth");
    const met = getDM("mDay","mMonth");

    // √ßocuklar
    const childCount = parseInt(document.getElementById('formChildCount')?.value,10) || 0;
    const kids = [];
    const maxKids = Math.min(childCount, 5);
    for(let i=1;i<=maxKids;i++){
      const name = (document.getElementById(`child_name_${i}`)?.value || "").trim();
      const m = document.getElementById(`child_month_${i}`)?.value || "";
      const d = document.getElementById(`child_day_${i}`)?.value || "";

      if((d && !m) || (!d && m)){
        toast(`√áocuk ${i}: Ay/G√ºn ikilisini ya tam se√ß, ya bo≈ü bƒ±rak.`);
        return;
      }
      if(d && m && !isValidDM(d,m)){
        toast(`√áocuk ${i}: ge√ßersiz tarih.`);
        return;
      }
      const dm = (d && m) ? `${d}.${m}` : "";
      if(name || dm) kids.push({ name, bday_dm: dm });
    }

    const gender = document.getElementById('formGender')?.value || "";
    const periodEnabled = (document.getElementById('periodEnabled')?.value === "true");
    const lastPeriodStart = document.getElementById('lastPeriodStart')?.value || "";
    const cycleLen = parseInt(document.getElementById('cycleLength')?.value,10) || 28;
    const periodLen = parseInt(document.getElementById('periodLength')?.value,10) || 5;

    if(gender === "Kadƒ±n" && periodEnabled && !lastPeriodStart){
      toast("Regl takibi a√ßƒ±ksa son adet ba≈ülangƒ±√ß tarihi lazƒ±m.");
      return;
    }

    const meta = {
      hitap: document.getElementById('formHitap')?.value || "",
      bot_name: document.getElementById('formBotName')?.value || "",
      gender,
      marital_status: document.getElementById('formStatus')?.value || "",
      region: document.getElementById('formCity')?.value || "",
      birth_city: document.getElementById('formBirthCity')?.value || "",
      team: document.getElementById('formTeam')?.value || "",
      birth_date: bd.value,

      spouse_name: document.getElementById('formSpouse')?.value || "",
      spouse_bday_dm: spouseB.value,
      wedding_dm: wed.value,
      engagement_dm: eng.value,
      met_dm: met.value,

      child_count: String(childCount),
      children: kids,

      period_tracking_enabled: (gender === "Kadƒ±n") ? periodEnabled : false,
      last_period_start: (gender === "Kadƒ±n" && periodEnabled) ? lastPeriodStart : "",
      cycle_length_days: (gender === "Kadƒ±n" && periodEnabled) ? cycleLen : "",
      period_length_days: (gender === "Kadƒ±n" && periodEnabled) ? periodLen : "",

      reminder_opt_in: true
    };

    // +5 tek sefer
    try{
      const eligible = isFullProfile(meta);
      const bonusState = JSON.parse(localStorage.getItem(PROFILE_BONUS_KEY) || "{}");
      const bonusState = JSON.parse(localStorage.getItem(PROFILE_BONUS_KEY) || "{}");

// kullanƒ±cƒ± anahtarƒ± (backend ile uyumlu: email > user_id > id)
const userKey = (
  user?.user_id ||
  user?.email ||
  user?.id ||
  ""
).toLowerCase();

// daha √∂nce bonus verildiyse √ßƒ±k
if(!userKey || bonusState[userKey]){
  return;
}

// profil ger√ßekten tam mƒ±?
if(!isFullProfile(meta)){
  return;
}

try{
  // mevcut user‚Äôƒ± oku
  let u = {};
  try{
    u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  }catch(e){ u = {}; }

  // mevcut samimiyet
  const cur = Number(u?.yp_percent ?? 10);

  // +5 ekle (5‚Äì100 arasƒ± clamp)
  const next = Math.max(5, Math.min(100, cur + 5));

  // user‚Äôa yaz
  u.yp_percent = next;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(u));

  // kilidi yaz (tek seferlik)
  bonusState[userKey] = {
    added: 5,
    from: cur,
    to: next,
    awarded_at: new Date().toISOString()
  };
  localStorage.setItem(PROFILE_BONUS_KEY, JSON.stringify(bonusState));

  // kullanƒ±cƒ±ya k√º√ß√ºk feedback
  toast("üéâ Profil tamamlandƒ±! Kaynana samimiyet puanƒ±n +5 arttƒ±.");
}catch(e){
  console.warn("Profil bonusu yazƒ±lamadƒ±:", e);
}
