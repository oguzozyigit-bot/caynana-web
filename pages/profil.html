<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profil AyarlarÄ±</title>

<style>
  :root{
    --bg:#0e0e0e; --text:#ececec; --gold:#ffb300; --pist:#bef264; --card:#141414;
    --border:#2a2a2a; --soft:#8c8c8c;
    --ok:#22c55e;
    --p: 10; /* progress 0-100 */
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; scrollbar-width:none; -ms-overflow-style:none; }
  *::-webkit-scrollbar{ display:none; width:0; height:0; }

  body{
    margin:0; background:#000; color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex; justify-content:center; height:100vh; overflow:hidden;
  }

  .frame{ width:100%; max-width:480px; height:100%; background:var(--bg); display:flex; flex-direction:column; }
  @media (min-width:500px){
    .frame{
      height:95vh; margin-top:2.5vh; border-radius:24px; border:1px solid #333;
      box-shadow:0 0 50px rgba(255,255,255,.05);
    }
  }

  .header{
    padding:16px 16px 14px; border-bottom:1px solid var(--border);
    background:rgba(20,20,20,.95);
    display:flex; align-items:center; gap:12px;
  }
  .back-btn{
    width:38px; height:38px; border-radius:12px; border:1px solid #333;
    background:#121212; color:#fff; cursor:pointer; font-size:18px;
    display:flex; align-items:center; justify-content:center;
  }
  .title-wrap{ flex:1; text-align:center; margin-right:38px; }
  .title-wrap h2{ margin:0; font-size:16px; font-weight:800; }
  .title-wrap p{ margin:4px 0 0; font-size:12px; color:var(--soft); }

  .content{ flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:16px; }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    border:1px solid var(--border); border-radius:16px; padding:14px;
  }

  /* âœ… Premium Progress Hero */
  .hero{
    padding:14px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(1200px 400px at 0% 0%, rgba(255,179,0,.10), rgba(0,0,0,0) 60%),
      radial-gradient(900px 400px at 100% 0%, rgba(34,197,94,.10), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,0));
    position:relative;
    overflow:hidden;
  }
  .hero-top{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .hero-title{ font-weight:900; font-size:13px; letter-spacing:.2px; }
  .hero-badge{
    font-size:11px; font-weight:900; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.35);
  }
  .hero-sub{ margin-top:8px; font-size:12px; color:rgba(255,255,255,.72); line-height:1.35; }
  .bar{
    margin-top:12px;
    height:10px; border-radius:999px;
    background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.08);
    overflow:hidden;
  }
  .bar > span{
    display:block; height:100%; width:calc(var(--p) * 1%);
    background:linear-gradient(90deg, rgba(255,179,0,.95), rgba(190,242,100,.95), rgba(34,197,94,.95));
    filter:saturate(1.1);
    transition:width .35s ease;
  }
  .hero-foot{
    margin-top:10px;
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-size:11px; color:rgba(255,255,255,.62);
  }
  .spark{
    position:absolute; inset:auto -40px -80px -40px; height:220px;
    opacity:.75;
  }

  .pill{
    display:inline-flex; gap:6px; align-items:center; font-size:11px; font-weight:800;
    background:var(--pist); color:#111; padding:4px 10px; border-radius:999px;
  }
  .muted{ color:#9a9a9a; font-size:12px; line-height:1.35; margin-top:8px; }

  .section-title{
    font-size:11px; color:var(--pist); font-weight:800; letter-spacing:1px; text-transform:uppercase;
    border-bottom:1px solid #232323; padding-bottom:8px; margin-bottom:10px;
  }

  .form-group{ display:flex; flex-direction:column; gap:8px; margin-bottom:6px; }
  label{ font-size:12px; color:#aaa; font-weight:600; margin-left:4px; }

  input, select{
    width:100%; background:#1a1a1a; border:1px solid #444; color:#fff;
    padding:14px; border-radius:12px; font-size:14px; outline:none; font-family:inherit;
    transition:.2s;
  }
  input:focus, select:focus{ border-color:var(--gold); background:#222; }

  .row{ display:flex; gap:12px; }
  .row > div{ flex:1; min-width:0; }

  .date-row{ display:flex; gap:8px; }
  .date-row select{ flex:1; padding:14px 8px; text-align:center; appearance:none; }

  .id-copy-box{
    display:flex; align-items:center; gap:10px; background:#111;
    padding:12px; border-radius:10px; border:1px dashed #444;
  }
  .id-text{ flex:1; font-family:monospace; color:var(--gold); font-size:12px; word-break:break-all; }
  .copy-btn{ background:none; border:none; cursor:pointer; font-size:18px; color:#777; }

  .conditional{ display:none; border-left:2px solid var(--gold); padding-left:14px; margin-left:4px; }
  .conditional.show{ display:block; animation:fadeIn .25s ease; }
  @keyframes fadeIn{ from{ opacity:0; transform:translateY(-6px);} to{opacity:1; transform:translateY(0);} }

  .children-wrap{ display:flex; flex-direction:column; gap:10px; }
  .child-card{
    background:#121212; border:1px solid #262626; border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }
  .mini{ font-size:11px; color:#8a8a8a; margin-left:4px; }

  .save-btn{
    background:var(--gold); color:#000; border:none; padding:16px; border-radius:14px;
    font-weight:900; font-size:15px; cursor:pointer; width:100%;
    box-shadow:0 8px 20px rgba(255,179,0,.15);
  }

  /* âœ… Toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:78px; z-index:9999;
    min-width:240px; max-width:92vw;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(10,10,10,.85);
    color:#fff;
    box-shadow:0 10px 30px rgba(0,0,0,.55);
    display:none;
    font-size:12px; line-height:1.35;
  }
  .toast.show{ display:block; animation:pop .18s ease; }
  @keyframes pop{ from{ opacity:0; transform:translateX(-50%) translateY(10px);} to{opacity:1; transform:translateX(-50%) translateY(0);} }

  /* âœ… Footer: stil bozulmasÄ±n */
  .footer{
    border-top:0 !important;
    background: linear-gradient(180deg, rgba(14,14,14,0), rgba(14,14,14,.75)) !important;
    padding:10px 10px 8px !important;
    text-align:center;
  }
  .footer .brand{
    color: rgba(255,255,255,.62) !important;
    font-size:11px !important;
    font-weight:700; letter-spacing:.3px;
  }
  .footer .slogan{ display:none !important; }
</style>
</head>

<body>
<div class="frame">
  <div class="header">
    <button class="back-btn" onclick="goBack()" title="Geri">â†</button>
    <div class="title-wrap">
      <h2>Profil AyarlarÄ±</h2>
      <p>Hepsi opsiyonel. Doldurursan Kaynana asistanÄ±n olur.</p>
    </div>
  </div>

  <div class="content">

    <!-- âœ… Premium progress hero -->
    <div class="hero" id="hero">
      <svg class="spark" viewBox="0 0 600 220" preserveAspectRatio="none" aria-hidden="true">
        <path d="M0,170 C120,120 160,40 260,70 C340,95 360,170 430,160 C520,146 540,85 600,95 L600,220 L0,220 Z"
              fill="rgba(255,179,0,.08)"></path>
        <path d="M0,185 C120,150 190,60 290,92 C360,115 380,185 455,175 C535,164 548,120 600,125 L600,220 L0,220 Z"
              fill="rgba(34,197,94,.08)"></path>
      </svg>

      <div class="hero-top">
        <div class="hero-title">Kaynana Samimiyet GÃ¶stergesi</div>
        <div class="hero-badge" id="heroBadge">%10</div>
      </div>
      <div class="hero-sub" id="heroSub">
        Biraz daha doldur, Kaynana â€œgelinim/damadÄ±mâ€ moduna geÃ§sin ğŸ˜„
      </div>
      <div class="bar"><span></span></div>
      <div class="hero-foot">
        <div id="heroHint">DoldurdukÃ§a yeÅŸile dÃ¶ner.</div>
        <div id="heroPts">+0 / +5</div>
      </div>
    </div>

    <div class="card">
      <div class="pill">ğŸ§¿ Kaynana Asistan</div>
      <div class="muted">
        Bu alanlarÄ± doldurursan gÃ¼nÃ¼ gelince <b>bildirimle hatÄ±rlatÄ±rÄ±m</b>:
        â€œBugÃ¼n eÅŸinin doÄŸum gÃ¼nÃ¼â€ gibiâ€¦<br><br>
        <b>HiÃ§biri zorunlu deÄŸil.</b>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Kimlik</div>

      <div class="form-group">
        <label>ID NumarasÄ± (DeÄŸiÅŸmez)</label>
        <div class="id-copy-box">
          <span id="formID" class="id-text">...</span>
          <button class="copy-btn" onclick="copyID()" title="Kopyala">ğŸ“‹</button>
        </div>
        <div class="mini" id="emailDisplay">Email: â€”</div>

        <div class="form-group" style="margin-top:10px;">
          <label>Ad Soyad (Googleâ€™dan gelir)</label>
          <input type="text" id="formFullname" placeholder="â€”" readonly disabled>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <label>Profil FotoÄŸrafÄ±</label>
          <div style="display:flex; align-items:center; gap:12px;">
            <img id="avatarImg" src="" alt="avatar"
                 style="width:54px;height:54px;border-radius:999px;border:1px solid #333;object-fit:cover;display:none;">
            <div class="mini" id="avatarHint">Google profil foto varsa burada gÃ¶rÃ¼nÃ¼r.</div>
          </div>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="section-title">Temel Bilgiler</div>

      <div class="form-group">
        <label>Caynana sana nasÄ±l hitap etsin?</label>
        <input type="text" id="formHitap" placeholder="Ã–rn: KÄ±zÄ±m, Gelinim, DamadÄ±m">
      </div>

      <div class="form-group">
        <label>Caynana'ya bir isim ver</label>
        <input type="text" id="formBotName" placeholder="Ã–rn: Sultan HanÄ±m, Åerife Teyze">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Cinsiyet</label>
          <select id="formGender" onchange="toggleGenderFields()">
            <option value="">SeÃ§</option>
            <option value="KadÄ±n">KadÄ±n</option>
            <option value="Erkek">Erkek</option>
          </select>
        </div>
        <div class="form-group">
          <label>Medeni Durum</label>
          <select id="formStatus" onchange="toggleMarriedFields()">
            <option value="">SeÃ§</option>
            <option value="Bekar">Bekar</option>
            <option value="Evli">Evli</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>YaÅŸadÄ±ÄŸÄ± Ä°l</label>
          <select id="formCity"><option value="">SeÃ§</option></select>
        </div>
        <div class="form-group">
          <label>DoÄŸduÄŸu Ä°l</label>
          <select id="formBirthCity"><option value="">SeÃ§</option></select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>TuttuÄŸu TakÄ±m</label>
          <input type="text" id="formTeam" placeholder="Ã–rn: BeÅŸiktaÅŸ">
        </div>
      </div>

      <div class="form-group">
        <label>DoÄŸum Tarihi (YÄ±l / Ay / GÃ¼n)</label>
        <div class="date-row">
          <select id="yearSelect"><option value="">YÄ±l</option></select>
          <select id="monthSelect" disabled>
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
          <select id="daySelect" disabled><option value="">GÃ¼n</option></select>
        </div>
        <div class="mini">Ã–nce yÄ±l â†’ sonra ay â†’ sonra gÃ¼n. Åubat 28/29 otomatik doÄŸru gelir.</div>
      </div>
    </div>

    <!-- REGL TAKÄ°BÄ° -->
    <div class="card conditional" id="periodFields">
      <div class="section-title">Regl Takibi (opsiyonel)</div>

      <div class="form-group" style="margin-top:10px;">
        <label>Takip aÃ§Ä±k mÄ±?</label>
        <select id="periodEnabled">
          <option value="false">KapalÄ±</option>
          <option value="true">AÃ§Ä±k</option>
        </select>
      </div>

      <div class="form-group">
        <label>Son adet baÅŸlangÄ±Ã§ tarihi</label>
        <input type="date" id="lastPeriodStart">
      </div>

      <div class="row">
        <div class="form-group">
          <label>Ortalama dÃ¶ngÃ¼ (gÃ¼n)</label>
          <input type="number" id="cycleLength" value="28" min="21" max="35">
        </div>
        <div class="form-group">
          <label>Ortalama adet sÃ¼resi (gÃ¼n)</label>
          <input type="number" id="periodLength" value="5" min="3" max="8">
        </div>
      </div>

      <div class="mini">Not: Bu takip sadece hatÄ±rlatma iÃ§indir.</div>
    </div>

    <!-- EVLÄ° ALANLARI -->
    <div class="card conditional" id="marriedFields">
      <div class="section-title">Ã–zel GÃ¼nler</div>

      <div class="form-group">
        <label>EÅŸinin AdÄ±</label>
        <input type="text" id="formSpouse" placeholder="Yenge/EniÅŸte adÄ±">
      </div>

      <div class="form-group">
        <label>EÅŸinin DoÄŸum GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="spouseBDay"><option value="">G</option></select>
          <select id="spouseBMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Evlilik GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="wDay"><option value="">G</option></select>
          <select id="wMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>NiÅŸan GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="eDay"><option value="">G</option></select>
          <select id="eMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Ä°lk TanÄ±ÅŸma GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="mDay"><option value="">G</option></select>
          <select id="mMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="mini">GeÃ§ersiz gÃ¼n/ay seÃ§ilirse kaydetmez.</div>
    </div>

    <!-- Ã‡OCUKLAR -->
    <div class="card">
      <div class="section-title">Ã‡ocuklar (opsiyonel)</div>

      <div class="form-group">
        <label>Ã‡ocuk SayÄ±sÄ±</label>
        <select id="formChildCount" onchange="toggleChildFields()">
          <option value="0">Yok</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5+</option>
        </select>
      </div>

      <div class="conditional" id="childFields">
        <div class="children-wrap" id="childrenContainer"></div>
        <div class="mini" style="margin-top:8px;">Ã‡ocuÄŸun adÄ±nÄ±/doÄŸum gÃ¼nÃ¼nÃ¼ girersen hatÄ±rlatÄ±rÄ±m.</div>
      </div>
    </div>

    <button class="save-btn" onclick="saveProfile()">ğŸ’¾ KAYDET VE BAÅLA</button>

  </div>

  <div class="footer">
    <div class="brand">@CaynanaAI By Ozyigit's 2026</div>
    <div class="slogan">Yapay ZekÃ¢nÄ±n Geleneksel AklÄ±</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { BASE_DOMAIN, STORAGE_KEY } from '../js/config.js';

  const PROFILE_KEY = "caynana_profile_v2";
  const PROFILE_BONUS_KEY = "caynana_profile_bonus_v1";
  const GENERATED_IDS_KEY = "caynana_generated_ids_v1";
  const pad2 = (n) => String(n).padStart(2, "0");

  const TR_CITIES_81 = [
    "Adana","AdÄ±yaman","Afyonkarahisar","AÄŸrÄ±","Amasya","Ankara","Antalya","Artvin","AydÄ±n","BalÄ±kesir",
    "Bilecik","BingÃ¶l","Bitlis","Bolu","Burdur","Bursa","Ã‡anakkale","Ã‡ankÄ±rÄ±","Ã‡orum","Denizli",
    "DiyarbakÄ±r","Edirne","ElazÄ±ÄŸ","Erzincan","Erzurum","EskiÅŸehir","Gaziantep","Giresun","GÃ¼mÃ¼ÅŸhane","Hakkari",
    "Hatay","Isparta","Mersin","Ä°stanbul","Ä°zmir","Kars","Kastamonu","Kayseri","KÄ±rklareli","KÄ±rÅŸehir",
    "Kocaeli","Konya","KÃ¼tahya","Malatya","Manisa","KahramanmaraÅŸ","Mardin","MuÄŸla","MuÅŸ","NevÅŸehir",
    "NiÄŸde","Ordu","Rize","Sakarya","Samsun","Siirt","Sinop","Sivas","TekirdaÄŸ","Tokat",
    "Trabzon","Tunceli","ÅanlÄ±urfa","UÅŸak","Van","Yozgat","Zonguldak","Aksaray","Bayburt","Karaman",
    "KÄ±rÄ±kkale","Batman","ÅÄ±rnak","BartÄ±n","Ardahan","IÄŸdÄ±r","Yalova","KarabÃ¼k","Kilis","Osmaniye","DÃ¼zce"
  ];

  /* âœ… Karakter bozulmasÄ± dÃ¼zelt (OÃ„Å¸uz -> OÄŸuz) */
  function fixMojibakeTR(s){
    s = String(s ?? "");
    const looksBroken = /Ãƒ.|Ã‚.|Ã„.|Ã….|Ã˜.|Ã.|Ã.|Ã.|ÃƒÂ¶|ÃƒÂ¼|Ã„Å¸|Ã…Å¸|Ã„Â±|Ã„Â°/i.test(s);
    if(!looksBroken) return s;
    try{
      const bytes = Uint8Array.from(s, ch => ch.charCodeAt(0));
      const fixed = new TextDecoder("utf-8", { fatal:false }).decode(bytes);
      if(/Ãƒ.|Ã‚.|Ã„.|Ã…./.test(fixed)) return s;
      return fixed;
    }catch(e){
      try{ return decodeURIComponent(escape(s)); }catch(e2){ return s; }
    }
  }

  function toast(msg){
    const t = document.getElementById("toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.classList.remove("show"), 2300);
  }

  function norm(v){ return String(v || "").trim(); }
  function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
  function pickLetter(except){
    const A = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let ch = "";
    for(let t=0;t<50;t++){
      ch = A[randInt(0, A.length-1)];
      if(ch !== except) return ch;
    }
    return ch || "X";
  }
  function buildNonSequentialDigits(len=8){
    const digits = [];
    for(let i=0;i<len;i++){
      let d = randInt(0,9);
      for(let t=0;t<100;t++){
        const prev = digits[i-1];
        const prev2 = digits[i-2];
        const ok1 = (prev === undefined) ? true : (d !== prev && Math.abs(d - prev) !== 1);
        const ok2 = (prev2 === undefined) ? true : (d !== prev2);
        if(ok1 && ok2) break;
        d = randInt(0,9);
      }
      digits.push(d);
    }
    return digits.join("");
  }
  function getGeneratedIds(){
    try{
      const a = JSON.parse(localStorage.getItem(GENERATED_IDS_KEY) || "[]");
      return Array.isArray(a) ? a : [];
    }catch(e){ return []; }
  }
  function saveGeneratedId(id){
    const ids = getGeneratedIds();
    if(!ids.includes(id)) ids.push(id);
    try{ localStorage.setItem(GENERATED_IDS_KEY, JSON.stringify(ids)); }catch(e){}
  }
  function generateStableRandomId(){
    const used = new Set(getGeneratedIds());
    for(let tries=0; tries<200; tries++){
      const a = pickLetter("");
      const b = pickLetter(a);
      const nums = buildNonSequentialDigits(8);
      const id = `${a}${b}${nums}`;
      if(!used.has(id)){
        saveGeneratedId(id);
        return id;
      }
    }
    const fallback = `XZ${buildNonSequentialDigits(8)}`;
    saveGeneratedId(fallback);
    return fallback;
  }

  function ensureIdentity(user){
    if(!user || typeof user !== "object") user = {};
    user.id = norm(user.id);
    user.email = norm(user.email);
    user.user_id = norm(user.user_id);

    if(!user.id) user.id = generateStableRandomId();
    if(!user.user_id) user.user_id = user.email || user.id;

    // isim varsa dÃ¼zelt
    const nm = fixMojibakeTR(user.fullname || user.name || user.display_name || "");
    if(nm && nm !== (user.fullname || user.name || user.display_name || "")){
      user.fullname = nm; user.name = nm; user.display_name = nm;
    }
    return user;
  }

  function safeUpdateUser(patch){
    let u = {};
    try{ u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){}
    u = ensureIdentity(u);
    u = { ...u, ...(patch || {}) };
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(u)); }catch(e){}
    return u;
  }

  function getUser(){
    let user = {};
    try { user = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); } catch {}
    user = ensureIdentity(user);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(user)); } catch {}
    return user;
  }

  function fillCitySelects(){
    const s1 = document.getElementById("formCity");
    const s2 = document.getElementById("formBirthCity");
    if(!s1 || !s2) return;
    if(s1.dataset.filled === "1") return;

    const opts = TR_CITIES_81.map(c => `<option value="${c}">${c}</option>`).join("");
    s1.insertAdjacentHTML("beforeend", opts);
    s2.insertAdjacentHTML("beforeend", opts);
    s1.dataset.filled = "1";
    s2.dataset.filled = "1";
  }

  function daysInMonth(year, month){
    const y = parseInt(year,10);
    const m = parseInt(month,10);
    if(!y || !m) return 31;
    return new Date(y, m, 0).getDate();
  }

  function fillDayOptions(selectId, maxDays=31){
    const s = document.getElementById(selectId);
    if(!s) return;
    const cur = s.value || "";
    s.innerHTML = `<option value="">GÃ¼n</option>`;
    for(let i=1;i<=maxDays;i++){
      s.innerHTML += `<option value="${pad2(i)}">${i}</option>`;
    }
    if(cur){
      const n = parseInt(cur,10) || 0;
      if(n >= 1 && n <= maxDays) s.value = pad2(n);
    }
  }

  function fillYearOptions(selectId, start=1950){
    const s = document.getElementById(selectId);
    if(!s) return;
    if(s.dataset.filled === "1") return;
    const nowY = new Date().getFullYear();
    for(let y=nowY; y>=start; y--){
      s.innerHTML += `<option value="${y}">${y}</option>`;
    }
    s.dataset.filled = "1";
  }

  function isValidDM(d, m){
    const dd = parseInt(d,10);
    const mm = parseInt(m,10);
    if(!dd || !mm) return false;
    if(mm < 1 || mm > 12) return false;
    const max = new Date(2024, mm, 0).getDate();
    return dd >= 1 && dd <= max;
  }

  function getDM(dayId, monthId){
    const d = document.getElementById(dayId)?.value || "";
    const m = document.getElementById(monthId)?.value || "";
    if((d && !m) || (!d && m)) return { ok:false, value:"" };
    return { ok:true, value: (d && m) ? `${d}.${m}` : "" };
  }

  function setDM(dayId, monthId, val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===2){
      const d = document.getElementById(dayId);
      const m = document.getElementById(monthId);
      if(d) d.value = p[0];
      if(m) m.value = p[1];
    }
  }

  /* âœ… YÄ±l/Ay/GÃ¼n akÄ±ÅŸÄ± */
  function refreshBirthFlow(){
    const y = document.getElementById("yearSelect")?.value || "";
    const m = document.getElementById("monthSelect")?.value || "";
    const monthSel = document.getElementById("monthSelect");
    const daySel = document.getElementById("daySelect");

    if(monthSel){
      monthSel.disabled = !y;
      if(!y) monthSel.value = "";
    }
    if(daySel){
      daySel.disabled = !(y && m);
      if(!y || !m) daySel.value = "";
    }
    if(y && m){
      fillDayOptions("daySelect", daysInMonth(y, m));
    }else{
      fillDayOptions("daySelect", 31);
    }
  }

  function getBirthDate(){
    const y = document.getElementById('yearSelect')?.value || "";
    const m = document.getElementById('monthSelect')?.value || "";
    const d = document.getElementById('daySelect')?.value || "";

    const any = !!(y || m || d);
    const full = !!(y && m && d);
    if(any && !full) return { ok:false, value:"" };

    if(full){
      const max = daysInMonth(y, m);
      const dd = parseInt(d,10);
      if(!dd || dd<1 || dd>max) return { ok:false, value:"" };
      return { ok:true, value: `${d}.${m}.${y}` };
    }
    return { ok:true, value:"" };
  }

  function setBirthDate(val){
    if(!val) return;
    const p = String(val).split(".");
    if(p.length===3){
      const d = p[0], m=p[1], y=p[2];
      const yEl = document.getElementById("yearSelect");
      const mEl = document.getElementById("monthSelect");
      const dEl = document.getElementById("daySelect");
      if(yEl) yEl.value = y;
      refreshBirthFlow();
      if(mEl) mEl.value = m;
      refreshBirthFlow();
      if(dEl) dEl.value = d;
      refreshBirthFlow();
    }
  }

  async function safeCopy(text){
    const t = String(text || "");
    if(!t) return false;
    try{ await navigator.clipboard.writeText(t); return true; }
    catch(e){
      try{
        const ta = document.createElement("textarea");
        ta.value = t; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        return true;
      }catch(e2){ return false; }
    }
  }

  /* âœ… Progress hesap */
  function readMetaDraft(){
    const gender = document.getElementById('formGender')?.value || "";
    const bd = getBirthDate().value || "";

    const meta = {
      hitap: document.getElementById('formHitap')?.value || "",
      bot_name: document.getElementById('formBotName')?.value || "",
      gender,
      marital_status: document.getElementById('formStatus')?.value || "",
      region: document.getElementById('formCity')?.value || "",
      birth_city: document.getElementById('formBirthCity')?.value || "",
      team: document.getElementById('formTeam')?.value || "",
      birth_date: bd,

      spouse_name: document.getElementById('formSpouse')?.value || "",
      spouse_bday_dm: getDM("spouseBDay","spouseBMonth").value,
      wedding_dm: getDM("wDay","wMonth").value,
      engagement_dm: getDM("eDay","eMonth").value,
      met_dm: getDM("mDay","mMonth").value,

      child_count: String(parseInt(document.getElementById('formChildCount')?.value,10) || 0),
      children: [],

      period_tracking_enabled: (gender === "KadÄ±n") ? (document.getElementById('periodEnabled')?.value === "true") : false,
      last_period_start: document.getElementById('lastPeriodStart')?.value || "",
      cycle_length_days: document.getElementById('cycleLength')?.value || "",
      period_length_days: document.getElementById('periodLength')?.value || ""
    };

    // children draft read
    const cc = parseInt(meta.child_count || "0", 10) || 0;
    const maxKids = Math.min(cc, 5);
    const kids = [];
    for(let i=1;i<=maxKids;i++){
      const name = (document.getElementById(`child_name_${i}`)?.value || "").trim();
      const d = document.getElementById(`child_day_${i}`)?.value || "";
      const m = document.getElementById(`child_month_${i}`)?.value || "";
      const dm = (d && m) ? `${d}.${m}` : "";
      if(name || dm) kids.push({ name, bday_dm: dm });
    }
    meta.children = kids;

    return meta;
  }

  function isFullProfile(meta){
    const baseOk =
      !!String(meta.hitap||"").trim() &&
      !!String(meta.bot_name||"").trim() &&
      !!String(meta.gender||"").trim() &&
      !!String(meta.birth_date||"").trim() &&
      !!String(meta.region||"").trim() &&
      !!String(meta.birth_city||"").trim();

    if(!baseOk) return false;

    if(String(meta.marital_status||"") === "Evli"){
      const spouseOk = !!String(meta.spouse_name||"").trim();
      const anyDay = !!(meta.spouse_bday_dm || meta.wedding_dm || meta.engagement_dm || meta.met_dm);
      if(!spouseOk || !anyDay) return false;
    }

    const cc = parseInt(meta.child_count || "0", 10) || 0;
    if(cc > 0){
      const kids = Array.isArray(meta.children) ? meta.children : [];
      const hasKidData = kids.some(k => (k?.name && String(k.name).trim()) || (k?.bday_dm && String(k.bday_dm).trim()));
      if(!hasKidData) return false;
    }

    if(meta.period_tracking_enabled){
      if(!String(meta.last_period_start||"").trim()) return false;
      if(!String(meta.cycle_length_days||"").trim()) return false;
      if(!String(meta.period_length_days||"").trim()) return false;
    }

    return true;
  }

  function computeCompletion(meta){
    // â€œkafa karÄ±ÅŸmasÄ±nâ€ diye basit, anlaÅŸÄ±lÄ±r puanlama
    // Temel 6 alan: her biri 12 puan = 72
    let score = 0;
    const add = (ok, pts)=>{ if(ok) score += pts; };

    add(!!String(meta.hitap||"").trim(), 12);
    add(!!String(meta.bot_name||"").trim(), 12);
    add(!!String(meta.gender||"").trim(), 12);
    add(!!String(meta.birth_date||"").trim(), 12);
    add(!!String(meta.region||"").trim(), 12);
    add(!!String(meta.birth_city||"").trim(), 12);

    // Evli ekstra: spouse + any day (maks 14)
    if(String(meta.marital_status||"") === "Evli"){
      add(!!String(meta.spouse_name||"").trim(), 7);
      const anyDay = !!(meta.spouse_bday_dm || meta.wedding_dm || meta.engagement_dm || meta.met_dm);
      add(anyDay, 7);
    }else{
      // bekar seÃ§tiyse kÃ¼Ã§Ã¼k artÄ± (seÃ§im yaptÄ±)
      add(!!String(meta.marital_status||"").trim(), 6);
    }

    // Ã‡ocuk: sayÄ±sÄ±>0 ise en az bir veri (maks 8)
    const cc = parseInt(meta.child_count || "0", 10) || 0;
    if(cc > 0){
      const kids = Array.isArray(meta.children) ? meta.children : [];
      const hasKidData = kids.some(k => (k?.name && String(k.name).trim()) || (k?.bday_dm && String(k.bday_dm).trim()));
      add(hasKidData, 8);
    }else{
      add(true, 4); // Ã§ocuk yok seÃ§imi
    }

    // Regl takip: aÃ§Ä±ksa 3 alan (maks 10)
    if(meta.period_tracking_enabled){
      add(!!String(meta.last_period_start||"").trim(), 4);
      add(!!String(meta.cycle_length_days||"").trim(), 3);
      add(!!String(meta.period_length_days||"").trim(), 3);
    }else{
      add(true, 4); // kapalÄ± seÃ§imi
    }

    // takÄ±m: ufak bonus (maks 4)
    add(!!String(meta.team||"").trim(), 4);

    score = Math.max(0, Math.min(100, Math.round(score)));
    return score;
  }

  function renderProgress(){
    const meta = readMetaDraft();
    const pct = computeCompletion(meta);
    document.documentElement.style.setProperty("--p", String(pct));

    const badge = document.getElementById("heroBadge");
    if(badge) badge.textContent = `%${pct}`;

    const sub = document.getElementById("heroSub");
    if(sub){
      if(pct < 35) sub.textContent = "AzÄ±cÄ±k dahaâ€¦ Kaynana gÃ¶z ucuyla izliyor ğŸ˜„";
      else if(pct < 70) sub.textContent = "Ä°yi gidiyorsun! Kaynana samimiyeti yÃ¼kseliyor.";
      else if(pct < 95) sub.textContent = "Efsane! BirkaÃ§ detay kaldÄ±, tamamlanÄ±nca +5 geliyor.";
      else sub.textContent = "Tam dolu! Kaynana samimiyet puanÄ±n artmaya hazÄ±r ğŸ§¿";
    }

    const pts = document.getElementById("heroPts");
if(pts){
  // â€œSamimiyetâ€ gÃ¶stergesi: STORAGE_KEY iÃ§indeki yp_percent varsa onu baz al,
  // yoksa completion yÃ¼zdesinden tÃ¼ret (fallback)
  let base = 0;
  try{
    const u = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    base = Number(u?.yp_percent ?? 0);
  }catch(e){ base = 0; }

  const shown = base > 0 ? base : pct; // fallback: completion

  // metin
  pts.textContent = `Kaynana Samimiyeti: ${Math.round(shown)}%`;

  // kÃ¼Ã§Ã¼k rozet: doldurdukÃ§a +1 yaklaÅŸtÄ±n / bitince tebrik
  const badge = document.getElementById("heroBadge");
  if(badge){
    if(pct < 35){
      badge.textContent = "+1 yaklaÅŸtÄ±n";
      badge.classList.remove("ok","great");
      badge.classList.add("low");
    }else if(pct < 70){
      badge.textContent = "+1 daha!";
      badge.classList.remove("low","great");
      badge.classList.add("ok");
    }else if(pct < 95){
      badge.textContent = "Son dÃ¼zlÃ¼ktesin";
      badge.classList.remove("low","ok");
      badge.classList.add("great");
    }else{
      badge.textContent = "Tebrikler! +5 hazÄ±r ğŸ§¿";
      badge.classList.remove("low","ok");
      badge.classList.add("great");
    }
  }

  // progress bar rengi: % arttÄ±kÃ§a yeÅŸile kaydÄ±r (premium hissi)
  const bar = document.getElementById("heroBar");
  if(bar){
    bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    // kÄ±rmÄ±zÄ±(0) -> sarÄ±(55) -> yeÅŸil(120)
    const hue = Math.round((Math.max(0, Math.min(100, pct)) / 100) * 120);
    bar.style.background = `linear-gradient(90deg, hsl(${hue}, 85%, 55%), hsl(${Math.min(120, hue+10)}, 85%, 45%))`;
    bar.style.boxShadow = `0 10px 28px hsla(${hue}, 85%, 55%, .22)`;
  }

  // â€œKaynana samimiyet puanÄ±n arttÄ±â€ toast (tek seferlik)
  // pct 95+ olduÄŸunda gÃ¶ster; award zaten saveProfile iÃ§inde yapÄ±lÄ±yor.
  const TOAST_KEY = "caynana_profile_toast_v1";
  if(pct >= 95){
    try{
      const userKey = (user?.user_id || user?.email || user?.id || "").toLowerCase();
      const st = JSON.parse(localStorage.getItem(TOAST_KEY) || "{}");
      if(userKey && !st[userKey]){
        const t = document.getElementById("heroToast");
        if(t){
          t.textContent = "Profil tamamlandÄ±! Kaynana samimiyet puanÄ±n artmaya Ã§ok yakÄ±n ğŸ§¿";
          t.classList.add("show");
          setTimeout(()=> t.classList.remove("show"), 2800);
        }
        st[userKey] = { shown_at: new Date().toISOString() };
        localStorage.setItem(TOAST_KEY, JSON.stringify(st));
      }
    }catch(e){}
  }
}

