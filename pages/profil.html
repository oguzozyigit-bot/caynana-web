<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Profil AyarlarÄ±</title>
<style>
  :root { --bg: #0e0e0e; --text: #ececec; --gold: #ffb300; --pistachio: #bef264; --card-bg: #1a1a1a; }
  * { scrollbar-width: none; -ms-overflow-style: none; }
  *::-webkit-scrollbar { display: none; width: 0; height: 0; background: transparent; }

  body { margin: 0; padding: 0; background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text); display: flex; justify-content: center; height: 100vh; overflow: hidden; }

  .mobile-frame { width: 100%; max-width: 480px; height: 100%; background: var(--bg); display: flex; flex-direction: column; position: relative; }
  @media (min-width: 500px) { .mobile-frame { height: 95vh; border-radius: 24px; border: 1px solid #333; margin-top: 2.5vh; box-shadow: 0 0 50px rgba(255, 255, 255, 0.05); } }

  .header { padding: 20px; text-align: center; border-bottom: 1px solid #222; background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); z-index: 10; position: relative; }
  .header h2 { margin: 0; font-size: 18px; color: #fff; font-weight: 700; }
  .header p { margin: 6px 0 0; font-size: 12px; color: #888; }

  .logout-btn { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #ff5252; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 8px; }

  .scroll-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 18px; }

  .info-card{
    background:#121212;border:1px solid #222;border-radius:14px;padding:14px;
    line-height:1.35;
  }
  .info-card b{color:#fff}
  .info-card .mini{font-size:12px;color:#9a9a9a;margin-top:8px}
  .pill{
    display:inline-flex; gap:6px; align-items:center;
    font-size:11px; color:#111; background: var(--pistachio);
    padding:4px 8px; border-radius:999px; font-weight:800;
  }

  .section-title { font-size: 11px; color: var(--pistachio); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 8px; }

  .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 2px; }
  .form-label { font-size: 12px; color: #aaa; font-weight: 600; margin-left: 4px; }

  .form-input, .form-select { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 14px; border-radius: 12px; font-size: 14px; outline: none; width: 100%; transition: 0.2s; font-family: inherit; }
  .form-input:focus, .form-select:focus { border-color: var(--gold); background: #222; }

  .row-group { display: flex; gap: 15px; }
  .row-group > div { flex: 1; min-width: 0; }

  .date-row { display: flex; gap: 8px; }
  .date-row select { flex: 1; padding: 14px 5px; background: #1a1a1a; color: white; border: 1px solid #444; border-radius: 12px; font-size: 13px; appearance: none; text-align: center; }

  .id-copy-box { display: flex; align-items: center; gap: 10px; background: #111; padding: 12px; border-radius: 10px; border: 1px dashed #444; position: relative; }
  .id-text { flex: 1; font-family: monospace; color: var(--gold); font-size: 12px; word-break: break-all; }
  .copy-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #666; }

  .conditional-field { display: none; animation: fadeIn 0.4s; border-left: 2px solid var(--gold); padding-left: 15px; margin-left: 5px; margin-bottom: 8px; }
  .conditional-field.show { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

  .child-row{
    display:flex; gap:10px; align-items:center;
    background:#121212;border:1px solid #262626;border-radius:14px;padding:10px;
  }
  .child-row input{flex: 1;}
  .child-row .date-row{flex: 1.1;}
  .child-row .mini{font-size:11px;color:#8a8a8a;margin-top:4px}

  .save-btn { background: var(--gold); color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 800; font-size: 15px; width: 100%; cursor: pointer; margin-top: 10px; margin-bottom: 40px; }
</style>
</head>
<body>

<div class="mobile-frame">
  <div class="header">
    <button class="logout-btn" onclick="logoutFromProfile()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
    <h2>Profil AyarlarÄ±</h2>
    <p>Hepsi opsiyonel. Doldurursan Kaynana asistanÄ±n olur ğŸ™‚</p>
  </div>

  <div class="scroll-content">

    <div class="info-card">
      <div class="pill">ğŸ§¿ Kaynana Asistan</div>
      <div style="margin-top:10px;">
        <b>EvladÄ±m, ben sana asistanlÄ±k yapmak istiyorum.</b><br>
        Bu alanlarÄ± doldurursan, gÃ¼nÃ¼ gelince <b>bildirimle hatÄ±rlatÄ±rÄ±m</b>:
        â€œBugÃ¼n eÅŸinin doÄŸum gÃ¼nÃ¼, unutma!â€ gibiâ€¦<br><br>
        <b>HiÃ§biri zorunlu deÄŸil.</b> Doldurursan gÃ¼nlÃ¼k burÃ§ bildiriminden faydalanmak gibi dÃ¼ÅŸÃ¼n.
        <div class="mini">Ä°nan bana, bunlar hayat kurtarÄ±r. ğŸ˜„</div>
      </div>
    </div>

    <div class="section-title">Kimlik</div>

    <div class="form-group">
      <label class="form-label">ID NumarasÄ± (DeÄŸiÅŸmez)</label>
      <div class="id-copy-box">
        <span id="formID" class="id-text">...</span>
        <button class="copy-btn" onclick="copyID()" title="Kopyala">ğŸ“‹</button>
      </div>
      <div style="font-size:11px; color:#666; margin-top:6px;" id="emailDisplay">â€”</div>
    </div>

    <div class="section-title">Tercihler (opsiyonel)</div>

    <div class="form-group">
      <label class="form-label">Caynana sana nasÄ±l hitap etsin?</label>
      <input type="text" id="formHitap" class="form-input" placeholder="Ã–rn: KÄ±zÄ±m, Gelinim, DamadÄ±m">
    </div>

    <div class="form-group">
      <label class="form-label">Caynana'ya bir isim ver</label>
      <input type="text" id="formBotName" class="form-input" placeholder="Ã–rn: Sultan HanÄ±m, Åerife Teyze">
    </div>

    <div class="form-group row-group">
      <div style="flex: 1;">
        <label class="form-label">Medeni Durum</label>
        <select id="formStatus" class="form-select" onchange="toggleMarriedFields()">
          <option value="">SeÃ§</option>
          <option value="Bekar">Bekar</option>
          <option value="Evli">Evli</option>
        </select>
      </div>
      <div style="flex: 1;">
        <label class="form-label">Cinsiyet</label>
        <select id="formGender" class="form-select">
          <option value="">SeÃ§</option>
          <option value="KadÄ±n">KadÄ±n</option>
          <option value="Erkek">Erkek</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">YaÅŸadÄ±ÄŸÄ± Ä°l</label>
      <input type="text" id="formCity" class="form-input" placeholder="Ã–rn: Ankara">
    </div>

    <div class="form-group">
      <label class="form-label">TuttuÄŸu TakÄ±m</label>
      <input type="text" id="formTeam" class="form-input" placeholder="Ã–rn: BeÅŸiktaÅŸ">
    </div>

    <div class="section-title">Ã–zel GÃ¼nler (hayat kurtarÄ±r)</div>

    <!-- EÅŸ / Evlilik alanlarÄ± sadece Evli seÃ§ilince gÃ¶rÃ¼nÃ¼r -->
    <div id="marriedFields" class="conditional-field">
      <div class="form-group">
        <label class="form-label">EÅŸinin AdÄ±</label>
        <input type="text" id="formSpouse" class="form-input" placeholder="Yenge/EniÅŸte adÄ±">
      </div>

      <div class="form-group">
        <label class="form-label">EÅŸinin DoÄŸum GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="spouseBDay"><option value="">G</option></select>
          <select id="spouseBMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Evlilik GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="wDay"><option value="">G</option></select>
          <select id="wMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">NiÅŸan GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="eDay"><option value="">G</option></select>
          <select id="eMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Ä°lk TanÄ±ÅŸma GÃ¼nÃ¼ (GÃ¼n / Ay)</label>
        <div class="date-row">
          <select id="mDay"><option value="">G</option></select>
          <select id="mMonth">
            <option value="">Ay</option>
            <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
            <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
            <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
            <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
          </select>
        </div>
      </div>
    </div>

    <div class="section-title">Ã‡ocuklar (opsiyonel)</div>

    <div class="form-group">
      <label class="form-label">Ã‡ocuk SayÄ±sÄ±</label>
      <select id="formChildCount" class="form-select" onchange="toggleChildFields()">
        <option value="0">Yok</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5+</option>
      </select>
    </div>

    <div id="childFields" class="conditional-field">
      <div id="childrenContainer" style="display:flex; flex-direction:column; gap:10px;"></div>
      <div style="font-size:11px; color:#777; margin-top:6px;">
        Ã‡ocuÄŸun adÄ±nÄ± ve doÄŸum gÃ¼nÃ¼nÃ¼ girersen, Kaynana gÃ¼nÃ¼ gelince â€œBugÃ¼n Ã§ocuÄŸun doÄŸum gÃ¼nÃ¼!â€ diye dÃ¼rter. ğŸ˜‰
      </div>
    </div>

    <button class="save-btn" onclick="saveProfile()">ğŸ’¾ KAYDET VE BAÅLA</button>
  </div>
</div>

<script type="module">
  import { BASE_DOMAIN } from '../js/config.js';

  const PROFILE_KEY = "caynana_profile_v1";
  const USER_KEY = "caynana_user_v8";

  // --- yardÄ±mcÄ±lar ---
  function pad2(n){ return String(n).padStart(2,"0"); }

  function fillDayOptions(selId){
    const s = document.getElementById(selId);
    if(!s) return;
    // ilk option zaten var
    for(let i=1;i<=31;i++){
      s.innerHTML += `<option value="${pad2(i)}">${i}</option>`;
    }
  }

  function getDayMonth(dayId, monthId){
    const d = document.getElementById(dayId)?.value || "";
    const m = document.getElementById(monthId)?.value || "";
    // kural: ya ikisi de dolu, ya ikisi de boÅŸ
    if((d && !m) || (!d && m)) return { ok:false, value:"" };
    return { ok:true, value: (d && m) ? `${d}.${m}` : "" };
  }

  function setDayMonth(dayId, monthId, val){
    if(!val) return;
    const p = val.split(".");
    if(p.length===2){
      document.getElementById(dayId).value = p[0];
      document.getElementById(monthId).value = p[1];
    }
  }

  // 1) GÃ¼n dropdownlarÄ±nÄ± doldur
  ["spouseBDay","wDay","eDay","mDay"].forEach(fillDayOptions);

  // 2) Togglelar
  window.toggleMarriedFields = function(){
    const val = document.getElementById('formStatus').value;
    const div = document.getElementById('marriedFields');
    if(val === 'Evli') div.classList.add('show'); else div.classList.remove('show');
  }

  window.toggleChildFields = function(){
    const val = document.getElementById('formChildCount').value;
    const div = document.getElementById('childFields');
    if(val !== '0') {
      div.classList.add('show');
      renderChildRows(parseInt(val,10) || 0);
    } else {
      div.classList.remove('show');
      document.getElementById("childrenContainer").innerHTML = "";
    }
  }

  function renderChildRows(n){
    const c = document.getElementById("childrenContainer");
    if(!c) return;

    // 5+ seÃ§ilirse 5 gÃ¶sterelim (istersen artÄ±rÄ±rÄ±z)
    const count = Math.min(n, 5);
    c.innerHTML = "";

    for(let i=1;i<=count;i++){
      const row = document.createElement("div");
      row.className = "child-row";
      row.innerHTML = `
        <div style="flex:1;">
          <div class="mini">Ã‡ocuk ${i} AdÄ±</div>
          <input type="text" class="form-input" id="child_name_${i}" placeholder="Ã–rn: Ali">
        </div>
        <div style="flex:1.1;">
          <div class="mini">DoÄŸum (G/Ay)</div>
          <div class="date-row">
            <select id="child_day_${i}"><option value="">G</option></select>
            <select id="child_month_${i}">
              <option value="">Ay</option>
              <option value="01">Oca</option><option value="02">Åub</option><option value="03">Mar</option>
              <option value="04">Nis</option><option value="05">May</option><option value="06">Haz</option>
              <option value="07">Tem</option><option value="08">AÄŸu</option><option value="09">Eyl</option>
              <option value="10">Eki</option><option value="11">Kas</option><option value="12">Ara</option>
            </select>
          </div>
        </div>
      `;
      c.appendChild(row);

      fillDayOptions(`child_day_${i}`);
    }
  }

  // 3) Sayfa aÃ§Ä±lÄ±ÅŸ
  window.onload = async function(){
    const user = JSON.parse(localStorage.getItem(USER_KEY) || "{}");
    if(!user.id){
      alert("GiriÅŸ yapmamÄ±ÅŸsÄ±n!");
      window.location.href = "../index.html";
      return;
    }

    // kimlik sadece gÃ¶stermek iÃ§in
    document.getElementById("formID").innerText = user.id;
    document.getElementById("emailDisplay").innerText = user.email ? `Email: ${user.email}` : "Email: â€”";

    // Ã¶nce local profil
    const localProfile = JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
    if(localProfile && Object.keys(localProfile).length){
      fillFormFields(localProfile);
    }

    // sonra server profil
    try{
      const url = `${BASE_DOMAIN}/api/profile/get?user_id=${user.id}&email=${user.email || ""}`;
      const res = await fetch(url);
      const data = await res.json();
      if(data.found && data.meta){
        fillFormFields(data.meta);
        localStorage.setItem(PROFILE_KEY, JSON.stringify(data.meta));
      }
    }catch(e){ console.log("Profil senkron hatasÄ±:", e); }
  }

  function fillFormFields(data){
    if(data.hitap) document.getElementById('formHitap').value = data.hitap;
    if(data.bot_name) document.getElementById('formBotName').value = data.bot_name;
    if(data.gender) document.getElementById('formGender').value = data.gender;
    if(data.region) document.getElementById('formCity').value = data.region;
    if(data.team) document.getElementById('formTeam').value = data.team;

    if(data.marital_status){
      document.getElementById('formStatus').value = data.marital_status;
      toggleMarriedFields();
    }
    if(data.spouse_name) document.getElementById('formSpouse').value = data.spouse_name;

    // Ã¶zel gÃ¼nler (G/Ay)
    setDayMonth("spouseBDay","spouseBMonth", data.spouse_bday_dm);
    setDayMonth("wDay","wMonth", data.wedding_dm);
    setDayMonth("eDay","eMonth", data.engagement_dm);
    setDayMonth("mDay","mMonth", data.met_dm);

    // Ã§ocuklar
    if(data.child_count){
      document.getElementById("formChildCount").value = String(data.child_count);
      toggleChildFields();
      const kids = Array.isArray(data.children) ? data.children : [];
      kids.forEach((k, idx) => {
        const i = idx+1;
        const nameEl = document.getElementById(`child_name_${i}`);
        if(nameEl && k?.name) nameEl.value = k.name;
        if(k?.bday_dm){
          const p = k.bday_dm.split(".");
          if(p.length===2){
            const dEl = document.getElementById(`child_day_${i}`);
            const mEl = document.getElementById(`child_month_${i}`);
            if(dEl) dEl.value = p[0];
            if(mEl) mEl.value = p[1];
          }
        }
      });
    }
  }

  // 4) Kaydet
  window.saveProfile = async function(){
    const user = JSON.parse(localStorage.getItem(USER_KEY) || "{}");

    // G/Ay doÄŸrulama (yarÄ±m girilmesin)
    const spouseB = getDayMonth("spouseBDay","spouseBMonth");
    const wed = getDayMonth("wDay","wMonth");
    const eng = getDayMonth("eDay","eMonth");
    const met = getDayMonth("mDay","mMonth");

    if(!spouseB.ok || !wed.ok || !eng.ok || !met.ok){
      alert("Ã–zel gÃ¼nlerde GÃ¼n/Ay ikilisini ya tam seÃ§, ya tamamen boÅŸ bÄ±rak.");
      return;
    }

    // Ã§ocuklar
    const childCount = parseInt(document.getElementById("formChildCount").value,10) || 0;
    const kids = [];
    const maxKids = Math.min(childCount, 5);

    for(let i=1;i<=maxKids;i++){
      const name = (document.getElementById(`child_name_${i}`)?.value || "").trim();
      const d = document.getElementById(`child_day_${i}`)?.value || "";
      const m = document.getElementById(`child_month_${i}`)?.value || "";
      if((d && !m) || (!d && m)){
        alert(`Ã‡ocuk ${i} iÃ§in GÃ¼n/Ay ikilisini ya tam seÃ§, ya boÅŸ bÄ±rak.`);
        return;
      }
      const dm = (d && m) ? `${d}.${m}` : "";
      // tamamen boÅŸ satÄ±rÄ± kaydetme (isim ve tarih yoksa)
      if(name || dm){
        kids.push({ name, bday_dm: dm });
      }
    }

    const payloadMeta = {
      // opsiyonel tercih
      hitap: document.getElementById('formHitap').value,
      bot_name: document.getElementById('formBotName').value,
      gender: document.getElementById('formGender').value,
      region: document.getElementById('formCity').value,
      team: document.getElementById('formTeam').value,

      // iliÅŸki
      marital_status: document.getElementById('formStatus').value,
      spouse_name: document.getElementById('formSpouse').value,

      // Ã¶zel gÃ¼nler (G/Ay)
      spouse_bday_dm: spouseB.value,
      wedding_dm: wed.value,
      engagement_dm: eng.value,
      met_dm: met.value,

      // Ã§ocuklar
      child_count: String(childCount),
      children: kids,

      // sistem: bildirim iÃ§in izin mantÄ±ÄŸÄ± (ileride)
      reminder_opt_in: true
    };

    // Googleâ€™dan baÄŸÄ±msÄ±z local profil
    localStorage.setItem(PROFILE_KEY, JSON.stringify(payloadMeta));

    // UI fayda bayraÄŸÄ± (Ã¶rnek): burÃ§ bildirimi iÃ§in "opt-in" gibi
    const u = JSON.parse(localStorage.getItem(USER_KEY) || "{}");
    u.profile_ready_for_assistant = true;
    localStorage.setItem(USER_KEY, JSON.stringify(u));

    // serverâ€™a yaz (istersen bunu kapatabiliriz)
    try{
      const res = await fetch(`${BASE_DOMAIN}/api/profile/update`,{
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ user_id: user.id, meta: payloadMeta })
      });
      const result = await res.json();
      if(!result.ok){
        // server yazamazsa bile local kaydedildi
        console.log("Server yazÄ±m hatasÄ±:", result);
      }
    }catch(e){
      console.log("Sunucu hatasÄ± (local kayÄ±t ok):", e);
    }

    alert("TamamdÄ±r evladÄ±m. Ben bunlarÄ± gÃ¼nÃ¼ gelince hatÄ±rlatacaÄŸÄ±m. ğŸ§¿");
    window.location.href = "../index.html";
  }

  window.logoutFromProfile = function(){
    if(confirm("Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?")){
      localStorage.removeItem(USER_KEY);
      // profil opsiyonel; ister temizle ister bÄ±rak
      // localStorage.removeItem(PROFILE_KEY);
      window.location.href = "../index.html";
    }
  }

  window.copyID = function(){
    navigator.clipboard.writeText(document.getElementById('formID').innerText);
    alert("ID KopyalandÄ±");
  }
</script>
</body>
</html>
